<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <style>
      :root {
          --bg-primary: #1a1b1e;
          --bg-secondary: #2d2d30;
          --primary: #7289da;
          --primary-dark: #5c6fb1;
          --text-primary: #ffffff;
          --text-secondary: #a0a0a0;
          --danger: #ef4444;
          --warning: #f59e0b;
          --success: #22c55e;
          --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
          --border-color: rgba(255, 255, 255, 0.1);
          --info: #3b82f6;
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
          background: var(--bg-primary);
          min-height: 100vh;
          padding: 12px;
          color: var(--text-primary);
      }

      .container {
          max-width: 480px;
          margin: 0 auto;
          height: calc(100vh - 24px);
          overflow-y: auto;
          background: var(--bg-secondary);
          border-radius: 12px;
          box-shadow: var(--shadow);
      }

      .header {
          background: var(--bg-secondary);
          padding: 15px;
          border-bottom: 1px solid var(--border-color);
          position: sticky;
          top: 0;
          z-index: 100;
      }

      .header-title {
          display: flex;
          flex-direction: column;
          margin-bottom: 10px;
      }

      .title-text {
          font-size: 1.3rem;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 8px;
          justify-content: space-between;
      }

      .user-info {
          font-size: 0.9rem;
          color: var(--text-secondary);
          margin-top: 5px;
      }

      .connection-status {
          background-color: var(--success);
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.8rem;
          margin-left: 8px;
      }

      .btn {
          padding: 8px 16px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 0.9rem;
          transition: all 0.3s ease;
          flex: 1;
      }

      .btn-primary {
          background: var(--primary);
          color: var(--text-primary);
      }

      .btn-primary:hover {
          background: var(--primary-dark);
      }

      .btn-secondary {
          background: var(--warning);
          color: var(--text-primary);
      }

      .btn-danger {
          background: var(--danger);
          color: var(--text-primary);
      }

      .challenge-item {
          padding: 15px;
          border-bottom: 1px solid var(--border-color);
      }

      .challenge-title {
          font-size: 1.1rem;
          color: var(--text-primary);
          margin-bottom: 8px;
      }

      .challenge-info {
          color: var(--text-secondary);
          font-size: 0.9rem;
          margin-bottom: 12px;
      }

      .challenge-actions {
          display: flex;
          gap: 8px;
      }

      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 1000;
      }

      .modal {
          background: var(--bg-secondary);
          width: 90%;
          max-width: 400px;
          max-height: 80vh;
          border-radius: 12px;
          overflow: hidden;
          position: relative;
      }

      .modal-header {
          padding: 15px;
          background: var(--primary);
          color: var(--text-primary);
          display: flex;
          justify-content: space-between;
          align-items: center;
          position: sticky;
          top: 0;
      }

      .close-btn {
          background: none;
          border: none;
          color: var(--text-primary);
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0 8px;
      }

      .modal-content {
          padding: 15px;
          overflow-y: auto;
          max-height: calc(80vh - 56px);
      }

      .leaderboard-item {
          display: flex;
          align-items: center;
          padding: 8px 12px;
          border-bottom: 1px solid var(--border-color);
          transition: background-color 0.3s;
      }

      .leaderboard-item.current-user {
          background: rgba(114, 137, 218, 0.1);
          border-left: 3px solid var(--primary);
      }

      .rank {
          min-width: 30px;
          font-weight: bold;
          color: var(--primary);
      }

      .user-name {
          flex: 1;
          margin: 0 10px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .score {
          font-weight: bold;
          color: var(--primary);
          margin-left: auto;
      }

      .empty-leaderboard {
          text-align: center;
          padding: 20px;
          color: var(--text-secondary);
      }

      .exam-container {
          padding: 20px;
      }

      .exam-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .timer {
          font-size: 1.2rem;
          color: var(--primary);
      }

      .question {
          background: var(--bg-secondary);
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
      }

      .options {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          margin-top: 20px;
      }

      .option-btn {
          width: 100%;
          text-align: left;
          padding: 12px;
      }

      .option-btn.correct {
          background: var(--success);
      }

      .option-btn.wrong {
          background: var(--danger);
      }

      .exam-result {
          text-align: center;
          padding: 20px;
      }

      .exam-result h2 {
          margin-bottom: 20px;
      }

      .exam-result p {
          margin-bottom: 10px;
      }

      .exam-result button {
          margin: 10px;
      }

      ::-webkit-scrollbar {
          width: 8px;
      }

      ::-webkit-scrollbar-track {
          background: var(--bg-primary);
      }

      ::-webkit-scrollbar-thumb {
          background: var(--primary);
          border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
          background: var(--primary-dark);
      }

      .sudoku-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 4px;
          background: var(--border-color);
          padding: 4px;
          border-radius: 8px;
          margin-bottom: 20px;
      }

      .sudoku-cell {
          width: 100%;
          aspect-ratio: 1;
          background: var(--bg-primary);
          border: none;
          border-radius: 4px;
          color: var(--text-primary);
          font-size: 1.5rem;
          text-align: center;
          cursor: pointer;
      }

      .sudoku-cell:disabled {
          background: var(--bg-secondary);
          color: var(--text-secondary);
          cursor: not-allowed;
      }

      .sudoku-cell:focus {
          outline: 2px solid var(--primary);
      }

      .sudoku-cell::-webkit-inner-spin-button,
      .sudoku-cell::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
      }

      .loading {
          text-align: center;
          padding: 40px 20px;
          color: var(--text-secondary);
      }

      .loading-spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid var(--primary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-right: 10px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
  </style>
</head>
<body>
  <!-- è¼‰å…¥ä¸­ç•«é¢ -->
  <div id="loadingScreen" class="container">
      <div class="loading">
          <div class="loading-spinner"></div>
          æ­£åœ¨é©—è­‰ç™»å…¥ç‹€æ…‹...
      </div>
  </div>

  <!-- ä¸»è¦å…§å®¹ -->
  <div id="mainContent" class="container" style="display: none;">
      <header class="header">
          <div class="header-title">
              <div class="title-text">
                  <span>ğŸ¯</span>
                  <h1>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</h1>
                  <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
              </div>
              <div class="user-info">
                  <span id="currentUserWelcome">æ­¡è¿å›ä¾†ï¼Œè¼‰å…¥ä¸­...</span>
                  <span class="connection-status" id="connectionStatus">ç”¨æˆ¶é€£ç·šä¸­</span>
              </div>
          </div>
          <div class="header-actions">
              <button class="btn btn-primary" onclick="backToT2()">è¿”å›T2æ—¥</button>
          </div>
      </header>

      <div class="challenge-item">
          <h3 class="challenge-title">åˆ†æµè€ƒè©¦æŒ‘æˆ°</h3>
          <p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ10ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('basic')">è€ƒè©¦</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('basic')">æ’è¡Œæ¦œ</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">é£Ÿç‰©è‹±æ–‡å–®å­—è€ƒè©¦</h3>
          <p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ5ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('food')">è€ƒè©¦</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('food')">æ’è¡Œæ¦œ</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">å‰å°è¤‡æŸ¥æŒ‘æˆ°</h3>
          <p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ15ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('precheck')">è€ƒè©¦</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('precheck')">æ’è¡Œæ¦œ</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">è¦å®šæŒ‘æˆ°</h3>
          <p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ15ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('rule')">è€ƒè©¦</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('rule')">æ’è¡Œæ¦œ</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">åˆéšæ•¸ç¨æŒ‘æˆ°</h3>
          <p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ60ç§’ä½œç­”æ™‚é–“ï¼Œå…±5é¡Œ</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('sudoku')">è€ƒè©¦</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('sudoku')">æ’è¡Œæ¦œ</button>
          </div>
      </div>
  </div>

  <!-- æ’è¡Œæ¦œæ¨¡æ…‹è¦–çª— -->
  <div class="modal-overlay" id="leaderboardModal">
      <div class="modal">
          <div class="modal-header">
              <h2 id="modalTitle">æ’è¡Œæ¦œ</h2>
              <button class="close-btn" onclick="hideLeaderboard()">Ã—</button>
          </div>
          <div class="modal-content" id="leaderboardContent">
          </div>
      </div>
  </div>

  <script>
      // Firebase é…ç½®
      const firebaseConfig = {
          apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
          authDomain: "openexammodal.firebaseapp.com",
          databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
          projectId: "openexammodal",
          storageBucket: "openexammodal.firebasestorage.app",
          messagingSenderId: "336901617556",
          appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
      };

      // åˆå§‹åŒ– Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // å…¨åŸŸè®Šæ•¸
      let currentUser = null;
      let usersData = [];
      let currentExam = null;
      let currentQuestions = [];
      let currentQuestionIndex = 0;
      let examTimer = null;
      let questionStartTime = null;
      let userScores = {
          fastAnswers: 0,
          correctAnswers: 0
      };

      // å·¥å…·å‡½æ•¸ï¼šå¾æ•¸çµ„ä¸­ç§»é™¤ç‰¹å®šå…ƒç´ 
      Array.prototype.remove = function(element) {
          const index = this.indexOf(element);
          if (index > -1) {
              this.splice(index, 1);
          }
      };

      // å¼·åˆ¶ç™»å‡ºå‡½æ•¸
      function forceLogout(message = 'ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥') {
          localStorage.removeItem('t2_login');
          localStorage.removeItem('t2_login_time');
          localStorage.removeItem('t2_login_user');
          alert(message);
          window.location.href = 'index3.html';
      }

      // æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ™‚æ•ˆ
      function checkLoginStatus() {
          const loginFlag = localStorage.getItem('t2_login');
          const loginTime = localStorage.getItem('t2_login_time');
          const loginUser = localStorage.getItem('t2_login_user');

          if (loginFlag !== 'yes' || !loginTime || !loginUser) {
              forceLogout('æœªæª¢æ¸¬åˆ°æœ‰æ•ˆç™»å…¥ç‹€æ…‹');
              return false;
          }

          // æª¢æŸ¥ç™»å…¥æ™‚æ•ˆ (1å°æ™‚)
          const now = Date.now();
          const loginTimeStamp = parseInt(loginTime);
          const LIMIT = 3600000; // 1å°æ™‚

          if (now - loginTimeStamp > LIMIT) {
              forceLogout('ç™»å…¥æ™‚é–“å·²è¶…é1å°æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
              return false;
          }

          return loginUser;
      }

      // è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«
      async function loadUsersData() {
          try {
              const response = await fetch('password.json');
              if (!response.ok) {
                  throw new Error('ç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«');
              }
              const data = await response.json();
              usersData = Array.isArray(data) ? data : [data];
              return true;
          } catch (error) {
              console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«å¤±æ•—:', error);
              forceLogout('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«');
              return false;
          }
      }

      // é©—è­‰ç”¨æˆ¶æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­
      function validateUser(username) {
          const user = usersData.find(u => u.username === username);
          if (!user) {
              forceLogout('ç”¨æˆ¶å¸³è™Ÿä¸å­˜åœ¨æ–¼ç³»çµ±ä¸­');
              return null;
          }
          return user;
      }

      // é¡¯ç¤ºç”¨æˆ¶æ­¡è¿è¨Šæ¯
      function showWelcomeMessage(user) {
          const welcomeElement = document.getElementById('currentUserWelcome');
          const displayName = user.welcome || user._comment || user.username;
          welcomeElement.textContent = displayName;
      }

      // ä¸»è¦åˆå§‹åŒ–å‡½æ•¸
      async function initializePage() {
          try {
              // 1. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
              const loginUser = checkLoginStatus();
              if (!loginUser) {
                  return;
              }

              // 2. è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«
              const loadSuccess = await loadUsersData();
              if (!loadSuccess) {
                  return;
              }

              // 3. é©—è­‰ç”¨æˆ¶æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­
              const user = validateUser(loginUser);
              if (!user) {
                  return;
              }

              // 4. è¨­å®šç•¶å‰ç”¨æˆ¶
              currentUser = user;

              // 5. é¡¯ç¤ºæ­¡è¿è¨Šæ¯
              showWelcomeMessage(user);

              // 6. é¡¯ç¤ºä¸»è¦å…§å®¹
              document.getElementById('loadingScreen').style.display = 'none';
              document.getElementById('mainContent').style.display = 'block';

          } catch (error) {
              console.error('é é¢åˆå§‹åŒ–å¤±æ•—:', error);
              forceLogout('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
          }
      }

      // è€ƒè©¦é¡Œåº«
      const examCategories = {
          "åˆ†æµè€ƒè©¦æŒ‘æˆ°": [
              {
                  question: "ä»¥ä¸‹å“ªç¨®ç‰©å“éœ€è¦éXå…‰æ©Ÿæª¢æŸ¥ï¼Ÿ",
                  options: ["æ‰‹æ©Ÿ", "å¤§åŒ…åŒ…", "è­·ç…§", "å¸½å­"],
                  correct: 1
              },
              {
                  question: "æ—…å®¢æ”œå¸¶æ‹ç«‹å¾—ç›¸æ©Ÿæ™‚ï¼Œå‰å°äººå“¡æ‡‰è©²è©¢å•ä»€éº¼ï¼Ÿ",
                  options: ["ç›¸æ©Ÿå“ç‰Œ", "ç›¸æ©Ÿåƒ¹æ ¼", "åº•ç‰‡æ˜¯å¦å·²å–å‡º", "è³¼è²·åœ°é»"],
                  correct: 2
              },
              {
                  question: "æª¢ç–«ç«™çš„ä¸»è¦ä»»å‹™æ˜¯ä»€éº¼ï¼Ÿ",
                  options: ["æª¢æŸ¥è¡Œæ", "é˜²æ­¢ç–«æƒ…å‚³æ’­", "æŸ¥é©—è­·ç…§", "æ”¶å–è²»ç”¨"],
                  correct: 1
              },
              {
                  question: "ä»¥ä¸‹ä½•è€…ä¸å±¬æ–¼å€‹äººé˜²è­·è£å‚™ï¼ˆPPEï¼‰ï¼Ÿ",
                  options: ["å£ç½©", "æ‰‹å¥—", "è­·ç›®é¡", "æ‰‹æ©Ÿ"],
                  correct: 3
              },
              {
                  question: "ç™¼ç¾å¯ç–‘æ—…å®¢æ™‚ï¼Œæ‡‰è©²å¦‚ä½•è™•ç†ï¼Ÿ",
                  options: ["ç›´æ¥æ”¾è¡Œ", "ç«‹å³é€šå ±ä¸»ç®¡", "è‡ªè¡Œè™•ç†", "è«‹ä»–é›¢é–‹"],
                  correct: 1
              },
              {
                  question: "æª¢ç–«ç«™çš„å·¥ä½œæ™‚é–“æ˜¯ï¼Ÿ",
                  options: ["æ—©ä¸Š8é»åˆ°ä¸‹åˆ5é»", "24å°æ™‚è¼ªç­åˆ¶", "ä¾èˆªç­æ™‚é–“èª¿æ•´", "å›ºå®šä¸‹åˆç­"],
                  correct: 2
              },
              {
                  question: "ä»¥ä¸‹ä½•è€…æ˜¯æ­£ç¢ºçš„æ¶ˆæ¯’ç¨‹åºï¼Ÿ",
                  options: ["åªéœ€è¦å™´ç‘æ¶ˆæ¯’æ°´", "ä¾æ¨™æº–ä½œæ¥­ç¨‹åºåŸ·è¡Œ", "çœ‹å¿ƒæƒ…æ±ºå®š", "ä¸éœ€è¦æ¶ˆæ¯’"],
                  correct: 1
              },
              {
                  question: "æª¢ç–«äººå“¡æ‡‰è©²å¤šä¹…æ›´æ›ä¸€æ¬¡æ‰‹å¥—ï¼Ÿ",
                  options: ["ä¸€å¤©ä¸€æ¬¡", "æ¥è§¸ä¸åŒæ—…å®¢å¾Œ", "çœ‹å¿ƒæƒ…", "ä¸ç”¨æ›´æ›"],
                  correct: 1
              },
              {
                  question: "ä»¥ä¸‹ä½•è€…ä¸æ˜¯æœ‰æ•ˆçš„é˜²ç–«æªæ–½ï¼Ÿ",
                  options: ["æˆ´å£ç½©", "å‹¤æ´—æ‰‹", "ä¿æŒç¤¾äº¤è·é›¢", "å…±ç”¨å€‹äººç‰©å“"],
                  correct: 3
              },
              {
                  question: "ç™¼ç¾æ—…å®¢æ”œå¸¶é•ç¦å“æ™‚ï¼Œæ‡‰è©²ï¼Ÿ",
                  options: ["è¦–è€Œä¸è¦‹", "ç«‹å³é€šå ±", "ç§ä¸‹è™•ç†", "è«‹æ—…å®¢è‡ªè¡Œè™•ç†"],
                  correct: 1
              }
          ],
          "è‹±æ–‡åŸºæœ¬é£Ÿç‰©é¡å–®å­—è€ƒè©¦": [
              {
                  question: "è˜‹æœçš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["apple", "april", "ample", "ankle"],
                  correct: 0
              },
              {
                  question: "é¦™è•‰çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["balance", "banana", "bandana", "bamboo"],
                  correct: 1
              },
              {
                  question: "æ©˜å­çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["organ", "orange", "origin", "orchid"],
                  correct: 1
              },
              {
                  question: "éºµåŒ…çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["break", "bread", "breed", "broad"],
                  correct: 1
              },
              {
                  question: "ç‰›å¥¶çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["milk", "mile", "mild", "mill"],
                  correct: 0
              },
              {
                  question: "æ°´çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["world", "word", "water", "worth"],
                  correct: 2
              },
              {
                  question: "é­šçš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["dish", "fish", "wish", "flash"],
                  correct: 1
              },
              {
                  question: "é›è‚‰çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["chicken", "kitchen", "children", "channel"],
                  correct: 0
              },
              {
                  question: "ç±³é£¯çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["rise", "rice", "race", "rich"],
                  correct: 1
              },
              {
                  question: "è›‹çš„è‹±æ–‡æ˜¯ï¼Ÿ",
                  options: ["egg", "edge", "age", "eagle"],
                  correct: 0
              }
          ],
          "å‰å°è¤‡æŸ¥æŒ‘æˆ°": [
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®1ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 0
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®2ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 1
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®3ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 2
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®4ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 3
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®5ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 0
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®6ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 1
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®7ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 2
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®8ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 3
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®9ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 0
              },
              {
                  question: "å‰å°è¤‡æŸ¥é¡Œç›®10ï¼šè«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"],
                  correct: 1
              }
          ],
          "è¦å®šæŒ‘æˆ°": [
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®1ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 2
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®2ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 3
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®3ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 0
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®4ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 1
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®5ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 2
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®6ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 3
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®7ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 0
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®8ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 1
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®9ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 2
              },
              {
                  question: "è¦å®šæŒ‘æˆ°é¡Œç›®10ï¼šé¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼Ÿ",
                  options: ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"],
                  correct: 3
              }
          ],
          "åˆéšæ•¸ç¨æŒ‘æˆ°": Array(5).fill().map(() => ({
              type: 'sudoku',
              puzzle: null,
              solution: null
          }))
      };

      // è€ƒè©¦é…ç½®
      const examConfigs = {
          'basic': {
              name: 'åˆ†æµè€ƒè©¦æŒ‘æˆ°',
              timePerQuestion: 10,
              questionCount: 10,
              fastAnswerThreshold: 5,
              questions: examCategories['åˆ†æµè€ƒè©¦æŒ‘æˆ°']
          },
          'food': {
              name: 'é£Ÿç‰©è‹±æ–‡å–®å­—è€ƒè©¦',
              timePerQuestion: 5,
              questionCount: 10,
              fastAnswerThreshold: 2.5,
              questions: examCategories['è‹±æ–‡åŸºæœ¬é£Ÿç‰©é¡å–®å­—è€ƒè©¦']
          },
          'sudoku': {
              name: 'åˆéšæ•¸ç¨æŒ‘æˆ°',
              timePerQuestion: 60,
              questionCount: 5,
            fastAnswerThreshold: 30,
            questions: examCategories['åˆéšæ•¸ç¨æŒ‘æˆ°']
        },
        'precheck': {
            name: 'å‰å°è¤‡æŸ¥æŒ‘æˆ°',
            timePerQuestion: 15,
            questionCount: 10,
            fastAnswerThreshold: 7.5,
            questions: examCategories['å‰å°è¤‡æŸ¥æŒ‘æˆ°']
        },
        'rule': {
            name: 'è¦å®šæŒ‘æˆ°',
            timePerQuestion: 15,
            questionCount: 10,
            fastAnswerThreshold: 7.5,
            questions: examCategories['è¦å®šæŒ‘æˆ°']
        }
    };

    // æ•¸ç¨ç›¸é—œå‡½æ•¸
    function generateSudoku() {
        const solution = Array(4).fill().map(() => Array(4).fill(0));
        const numbers = [1, 2, 3, 4];
        
        // å¡«å……ç¬¬ä¸€è¡Œ
        shuffleArray([...numbers]).forEach((num, i) => {
            solution[0][i] = num;
        });
        
        // å¡«å……å…¶é¤˜è¡Œ
        for (let row = 1; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const possibleNumbers = [...numbers];
                // ç§»é™¤åŒè¡Œå’ŒåŒåˆ—å·²ä½¿ç”¨çš„æ•¸å­—
                for (let i = 0; i < 4; i++) {
                    const usedInRow = solution[row][i];
                    const usedInCol = solution[i][col];
                    possibleNumbers.remove(usedInRow);
                    possibleNumbers.remove(usedInCol);
                }
                // ç§»é™¤2x2æ–¹å¡Šå…§å·²ä½¿ç”¨çš„æ•¸å­—
                const blockRow = Math.floor(row / 2) * 2;
                const blockCol = Math.floor(col / 2) * 2;
                for (let i = blockRow; i < blockRow + 2; i++) {
                    for (let j = blockCol; j < blockCol + 2; j++) {
                        if (i < row || (i === row && j < col)) {
                            possibleNumbers.remove(solution[i][j]);
                        }
                    }
                }
                // å¦‚æœæ²’æœ‰å¯ç”¨æ•¸å­—ï¼Œè¿”å›nullä»¥é‡æ–°ç”Ÿæˆ
                if (possibleNumbers.length === 0) return null;
                // éš¨æ©Ÿé¸æ“‡ä¸€å€‹å¯ç”¨æ•¸å­—
                solution[row][col] = possibleNumbers[Math.floor(Math.random() * possibleNumbers.length)];
            }
        }
        return solution;
    }

    function createSudokuPuzzle(solution) {
        const puzzle = solution.map(row => [...row]);
        const cellsToRemove = 8; // ç§»é™¤8å€‹æ•¸å­—ï¼Œç•™ä¸‹8å€‹æ•¸å­—ä½œç‚ºæç¤º
        let removed = 0;
        
        while (removed < cellsToRemove) {
            const row = Math.floor(Math.random() * 4);
            const col = Math.floor(Math.random() * 4);
            if (puzzle[row][col] !== 0) {
                puzzle[row][col] = 0;
                removed++;
            }
        }
        
        return puzzle;
    }

    function generateSudokuQuestion() {
        let solution = null;
        while (!solution) {
            solution = generateSudoku();
        }
        const puzzle = createSudokuPuzzle(solution);
        return {
            puzzle,
            solution,
            userAnswer: puzzle.map(row => [...row])
        };
    }

    function checkSudokuAnswer(userAnswer, solution) {
        return userAnswer.every((row, i) => 
            row.every((num, j) => num === solution[i][j])
        );
    }

    function validateSudokuInput(cell) {
        const value = parseInt(cell.value);
        if (value < 1 || value > 4 || isNaN(value)) {
            cell.value = '';
        }
    }

    // é–‹å§‹è€ƒè©¦
    function startExam(type) {
        currentExam = examConfigs[type];
        userScores = {
            fastAnswers: 0,
            correctAnswers: 0
        };
        
        if (type === 'sudoku') {
            currentQuestions = Array(currentExam.questionCount).fill().map(() => ({
                type: 'sudoku',
                ...generateSudokuQuestion()
            }));
        } else {
            currentQuestions = shuffleArray([...currentExam.questions])
                .slice(0, currentExam.questionCount);
        }
        
        currentQuestionIndex = 0;
        createExamInterface();
        showQuestion();
    }

    // å‰µå»ºè€ƒè©¦ä»‹é¢
    function createExamInterface() {
        const examHtml = `
            <div id="examContainer" class="exam-container">
                <div class="exam-header">
                    <h2>${currentExam.name}</h2>
                    <div class="timer">å‰©é¤˜æ™‚é–“ï¼š<span id="timeLeft"></span></div>
                </div>
                <div id="questionContainer" class="question-container"></div>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="btn btn-danger" onclick="quitExam()">æ”¾æ£„è€ƒè©¦</button>
                </div>
            </div>
        `;
        
        document.querySelector('.container').innerHTML = examHtml;
    }

    // æ”¾æ£„è€ƒè©¦
    function quitExam() {
        clearInterval(examTimer);
        location.reload();
    }

    // é¡¯ç¤ºé¡Œç›®
    function showQuestion() {
        if (currentQuestionIndex >= currentQuestions.length) {
            finishExam();
            return;
        }
        
        const question = currentQuestions[currentQuestionIndex];
        
        if (question.type === 'sudoku') {
            const questionHtml = `
                <div class="question">
                    <h3>ç¬¬ ${currentQuestionIndex + 1} é¡Œ</h3>
                    <p>å¡«å…¥æ•¸å­—1-4ï¼Œä½¿æ¯è¡Œã€æ¯åˆ—å’Œæ¯å€‹2x2æ–¹æ ¼å…§çš„æ•¸å­—éƒ½ä¸é‡è¤‡</p>
                    <div class="sudoku-grid">
                        ${question.puzzle.map((row, i) => 
                            row.map((cell, j) => `
                                <input type="number" 
                                       class="sudoku-cell" 
                                       min="1" 
                                       max="4"
                                       value="${cell || ''}"
                                       ${cell ? 'disabled' : ''}
                                       data-row="${i}"
                                       data-col="${j}"
                                       oninput="validateSudokuInput(this)"
                                >
                            `).join('')
                        ).join('')}
                    </div>
                    <button class="btn btn-primary" onclick="submitSudokuAnswer()">æäº¤ç­”æ¡ˆ</button>
                </div>
            `;
            document.getElementById('questionContainer').innerHTML = questionHtml;
        } else {
            const questionHtml = `
                <div class="question">
                    <h3>ç¬¬ ${currentQuestionIndex + 1} é¡Œ</h3>
                    <p>${question.question}</p>
                    <div class="options">
                        ${question.options.map((option, index) => `
                            <button class="btn btn-primary option-btn" onclick="submitAnswer(${index})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('questionContainer').innerHTML = questionHtml;
        }
        
        startTimer();
        questionStartTime = Date.now();
    }

    // è¨ˆæ™‚å™¨
    function startTimer() {
        let timeLeft = currentExam.timePerQuestion;
        updateTimer(timeLeft);
        
        clearInterval(examTimer);
        examTimer = setInterval(() => {
            timeLeft--;
            updateTimer(timeLeft);
            
            if (timeLeft <= 0) {
                clearInterval(examTimer);
                if (currentQuestions[currentQuestionIndex].type === 'sudoku') {
                    submitSudokuAnswer();
                } else {
                    submitAnswer(-1);
                }
            }
        }, 1000);
    }

    // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
    function updateTimer(time) {
        document.getElementById('timeLeft').textContent = `${time}ç§’`;
    }

    // æäº¤æ•¸ç¨ç­”æ¡ˆ
    function submitSudokuAnswer() {
        clearInterval(examTimer);
        const question = currentQuestions[currentQuestionIndex];
        const cells = document.querySelectorAll('.sudoku-cell');
        const userAnswer = Array(4).fill().map(() => Array(4).fill(0));
        
        // é˜²æ­¢é‡è¤‡æäº¤
        const submitButton = document.querySelector('.btn.btn-primary');
        if (submitButton) submitButton.disabled = true;
        
        // æ”¶é›†ç”¨æˆ¶ç­”æ¡ˆ
        cells.forEach(cell => {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            userAnswer[row][col] = parseInt(cell.value) || 0;
        });
        
        // æª¢æŸ¥ç­”æ¡ˆæ˜¯å¦å®Œæ•´
        const hasEmptyCell = Array.from(cells).some(cell => 
            !cell.disabled && (!cell.value || cell.value.trim() === '')
        );
        
        // é©—è­‰ç­”æ¡ˆ
        const isCorrect = !hasEmptyCell && checkSudokuAnswer(userAnswer, question.solution);
        const timeTaken = (Date.now() - questionStartTime) / 1000;
        
        // è¨ˆåˆ†
        if (isCorrect) {
            userScores.correctAnswers++;
            if (timeTaken <= currentExam.fastAnswerThreshold) {
                userScores.fastAnswers++;
            }
        }
        
        // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
        cells.forEach(cell => {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            const correctValue = question.solution[row][col];
            const userValue = parseInt(cell.value) || 0;
            
            cell.disabled = true;
            if (!hasEmptyCell && userValue === correctValue) {
                cell.style.backgroundColor = 'var(--success)';
            } else {
                cell.style.backgroundColor = 'var(--danger)';
                cell.value = correctValue;
            }
        });
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    }

    // æäº¤é¸æ“‡é¡Œç­”æ¡ˆ
    function submitAnswer(selectedIndex) {
        clearInterval(examTimer);

        const question = currentQuestions[currentQuestionIndex];
        const correctIndex = question.correct;
        const timeTaken = (Date.now() - questionStartTime) / 1000;

        // è¨ˆåˆ†
        if (selectedIndex === correctIndex) {
            userScores.correctAnswers++;
            if (timeTaken <= currentExam.fastAnswerThreshold) {
                userScores.fastAnswers++;
            }
        }

        // é¡¯ç¤ºæŒ‰éˆ•ç‹€æ…‹
        const optionButtons = document.querySelectorAll('.option-btn');
        optionButtons.forEach((btn, idx) => {
            btn.disabled = true;
            if (idx === correctIndex) {
                btn.classList.add('correct');
            } else if (idx === selectedIndex) {
                btn.classList.add('wrong');
            }
        });

        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    }

    // å®Œæˆè€ƒè©¦
    function finishExam() {
        const baseScore = (userScores.correctAnswers / currentExam.questionCount) * 100;
        const bonusScore = userScores.fastAnswers;
        const totalScore = Math.min(baseScore + bonusScore, 110);
        
        const resultHtml = `
            <div class="exam-result">
                <h2>è€ƒè©¦å®Œæˆï¼</h2>
                <p>ç­”å°é¡Œæ•¸ï¼š${userScores.correctAnswers}/${currentExam.questionCount}</p>
                <p>å¿«é€Ÿç­”å°é¡Œæ•¸ï¼š${userScores.fastAnswers}</p>
                <p>ç¸½åˆ†ï¼š${totalScore.toFixed(1)}</p>
                <button class="btn btn-primary" onclick="updateLeaderboard('${currentExam.name}', ${totalScore})">
                    æŸ¥çœ‹æ’è¡Œæ¦œ
                </button>
                <button class="btn btn-secondary" onclick="location.reload()">
                    è¿”å›ä¸»é 
                </button>
            </div>
        `;
        
        document.getElementById('examContainer').innerHTML = resultHtml;
    }

    // æ›´æ–°æ’è¡Œæ¦œåˆ° Firebase
    async function updateLeaderboard(examName, score) {
        try {
            const userDisplayName = currentUser.welcome || currentUser._comment || currentUser.username;
            const scoreData = {
                name: userDisplayName,
                username: currentUser.username,
                score: parseFloat(score.toFixed(1)),
                timestamp: Date.now(),
                date: new Date().toISOString()
            };

            // å¯«å…¥ Firebase
            await database.ref(`leaderboards/${examName}/${currentUser.username}`).set(scoreData);
            
            // é¡¯ç¤ºæ’è¡Œæ¦œ
            const examType = Object.keys(examConfigs).find(key => examConfigs[key].name === examName);
            showLeaderboard(examType);
            
        } catch (error) {
            console.error('æ›´æ–°æ’è¡Œæ¦œå¤±æ•—:', error);
            alert('æ’è¡Œæ¦œæ›´æ–°å¤±æ•—ï¼Œä½†æˆç¸¾å·²è¨˜éŒ„');
            showLeaderboard(Object.keys(examConfigs).find(key => examConfigs[key].name === examName));
        }
    }

    // é¡¯ç¤ºæ’è¡Œæ¦œ
    async function showLeaderboard(type) {
        const modal = document.getElementById('leaderboardModal');
        const modalTitle = document.getElementById('modalTitle');
        const content = document.getElementById('leaderboardContent');
        
        const examName = examConfigs[type].name;
        modalTitle.textContent = examName + 'æ’è¡Œæ¦œ';

        try {
            // å¾ Firebase è®€å–æ’è¡Œæ¦œæ•¸æ“š
            const snapshot = await database.ref(`leaderboards/${examName}`).once('value');
            const data = snapshot.val() || {};
            
            // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
            const leaderboardData = Object.values(data)
                .sort((a, b) => b.score - a.score)
                .slice(0, 20); // åªé¡¯ç¤ºå‰20å

            if (leaderboardData.length === 0) {
                content.innerHTML = '<div class="empty-leaderboard">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“š</div>';
            } else {
                content.innerHTML = leaderboardData.map((item, index) => `
                    <div class="leaderboard-item ${item.username === currentUser.username ? 'current-user' : ''}">
                        <div class="rank">#${index + 1}</div>
                        <div class="user-name">${item.name}</div>
                        <div class="score">${item.score}åˆ†</div>
                    </div>
                `).join('');
            }

        } catch (error) {
            console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
            content.innerHTML = '<div class="empty-leaderboard">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</div>';
        }

        modal.style.display = 'flex';
    }

    // éš±è—æ’è¡Œæ¦œ
    function hideLeaderboard() {
        document.getElementById('leaderboardModal').style.display = 'none';
    }

    // è¿”å›T2æ—¥ç³»çµ±
    function backToT2() {
        window.location.href = 'page3.html';
    }

    // ç™»å‡º
    function logout() {
        localStorage.removeItem('t2_login');
        localStorage.removeItem('t2_login_time');
        localStorage.removeItem('t2_login_user');
        window.location.href = 'index3.html';
    }

    // å·¥å…·å‡½æ•¸ï¼šéš¨æ©Ÿæ‰“äº‚æ•¸çµ„
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // å®šæœŸæª¢æŸ¥ç”¨æˆ¶æœ‰æ•ˆæ€§
    function startUserValidationCheck() {
        setInterval(async () => {
            try {
                const response = await fetch('password.json');
                if (response.ok) {
                    const data = await response.json();
                    const users = Array.isArray(data) ? data : [data];
                    const currentUserExists = users.some(u => u.username === currentUser.username);
                    
                    if (!currentUserExists) {
                        forceLogout('æ‚¨çš„å¸³è™Ÿå·²è¢«ç³»çµ±ç§»é™¤ï¼Œè«‹é‡æ–°ç™»å…¥');
                    }
                }
            } catch (error) {
                console.warn('ç”¨æˆ¶é©—è­‰æª¢æŸ¥å¤±æ•—:', error);
            }
        }, 300000); // æ¯5åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
    }

    // é»æ“Šå½ˆå‡ºè¦–çª—å¤–éƒ¨æ™‚é—œé–‰
    document.getElementById('leaderboardModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideLeaderboard();
        }
    });

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener('load', async () => {
        await initializePage();
        if (currentUser) {
            startUserValidationCheck();
        }
    });

</script>
</body>
</html>
