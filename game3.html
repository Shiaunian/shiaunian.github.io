<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T2Êó•Ê™¢Áñ´ÊåëÊà∞Á≥ªÁµ±</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <style>
      :root {
          --bg-primary: #1a1b1e;
          --bg-secondary: #2d2d30;
          --primary: #7289da;
          --primary-dark: #5c6fb1;
          --text-primary: #ffffff;
          --text-secondary: #a0a0a0;
          --danger: #ef4444;
          --warning: #f59e0b;
          --success: #22c55e;
          --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
          --border-color: rgba(255, 255, 255, 0.1);
          --info: #3b82f6;
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: "ÂæÆËªüÊ≠£ÈªëÈ´î", Arial, sans-serif;
          background: var(--bg-primary);
          min-height: 100vh;
          padding: 12px;
          color: var(--text-primary);
      }

      .container {
          max-width: 480px;
          margin: 0 auto;
          height: calc(100vh - 24px);
          overflow-y: auto;
          background: var(--bg-secondary);
          border-radius: 12px;
          box-shadow: var(--shadow);
      }

      .header {
          background: var(--bg-secondary);
          padding: 15px;
          border-bottom: 1px solid var(--border-color);
          position: sticky;
          top: 0;
          z-index: 100;
      }

      .header-title {
          display: flex;
          flex-direction: column;
          margin-bottom: 10px;
      }

      .title-text {
          font-size: 1.3rem;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 8px;
          justify-content: space-between;
      }

      .user-info {
          font-size: 0.9rem;
          color: var(--text-secondary);
          margin-top: 5px;
      }

      .connection-status {
          background-color: var(--success);
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.8rem;
          margin-left: 8px;
      }

      .btn {
          padding: 8px 16px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 0.9rem;
          transition: all 0.3s ease;
          flex: 1;
      }

      .btn-primary {
          background: var(--primary);
          color: var(--text-primary);
      }

      .btn-primary:hover {
          background: var(--primary-dark);
      }

      .btn-secondary {
          background: var(--warning);
          color: var(--text-primary);
      }

      .btn-danger {
          background: var(--danger);
          color: var(--text-primary);
      }

      .challenge-item {
          padding: 15px;
          border-bottom: 1px solid var(--border-color);
      }

      .challenge-title {
          font-size: 1.1rem;
          color: var(--text-primary);
          margin-bottom: 8px;
      }

      .challenge-info {
          color: var(--text-secondary);
          font-size: 0.9rem;
          margin-bottom: 12px;
      }

      .challenge-actions {
          display: flex;
          gap: 8px;
      }

      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 1000;
      }

      .modal {
          background: var(--bg-secondary);
          width: 90%;
          max-width: 400px;
          max-height: 80vh;
          border-radius: 12px;
          overflow: hidden;
          position: relative;
      }

      .modal-header {
          padding: 15px;
          background: var(--primary);
          color: var(--text-primary);
          display: flex;
          justify-content: space-between;
          align-items: center;
          position: sticky;
          top: 0;
      }

      .close-btn {
          background: none;
          border: none;
          color: var(--text-primary);
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0 8px;
      }

      .modal-content {
          padding: 15px;
          overflow-y: auto;
          max-height: calc(80vh - 56px);
      }

      .leaderboard-item {
          display: flex;
          align-items: center;
          padding: 8px 12px;
          border-bottom: 1px solid var(--border-color);
          transition: background-color 0.3s;
      }

      .leaderboard-item.current-user {
          background: rgba(114, 137, 218, 0.1);
          border-left: 3px solid var(--primary);
      }

      .rank {
          min-width: 30px;
          font-weight: bold;
          color: var(--primary);
      }

      .user-name {
          flex: 1;
          margin: 0 10px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .score {
          font-weight: bold;
          color: var(--primary);
          margin-left: auto;
      }

      .empty-leaderboard {
          text-align: center;
          padding: 20px;
          color: var(--text-secondary);
      }

      .exam-container {
          padding: 20px;
      }

      .exam-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .timer {
          font-size: 1.2rem;
          color: var(--primary);
      }

      .question {
          background: var(--bg-secondary);
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
      }

      .options {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          margin-top: 20px;
      }

      .option-btn {
          width: 100%;
          text-align: left;
          padding: 12px;
      }

      .option-btn.correct {
          background: var(--success);
      }

      .option-btn.wrong {
          background: var(--danger);
      }

      .exam-result {
          text-align: center;
          padding: 20px;
      }

      .exam-result h2 {
          margin-bottom: 20px;
      }

      .exam-result p {
          margin-bottom: 10px;
      }

      .exam-result button {
          margin: 10px;
      }

      ::-webkit-scrollbar {
          width: 8px;
      }

      ::-webkit-scrollbar-track {
          background: var(--bg-primary);
      }

      ::-webkit-scrollbar-thumb {
          background: var(--primary);
          border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
          background: var(--primary-dark);
      }

      .sudoku-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 4px;
          background: var(--border-color);
          padding: 4px;
          border-radius: 8px;
          margin-bottom: 20px;
      }

      .sudoku-cell {
          width: 100%;
          aspect-ratio: 1;
          background: var(--bg-primary);
          border: none;
          border-radius: 4px;
          color: var(--text-primary);
          font-size: 1.5rem;
          text-align: center;
          cursor: pointer;
      }

      .sudoku-cell:disabled {
          background: var(--bg-secondary);
          color: var(--text-secondary);
          cursor: not-allowed;
      }

      .sudoku-cell:focus {
          outline: 2px solid var(--primary);
      }

      .sudoku-cell::-webkit-inner-spin-button,
      .sudoku-cell::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
      }

      .loading {
          text-align: center;
          padding: 40px 20px;
          color: var(--text-secondary);
      }

      .loading-spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid var(--primary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-right: 10px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
  </style>
</head>
<body>
  <!-- ËºâÂÖ•‰∏≠Áï´Èù¢ -->
  <div id="loadingScreen" class="container">
      <div class="loading">
          <div class="loading-spinner"></div>
          Ê≠£Âú®È©óË≠âÁôªÂÖ•ÁãÄÊÖã...
      </div>
  </div>

  <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
  <div id="mainContent" class="container" style="display: none;">
      <header class="header">
          <div class="header-title">
              <div class="title-text">
                  <span>üéØ</span>
                  <h1>T2Êó•Ê™¢Áñ´ÊåëÊà∞Á≥ªÁµ±</h1>
                  <button class="btn btn-danger" onclick="logout()">ÁôªÂá∫</button>
              </div>
              <div class="user-info">
                  <span id="currentUserWelcome">Ê≠°ËøéÂõû‰æÜÔºåËºâÂÖ•‰∏≠...</span>
                  <span class="connection-status" id="connectionStatus">Áî®Êà∂ÈÄ£Á∑ö‰∏≠</span>
              </div>
          </div>
          <div class="header-actions">
              <button class="btn btn-primary" onclick="backToT2()">ËøîÂõûT2Êó•</button>
          </div>
      </header>

      <div class="challenge-item">
          <h3 class="challenge-title">ÂàÜÊµÅËÄÉË©¶ÊåëÊà∞</h3>
          <p class="challenge-info" style="color:#ef4444;">ÊØèÈ°å10Áßí‰ΩúÁ≠îÊôÇÈñìÔºåÂÖ±10È°å</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('basic')">ËÄÉË©¶</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('basic')">ÊéíË°åÊ¶ú</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">È£üÁâ©Ëã±ÊñáÂñÆÂ≠óËÄÉË©¶</h3>
          <p class="challenge-info" style="color:#ef4444;">ÊØèÈ°å5Áßí‰ΩúÁ≠îÊôÇÈñìÔºåÂÖ±10È°å</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('food')">ËÄÉË©¶</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('food')">ÊéíË°åÊ¶ú</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">ÂâçÂ∞éË§áÊü•ÊåëÊà∞</h3>
          <p class="challenge-info" style="color:#ef4444;">ÊØèÈ°å15Áßí‰ΩúÁ≠îÊôÇÈñìÔºåÂÖ±10È°å</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('precheck')">ËÄÉË©¶</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('precheck')">ÊéíË°åÊ¶ú</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">Ë¶èÂÆöÊåëÊà∞</h3>
          <p class="challenge-info" style="color:#ef4444;">ÊØèÈ°å15Áßí‰ΩúÁ≠îÊôÇÈñìÔºåÂÖ±10È°å</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('rule')">ËÄÉË©¶</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('rule')">ÊéíË°åÊ¶ú</button>
          </div>
      </div>

      <div class="challenge-item">
          <h3 class="challenge-title">ÂàùÈöéÊï∏Áç®ÊåëÊà∞</h3>
          <p class="challenge-info" style="color:#ef4444;">ÊØèÈ°å60Áßí‰ΩúÁ≠îÊôÇÈñìÔºåÂÖ±5È°å</p>
          <div class="challenge-actions">
              <button class="btn btn-primary" onclick="startExam('sudoku')">ËÄÉË©¶</button>
              <button class="btn btn-secondary" onclick="showLeaderboard('sudoku')">ÊéíË°åÊ¶ú</button>
          </div>
      </div>
  </div>

  <!-- ÊéíË°åÊ¶úÊ®°ÊÖãË¶ñÁ™ó -->
  <div class="modal-overlay" id="leaderboardModal">
      <div class="modal">
          <div class="modal-header">
              <h2 id="modalTitle">ÊéíË°åÊ¶ú</h2>
              <button class="close-btn" onclick="hideLeaderboard()">√ó</button>
          </div>
          <div class="modal-content" id="leaderboardContent">
          </div>
      </div>
  </div>

  <script>
      // Firebase ÈÖçÁΩÆ
      const firebaseConfig = {
          apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
          authDomain: "openexammodal.firebaseapp.com",
          databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
          projectId: "openexammodal",
          storageBucket: "openexammodal.firebasestorage.app",
          messagingSenderId: "336901617556",
          appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
      };

      // ÂàùÂßãÂåñ Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // ÂÖ®ÂüüËÆäÊï∏
      let currentUser = null;
      let usersData = [];
      let currentExam = null;
      let currentQuestions = [];
      let currentQuestionIndex = 0;
      let examTimer = null;
      let questionStartTime = null;
      let userScores = {
          fastAnswers: 0,
          correctAnswers: 0
      };

      // Â∑•ÂÖ∑ÂáΩÊï∏ÔºöÂæûÊï∏ÁµÑ‰∏≠ÁßªÈô§ÁâπÂÆöÂÖÉÁ¥†
      Array.prototype.remove = function(element) {
          const index = this.indexOf(element);
          if (index > -1) {
              this.splice(index, 1);
          }
      };

      // Âº∑Âà∂ÁôªÂá∫ÂáΩÊï∏
      function forceLogout(message = 'ÁôªÂÖ•È©óË≠âÂ§±ÊïóÔºåË´ãÈáçÊñ∞ÁôªÂÖ•') {
          localStorage.removeItem('t2_login');
          localStorage.removeItem('t2_login_time');
          localStorage.removeItem('t2_login_user');
          alert(message);
          window.location.href = 'index3.html';
      }

      // Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖãÂíåÊôÇÊïà
      function checkLoginStatus() {
          const loginFlag = localStorage.getItem('t2_login');
          const loginTime = localStorage.getItem('t2_login_time');
          const loginUser = localStorage.getItem('t2_login_user');

          if (loginFlag !== 'yes' || !loginTime || !loginUser) {
              forceLogout('Êú™Ê™¢Ê∏¨Âà∞ÊúâÊïàÁôªÂÖ•ÁãÄÊÖã');
              return false;
          }

          // Ê™¢Êü•ÁôªÂÖ•ÊôÇÊïà (1Â∞èÊôÇ)
          const now = Date.now();
          const loginTimeStamp = parseInt(loginTime);
          const LIMIT = 3600000; // 1Â∞èÊôÇ

          if (now - loginTimeStamp > LIMIT) {
              forceLogout('ÁôªÂÖ•ÊôÇÈñìÂ∑≤Ë∂ÖÈÅé1Â∞èÊôÇÔºåË´ãÈáçÊñ∞ÁôªÂÖ•');
              return false;
          }

          return loginUser;
      }

      // ËºâÂÖ•Áî®Êà∂Ë≥áÊñôÂ∫´
      async function loadUsersData() {
          try {
              const response = await fetch('password.json');
              if (!response.ok) {
                  throw new Error('ÁÑ°Ê≥ïËºâÂÖ•Áî®Êà∂Ë≥áÊñôÂ∫´');
              }
              const data = await response.json();
              usersData = Array.isArray(data) ? data : [data];
              return true;
          } catch (error) {
              console.error('ËºâÂÖ•Áî®Êà∂Ë≥áÊñôÂ∫´Â§±Êïó:', error);
              forceLogout('Á≥ªÁµ±ÈåØË™§ÔºöÁÑ°Ê≥ïËºâÂÖ•Áî®Êà∂Ë≥áÊñôÂ∫´');
              return false;
          }
      }

      // È©óË≠âÁî®Êà∂ÊòØÂê¶Â≠òÂú®ÊñºË≥áÊñôÂ∫´‰∏≠
      function validateUser(username) {
          const user = usersData.find(u => u.username === username);
          if (!user) {
              forceLogout('Áî®Êà∂Â∏≥Ëôü‰∏çÂ≠òÂú®ÊñºÁ≥ªÁµ±‰∏≠');
              return null;
          }
          return user;
      }

      // È°ØÁ§∫Áî®Êà∂Ê≠°ËøéË®äÊÅØ
      function showWelcomeMessage(user) {
          const welcomeElement = document.getElementById('currentUserWelcome');
          const displayName = user.welcome || user._comment || user.username;
          welcomeElement.textContent = displayName;
      }

      // ‰∏ªË¶ÅÂàùÂßãÂåñÂáΩÊï∏
      async function initializePage() {
          try {
              // 1. Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
              const loginUser = checkLoginStatus();
              if (!loginUser) {
                  return;
              }

              // 2. ËºâÂÖ•Áî®Êà∂Ë≥áÊñôÂ∫´
              const loadSuccess = await loadUsersData();
              if (!loadSuccess) {
                  return;
              }

              // 3. È©óË≠âÁî®Êà∂ÊòØÂê¶Â≠òÂú®ÊñºË≥áÊñôÂ∫´‰∏≠
              const user = validateUser(loginUser);
              if (!user) {
                  return;
              }

              // 4. Ë®≠ÂÆöÁï∂ÂâçÁî®Êà∂
              currentUser = user;

              // 5. È°ØÁ§∫Ê≠°ËøéË®äÊÅØ
              showWelcomeMessage(user);

              // 6. È°ØÁ§∫‰∏ªË¶ÅÂÖßÂÆπ
              document.getElementById('loadingScreen').style.display = 'none';
              document.getElementById('mainContent').style.display = 'block';

          } catch (error) {
              console.error('È†ÅÈù¢ÂàùÂßãÂåñÂ§±Êïó:', error);
              forceLogout('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞ÁôªÂÖ•');
          }
      }

      // ËÄÉË©¶È°åÂ∫´
      const examCategories = {
          "ÂàÜÊµÅËÄÉË©¶ÊåëÊà∞": [
              {
                  question: "‰ª•‰∏ãÂì™Á®ÆÁâ©ÂìÅÈúÄË¶ÅÈÅéXÂÖâÊ©üÊ™¢Êü•Ôºü",
                  options: ["ÊâãÊ©ü", "Â§ßÂåÖÂåÖ", "Ë≠∑ÁÖß", "Â∏ΩÂ≠ê"],
                  correct: 1
              },
              {
                  question: "ÊóÖÂÆ¢ÊîúÂ∏∂ÊãçÁ´ãÂæóÁõ∏Ê©üÊôÇÔºåÂâçÂ∞é‰∫∫Âì°ÊáâË©≤Ë©¢Âïè‰ªÄÈ∫ºÔºü",
                  options: ["Áõ∏Ê©üÂìÅÁâå", "Áõ∏Ê©üÂÉπÊ†º", "Â∫ïÁâáÊòØÂê¶Â∑≤ÂèñÂá∫", "Ë≥ºË≤∑Âú∞Èªû"],
                  correct: 2
              },
              {
                  question: "Ê™¢Áñ´Á´ôÁöÑ‰∏ªË¶Å‰ªªÂãôÊòØ‰ªÄÈ∫ºÔºü",
                  options: ["Ê™¢Êü•Ë°åÊùé", "Èò≤Ê≠¢Áñ´ÊÉÖÂÇ≥Êí≠", "Êü•È©óË≠∑ÁÖß", "Êî∂ÂèñË≤ªÁî®"],
                  correct: 1
              },
              {
                  question: "‰ª•‰∏ã‰ΩïËÄÖ‰∏çÂ±¨ÊñºÂÄã‰∫∫Èò≤Ë≠∑Ë£ùÂÇôÔºàPPEÔºâÔºü",
                  options: ["Âè£ÁΩ©", "ÊâãÂ•ó", "Ë≠∑ÁõÆÈè°", "ÊâãÊ©ü"],
                  correct: 3
              },
              {
                  question: "ÁôºÁèæÂèØÁñëÊóÖÂÆ¢ÊôÇÔºåÊáâË©≤Â¶Ç‰ΩïËôïÁêÜÔºü",
                  options: ["Áõ¥Êé•ÊîæË°å", "Á´ãÂç≥ÈÄöÂ†±‰∏ªÁÆ°", "Ëá™Ë°åËôïÁêÜ", "Ë´ã‰ªñÈõ¢Èñã"],
                  correct: 1
              },
              {
                  question: "Ê™¢Áñ´Á´ôÁöÑÂ∑•‰ΩúÊôÇÈñìÊòØÔºü",
                  options: ["Êó©‰∏ä8ÈªûÂà∞‰∏ãÂçà5Èªû", "24Â∞èÊôÇËº™Áè≠Âà∂", "‰æùËà™Áè≠ÊôÇÈñìË™øÊï¥", "Âõ∫ÂÆö‰∏ãÂçàÁè≠"],
                  correct: 2
              },
              {
                  question: "‰ª•‰∏ã‰ΩïËÄÖÊòØÊ≠£Á¢∫ÁöÑÊ∂àÊØíÁ®ãÂ∫èÔºü",
                  options: ["Âè™ÈúÄË¶ÅÂô¥ÁÅëÊ∂àÊØíÊ∞¥", "‰æùÊ®ôÊ∫ñ‰ΩúÊ•≠Á®ãÂ∫èÂü∑Ë°å", "ÁúãÂøÉÊÉÖÊ±∫ÂÆö", "‰∏çÈúÄË¶ÅÊ∂àÊØí"],
                  correct: 1
              },
              {
                  question: "Ê™¢Áñ´‰∫∫Âì°ÊáâË©≤Â§ö‰πÖÊõ¥Êèõ‰∏ÄÊ¨°ÊâãÂ•óÔºü",
                  options: ["‰∏ÄÂ§©‰∏ÄÊ¨°", "Êé•Ëß∏‰∏çÂêåÊóÖÂÆ¢Âæå", "ÁúãÂøÉÊÉÖ", "‰∏çÁî®Êõ¥Êèõ"],
                  correct: 1
              },
              {
                  question: "‰ª•‰∏ã‰ΩïËÄÖ‰∏çÊòØÊúâÊïàÁöÑÈò≤Áñ´Êé™ÊñΩÔºü",
                  options: ["Êà¥Âè£ÁΩ©", "Âã§Ê¥óÊâã", "‰øùÊåÅÁ§æ‰∫§Ë∑ùÈõ¢", "ÂÖ±Áî®ÂÄã‰∫∫Áâ©ÂìÅ"],
                  correct: 3
              },
              {
                  question: "ÁôºÁèæÊóÖÂÆ¢ÊîúÂ∏∂ÈÅïÁ¶ÅÂìÅÊôÇÔºåÊáâË©≤Ôºü",
                  options: ["Ë¶ñËÄå‰∏çË¶ã", "Á´ãÂç≥ÈÄöÂ†±", "ÁßÅ‰∏ãËôïÁêÜ", "Ë´ãÊóÖÂÆ¢Ëá™Ë°åËôïÁêÜ"],
                  correct: 1
              }
          ],
          "Ëã±ÊñáÂü∫Êú¨È£üÁâ©È°ûÂñÆÂ≠óËÄÉË©¶": [
              {
                  question: "ËòãÊûúÁöÑËã±ÊñáÊòØÔºü",
                  options: ["apple", "april", "ample", "ankle"],
                  correct: 0
              },
              {
                  question: "È¶ôËïâÁöÑËã±ÊñáÊòØÔºü",
                  options: ["balance", "banana", "bandana", "bamboo"],
                  correct: 1
              },
              {
                  question: "Ê©òÂ≠êÁöÑËã±ÊñáÊòØÔºü",
                  options: ["organ", "orange", "origin", "orchid"],
                  correct: 1
              },
              {
                  question: "È∫µÂåÖÁöÑËã±ÊñáÊòØÔºü",
                  options: ["break", "bread", "breed", "broad"],
                  correct: 1
              },
              {
                  question: "ÁâõÂ•∂ÁöÑËã±ÊñáÊòØÔºü",
                  options: ["milk", "mile", "mild", "mill"],
                  correct: 0
              },
              {
                  question: "Ê∞¥ÁöÑËã±ÊñáÊòØÔºü",
                  options: ["world", "word", "water", "worth"],
                  correct: 2
              },
              {
                  question: "È≠öÁöÑËã±ÊñáÊòØÔºü",
                  options: ["dish", "fish", "wish", "flash"],
                  correct: 1
              },
              {
                  question: "ÈõûËÇâÁöÑËã±ÊñáÊòØÔºü",
                  options: ["chicken", "kitchen", "children", "channel"],
                  correct: 0
              },
              {
                  question: "Á±≥È£ØÁöÑËã±ÊñáÊòØÔºü",
                  options: ["rise", "rice", "race", "rich"],
                  correct: 1
              },
              {
                  question: "ËõãÁöÑËã±ÊñáÊòØÔºü",
                  options: ["egg", "edge", "age", "eagle"],
                  correct: 0
              }
          ],
          "ÂâçÂ∞éË§áÊü•ÊåëÊà∞": [
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ1ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 0
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ2ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 1
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ3ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 2
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ4ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 3
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ5ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 0
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ6ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 1
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ7ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 2
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ8ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 3
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ9ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 0
              },
              {
                  question: "ÂâçÂ∞éË§áÊü•È°åÁõÆ10ÔºöË´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                  correct: 1
              }
          ],
          "Ë¶èÂÆöÊåëÊà∞": [
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ1ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 2
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ2ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 3
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ3ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 0
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ4ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 1
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ5ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 2
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ6ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 3
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ7ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 0
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ8ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 1
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ9ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 2
              },
              {
                  question: "Ë¶èÂÆöÊåëÊà∞È°åÁõÆ10ÔºöÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°àÔºü",
                  options: ["ÈÅ∏È†Ö1", "ÈÅ∏È†Ö2", "ÈÅ∏È†Ö3", "ÈÅ∏È†Ö4"],
                  correct: 3
              }
          ],
          "ÂàùÈöéÊï∏Áç®ÊåëÊà∞": Array(5).fill().map(() => ({
              type: 'sudoku',
              puzzle: null,
              solution: null
          }))
      };

      // ËÄÉË©¶ÈÖçÁΩÆ
      const examConfigs = {
          'basic': {
              name: 'ÂàÜÊµÅËÄÉË©¶ÊåëÊà∞',
              timePerQuestion: 10,
              questionCount: 10,
              fastAnswerThreshold: 5,
              questions: examCategories['ÂàÜÊµÅËÄÉË©¶ÊåëÊà∞']
          },
          'food': {
              name: 'È£üÁâ©Ëã±ÊñáÂñÆÂ≠óËÄÉË©¶',
              timePerQuestion: 5,
              questionCount: 10,
              fastAnswerThreshold: 2.5,
              questions: examCategories['Ëã±ÊñáÂü∫Êú¨È£üÁâ©È°ûÂñÆÂ≠óËÄÉË©¶']
          },
          'sudoku': {
              name: 'ÂàùÈöéÊï∏Áç®ÊåëÊà∞',
              timePerQuestion: 60,
              questionCount: 5,
            fastAnswerThreshold: 30,
            questions: examCategories['ÂàùÈöéÊï∏Áç®ÊåëÊà∞']
        },
        'precheck': {
            name: 'ÂâçÂ∞éË§áÊü•ÊåëÊà∞',
            timePerQuestion: 15,
            questionCount: 10,
            fastAnswerThreshold: 7.5,
            questions: examCategories['ÂâçÂ∞éË§áÊü•ÊåëÊà∞']
        },
        'rule': {
            name: 'Ë¶èÂÆöÊåëÊà∞',
            timePerQuestion: 15,
            questionCount: 10,
            fastAnswerThreshold: 7.5,
            questions: examCategories['Ë¶èÂÆöÊåëÊà∞']
        }
    };

    // Êï∏Áç®Áõ∏ÈóúÂáΩÊï∏
    function generateSudoku() {
        const solution = Array(4).fill().map(() => Array(4).fill(0));
        const numbers = [1, 2, 3, 4];
        
        // Â°´ÂÖÖÁ¨¨‰∏ÄË°å
        shuffleArray([...numbers]).forEach((num, i) => {
            solution[0][i] = num;
        });
        
        // Â°´ÂÖÖÂÖ∂È§òË°å
        for (let row = 1; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                const possibleNumbers = [...numbers];
                // ÁßªÈô§ÂêåË°åÂíåÂêåÂàóÂ∑≤‰ΩøÁî®ÁöÑÊï∏Â≠ó
                for (let i = 0; i < 4; i++) {
                    const usedInRow = solution[row][i];
                    const usedInCol = solution[i][col];
                    possibleNumbers.remove(usedInRow);
                    possibleNumbers.remove(usedInCol);
                }
                // ÁßªÈô§2x2ÊñπÂ°äÂÖßÂ∑≤‰ΩøÁî®ÁöÑÊï∏Â≠ó
                const blockRow = Math.floor(row / 2) * 2;
                const blockCol = Math.floor(col / 2) * 2;
                for (let i = blockRow; i < blockRow + 2; i++) {
                    for (let j = blockCol; j < blockCol + 2; j++) {
                        if (i < row || (i === row && j < col)) {
                            possibleNumbers.remove(solution[i][j]);
                        }
                    }
                }
                // Â¶ÇÊûúÊ≤íÊúâÂèØÁî®Êï∏Â≠óÔºåËøîÂõûnull‰ª•ÈáçÊñ∞ÁîüÊàê
                if (possibleNumbers.length === 0) return null;
                // Èö®Ê©üÈÅ∏Êìá‰∏ÄÂÄãÂèØÁî®Êï∏Â≠ó
                solution[row][col] = possibleNumbers[Math.floor(Math.random() * possibleNumbers.length)];
            }
        }
        return solution;
    }

    function createSudokuPuzzle(solution) {
        const puzzle = solution.map(row => [...row]);
        const cellsToRemove = 8; // ÁßªÈô§8ÂÄãÊï∏Â≠óÔºåÁïô‰∏ã8ÂÄãÊï∏Â≠ó‰ΩúÁÇ∫ÊèêÁ§∫
        let removed = 0;
        
        while (removed < cellsToRemove) {
            const row = Math.floor(Math.random() * 4);
            const col = Math.floor(Math.random() * 4);
            if (puzzle[row][col] !== 0) {
                puzzle[row][col] = 0;
                removed++;
            }
        }
        
        return puzzle;
    }

    function generateSudokuQuestion() {
        let solution = null;
        while (!solution) {
            solution = generateSudoku();
        }
        const puzzle = createSudokuPuzzle(solution);
        return {
            puzzle,
            solution,
            userAnswer: puzzle.map(row => [...row])
        };
    }

    function checkSudokuAnswer(userAnswer, solution) {
        return userAnswer.every((row, i) => 
            row.every((num, j) => num === solution[i][j])
        );
    }

    function validateSudokuInput(cell) {
        const value = parseInt(cell.value);
        if (value < 1 || value > 4 || isNaN(value)) {
            cell.value = '';
        }
    }

    // ÈñãÂßãËÄÉË©¶
    function startExam(type) {
        currentExam = examConfigs[type];
        userScores = {
            fastAnswers: 0,
            correctAnswers: 0
        };
        
        if (type === 'sudoku') {
            currentQuestions = Array(currentExam.questionCount).fill().map(() => ({
                type: 'sudoku',
                ...generateSudokuQuestion()
            }));
        } else {
            currentQuestions = shuffleArray([...currentExam.questions])
                .slice(0, currentExam.questionCount);
        }
        
        currentQuestionIndex = 0;
        createExamInterface();
        showQuestion();
    }

    // ÂâµÂª∫ËÄÉË©¶‰ªãÈù¢
    function createExamInterface() {
        const examHtml = `
            <div id="examContainer" class="exam-container">
                <div class="exam-header">
                    <h2>${currentExam.name}</h2>
                    <div class="timer">Ââ©È§òÊôÇÈñìÔºö<span id="timeLeft"></span></div>
                </div>
                <div id="questionContainer" class="question-container"></div>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="btn btn-danger" onclick="quitExam()">ÊîæÊ£ÑËÄÉË©¶</button>
                </div>
            </div>
        `;
        
        document.querySelector('.container').innerHTML = examHtml;
    }

    // ÊîæÊ£ÑËÄÉË©¶
    function quitExam() {
        clearInterval(examTimer);
        location.reload();
    }

    // È°ØÁ§∫È°åÁõÆ
    function showQuestion() {
        if (currentQuestionIndex >= currentQuestions.length) {
            finishExam();
            return;
        }
        
        const question = currentQuestions[currentQuestionIndex];
        
        if (question.type === 'sudoku') {
            const questionHtml = `
                <div class="question">
                    <h3>Á¨¨ ${currentQuestionIndex + 1} È°å</h3>
                    <p>Â°´ÂÖ•Êï∏Â≠ó1-4Ôºå‰ΩøÊØèË°å„ÄÅÊØèÂàóÂíåÊØèÂÄã2x2ÊñπÊ†ºÂÖßÁöÑÊï∏Â≠óÈÉΩ‰∏çÈáçË§á</p>
                    <div class="sudoku-grid">
                        ${question.puzzle.map((row, i) => 
                            row.map((cell, j) => `
                                <input type="number" 
                                       class="sudoku-cell" 
                                       min="1" 
                                       max="4"
                                       value="${cell || ''}"
                                       ${cell ? 'disabled' : ''}
                                       data-row="${i}"
                                       data-col="${j}"
                                       oninput="validateSudokuInput(this)"
                                >
                            `).join('')
                        ).join('')}
                    </div>
                    <button class="btn btn-primary" onclick="submitSudokuAnswer()">Êèê‰∫§Á≠îÊ°à</button>
                </div>
            `;
            document.getElementById('questionContainer').innerHTML = questionHtml;
        } else {
            const questionHtml = `
                <div class="question">
                    <h3>Á¨¨ ${currentQuestionIndex + 1} È°å</h3>
                    <p>${question.question}</p>
                    <div class="options">
                        ${question.options.map((option, index) => `
                            <button class="btn btn-primary option-btn" onclick="submitAnswer(${index})">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('questionContainer').innerHTML = questionHtml;
        }
        
        startTimer();
        questionStartTime = Date.now();
    }

    // Ë®àÊôÇÂô®
    function startTimer() {
        let timeLeft = currentExam.timePerQuestion;
        updateTimer(timeLeft);
        
        clearInterval(examTimer);
        examTimer = setInterval(() => {
            timeLeft--;
            updateTimer(timeLeft);
            
            if (timeLeft <= 0) {
                clearInterval(examTimer);
                if (currentQuestions[currentQuestionIndex].type === 'sudoku') {
                    submitSudokuAnswer();
                } else {
                    submitAnswer(-1);
                }
            }
        }, 1000);
    }

    // Êõ¥Êñ∞Ë®àÊôÇÂô®È°ØÁ§∫
    function updateTimer(time) {
        document.getElementById('timeLeft').textContent = `${time}Áßí`;
    }

    // Êèê‰∫§Êï∏Áç®Á≠îÊ°à
    function submitSudokuAnswer() {
        clearInterval(examTimer);
        const question = currentQuestions[currentQuestionIndex];
        const cells = document.querySelectorAll('.sudoku-cell');
        const userAnswer = Array(4).fill().map(() => Array(4).fill(0));
        
        // Èò≤Ê≠¢ÈáçË§áÊèê‰∫§
        const submitButton = document.querySelector('.btn.btn-primary');
        if (submitButton) submitButton.disabled = true;
        
        // Êî∂ÈõÜÁî®Êà∂Á≠îÊ°à
        cells.forEach(cell => {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            userAnswer[row][col] = parseInt(cell.value) || 0;
        });
        
        // Ê™¢Êü•Á≠îÊ°àÊòØÂê¶ÂÆåÊï¥
        const hasEmptyCell = Array.from(cells).some(cell => 
            !cell.disabled && (!cell.value || cell.value.trim() === '')
        );
        
        // È©óË≠âÁ≠îÊ°à
        const isCorrect = !hasEmptyCell && checkSudokuAnswer(userAnswer, question.solution);
        const timeTaken = (Date.now() - questionStartTime) / 1000;
        
        // Ë®àÂàÜ
        if (isCorrect) {
            userScores.correctAnswers++;
            if (timeTaken <= currentExam.fastAnswerThreshold) {
                userScores.fastAnswers++;
            }
        }
        
        // È°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°à
        cells.forEach(cell => {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            const correctValue = question.solution[row][col];
            const userValue = parseInt(cell.value) || 0;
            
            cell.disabled = true;
            if (!hasEmptyCell && userValue === correctValue) {
                cell.style.backgroundColor = 'var(--success)';
            } else {
                cell.style.backgroundColor = 'var(--danger)';
                cell.value = correctValue;
            }
        });
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    }

    // Êèê‰∫§ÈÅ∏ÊìáÈ°åÁ≠îÊ°à
    function submitAnswer(selectedIndex) {
        clearInterval(examTimer);

        const question = currentQuestions[currentQuestionIndex];
        const correctIndex = question.correct;
        const timeTaken = (Date.now() - questionStartTime) / 1000;

        // Ë®àÂàÜ
        if (selectedIndex === correctIndex) {
            userScores.correctAnswers++;
            if (timeTaken <= currentExam.fastAnswerThreshold) {
                userScores.fastAnswers++;
            }
        }

        // È°ØÁ§∫ÊåâÈàïÁãÄÊÖã
        const optionButtons = document.querySelectorAll('.option-btn');
        optionButtons.forEach((btn, idx) => {
            btn.disabled = true;
            if (idx === correctIndex) {
                btn.classList.add('correct');
            } else if (idx === selectedIndex) {
                btn.classList.add('wrong');
            }
        });

        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    }

    // ÂÆåÊàêËÄÉË©¶
    function finishExam() {
        const baseScore = (userScores.correctAnswers / currentExam.questionCount) * 100;
        const bonusScore = userScores.fastAnswers;
        const totalScore = Math.min(baseScore + bonusScore, 110);
        
        const resultHtml = `
            <div class="exam-result">
                <h2>ËÄÉË©¶ÂÆåÊàêÔºÅ</h2>
                <p>Á≠îÂ∞çÈ°åÊï∏Ôºö${userScores.correctAnswers}/${currentExam.questionCount}</p>
                <p>Âø´ÈÄüÁ≠îÂ∞çÈ°åÊï∏Ôºö${userScores.fastAnswers}</p>
                <p>Á∏ΩÂàÜÔºö${totalScore.toFixed(1)}</p>
                <button class="btn btn-primary" onclick="updateLeaderboard('${currentExam.name}', ${totalScore})">
                    Êü•ÁúãÊéíË°åÊ¶ú
                </button>
                <button class="btn btn-secondary" onclick="location.reload()">
                    ËøîÂõû‰∏ªÈ†Å
                </button>
            </div>
        `;
        
        document.getElementById('examContainer').innerHTML = resultHtml;
    }

    // Êõ¥Êñ∞ÊéíË°åÊ¶úÂà∞ Firebase
    async function updateLeaderboard(examName, score) {
        try {
            const userDisplayName = currentUser.welcome || currentUser._comment || currentUser.username;
            const scoreData = {
                name: userDisplayName,
                username: currentUser.username,
                score: parseFloat(score.toFixed(1)),
                timestamp: Date.now(),
                date: new Date().toISOString()
            };

            // ÂØ´ÂÖ• Firebase
            await database.ref(`leaderboards/${examName}/${currentUser.username}`).set(scoreData);
            
            // È°ØÁ§∫ÊéíË°åÊ¶ú
            const examType = Object.keys(examConfigs).find(key => examConfigs[key].name === examName);
            showLeaderboard(examType);
            
        } catch (error) {
            console.error('Êõ¥Êñ∞ÊéíË°åÊ¶úÂ§±Êïó:', error);
            alert('ÊéíË°åÊ¶úÊõ¥Êñ∞Â§±ÊïóÔºå‰ΩÜÊàêÁ∏æÂ∑≤Ë®òÈåÑ');
            showLeaderboard(Object.keys(examConfigs).find(key => examConfigs[key].name === examName));
        }
    }

    // È°ØÁ§∫ÊéíË°åÊ¶ú
    async function showLeaderboard(type) {
        const modal = document.getElementById('leaderboardModal');
        const modalTitle = document.getElementById('modalTitle');
        const content = document.getElementById('leaderboardContent');
        
        const examName = examConfigs[type].name;
        modalTitle.textContent = examName + 'ÊéíË°åÊ¶ú';

        try {
            // Âæû Firebase ËÆÄÂèñÊéíË°åÊ¶úÊï∏Êìö
            const snapshot = await database.ref(`leaderboards/${examName}`).once('value');
            const data = snapshot.val() || {};
            
            // ËΩâÊèõÁÇ∫Èô£Âàó‰∏¶ÊéíÂ∫è
            const leaderboardData = Object.values(data)
                .sort((a, b) => b.score - a.score)
                .slice(0, 20); // Âè™È°ØÁ§∫Ââç20Âêç

            if (leaderboardData.length === 0) {
                content.innerHTML = '<div class="empty-leaderboard">Êö´ÁÑ°ÊéíË°åÊ¶úÊï∏Êìö</div>';
            } else {
                content.innerHTML = leaderboardData.map((item, index) => `
                    <div class="leaderboard-item ${item.username === currentUser.username ? 'current-user' : ''}">
                        <div class="rank">#${index + 1}</div>
                        <div class="user-name">${item.name}</div>
                        <div class="score">${item.score}ÂàÜ</div>
                    </div>
                `).join('');
            }

        } catch (error) {
            console.error('ËºâÂÖ•ÊéíË°åÊ¶úÂ§±Êïó:', error);
            content.innerHTML = '<div class="empty-leaderboard">ËºâÂÖ•ÊéíË°åÊ¶úÂ§±Êïó</div>';
        }

        modal.style.display = 'flex';
    }

    // Èö±ËóèÊéíË°åÊ¶ú
    function hideLeaderboard() {
        document.getElementById('leaderboardModal').style.display = 'none';
    }

    // ËøîÂõûT2Êó•Á≥ªÁµ±
    function backToT2() {
        window.location.href = 'page3.html';
    }

    // ÁôªÂá∫
    function logout() {
        localStorage.removeItem('t2_login');
        localStorage.removeItem('t2_login_time');
        localStorage.removeItem('t2_login_user');
        window.location.href = 'index3.html';
    }

    // Â∑•ÂÖ∑ÂáΩÊï∏ÔºöÈö®Ê©üÊâì‰∫ÇÊï∏ÁµÑ
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // ÂÆöÊúüÊ™¢Êü•Áî®Êà∂ÊúâÊïàÊÄß
    function startUserValidationCheck() {
        setInterval(async () => {
            try {
                const response = await fetch('password.json');
                if (response.ok) {
                    const data = await response.json();
                    const users = Array.isArray(data) ? data : [data];
                    const currentUserExists = users.some(u => u.username === currentUser.username);
                    
                    if (!currentUserExists) {
                        forceLogout('ÊÇ®ÁöÑÂ∏≥ËôüÂ∑≤Ë¢´Á≥ªÁµ±ÁßªÈô§ÔºåË´ãÈáçÊñ∞ÁôªÂÖ•');
                    }
                }
            } catch (error) {
                console.warn('Áî®Êà∂È©óË≠âÊ™¢Êü•Â§±Êïó:', error);
            }
        }, 300000); // ÊØè5ÂàÜÈêòÊ™¢Êü•‰∏ÄÊ¨°
    }

    // ÈªûÊìäÂΩàÂá∫Ë¶ñÁ™óÂ§ñÈÉ®ÊôÇÈóúÈñâ
    document.getElementById('leaderboardModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideLeaderboard();
        }
    });

    // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
    window.addEventListener('load', async () => {
        await initializePage();
        if (currentUser) {
            startUserValidationCheck();
        }
    });

</script>
</body>
</html>
