<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T2內部通話系統</title>
  
  <!-- PWA 設定 -->
  <link rel="manifest" href="#" id="manifest-placeholder">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="T2通話">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 10px;
      }
      
      .container {
          background: white;
          border-radius: 20px;
          padding: 20px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          max-width: 400px;
          margin: 0 auto;
          min-height: calc(100vh - 20px);
      }
      
      .header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 2px solid #f0f0f0;
      }
      
      .header h1 {
          color: #333;
          font-size: 22px;
          margin-bottom: 10px;
      }
      
      .status-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }
      
      .status {
          padding: 8px 15px;
          border-radius: 20px;
          font-weight: bold;
          font-size: 14px;
      }
      
      .status.online {
          background: #d4edda;
          color: #155724;
      }
      
      .status.offline {
          background: #f8d7da;
          color: #721c24;
      }
      
      .install-btn {
          padding: 8px 15px;
          background: #007bff;
          color: white;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          font-size: 12px;
          display: none;
      }
      
      .user-section {
          margin-bottom: 20px;
      }
      
      .user-input {
          display: flex;
          gap: 10px;
          margin-bottom: 15px;
      }
      
      .user-input input {
          flex: 1;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 10px;
          font-size: 16px;
      }
      
      .user-input button {
          padding: 12px 20px;
          background: #28a745;
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          font-weight: bold;
      }
      
      .online-users {
          background: #f8f9fa;
          border-radius: 10px;
          padding: 15px;
          margin-bottom: 20px;
          max-height: 150px;
          overflow-y: auto;
      }
      
      .online-users h3 {
          margin-bottom: 10px;
          color: #333;
          font-size: 16px;
      }
      
      .user-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px;
          margin: 5px 0;
          background: white;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .user-name {
          font-weight: bold;
          color: #333;
      }
      
      .call-user-btn {
          padding: 5px 10px;
          background: #007bff;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 12px;
      }
      
      .call-controls {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
      }
      
      .call-btn {
          flex: 1;
          padding: 15px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
      }
      
      .call-btn.answer {
          background: #28a745;
          color: white;
      }
      
      .call-btn.hangup {
          background: #dc3545;
          color: white;
      }
      
      .call-btn:disabled {
          background: #6c757d;
          cursor: not-allowed;
      }
      
      .call-status {
          text-align: center;
          padding: 15px;
          margin: 15px 0;
          border-radius: 10px;
          font-weight: bold;
          display: none;
      }
      
      .call-status.incoming {
          background: #fff3cd;
          color: #856404;
          animation: pulse 1s infinite;
      }
      
      .call-status.connected {
          background: #d1ecf1;
          color: #0c5460;
      }
      
      @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
      }
      
      .messages {
          background: #f8f9fa;
          border-radius: 10px;
          padding: 15px;
          height: 300px;
          overflow-y: auto;
          margin-bottom: 15px;
      }
      
      .message {
          padding: 8px 12px;
          margin: 5px 0;
          border-radius: 8px;
          max-width: 80%;
      }
      
      .message.self {
          background: #007bff;
          color: white;
          margin-left: auto;
          text-align: right;
      }
      
      .message.other {
          background: #e9ecef;
          color: #333;
      }
      
      .message.system {
          background: #fff3cd;
          color: #856404;
          text-align: center;
          max-width: 100%;
          font-size: 14px;
      }
      
      .message-input {
          display: flex;
          gap: 10px;
      }
      
      .message-input input {
          flex: 1;
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 10px;
          font-size: 16px;
      }
      
      .message-input button {
          padding: 12px 15px;
          background: #007bff;
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
      }
      
      .notification-permission {
          background: #fff3cd;
          color: #856404;
          padding: 10px;
          border-radius: 8px;
          margin-bottom: 15px;
          text-align: center;
          display: none;
      }
      
      .notification-permission button {
          margin-top: 10px;
          padding: 8px 15px;
          background: #ffc107;
          color: #212529;
          border: none;
          border-radius: 5px;
          cursor: pointer;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🏢 T2內部通話系統</h1>
          <div class="status-bar">
              <div id="status" class="status offline">⚫ 離線</div>
              <button id="installBtn" class="install-btn">📱 安裝APP</button>
          </div>
      </div>
      
      <div id="notificationPermission" class="notification-permission">
          <div>🔔 開啟通知權限以接收來電提醒</div>
          <button onclick="requestNotificationPermission()">開啟通知</button>
      </div>
      
      <div class="user-section">
          <div class="user-input">
              <input type="text" id="usernameInput" placeholder="輸入你的名稱">
              <button onclick="joinSystem()">上線</button>
          </div>
      </div>
      
      <div id="onlineUsers" class="online-users" style="display: none;">
          <h3>📋 線上人員</h3>
          <div id="usersList"></div>
      </div>
      
      <div id="callStatus" class="call-status"></div>
      
      <div class="call-controls">
          <button id="answerBtn" class="call-btn answer" style="display: none;" onclick="answerCall()">📞 接聽</button>
          <button id="hangupBtn" class="call-btn hangup" style="display: none;" onclick="hangupCall()">📵 掛斷</button>
      </div>
      
      <div class="messages" id="messages"></div>
      
      <div class="message-input">
          <input type="text" id="messageInput" placeholder="輸入訊息..." onkeypress="handleMessageKeyPress(event)">
          <button onclick="sendMessage()">發送</button>
      </div>
  </div>

  <script>
      // PWA 安裝功能
      let deferredPrompt;
      const installBtn = document.getElementById('installBtn');
      
      window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installBtn.style.display = 'block';
      });
      
      installBtn.addEventListener('click', async () => {
          if (deferredPrompt) {
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              if (outcome === 'accepted') {
                  installBtn.style.display = 'none';
              }
              deferredPrompt = null;
          }
      });
      
      // 系統變數
      let currentUser = '';
      let isOnline = false;
      let onlineUsers = {};
      let currentCall = null;
      let localStream = null;
      let peerConnection = null;
      
      // Firebase 設定 (使用你現有的)
      const firebaseConfig = {
          databaseURL: "https://stellarblue-system-default-rtdb.firebaseio.com"
      };
      
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      
      // 通知權限檢查
      if ('Notification' in window && Notification.permission === 'default') {
          document.getElementById('notificationPermission').style.display = 'block';
      }
      
      function requestNotificationPermission() {
          Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                  document.getElementById('notificationPermission').style.display = 'none';
                  showSystemMessage('✅ 通知權限已開啟');
              }
          });
      }
      
      // 加入系統
      function joinSystem() {
          const username = document.getElementById('usernameInput').value.trim();
          if (!username) {
              alert('請輸入名稱');
              return;
          }
          
          currentUser = username;
          isOnline = true;
          
          // 更新狀態
          document.getElementById('status').textContent = '🟢 線上';
          document.getElementById('status').className = 'status online';
          document.getElementById('onlineUsers').style.display = 'block';
          
          // 註冊到 Firebase
          const userRef = database.ref(`users/${currentUser}`);
          userRef.set({
              name: currentUser,
              status: 'online',
              lastSeen: firebase.database.ServerValue.TIMESTAMP
          });
          
          // 監聽線上用戶
          database.ref('users').on('value', (snapshot) => {
              onlineUsers = snapshot.val() || {};
              updateUsersList();
          });
          
          // 監聽來電
          database.ref(`calls/${currentUser}`).on('value', (snapshot) => {
              const callData = snapshot.val();
              if (callData && callData.status === 'incoming') {
                  handleIncomingCall(callData);
              }
          });
          
          // 監聽訊息
          database.ref('messages').limitToLast(50).on('child_added', (snapshot) => {
              const message = snapshot.val();
              if (message.timestamp > Date.now() - 60000) { // 只顯示最近1分鐘的訊息
                  displayMessage(message);
              }
          });
          
          showSystemMessage(`${currentUser} 已上線`);
          
          // 離開時清理
          window.addEventListener('beforeunload', () => {
              if (isOnline) {
                  database.ref(`users/${currentUser}`).remove();
              }
          });
      }
      
      // 更新用戶列表
      function updateUsersList() {
          const usersList = document.getElementById('usersList');
          usersList.innerHTML = '';
          
          Object.keys(onlineUsers).forEach(username => {
              if (username !== currentUser && onlineUsers[username].status === 'online') {
                  const userItem = document.createElement('div');
                  userItem.className = 'user-item';
                  userItem.innerHTML = `
                      <span class="user-name">👤 ${username}</span>
                      <button class="call-user-btn" onclick="callUser('${username}')">📞 通話</button>
                  `;
                  usersList.appendChild(userItem);
              }
          });
      }
      
      // 撥打電話
      function callUser(targetUser) {
          if (currentCall) {
              alert('目前已在通話中');
              return;
          }
          
          currentCall = {
              target: targetUser,
              status: 'calling'
          };
          
          // 發送來電通知
          database.ref(`calls/${targetUser}`).set({
              from: currentUser,
              status: 'incoming',
              timestamp: firebase.database.ServerValue.TIMESTAMP
          });
          
          showCallStatus(`📞 正在呼叫 ${targetUser}...`, 'calling');
          document.getElementById('hangupBtn').style.display = 'block';
          
          showSystemMessage(`📞 ${currentUser} 正在呼叫 ${targetUser}`);
      }
      
      // 處理來電
      function handleIncomingCall(callData) {
          if (currentCall) return;
          
          currentCall = {
              from: callData.from,
              status: 'incoming'
          };
          
          showCallStatus(`📞 ${callData.from} 來電中...`, 'incoming');
          document.getElementById('answerBtn').style.display = 'block';
          document.getElementById('hangupBtn').style.display = 'block';
          
          // 推播通知
          if ('Notification' in window && Notification.permission === 'granted') {
              new Notification(`📞 ${callData.from} 來電`, {
                  body: '點擊接聽電話',
                  icon: '/favicon.ico'
              });
          }
          
          // 播放鈴聲 (模擬)
          playRingtone();
      }
      
      // 接聽電話
      function answerCall() {
          if (!currentCall || currentCall.status !== 'incoming') return;
          
          // 清除來電通知
          database.ref(`calls/${currentUser}`).remove();
          
          currentCall.status = 'connected';
          showCallStatus(`🔊 與 ${currentCall.from} 通話中`, 'connected');
          
          document.getElementById('answerBtn').style.display = 'none';
          
          showSystemMessage(`📞 ${currentUser} 接聽了 ${currentCall.from} 的來電`);
          
          // 這裡可以加入 WebRTC 語音通話
          // startVoiceCall();
      }
      
      // 掛斷電話
      function hangupCall() {
          if (!currentCall) return;
          
          const otherUser = currentCall.target || currentCall.from;
          
          // 清除通話資料
          database.ref(`calls/${currentUser}`).remove();
          if (currentCall.target) {
              database.ref(`calls/${currentCall.target}`).remove();
          }
          
          currentCall = null;
          
          document.getElementById('callStatus').style.display = 'none';
          document.getElementById('answerBtn').style.display = 'none';
          document.getElementById('hangupBtn').style.display = 'none';
          
          showSystemMessage(`📵 與 ${otherUser} 的通話已結束`);
      }
      
      // 發送訊息
      function sendMessage() {
          const messageInput = document.getElementById('messageInput');
          const message = messageInput.value.trim();
          
          if (!message || !isOnline) return;
          
          const messageData = {
              from: currentUser,
              text: message,
              timestamp: Date.now()
          };
          
          database.ref('messages').push(messageData);
          messageInput.value = '';
      }
      
      function handleMessageKeyPress(event) {
          if (event.key === 'Enter') {
              sendMessage();
          }
      }
      
      // 顯示訊息
      function displayMessage(message) {
          const messagesDiv = document.getElementById('messages');
          const messageDiv = document.createElement('div');
          
          const time = new Date(message.timestamp).toLocaleTimeString();
          
          if (message.from === currentUser) {
              messageDiv.className = 'message self';
              messageDiv.textContent = `${message.text} (${time})`;
          } else {
              messageDiv.className = 'message other';
              messageDiv.textContent = `${message.from}: ${message.text} (${time})`;
          }
          
          messagesDiv.appendChild(messageDiv);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
      
      // 顯示系統訊息
      function showSystemMessage(text) {
          const messagesDiv = document.getElementById('messages');
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message system';
          messageDiv.textContent = `${new Date().toLocaleTimeString()} - ${text}`;
          messagesDiv.appendChild(messageDiv);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
      
      // 顯示通話狀態
      function showCallStatus(text, type) {
          const statusDiv = document.getElementById('callStatus');
          statusDiv.textContent = text;
          statusDiv.className = `call-status ${type}`;
          statusDiv.style.display = 'block';
      }
      
      // 播放鈴聲 (模擬)
      function playRingtone() {
          // 這裡可以加入真實的鈴聲
          console.log('🔔 鈴聲響起...');
      }
      
      // 生成 PWA manifest
      const manifest = {
          name: "T2內部通話系統",
          short_name: "T2通話",
          description: "桃園機場檢疫單位內部通話系統",
          start_url: "./",
          display: "standalone",
          background_color: "#667eea",
          theme_color: "#667eea",
          icons: [
              {
                  src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjNjY3ZWVhIi8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI4MCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+PojwvdGV4dD4KPC9zdmc+",
                  sizes: "192x192",
                  type: "image/svg+xml"
              }
          ]
      };
      
      const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
      const manifestURL = URL.createObjectURL(manifestBlob);
      document.getElementById('manifest-placeholder').href = manifestURL;
      
      // Service Worker 註冊
      if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
              self.addEventListener('install', event => {
                  console.log('Service Worker installing...');
              });
              
              self.addEventListener('activate', event => {
                  console.log('Service Worker activating...');
              });
              
              self.addEventListener('push', event => {
                  const options = {
                      body: event.data ? event.data.text() : 'T2內部通話系統通知',
                      icon: '/favicon.ico',
                      badge: '/favicon.ico'
                  };
                  
                  event.waitUntil(
                      self.registration.showNotification('T2通話系統', options)
                  );
              });
          `)).then(registration => {
              console.log('Service Worker registered successfully');
          }).catch(error => {
              console.log('Service Worker registration failed:', error);
          });
      }
  </script>
</body>
</html>
