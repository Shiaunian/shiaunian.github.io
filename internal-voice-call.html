<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªéŸ³é€šè©±ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            width: 90%;
            max-width: 500px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        /* ç™»å…¥ç•«é¢ */
        .login-screen {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
        }
        
        /* ä¸»ç•«é¢ */
        .main-screen {
            display: none;
        }
        
        .user-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .user-info h3 {
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status.online {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status.calling {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status.in-call {
            background: #bee3f8;
            color: #2a4365;
        }
        
        .online-users {
            margin-bottom: 25px;
        }
        
        .online-users h4 {
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .user-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        
        .user-item:hover {
            background: #edf2f7;
        }
        
        .user-item span {
            font-weight: bold;
            color: #2d3748;
        }
        
        .call-btn {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .call-btn:hover {
            background: #38a169;
        }
        
        .call-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        /* é€šè©±ç•«é¢ */
        .call-screen {
            display: none;
            text-align: center;
        }
        
        .call-info {
            margin-bottom: 30px;
        }
        
        .call-info h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .call-timer {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .call-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .call-controls button {
            width: auto;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 14px;
        }
        
        /* ä¾†é›»ç•«é¢ */
        .incoming-call {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .incoming-call-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .incoming-call h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .incoming-call-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .incoming-call-controls button {
            width: auto;
            padding: 15px 30px;
            border-radius: 10px;
        }
        
        /* éŸ³æ•ˆæ§åˆ¶ */
        .volume-control {
            margin: 20px 0;
            text-align: center;
        }
        
        .volume-slider {
            width: 200px;
            margin: 0 10px;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                width: 95%;
            }
            
            .call-controls {
                flex-direction: column;
            }
            
            .incoming-call-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å…¥ç•«é¢ -->
        <div id="loginScreen" class="login-screen">
            <div class="header">
                <h1>ğŸ™ï¸ èªéŸ³é€šè©±ç³»çµ±</h1>
                <p>è«‹è¼¸å…¥æ‚¨çš„å§“åç™»å…¥</p>
            </div>
            
            <div class="form-group">
                <label for="username">ä½¿ç”¨è€…åç¨±</label>
                <input type="text" id="username" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" maxlength="20">
            </div>
            
            <button id="loginBtn" class="btn-primary">ğŸš€ ç™»å…¥ç³»çµ±</button>
        </div>
        
        <!-- ä¸»ç•«é¢ -->
        <div id="mainScreen" class="main-screen">
            <div class="header">
                <h1>ğŸ™ï¸ èªéŸ³é€šè©±ç³»çµ±</h1>
            </div>
            
            <div class="user-info">
                <h3>æ­¡è¿ï¼Œ<span id="currentUser"></span></h3>
                <span id="userStatus" class="status online">ç·šä¸Š</span>
            </div>
            
            <div class="online-users">
                <h4>ğŸ“‹ ç·šä¸Šç”¨æˆ¶</h4>
                <div id="userList" class="user-list">
                    <!-- å‹•æ…‹ç”Ÿæˆç”¨æˆ¶åˆ—è¡¨ -->
                </div>
            </div>
            
            <div class="volume-control">
                <label>ğŸ”Š éŸ³é‡æ§åˆ¶</label>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="80">
                <span id="volumeValue">80%</span>
            </div>
            
            <button id="logoutBtn" class="btn-danger">ğŸšª ç™»å‡ºç³»çµ±</button>
        </div>
        
        <!-- é€šè©±ç•«é¢ -->
        <div id="callScreen" class="call-screen">
            <div class="call-info">
                <h3>ğŸ™ï¸ é€šè©±ä¸­</h3>
                <p>æ­£åœ¨èˆ‡ <strong id="callingUser"></strong> é€šè©±</p>
                <div id="callTimer" class="call-timer">00:00</div>
            </div>
            
            <div class="call-controls">
                <button id="muteBtn" class="btn-warning">ğŸ”‡ éœéŸ³</button>
                <button id="hangupBtn" class="btn-danger">ğŸ“ æ›æ–·</button>
            </div>
            
            <!-- éš±è—çš„éŸ³è¨Šå…ƒç´  -->
            <audio id="localAudio" muted></audio>
            <audio id="remoteAudio" autoplay></audio>
        </div>
    </div>
    
    <!-- ä¾†é›»é€šçŸ¥ -->
    <div id="incomingCall" class="incoming-call">
        <div class="incoming-call-box">
            <h3>ğŸ“ ä¾†é›»é€šçŸ¥</h3>
            <p><strong id="callerName"></strong> æ­£åœ¨å‘¼å«æ‚¨</p>
            <div class="incoming-call-controls">
                <button id="acceptCallBtn" class="btn-success">âœ… æ¥è½</button>
                <button id="rejectCallBtn" class="btn-danger">âŒ æ‹’æ¥</button>
            </div>
        </div>
    </div>
    
    <!-- éŸ³æ•ˆæª”æ¡ˆ -->
    <audio id="ringTone" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU4kdXy0n0vBSF3x+/eizELElyx5+yrWBUIQ53d87xtIgUqgM7y2Ik2CBxqvfDim04MD1Gq5O24ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik=" type="audio/wav">
    </audio>
    
    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentUser = '';
        let onlineUsers = new Map();
        let peerConnection = null;
        let localStream = null;
        let callTimer = null;
        let callStartTime = null;
        let isMuted = false;
        
        // DOM å…ƒç´ 
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const callScreen = document.getElementById('callScreen');
        const incomingCall = document.getElementById('incomingCall');
        
        const usernameInput = document.getElementById('username');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const userList = document.getElementById('userList');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        
        const callingUser = document.getElementById('callingUser');
        const callTimerDiv = document.getElementById('callTimer');
        const muteBtn = document.getElementById('muteBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        
        const callerName = document.getElementById('callerName');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const rejectCallBtn = document.getElementById('rejectCallBtn');
        
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');
        const ringTone = document.getElementById('ringTone');
        
        // WebRTC è¨­å®š
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // äº‹ä»¶ç›£è½å™¨
        loginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        muteBtn.addEventListener('click', toggleMute);
        hangupBtn.addEventListener('click', endCall);
        acceptCallBtn.addEventListener('click', acceptCall);
        rejectCallBtn.addEventListener('click', rejectCall);
        
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
        
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value;
            volumeValue.textContent = volume + '%';
            remoteAudio.volume = volume / 100;
        });
        
        // ç™»å…¥åŠŸèƒ½
        function login() {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±');
                return;
            }
            
            currentUser = username;
            currentUserSpan.textContent = username;
            
            // æ¨¡æ“¬å…¶ä»–ç·šä¸Šç”¨æˆ¶
            simulateOnlineUsers();
            
            // åˆ‡æ›åˆ°ä¸»ç•«é¢
            loginScreen.style.display = 'none';
            mainScreen.style.display = 'block';
            
            // åˆå§‹åŒ–éŸ³è¨Š
            initializeAudio();
            
            console.log(`${username} å·²ç™»å…¥ç³»çµ±`);
        }
        
        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (peerConnection) {
                endCall();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            currentUser = '';
            onlineUsers.clear();
            
            loginScreen.style.display = 'block';
            mainScreen.style.display = 'none';
            callScreen.style.display = 'none';
            incomingCall.style.display = 'none';
            
            usernameInput.value = '';
            
            console.log('å·²ç™»å‡ºç³»çµ±');
        }
        
        // æ¨¡æ“¬ç·šä¸Šç”¨æˆ¶
        function simulateOnlineUsers() {
            const users = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve'];
            onlineUsers.clear();
            
            // éš¨æ©Ÿæ·»åŠ  2-4 å€‹ç”¨æˆ¶
            const userCount = Math.floor(Math.random() * 3) + 2;
            const selectedUsers = users.sort(() => 0.5 - Math.random()).slice(0, userCount);
            
            selectedUsers.forEach(user => {
                if (user !== currentUser) {
                    onlineUsers.set(user, { status: 'online' });
                }
            });
            
            updateUserList();
        }
        
        // æ›´æ–°ç”¨æˆ¶åˆ—è¡¨
        function updateUserList() {
            userList.innerHTML = '';
            
            if (onlineUsers.size === 0) {
                userList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ç›®å‰æ²’æœ‰å…¶ä»–ç”¨æˆ¶ç·šä¸Š</div>';
                return;
            }
            
            onlineUsers.forEach((userData, username) => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const isInCall = userData.status === 'in-call';
                
                userItem.innerHTML = `
                    <span>${username}</span>
                    <button class="call-btn" onclick="makeCall('${username}')" ${isInCall ? 'disabled' : ''}>
                        ${isInCall ? 'é€šè©±ä¸­' : 'ğŸ“ æ’¥æ‰“'}
                    </button>
                `;
                
                userList.appendChild(userItem);
            });
        }
        
        // åˆå§‹åŒ–éŸ³è¨Š
        async function initializeAudio() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
                localAudio.srcObject = localStream;
                console.log('éŸ³è¨Šåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™:', error);
                alert('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
            }
        }
        
        // æ’¥æ‰“é›»è©±
        async function makeCall(targetUser) {
            if (!localStream) {
                alert('è«‹å…ˆå…è¨±éº¥å…‹é¢¨æ¬Šé™');
                return;
            }
            
            console.log(`æ­£åœ¨æ’¥æ‰“çµ¦ ${targetUser}`);
            
            // æ¨¡æ“¬æ’¥æ‰“å»¶é²
            setTimeout(() => {
                // æ¨¡æ“¬å°æ–¹æ¥è½æˆ–æ‹’æ¥
                const willAnswer = Math.random() > 0.3; // 70% æ©Ÿç‡æ¥è½
                
                if (willAnswer) {
                    startCall(targetUser);
                } else {
                    alert(`${targetUser} æ²’æœ‰æ¥è½`);
                }
            }, 2000);
            
            // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
            onlineUsers.get(targetUser).status = 'calling';
            updateUserList();
        }
        
        // æ¨¡æ“¬ä¾†é›»
        function simulateIncomingCall() {
            const callers = Array.from(onlineUsers.keys());
            if (callers.length === 0) return;
            
            const caller = callers[Math.floor(Math.random() * callers.length)];
            showIncomingCall(caller);
        }
        
        // é¡¯ç¤ºä¾†é›»é€šçŸ¥
        function showIncomingCall(caller) {
            callerName.textContent = caller;
            incomingCall.style.display = 'flex';
            
            // æ’­æ”¾éˆ´è²
            ringTone.currentTime = 0;
            ringTone.play().catch(e => console.log('ç„¡æ³•æ’­æ”¾éˆ´è²:', e));
            
            console.log(`æ”¶åˆ°ä¾†è‡ª ${caller} çš„ä¾†é›»`);
        }
        
        // æ¥è½é›»è©±
        function acceptCall() {
            const caller = callerName.textContent;
            
            // åœæ­¢éˆ´è²
            ringTone.pause();
            ringTone.currentTime = 0;
            
            // éš±è—ä¾†é›»é€šçŸ¥
            incomingCall.style.display = 'none';
            
            // é–‹å§‹é€šè©±
            startCall(caller);
            
            console.log(`æ¥è½ä¾†è‡ª ${caller} çš„é›»è©±`);
        }
        
        // æ‹’æ¥é›»è©±
        function rejectCall() {
            const caller = callerName.textContent;
            
            // åœæ­¢éˆ´è²
            ringTone.pause();
            ringTone.currentTime = 0;
            
            // éš±è—ä¾†é›»é€šçŸ¥
            incomingCall.style.display = 'none';
            
            console.log(`æ‹’æ¥ä¾†è‡ª ${caller} çš„é›»è©±`);
        }
        
        // é–‹å§‹é€šè©±
        async function startCall(otherUser) {
            try {
                // å»ºç«‹ WebRTC é€£ç·š
                peerConnection = new RTCPeerConnection(rtcConfiguration);
                
                // æ·»åŠ æœ¬åœ°éŸ³è¨Šæµ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // è™•ç†é ç«¯éŸ³è¨Šæµ
                peerConnection.ontrack = (event) => {
                    remoteAudio.srcObject = event.streams[0];
                };
                
                // åˆ‡æ›åˆ°é€šè©±ç•«é¢
                mainScreen.style.display = 'none';
                callScreen.style.display = 'block';
                
                callingUser.textContent = otherUser;
                
                // é–‹å§‹è¨ˆæ™‚
                startCallTimer();
                
                // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                document.getElementById('userStatus').textContent = 'é€šè©±ä¸­';
                document.getElementById('userStatus').className = 'status in-call';
                
                console.log(`èˆ‡ ${otherUser} çš„é€šè©±å·²é–‹å§‹`);
                
            } catch (error) {
                console.error('å»ºç«‹é€šè©±é€£ç·šå¤±æ•—:', error);
                alert('å»ºç«‹é€šè©±é€£ç·šå¤±æ•—');
            }
        }
        
        // é–‹å§‹é€šè©±è¨ˆæ™‚
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                callTimerDiv.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // åˆ‡æ›éœéŸ³
        function toggleMute() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                isMuted = !audioTrack.enabled;
                
                muteBtn.textContent = isMuted ? 'ğŸ”Š å–æ¶ˆéœéŸ³' : 'ğŸ”‡ éœéŸ³';
                muteBtn.className = isMuted ? 'btn-success' : 'btn-warning';
                
                console.log(isMuted ? 'å·²éœéŸ³' : 'å·²å–æ¶ˆéœéŸ³');
            }
        }
        
        // çµæŸé€šè©±
        function endCall() {
            // åœæ­¢è¨ˆæ™‚
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // é—œé–‰ WebRTC é€£ç·š
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // é‡ç½®éŸ³è¨Š
            remoteAudio.srcObject = null;
            
            // é‡ç½®éœéŸ³ç‹€æ…‹
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = true;
                }
            }
            isMuted = false;
            muteBtn.textContent = 'ğŸ”‡ éœéŸ³';
            muteBtn.className = 'btn-warning';
            
            // åˆ‡æ›å›ä¸»ç•«é¢
            callScreen.style.display = 'none';
            mainScreen.style.display = 'block';
            
            // é‡ç½®ç”¨æˆ¶ç‹€æ…‹
            document.getElementById('userStatus').textContent = 'ç·šä¸Š';
            document.getElementById('userStatus').className = 'status online';
            
            // é‡ç½®å…¶ä»–ç”¨æˆ¶ç‹€æ…‹
            onlineUsers.forEach((userData, username) => {
                userData.status = 'online';
            });
            updateUserList();
            
            console.log('é€šè©±å·²çµæŸ');
        }
        
        // æ¨¡æ“¬å®šæœŸæ”¶åˆ°ä¾†é›» (æ¸¬è©¦ç”¨)
        setInterval(() => {
            if (currentUser && mainScreen.style.display === 'block' && Math.random() > 0.7) {
                simulateIncomingCall();
            }
        }, 30000); // æ¯30ç§’æœ‰30%æ©Ÿç‡æ”¶åˆ°ä¾†é›»
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('èªéŸ³é€šè©±ç³»çµ±å·²è¼‰å…¥');
        });
        
        // é é¢é—œé–‰å‰æ¸…ç†è³‡æº
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
        });
        
        // è™•ç†ç€è¦½å™¨æ¬Šé™è®ŠåŒ–
        navigator.permissions.query({name: 'microphone'}).then((result) => {
            result.onchange = () => {
                console.log('éº¥å…‹é¢¨æ¬Šé™ç‹€æ…‹:', result.state);
            };
        });
        
    </script>
</body>
</html>
