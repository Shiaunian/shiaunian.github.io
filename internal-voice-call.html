<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音通話系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            width: 90%;
            max-width: 500px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        /* 登入畫面 */
        .login-screen {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
        }
        
        /* 主畫面 */
        .main-screen {
            display: none;
        }
        
        .user-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .user-info h3 {
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status.online {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status.calling {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status.in-call {
            background: #bee3f8;
            color: #2a4365;
        }
        
        .online-users {
            margin-bottom: 25px;
        }
        
        .online-users h4 {
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .user-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        
        .user-item:hover {
            background: #edf2f7;
        }
        
        .user-item span {
            font-weight: bold;
            color: #2d3748;
        }
        
        .call-btn {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .call-btn:hover {
            background: #38a169;
        }
        
        .call-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        /* 通話畫面 */
        .call-screen {
            display: none;
            text-align: center;
        }
        
        .call-info {
            margin-bottom: 30px;
        }
        
        .call-info h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .call-timer {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .call-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .call-controls button {
            width: auto;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 14px;
        }
        
        /* 來電畫面 */
        .incoming-call {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .incoming-call-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .incoming-call h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .incoming-call-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .incoming-call-controls button {
            width: auto;
            padding: 15px 30px;
            border-radius: 10px;
        }
        
        /* 音效控制 */
        .volume-control {
            margin: 20px 0;
            text-align: center;
        }
        
        .volume-slider {
            width: 200px;
            margin: 0 10px;
        }
        
        /* 響應式設計 */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                width: 95%;
            }
            
            .call-controls {
                flex-direction: column;
            }
            
            .incoming-call-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登入畫面 -->
        <div id="loginScreen" class="login-screen">
            <div class="header">
                <h1>🎙️ 語音通話系統</h1>
                <p>請輸入您的姓名登入</p>
            </div>
            
            <div class="form-group">
                <label for="username">使用者名稱</label>
                <input type="text" id="username" placeholder="請輸入您的姓名" maxlength="20">
            </div>
            
            <button id="loginBtn" class="btn-primary">🚀 登入系統</button>
        </div>
        
        <!-- 主畫面 -->
        <div id="mainScreen" class="main-screen">
            <div class="header">
                <h1>🎙️ 語音通話系統</h1>
            </div>
            
            <div class="user-info">
                <h3>歡迎，<span id="currentUser"></span></h3>
                <span id="userStatus" class="status online">線上</span>
            </div>
            
            <div class="online-users">
                <h4>📋 線上用戶</h4>
                <div id="userList" class="user-list">
                    <!-- 動態生成用戶列表 -->
                </div>
            </div>
            
            <div class="volume-control">
                <label>🔊 音量控制</label>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="80">
                <span id="volumeValue">80%</span>
            </div>
            
            <button id="logoutBtn" class="btn-danger">🚪 登出系統</button>
        </div>
        
        <!-- 通話畫面 -->
        <div id="callScreen" class="call-screen">
            <div class="call-info">
                <h3>🎙️ 通話中</h3>
                <p>正在與 <strong id="callingUser"></strong> 通話</p>
                <div id="callTimer" class="call-timer">00:00</div>
            </div>
            
            <div class="call-controls">
                <button id="muteBtn" class="btn-warning">🔇 靜音</button>
                <button id="hangupBtn" class="btn-danger">📞 掛斷</button>
            </div>
            
            <!-- 隱藏的音訊元素 -->
            <audio id="localAudio" muted></audio>
            <audio id="remoteAudio" autoplay></audio>
        </div>
    </div>
    
    <!-- 來電通知 -->
    <div id="incomingCall" class="incoming-call">
        <div class="incoming-call-box">
            <h3>📞 來電通知</h3>
            <p><strong id="callerName"></strong> 正在呼叫您</p>
            <div class="incoming-call-controls">
                <button id="acceptCallBtn" class="btn-success">✅ 接聽</button>
                <button id="rejectCallBtn" class="btn-danger">❌ 拒接</button>
            </div>
        </div>
    </div>
    
    <!-- 音效檔案 -->
    <audio id="ringTone" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU4kdXy0n0vBSF3x+/eizELElyx5+yrWBUIQ53d87xtIgUqgM7y2Ik2CBxqvfDim04MD1Gq5O24ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik2CBxpvfDjnE4MDlCq5O25ZRoFOZLU8tJ+LgUgdsfw3YwxCxJcsefjrVkVCEOd3fO7bSMFKoDO8tiJNggcab3w45xODA5QquTtuWUaBTmS1PLSfi4FIHbH8N2MMQsSXLHn461ZFQhDnd3zu20jBSqAzvLYiTYIHGm98OOcTgwOUKrk7bllGgU5ktTy0n4uBSB2x/DdjDELElyx5+OtWRUIQ53d87ttIwUqgM7y2Ik=" type="audio/wav">
    </audio>
    
    <script>
        // 全域變數
        let currentUser = '';
        let onlineUsers = new Map();
        let peerConnection = null;
        let localStream = null;
        let callTimer = null;
        let callStartTime = null;
        let isMuted = false;
        
        // DOM 元素
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const callScreen = document.getElementById('callScreen');
        const incomingCall = document.getElementById('incomingCall');
        
        const usernameInput = document.getElementById('username');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const userList = document.getElementById('userList');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        
        const callingUser = document.getElementById('callingUser');
        const callTimerDiv = document.getElementById('callTimer');
        const muteBtn = document.getElementById('muteBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        
        const callerName = document.getElementById('callerName');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const rejectCallBtn = document.getElementById('rejectCallBtn');
        
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');
        const ringTone = document.getElementById('ringTone');
        
        // WebRTC 設定
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // 事件監聽器
        loginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        muteBtn.addEventListener('click', toggleMute);
        hangupBtn.addEventListener('click', endCall);
        acceptCallBtn.addEventListener('click', acceptCall);
        rejectCallBtn.addEventListener('click', rejectCall);
        
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
        
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value;
            volumeValue.textContent = volume + '%';
            remoteAudio.volume = volume / 100;
        });
        
        // 登入功能
        function login() {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('請輸入使用者名稱');
                return;
            }
            
            currentUser = username;
            currentUserSpan.textContent = username;
            
            // 模擬其他線上用戶
            simulateOnlineUsers();
            
            // 切換到主畫面
            loginScreen.style.display = 'none';
            mainScreen.style.display = 'block';
            
            // 初始化音訊
            initializeAudio();
            
            console.log(`${username} 已登入系統`);
        }
        
        // 登出功能
        function logout() {
            if (peerConnection) {
                endCall();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            currentUser = '';
            onlineUsers.clear();
            
            loginScreen.style.display = 'block';
            mainScreen.style.display = 'none';
            callScreen.style.display = 'none';
            incomingCall.style.display = 'none';
            
            usernameInput.value = '';
            
            console.log('已登出系統');
        }
        
        // 模擬線上用戶
        function simulateOnlineUsers() {
            const users = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve'];
            onlineUsers.clear();
            
            // 隨機添加 2-4 個用戶
            const userCount = Math.floor(Math.random() * 3) + 2;
            const selectedUsers = users.sort(() => 0.5 - Math.random()).slice(0, userCount);
            
            selectedUsers.forEach(user => {
                if (user !== currentUser) {
                    onlineUsers.set(user, { status: 'online' });
                }
            });
            
            updateUserList();
        }
        
        // 更新用戶列表
        function updateUserList() {
            userList.innerHTML = '';
            
            if (onlineUsers.size === 0) {
                userList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">目前沒有其他用戶線上</div>';
                return;
            }
            
            onlineUsers.forEach((userData, username) => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const isInCall = userData.status === 'in-call';
                
                userItem.innerHTML = `
                    <span>${username}</span>
                    <button class="call-btn" onclick="makeCall('${username}')" ${isInCall ? 'disabled' : ''}>
                        ${isInCall ? '通話中' : '📞 撥打'}
                    </button>
                `;
                
                userList.appendChild(userItem);
            });
        }
        
        // 初始化音訊
        async function initializeAudio() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
                localAudio.srcObject = localStream;
                console.log('音訊初始化成功');
            } catch (error) {
                console.error('無法取得麥克風權限:', error);
                alert('無法取得麥克風權限，請檢查瀏覽器設定');
            }
        }
        
        // 撥打電話
        async function makeCall(targetUser) {
            if (!localStream) {
                alert('請先允許麥克風權限');
                return;
            }
            
            console.log(`正在撥打給 ${targetUser}`);
            
            // 模擬撥打延遲
            setTimeout(() => {
                // 模擬對方接聽或拒接
                const willAnswer = Math.random() > 0.3; // 70% 機率接聽
                
                if (willAnswer) {
                    startCall(targetUser);
                } else {
                    alert(`${targetUser} 沒有接聽`);
                }
            }, 2000);
            
            // 更新用戶狀態
            onlineUsers.get(targetUser).status = 'calling';
            updateUserList();
        }
        
        // 模擬來電
        function simulateIncomingCall() {
            const callers = Array.from(onlineUsers.keys());
            if (callers.length === 0) return;
            
            const caller = callers[Math.floor(Math.random() * callers.length)];
            showIncomingCall(caller);
        }
        
        // 顯示來電通知
        function showIncomingCall(caller) {
            callerName.textContent = caller;
            incomingCall.style.display = 'flex';
            
            // 播放鈴聲
            ringTone.currentTime = 0;
            ringTone.play().catch(e => console.log('無法播放鈴聲:', e));
            
            console.log(`收到來自 ${caller} 的來電`);
        }
        
        // 接聽電話
        function acceptCall() {
            const caller = callerName.textContent;
            
            // 停止鈴聲
            ringTone.pause();
            ringTone.currentTime = 0;
            
            // 隱藏來電通知
            incomingCall.style.display = 'none';
            
            // 開始通話
            startCall(caller);
            
            console.log(`接聽來自 ${caller} 的電話`);
        }
        
        // 拒接電話
        function rejectCall() {
            const caller = callerName.textContent;
            
            // 停止鈴聲
            ringTone.pause();
            ringTone.currentTime = 0;
            
            // 隱藏來電通知
            incomingCall.style.display = 'none';
            
            console.log(`拒接來自 ${caller} 的電話`);
        }
        
        // 開始通話
        async function startCall(otherUser) {
            try {
                // 建立 WebRTC 連線
                peerConnection = new RTCPeerConnection(rtcConfiguration);
                
                // 添加本地音訊流
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // 處理遠端音訊流
                peerConnection.ontrack = (event) => {
                    remoteAudio.srcObject = event.streams[0];
                };
                
                // 切換到通話畫面
                mainScreen.style.display = 'none';
                callScreen.style.display = 'block';
                
                callingUser.textContent = otherUser;
                
                // 開始計時
                startCallTimer();
                
                // 更新用戶狀態
                document.getElementById('userStatus').textContent = '通話中';
                document.getElementById('userStatus').className = 'status in-call';
                
                console.log(`與 ${otherUser} 的通話已開始`);
                
            } catch (error) {
                console.error('建立通話連線失敗:', error);
                alert('建立通話連線失敗');
            }
        }
        
        // 開始通話計時
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                callTimerDiv.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // 切換靜音
        function toggleMute() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                isMuted = !audioTrack.enabled;
                
                muteBtn.textContent = isMuted ? '🔊 取消靜音' : '🔇 靜音';
                muteBtn.className = isMuted ? 'btn-success' : 'btn-warning';
                
                console.log(isMuted ? '已靜音' : '已取消靜音');
            }
        }
        
        // 結束通話
        function endCall() {
            // 停止計時
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // 關閉 WebRTC 連線
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // 重置音訊
            remoteAudio.srcObject = null;
            
            // 重置靜音狀態
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = true;
                }
            }
            isMuted = false;
            muteBtn.textContent = '🔇 靜音';
            muteBtn.className = 'btn-warning';
            
            // 切換回主畫面
            callScreen.style.display = 'none';
            mainScreen.style.display = 'block';
            
            // 重置用戶狀態
            document.getElementById('userStatus').textContent = '線上';
            document.getElementById('userStatus').className = 'status online';
            
            // 重置其他用戶狀態
            onlineUsers.forEach((userData, username) => {
                userData.status = 'online';
            });
            updateUserList();
            
            console.log('通話已結束');
        }
        
        // 模擬定期收到來電 (測試用)
        setInterval(() => {
            if (currentUser && mainScreen.style.display === 'block' && Math.random() > 0.7) {
                simulateIncomingCall();
            }
        }, 30000); // 每30秒有30%機率收到來電
        
        // 頁面載入完成後的初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('語音通話系統已載入');
        });
        
        // 頁面關閉前清理資源
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
        });
        
        // 處理瀏覽器權限變化
        navigator.permissions.query({name: 'microphone'}).then((result) => {
            result.onchange = () => {
                console.log('麥克風權限狀態:', result.state);
            };
        });
        
    </script>
</body>
</html>
