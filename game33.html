<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2Êó•Ê™¢Áñ´ÊåëÊà∞Á≥ªÁµ±</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--border-radius: 8px;
--gold: #fbbf24;
--silver: #9ca3af;
--bronze: #d97706;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "ÂæÆËªüÊ≠£ÈªëÈ´î", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
line-height: 1.5;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
will-change: scroll-position;
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
display: flex;
align-items: center;
justify-content: space-between;
}

.user-currency {
display: flex;
gap: 12px;
align-items: center;
}

.currency-item {
display: flex;
align-items: center;
gap: 4px;
background: rgba(255, 255, 255, 0.05);
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

/* üé® ÊåâÈàïÊ®£Âºè */
.btn {
padding: 10px 16px;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
font-size: 0.9rem;
font-weight: 500;
transition: var(--transition);
flex: 1;
position: relative;
overflow: hidden;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
min-height: 44px;
}

.btn::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
transition: left 0.5s;
}

.btn:hover::before {
left: 100%;
}

.btn-primary {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.3);
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(114, 137, 218, 0.4);
}

.btn-secondary {
background: linear-gradient(135deg, var(--warning), #e67e22);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.btn-secondary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.btn-danger {
background: linear-gradient(135deg, var(--danger), #c0392b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

.btn-shop {
background: linear-gradient(135deg, var(--gold), #f59e0b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
}

.btn-shop:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
}

/* header-actions ÊåâÈàï‰ΩàÂ±Ä */
.header-actions {
display: flex;
gap: 8px;
margin-top: 12px;
}

.header-actions .btn {
flex: 1;
font-size: 0.8rem;
padding: 8px 10px;
min-height: 36px;
}

/* üèÖ Âã≥Á´†È°ØÁ§∫Ê®£Âºè */
.user-medals {
display: flex;
gap: 4px;
margin-top: 8px;
flex-wrap: wrap;
}

.medal-icon {
display: inline-flex;
align-items: center;
justify-content: center;
width: 28px;
height: 28px;
border-radius: 50%;
font-size: 0.9rem;
border: 2px solid;
background: rgba(255, 255, 255, 0.1);
transition: var(--transition);
cursor: pointer;
}

.medal-icon:hover {
transform: scale(1.1);
}

.medal-icon.common { border-color: #84cc16; }
.medal-icon.rare { border-color: #3b82f6; }
.medal-icon.epic { border-color: #8b5cf6; }
.medal-icon.legendary { border-color: #f59e0b; }

/* üè™ ÂïÜÂ∫óÊ®£Âºè */
.shop-container {
padding: 16px;
}

.shop-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.shop-categories {
display: flex;
gap: 8px;
margin-bottom: 16px;
}

.category-btn {
padding: 8px 16px;
background: rgba(255, 255, 255, 0.05);
border: 1px solid var(--border-color);
border-radius: var(--border-radius);
color: var(--text-secondary);
cursor: pointer;
transition: var(--transition);
font-size: 0.85rem;
}

.category-btn.active {
background: var(--primary);
color: var(--text-primary);
border-color: var(--primary);
}

.shop-items {
display: grid;
gap: 12px;
}

.shop-item {
display: flex;
align-items: center;
padding: 12px;
background: rgba(255, 255, 255, 0.03);
border: 1px solid var(--border-color);
border-radius: var(--border-radius);
transition: var(--transition);
}

.shop-item:hover {
background: rgba(255, 255, 255, 0.05);
transform: translateY(-1px);
}

.shop-item.owned {
opacity: 0.6;
border-color: var(--success);
}

.shop-item.equipped {
border-color: var(--gold);
background: rgba(251, 191, 36, 0.1);
}

.medal-preview {
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
border: 2px solid;
margin-right: 12px;
}

.item-info {
flex: 1;
}

.item-name {
font-weight: 600;
margin-bottom: 4px;
}

.item-description {
font-size: 0.8rem;
color: var(--text-secondary);
margin-bottom: 4px;
}

.item-price {
font-size: 0.9rem;
color: var(--gold);
font-weight: 600;
}

.item-actions {
display: flex;
gap: 8px;
}

.btn-small {
padding: 6px 12px;
font-size: 0.8rem;
min-height: 32px;
}

/* üéí ËÉåÂåÖÊ®£Âºè */
.inventory-container {
padding: 16px;
}

.inventory-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
gap: 12px;
}

.inventory-item {
aspect-ratio: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.03);
border: 2px solid var(--border-color);
border-radius: var(--border-radius);
cursor: pointer;
transition: var(--transition);
padding: 8px;
}

.inventory-item:hover {
background: rgba(255, 255, 255, 0.08);
transform: translateY(-2px);
}

.inventory-item.equipped {
border-color: var(--gold);
background: rgba(251, 191, 36, 0.1);
}

.inventory-medal-icon {
font-size: 1.5rem;
margin-bottom: 4px;
}

.inventory-medal-name {
font-size: 0.7rem;
text-align: center;
line-height: 1.2;
}

/* ÊéíË°åÊ¶úÂã≥Á´†È°ØÁ§∫ */
.leaderboard-medals {
display: flex;
gap: 2px;
margin-left: 8px;
}

.leaderboard-medal {
width: 16px;
height: 16px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.6rem;
border: 1px solid;
}

/* ÂÖ∂‰ªñÁèæÊúâÊ®£Âºè‰øùÊåÅ‰∏çËÆä... */
.challenge-item {
padding: 16px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s ease;
}

.challenge-item:hover {
background: rgba(255, 255, 255, 0.02);
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
font-weight: 600;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 10px;
}

.champion-display {
margin-bottom: 10px;
}

.champion-card {
display: flex;
align-items: center;
justify-content: space-between;
background: linear-gradient(45deg, #FFD700, #FFA500);
color: #000;
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
font-weight: bold;
box-shadow: 0 3px 6px rgba(255, 215, 0, 0.3);
transition: var(--transition);
}

.champion-card:hover {
transform: translateY(-1px);
box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
}

.champion-empty {
display: flex;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.05);
color: var(--text-secondary);
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
border: 1px dashed rgba(255, 255, 255, 0.15);
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
backdrop-filter: blur(4px);
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 420px;
max-height: 85vh;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { transform: translateY(30px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.modal-header {
padding: 16px;
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 4px 8px;
border-radius: 4px;
transition: var(--transition);
}

.close-btn:hover {
background: rgba(255, 255, 255, 0.1);
transform: scale(1.1);
}

.modal-content {
padding: 16px;
overflow-y: auto;
max-height: calc(85vh - 68px);
min-height: 200px;
}

.leaderboard-container {
max-height: calc(60vh - 100px);
overflow-y: auto;
padding-right: 5px;
scroll-behavior: smooth;
}

.leaderboard-item {
display: flex;
align-items: center;
padding: 10px 12px;
border-bottom: 1px solid var(--border-color);
transition: var(--transition);
border-radius: 6px;
margin-bottom: 2px;
}

.leaderboard-item:hover {
background: rgba(114, 137, 218, 0.05);
transform: translateX(2px);
}

.leaderboard-item.current-user {
background: rgba(114, 137, 218, 0.1);
border-left: 3px solid var(--primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.2);
}

.rank {
min-width: 35px;
font-weight: bold;
color: var(--primary);
font-size: 1rem;
}

.user-name {
flex: 1;
margin: 0 12px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
display: flex;
align-items: center;
}

.score {
font-weight: bold;
color: var(--primary);
margin-left: auto;
font-size: 1rem;
}

.empty-leaderboard {
text-align: center;
padding: 30px 20px;
color: var(--text-secondary);
}

/* ÈüøÊáâÂºèË®≠Ë®à */
@media (max-width: 400px) {
.header-actions {
flex-direction: column;
gap: 8px;
}
.header-actions .btn {
width: 100%;
}
.user-currency {
flex-direction: column;
gap: 4px;
}
}

/* GPU Âä†ÈÄü */
.btn, .modal, .leaderboard-item, .champion-card, .medal-icon {
transform: translateZ(0);
backface-visibility: hidden;
}

/* ÂÖ∂‰ªñÁèæÊúâÊ®£Âºè... */
.exam-container { padding: 20px; }
.exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: var(--border-radius); }
.timer { font-size: 1.4rem; color: var(--primary); font-weight: bold; padding: 8px 16px; background: rgba(114, 137, 218, 0.1); border-radius: var(--border-radius); }
.question { background: rgba(255, 255, 255, 0.03); padding: 24px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color); }
.options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 20px; }
.option-btn { width: 100%; text-align: left; padding: 14px 16px; border-radius: var(--border-radius); transition: var(--transition); }
.option-btn.correct { background: linear-gradient(135deg, var(--success), #27ae60); }
.option-btn.wrong { background: linear-gradient(135deg, var(--danger), #c0392b); }
.exam-result { text-align: center; padding: 30px 20px; }
.exam-result h2 { margin-bottom: 20px; color: var(--primary); }
.exam-result p { margin-bottom: 12px; font-size: 1.05rem; }
.exam-result button { margin: 8px; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 3px; }
::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--primary), var(--primary-dark)); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, var(--primary-dark), var(--primary)); }
.sudoku-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; background: var(--border-color); padding: 8px; border-radius: var(--border-radius); margin-bottom: 20px; }
.sudoku-cell { width: 100%; aspect-ratio: 1; background: var(--bg-primary); border: 2px solid transparent; border-radius: 6px; color: var(--text-primary); font-size: 1.5rem; text-align: center; cursor: pointer; transition: var(--transition); }
.sudoku-cell:disabled { background: var(--bg-secondary); color: var(--text-secondary); cursor: not-allowed; }
.sudoku-cell:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(114, 137, 218, 0.3); }
.sudoku-cell::-webkit-inner-spin-button, .sudoku-cell::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.loading { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
.loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(114, 137, 218, 0.3); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; will-change: transform; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media (max-width: 400px) { .options { grid-template-columns: 1fr; } }
.btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
::selection { background: rgba(114, 137, 218, 0.3); color: var(--text-primary); }
</style>
</head>
<body>
<!-- ËºâÂÖ•‰∏≠Áï´Èù¢ -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
Ê≠£Âú®È©óË≠âÁôªÂÖ•ÁãÄÊÖã...
</div>
</div>

<!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
<div class="title-text">
<span>üéØ</span>
<h1>T2Êó•Ê™¢Áñ´ÊåëÊà∞Á≥ªÁµ±</h1>
<button class="btn btn-danger" onclick="logout()">ÁôªÂá∫</button>
</div>
<div class="user-info">
<div>
<span id="currentUserWelcome">Ê≠°ËøéÂõû‰æÜÔºåËºâÂÖ•‰∏≠...</span>
<div class="user-currency">
<div class="currency-item">
  <span>üí∞</span>
  <span id="userCoins">0</span>
</div>
<div class="currency-item">
  <span>üíé</span>
  <span id="userGems">0</span>
</div>
</div>
<div class="user-medals" id="userMedals"></div>
</div>
<span class="connection-status" id="connectionStatus">Áî®Êà∂ÈÄ£Á∑ö‰∏≠</span>
</div>
</div>
<div class="header-actions">
<button class="btn btn-primary" onclick="backToT2()">üè† ËøîÂõûT2Êó•</button>
<button class="btn btn-secondary" onclick="showTotalLeaderboard()">üèÜ Á∏ΩÂàÜÊéíË°åÊ¶ú</button>
<button class="btn btn-shop" onclick="showShop()">üè™ ÂïÜÂ∫ó</button>
<button class="btn btn-primary" onclick="showInventory()">üéí ËÉåÂåÖ</button>
</div>
</header>

<!-- ÊåëÊà∞È†ÖÁõÆÂàóË°® - Â∞áÂãïÊÖãÁîüÊàê -->
<div id="challengesList">
<!-- ÊåëÊà∞È†ÖÁõÆÂ∞áÂú®Ê≠§ÂãïÊÖãÁîüÊàê -->
</div>
</div>

<!-- üè™ ÂïÜÂ∫óÊ®°ÊÖãË¶ñÁ™ó -->
<div class="modal-overlay" id="shopModal">
<div class="modal">
<div class="modal-header">
<h2>üè™ Âã≥Á´†ÂïÜÂ∫ó</h2>
<button class="close-btn" onclick="hideShop()">√ó</button>
</div>
<div class="modal-content">
<div class="shop-container">
<div class="shop-categories">
<button class="category-btn active" onclick="filterShop('all')">ÂÖ®ÈÉ®</button>
<button class="category-btn" onclick="filterShop('common')">ÊôÆÈÄö</button>
<button class="category-btn" onclick="filterShop('rare')">Á®ÄÊúâ</button>
<button class="category-btn" onclick="filterShop('epic')">Âè≤Ë©©</button>
<button class="category-btn" onclick="filterShop('legendary')">ÂÇ≥Ë™™</button>
</div>
<div class="shop-items" id="shopItems">
<!-- ÂïÜÂ∫óÁâ©ÂìÅÂ∞áÂú®Ê≠§ÂãïÊÖãÁîüÊàê -->
</div>
</div>
</div>
</div>
</div>

<!-- üéí ËÉåÂåÖÊ®°ÊÖãË¶ñÁ™ó -->
<div class="modal-overlay" id="inventoryModal">
<div class="modal">
<div class="modal-header">
<h2>üéí Âã≥Á´†ËÉåÂåÖ</h2>
<button class="close-btn" onclick="hideInventory()">√ó</button>
</div>
<div class="modal-content">
<div class="inventory-container">
<p style="margin-bottom: 16px; color: var(--text-secondary);">ÈªûÊìäÂã≥Á´†Ë£ùÂÇô/Âç∏‰∏ã (ÊúÄÂ§öË£ùÂÇô5ÂÄã)</p>
<div class="inventory-grid" id="inventoryGrid">
<!-- ËÉåÂåÖÁâ©ÂìÅÂ∞áÂú®Ê≠§ÂãïÊÖãÁîüÊàê -->
</div>
</div>
</div>
</div>
</div>

<!-- ÊéíË°åÊ¶úÊ®°ÊÖãË¶ñÁ™ó -->
<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">ÊéíË°åÊ¶ú</h2>
<button class="close-btn" onclick="hideLeaderboard()">√ó</button>
</div>
<div class="modal-content" id="leaderboardContent">
</div>
</div>
</div>

<script>
// Firebase ÈÖçÁΩÆ
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöFirebase ÂàùÂßãÂåñ
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÈ°åÂ∫´Âø´Âèñ
let examQuestions = {};
let questionsCache = new Map();

// üèÖ Âã≥Á´†Á≥ªÁµ±ËÆäÊï∏
let medalsData = {};
let userMedals = { owned: [], equipped: [] };
let userCurrency = { coins: 0, gems: 0 };

// üìù ËÄÉË©¶ÈÖçÁΩÆËÆäÊï∏ (ÂæûJSONËºâÂÖ•)
let examConfigs = {};

// üèÖ ËºâÂÖ•Âã≥Á´†Ë≥áÊñô
async function loadMedalsData() {
try {
const cacheKey = 'medals_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
medalsData = JSON.parse(cached);
console.log('‚úÖ ÂæûÂø´ÂèñËºâÂÖ•Âã≥Á´†Ë≥áÊñô');
return;
}

const resp = await fetch('medals.json');
if (!resp.ok) throw new Error(`ËºâÂÖ•Âã≥Á´†Ë≥áÊñôÂ§±ÊïóÔºö${resp.status}`);
medalsData = await resp.json();

localStorage.setItem(cacheKey, JSON.stringify(medalsData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('‚úÖ Âã≥Á´†Ë≥áÊñôÂ∑≤ËºâÂÖ•‰∏¶Âø´Âèñ', medalsData);
} catch (err) {
console.error('ËºâÂÖ•Âã≥Á´†Ë≥áÊñôÂ§±Êïó:', err);
// Êèê‰æõÈ†êË®≠Âã≥Á´†Ë≥áÊñô
medalsData = {
medals: {},
rarityColors: {
common: "#84cc16",
rare: "#3b82f6", 
epic: "#8b5cf6",
legendary: "#f59e0b"
},
maxEquippedMedals: 5
};
}
}

// üìù ËºâÂÖ•ËÄÉË©¶ÈÖçÁΩÆ
async function loadExamConfigs() {
try {
const cacheKey = 'exam_configs_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examConfigs = JSON.parse(cached);
console.log('‚úÖ ÂæûÂø´ÂèñËºâÂÖ•ËÄÉË©¶ÈÖçÁΩÆ');
return;
}

const resp = await fetch('exam-configs.json');
if (!resp.ok) throw new Error(`ËºâÂÖ•ËÄÉË©¶ÈÖçÁΩÆÂ§±ÊïóÔºö${resp.status}`);
examConfigs = await resp.json();

localStorage.setItem(cacheKey, JSON.stringify(examConfigs));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('‚úÖ ËÄÉË©¶ÈÖçÁΩÆÂ∑≤ËºâÂÖ•‰∏¶Âø´Âèñ', examConfigs);
} catch (err) {
console.error('ËºâÂÖ•ËÄÉË©¶ÈÖçÁΩÆÂ§±Êïó:', err);
alert('Á≥ªÁµ±ÈåØË™§ÔºöÁÑ°Ê≥ïËºâÂÖ•ËÄÉË©¶ÈÖçÁΩÆÊ™îÊ°à');
}
}

// üìù ÂãïÊÖãÁîüÊàêÊåëÊà∞È†ÖÁõÆÂàóË°®
function renderChallengesList() {
const challengesContainer = document.getElementById('challengesList');
const fragment = document.createDocumentFragment();

Object.entries(examConfigs).forEach(([examType, config]) => {
const challengeItem = document.createElement('div');
challengeItem.className = 'challenge-item';

challengeItem.innerHTML = `
<h3 class="challenge-title">${config.name}</h3>
<p class="challenge-info" style="color:#ef4444;">${config.description}</p>
<div class="champion-display" data-exam-type="${examType}">
<!-- Ê¶úÈ¶ñË≥áÊñôÂ∞áÂú®Ê≠§ÂãïÊÖãËºâÂÖ• -->
</div>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('${examType}')">ÈñãÂßãËÄÉË©¶</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${examType}')">Êü•ÁúãÊéíË°åÊ¶ú</button>
</div>
`;

fragment.appendChild(challengeItem);
});

challengesContainer.appendChild(fragment);
}

// üèÖ ËºâÂÖ•Áî®Êà∂Âã≥Á´†ÂíåË≤®Âπ£Ë≥áÊñô
async function loadUserMedalsAndCurrency() {
try {
const snapshot = await database.ref(`users/${currentUser}/medals`).once('value');
const medalSnapshot = snapshot.val() || {};
userMedals = {
owned: medalSnapshot.owned || [],
equipped: medalSnapshot.equipped || []
};

const currencySnapshot = await database.ref(`users/${currentUser}/currency`).once('value');
userCurrency = currencySnapshot.val() || { coins: 0, gems: 0 };

updateCurrencyDisplay();
updateMedalDisplay();
} catch (err) {
console.error('ËºâÂÖ•Áî®Êà∂Âã≥Á´†Ë≥áÊñôÂ§±Êïó:', err);
}
}

// üèÖ Êõ¥Êñ∞Ë≤®Âπ£È°ØÁ§∫
function updateCurrencyDisplay() {
document.getElementById('userCoins').textContent = userCurrency.coins;
document.getElementById('userGems').textContent = userCurrency.gems;
}

// üèÖ Êõ¥Êñ∞Âã≥Á´†È°ØÁ§∫
function updateMedalDisplay() {
const medalContainer = document.getElementById('userMedals');
medalContainer.innerHTML = '';

userMedals.equipped.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (medal) {
const medalIcon = document.createElement('div');
medalIcon.className = `medal-icon ${medal.rarity}`;
medalIcon.style.borderColor = medal.color;
medalIcon.innerHTML = medal.icon;
medalIcon.title = `${medal.name}: ${medal.description}`;
medalContainer.appendChild(medalIcon);
}
});
}

// üèÖ Ê™¢Êü•Âã≥Á´†Ëß£ÈéñÊ¢ù‰ª∂
async function checkMedalUnlocks(examType, score, totalTime, fastAnswers) {
const newUnlocks = [];

for (const [medalId, medal] of Object.entries(medalsData.medals)) {
if (userMedals.owned.includes(medalId)) continue;

let unlocked = false;
const condition = medal.unlockCondition;

switch (condition.type) {
case 'fast_answers':
if (fastAnswers >= condition.value) unlocked = true;
break;
case 'perfect_score':
if (score >= examConfigs[examType].questionCount * 10) unlocked = true;
break;
case 'high_score':
if (condition.examType === examType && score >= condition.value) unlocked = true;
break;
case 'first_exam':
unlocked = true;
break;
// ÂÖ∂‰ªñÊ¢ù‰ª∂ÂèØ‰ª•Âú®ÈÄôË£°Ê∑ªÂä†
}

if (unlocked) {
newUnlocks.push(medalId);
userMedals.owned.push(medalId);
}
}

if (newUnlocks.length > 0) {
await saveMedalData();
showMedalUnlockNotification(newUnlocks);
}
}

// üèÖ È°ØÁ§∫Âã≥Á´†Ëß£ÈéñÈÄöÁü•
function showMedalUnlockNotification(medalIds) {
medalIds.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (medal) {
// Á∞°ÂñÆÁöÑÈÄöÁü•ÔºåÂèØ‰ª•ÂæåÁ∫åÂÑ™ÂåñÁÇ∫Êõ¥Â•ΩÁöÑUI
setTimeout(() => {
alert(`üéâ ÊÅ≠ÂñúËß£ÈéñÂã≥Á´†Ôºö${medal.icon} ${medal.name}\n${medal.description}`);
}, 500);
}
});
}

// üèÖ ‰øùÂ≠òÂã≥Á´†Ë≥áÊñô
async function saveMedalData() {
try {
await database.ref(`users/${currentUser}/medals`).set(userMedals);
updateMedalDisplay();
} catch (err) {
console.error('‰øùÂ≠òÂã≥Á´†Ë≥áÊñôÂ§±Êïó:', err);
}
}

// üèÖ ‰øùÂ≠òË≤®Âπ£Ë≥áÊñô
async function saveCurrencyData() {
try {
await database.ref(`users/${currentUser}/currency`).set(userCurrency);
updateCurrencyDisplay();
} catch (err) {
console.error('‰øùÂ≠òË≤®Âπ£Ë≥áÊñôÂ§±Êïó:', err);
}
}

// üè™ È°ØÁ§∫ÂïÜÂ∫ó
async function showShop() {
document.getElementById('shopModal').style.display = 'flex';
await renderShopItems();
}

// üè™ Èö±ËóèÂïÜÂ∫ó
function hideShop() {
document.getElementById('shopModal').style.display = 'none';
}

// üè™ ÁØ©ÈÅ∏ÂïÜÂ∫óÁâ©ÂìÅ
function filterShop(category) {
document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
event.target.classList.add('active');
renderShopItems(category);
}

// üè™ Ê∏≤ÊüìÂïÜÂ∫óÁâ©ÂìÅ
async function renderShopItems(filter = 'all') {
const shopContainer = document.getElementById('shopItems');
shopContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div>ËºâÂÖ•ÂïÜÂ∫ó‰∏≠...</div>';

const medals = Object.values(medalsData.medals);
const filteredMedals = filter === 'all' ? medals : medals.filter(medal => medal.rarity === filter);

const fragment = document.createDocumentFragment();

filteredMedals.forEach(medal => {
const isOwned = userMedals.owned.includes(medal.id);
const isEquipped = userMedals.equipped.includes(medal.id);
const canAfford = userCurrency.coins >= medal.price;

const item = document.createElement('div');
item.className = `shop-item ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;

item.innerHTML = `
<div class="medal-preview" style="border-color: ${medal.color};">
${medal.icon}
</div>
<div class="item-info">
<div class="item-name" style="color: ${medal.color};">${medal.name}</div>
<div class="item-description">${medal.description}</div>
<div class="item-price">üí∞ ${medal.price}</div>
</div>
<div class="item-actions">
${isOwned ? 
'<span class="btn btn-small btn-secondary">Â∑≤ÊìÅÊúâ</span>' :
`<button class="btn btn-small btn-primary ${!canAfford ? 'disabled' : ''}" 
onclick="buyMedal('${medal.id}')" ${!canAfford ? 'disabled' : ''}>
Ë≥ºË≤∑
</button>`
}
</div>
`;

fragment.appendChild(item);
});

shopContainer.innerHTML = '';
shopContainer.appendChild(fragment);
}

// üè™ Ë≥ºË≤∑Âã≥Á´†
async function buyMedal(medalId) {
const medal = medalsData.medals[medalId];
if (!medal || userMedals.owned.includes(medalId)) return;

if (userCurrency.coins < medal.price) {
alert('üí∞ ÈáëÂπ£‰∏çË∂≥ÔºÅ');
return;
}

if (confirm(`Á¢∫ÂÆöË¶ÅË≥ºË≤∑ ${medal.icon} ${medal.name} ÂóéÔºü\nÂÉπÊ†ºÔºöüí∞ ${medal.price}`)) {
userCurrency.coins -= medal.price;
userMedals.owned.push(medalId);

await Promise.all([saveMedalData(), saveCurrencyData()]);
await renderShopItems();
alert(`üéâ ÊàêÂäüË≥ºË≤∑ ${medal.icon} ${medal.name}ÔºÅ`);
}
}

// üéí È°ØÁ§∫ËÉåÂåÖ
async function showInventory() {
document.getElementById('inventoryModal').style.display = 'flex';
await renderInventory();
}

// üéí Èö±ËóèËÉåÂåÖ
function hideInventory() {
document.getElementById('inventoryModal').style.display = 'none';
}

// üéí Ê∏≤ÊüìËÉåÂåÖ
async function renderInventory() {
const inventoryGrid = document.getElementById('inventoryGrid');
inventoryGrid.innerHTML = '<div class="loading"><div class="loading-spinner"></div>ËºâÂÖ•ËÉåÂåÖ‰∏≠...</div>';

const fragment = document.createDocumentFragment();

userMedals.owned.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (!medal) return;

const isEquipped = userMedals.equipped.includes(medalId);
const item = document.createElement('div');
item.className = `inventory-item ${isEquipped ? 'equipped' : ''}`;
item.onclick = () => toggleMedalEquip(medalId);

item.innerHTML = `
<div class="inventory-medal-icon" style="color: ${medal.color};">
${medal.icon}
</div>
<div class="inventory-medal-name">${medal.name}</div>
${isEquipped ? '<div style="font-size: 0.6rem; color: var(--gold);">Â∑≤Ë£ùÂÇô</div>' : ''}
`;

fragment.appendChild(item);
});

if (userMedals.owned.length === 0) {
const emptyMsg = document.createElement('div');
emptyMsg.className = 'empty-leaderboard';
emptyMsg.innerHTML = '<p>üéí ËÉåÂåÖÁ©∫Á©∫Â¶Ç‰πü</p><p>ÂéªÂïÜÂ∫óË≥ºË≤∑‰∏Ä‰∫õÂã≥Á´†ÂêßÔºÅ</p>';
fragment.appendChild(emptyMsg);
}

inventoryGrid.innerHTML = '';
inventoryGrid.appendChild(fragment);
}

// üéí ÂàáÊèõÂã≥Á´†Ë£ùÂÇôÁãÄÊÖã
async function toggleMedalEquip(medalId) {
const isEquipped = userMedals.equipped.includes(medalId);

if (isEquipped) {
// Âç∏‰∏ãÂã≥Á´†
userMedals.equipped = userMedals.equipped.filter(id => id !== medalId);
} else {
// Ë£ùÂÇôÂã≥Á´†
if (userMedals.equipped.length >= medalsData.maxEquippedMedals) {
alert(`ÊúÄÂ§öÂè™ËÉΩË£ùÂÇô ${medalsData.maxEquippedMedals} ÂÄãÂã≥Á´†ÔºÅ`);
return;
}
userMedals.equipped.push(medalId);
}

await saveMedalData();
await renderInventory();
}

async function loadExamQuestions() {
try {
// Ê™¢Êü•Âø´Âèñ
const cacheKey = 'exam_questions_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// Âø´ÂèñÊúâÊïàÊúü 1 Â∞èÊôÇ
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examQuestions = JSON.parse(cached);
console.log('‚úÖ ÂæûÂø´ÂèñËºâÂÖ•È°åÂ∫´');
return;
}

const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`ËºâÂÖ•È°åÂ∫´Â§±ÊïóÔºö${resp.status}`);
examQuestions = await resp.json();

// ÂÑ≤Â≠òÂà∞Âø´Âèñ
localStorage.setItem(cacheKey, JSON.stringify(examQuestions));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('‚úÖ È°åÂ∫´Â∑≤ËºâÂÖ•‰∏¶Âø´Âèñ', examQuestions);
} catch (err) {
console.error(err);
alert('Á≥ªÁµ±ÈåØË™§ÔºöÁÑ°Ê≥ïËºâÂÖ•È°åÂ∫´Ê™îÊ°à');
}
}

// ÂÖ®ÂüüËÆäÊï∏
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÈò≤ÊäñÂáΩÊï∏
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
const later = () => {
clearTimeout(timeout);
func(...args);
};
clearTimeout(timeout);
timeout = setTimeout(later, wait);
};
}

// Â∑•ÂÖ∑ÂáΩÊï∏ÔºöÂæûÊï∏ÁµÑ‰∏≠ÁßªÈô§ÁâπÂÆöÂÖÉÁ¥†
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// Âº∑Âà∂ÁôªÂá∫ÂáΩÊï∏
function forceLogout(message = 'ÁôªÂÖ•È©óË≠âÂ§±ÊïóÔºåË´ãÈáçÊñ∞ÁôªÂÖ•') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index.html';
}

// Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖãÂíåÊôÇÊïà
function checkLoginStatus() {
const flag = localStorage.getItem('t2_login');
const time = localStorage.getItem('t2_login_time');
const user = localStorage.getItem('t2_login_user');
if (flag!=='yes' || !time || !user) {
forceLogout('Êú™Ê™¢Ê∏¨Âà∞ÊúâÊïàÁôªÂÖ•ÁãÄÊÖã');
return false;
}
if (Date.now()-parseInt(time) > 3600000) {
forceLogout('ÁôªÂÖ•ÊôÇÈñìÂ∑≤Ë∂ÖÈÅé1Â∞èÊôÇÔºåË´ãÈáçÊñ∞ÁôªÂÖ•');
return false;
}
return user;
}

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÁî®Êà∂Ë≥áÊñôÂø´Âèñ
async function loadUsersData() {
try {
// Ê™¢Êü•Âø´Âèñ
const cacheKey = 'users_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// Âø´ÂèñÊúâÊïàÊúü 5 ÂàÜÈêò
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 300000) {
usersData = JSON.parse(cached);
console.log('‚úÖ ÂæûÂø´ÂèñËºâÂÖ•Áî®Êà∂Ë≥áÊñô');
return;
}

const snapshot = await database.ref('users').once('value');
usersData = snapshot.val() || {};

// ÂÑ≤Â≠òÂà∞Âø´Âèñ
localStorage.setItem(cacheKey, JSON.stringify(usersData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('‚úÖ Áî®Êà∂Ë≥áÊñôÂ∑≤ËºâÂÖ•‰∏¶Âø´Âèñ');
} catch (err) {
console.error('ËºâÂÖ•Áî®Êà∂Ë≥áÊñôÂ§±Êïó:', err);
}
}

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÊ¶úÈ¶ñË≥áÊñôÂø´Âèñ
const championCache = new Map();

async function getChampion(examType) {
// Ê™¢Êü•Âø´Âèñ
const cacheKey = `champion_${examType}`;
const cached = championCache.get(cacheKey);
if (cached && (Date.now() - cached.timestamp) < 60000) { // 1ÂàÜÈêòÂø´Âèñ
return cached.data;
}

try {
const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').limitToLast(1).once('value');
const data = snapshot.val();
if (data) {
const users = Object.keys(data);
const champion = data[users[0]];
const result = { user: users[0], ...champion };

// Âø´ÂèñÁµêÊûú
championCache.set(cacheKey, {
data: result,
timestamp: Date.now()
});
return result;
}
return null;
} catch (err) {
console.error('Áç≤ÂèñÊ¶úÈ¶ñÂ§±Êïó:', err);
return null;
}
}

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÊâπÈáèÊõ¥Êñ∞Ê¶úÈ¶ñÈ°ØÁ§∫
const debouncedUpdateChampions = debounce(updateAllChampions, 300);

async function updateAllChampions() {
const examTypes = Object.keys(examConfigs);
const promises = examTypes.map(async (examType) => {
const champion = await getChampion(examType);
const championDisplay = document.querySelector(`[data-exam-type="${examType}"]`);
if (!championDisplay) return;

if (champion) {
championDisplay.innerHTML = `
<div class="champion-card">
<span>üèÜ Ê¶úÈ¶ñÔºö${champion.user}</span>
<span>${champion.score}ÂàÜ</span>
</div>
`;
} else {
championDisplay.innerHTML = `
<div class="champion-empty">
<span>üèÜ Â∞öÁÑ°Ê¶úÈ¶ñ</span>
</div>
`;
}
});

await Promise.all(promises);
}

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÁôªÂÖ•È©óË≠âÂíåÂàùÂßãÂåñ
async function initializeApp() {
try {
const user = checkLoginStatus();
if (!user) return;

currentUser = user;
document.getElementById('currentUserWelcome').textContent = `Ê≠°ËøéÂõû‰æÜÔºå${user}`;

// ‰∏¶Ë°åËºâÂÖ•Ë≥áÊñô
await Promise.all([
loadExamQuestions(),
loadUsersData(),
loadMedalsData(),
loadExamConfigs()
]);

// ËºâÂÖ•Áî®Êà∂Âã≥Á´†ÂíåË≤®Âπ£
await loadUserMedalsAndCurrency();

// ÁîüÊàêÊåëÊà∞È†ÖÁõÆÂàóË°®
renderChallengesList();

// Êõ¥Êñ∞Ê¶úÈ¶ñÈ°ØÁ§∫
await updateAllChampions();

// Èö±ËóèËºâÂÖ•Áï´Èù¢ÔºåÈ°ØÁ§∫‰∏ªË¶ÅÂÖßÂÆπ
document.getElementById('loadingScreen').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';

} catch (err) {
console.error('ÂàùÂßãÂåñÂ§±Êïó:', err);
alert('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
}
}

// ÁôªÂá∫ÂäüËÉΩ
function logout() {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
// Ê∏ÖÈô§Âø´Âèñ
localStorage.removeItem('exam_questions_v1');
localStorage.removeItem('exam_questions_v1_time');
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
localStorage.removeItem('medals_data_v1');
localStorage.removeItem('medals_data_v1_time');
localStorage.removeItem('exam_configs_v1');
localStorage.removeItem('exam_configs_v1_time');
championCache.clear();
window.location.href = 'index.html';
}

// ËøîÂõûT2Êó•
function backToT2() {
window.location.href = 'dashboard.html';
}

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÈ°åÁõÆÈö®Ê©üÂåñ
function shuffleArray(array) {
const newArray = [...array];
for (let i = newArray.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[newArray[i], newArray[j]] = [newArray[j], newArray[i]];
}
return newArray;
}

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöËÄÉË©¶ÈñãÂßãÂÑ™Âåñ
function startExam(examType) {
if (!examQuestions[examType]) {
alert('È°åÂ∫´ËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶');
return;
}

const config = examConfigs[examType];
const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

if (questions.length < config.questionCount) {
alert(`È°åÂ∫´È°åÁõÆ‰∏çË∂≥ÔºÅÈúÄË¶Å ${config.questionCount} È°åÔºå‰ΩÜÂè™Êúâ ${questions.length} È°å`);
return;
}

currentExam = examType;
currentQuestions = questions;
currentQuestionIndex = 0;
examStartTime = Date.now();
userScores = { fastAnswers: 0, correctAnswers: 0 };

// üèÖ ÁçéÂãµÈáëÂπ£ (ËÄÉË©¶ÈñãÂßãÁçéÂãµ)
userCurrency.coins += 5;
saveCurrencyData();

showExamInterface();
displayQuestion();
startQuestionTimer();
}

// È°ØÁ§∫ËÄÉË©¶‰ªãÈù¢ - ‰øÆÊ≠£ÈÅ∏ÊìáÂô®ÂïèÈ°å
function showExamInterface() {
const container = document.getElementById('mainContent'); // ‰øÆÊ≠£Ôºö‰ΩøÁî®Ê≠£Á¢∫ÁöÑID
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
</div>
<div class="question" id="questionContainer">
<!-- È°åÁõÆÂ∞áÂú®Ê≠§È°ØÁ§∫ -->
</div>
<div class="exam-progress">
<p>È°åÁõÆ <span id="currentQuestionNum">1</span> / ${config.questionCount}</p>
<p>ÂæóÂàÜÔºö<span id="currentScore">0</span> ÂàÜ</p>
</div>
</div>
`;
}

// È°ØÁ§∫È°åÁõÆ
function displayQuestion() {
const question = currentQuestions[currentQuestionIndex];
const questionContainer = document.getElementById('questionContainer');
const config = examConfigs[currentExam];

document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;

if (currentExam === 'sudoku') {
// Êï∏Áç®ÁâπÊÆäÈ°ØÁ§∫
questionContainer.innerHTML = `
<h3>${question.question}</h3>
<div class="sudoku-grid">
${question.grid.map((cell, index) => 
`<input type="number" class="sudoku-cell" 
${cell !== 0 ? `value="${cell}" disabled` : ''} 
min="1" max="4" 
data-index="${index}"
${cell === 0 ? 'onchange="checkSudokuAnswer()"' : ''}>`
).join('')}
</div>
<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">
Â°´ÂÖ•1-4ÁöÑÊï∏Â≠óÔºå‰ΩøÊØèË°åÊØèÂàóÈÉΩÂåÖÂê´1-4
</p>
`;
} else {
// ‰∏ÄËà¨È°åÁõÆÈ°ØÁ§∫
const optionsHtml = question.options.map((option, index) => 
`<button class="btn option-btn" onclick="selectAnswer(${index})">${option}</button>`
).join('');

questionContainer.innerHTML = `
<h3>${question.question}</h3>
<div class="options">
${optionsHtml}
</div>
`;
}

questionStartTime = Date.now();
}

// ÈñãÂßãÈ°åÁõÆË®àÊôÇÂô®
function startQuestionTimer() {
const config = examConfigs[currentExam];
let timeLeft = config.timePerQuestion;
const timerElement = document.getElementById('timer');

examTimer = setInterval(() => {
timeLeft--;
timerElement.textContent = timeLeft;

if (timeLeft <= 0) {
clearInterval(examTimer);
// ÊôÇÈñìÂà∞ÔºåËá™ÂãïË∑≥Âà∞‰∏ã‰∏ÄÈ°å
if (currentExam === 'sudoku') {
nextQuestion(false);
} else {
selectAnswer(-1); // -1 Ë°®Á§∫Êú™‰ΩúÁ≠î
}
}
}, 1000);
}

// ÈÅ∏ÊìáÁ≠îÊ°à - ‰øÆÊ≠£ÁâàÊú¨
function selectAnswer(selectedIndex) {
clearInterval(examTimer);
const question = currentQuestions[currentQuestionIndex];
const isCorrect = selectedIndex === question.correct;
const responseTime = (Date.now() - questionStartTime) / 1000;
const config = examConfigs[currentExam];

// üèÖ Ê™¢Êü•Âø´ÈÄüÁ≠îÈ°å
if (responseTime <= config.fastAnswerThreshold) {
userScores.fastAnswers++;
}

// üîß ‰øÆÊ≠£ÔºöÂè™ÊúâÁ≠îÂ∞çÊâçÂä†ÂàÜÔºå‰∏çÁµ¶Èå¢
if (isCorrect) {
userScores.correctAnswers++;
// ÁßªÈô§ÔºöuserCurrency.coins += 2; // Á≠îÂ∞ç‰∏çÁµ¶Èå¢
}

// È°ØÁ§∫Á≠îÊ°àÂèçÈ•ã
showAnswerFeedback(selectedIndex, question.correct, responseTime);

// Âª∂ÈÅ≤ÂæåÈÄ≤ÂÖ•‰∏ã‰∏ÄÈ°å
setTimeout(() => {
nextQuestion(isCorrect);
}, 1500);
}

// Êï∏Áç®Á≠îÊ°àÊ™¢Êü• - ‰øÆÊ≠£ÁâàÊú¨
function checkSudokuAnswer() {
const cells = document.querySelectorAll('.sudoku-cell');
const userGrid = Array.from(cells).map(cell => parseInt(cell.value) || 0);
const question = currentQuestions[currentQuestionIndex];

// Ê™¢Êü•ÊòØÂê¶Â°´ÂÆå
const isEmpty = userGrid.some(cell => cell === 0);
if (isEmpty) return;

// Ê™¢Êü•Á≠îÊ°à
const isCorrect = JSON.stringify(userGrid) === JSON.stringify(question.solution);
const responseTime = (Date.now() - questionStartTime) / 1000;

clearInterval(examTimer);

// üîß ‰øÆÊ≠£ÔºöÂè™ÊúâÁ≠îÂ∞çÊâçÂä†ÂàÜÔºå‰∏çÁµ¶Èå¢
if (isCorrect) {
userScores.correctAnswers++;
// ÁßªÈô§ÔºöuserCurrency.coins += 2; // Á≠îÂ∞ç‰∏çÁµ¶Èå¢
}

// üèÖ Ê™¢Êü•Âø´ÈÄüÁ≠îÈ°å
const config = examConfigs[currentExam];
if (responseTime <= config.fastAnswerThreshold) {
userScores.fastAnswers++;
}

// È°ØÁ§∫Êï∏Áç®ÂèçÈ•ã
cells.forEach(cell => cell.disabled = true);
const feedbackDiv = document.createElement('div');
feedbackDiv.style.cssText = `
margin-top: 15px; 
text-align: center; 
font-size: 0.9rem;
color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};
`;
feedbackDiv.innerHTML = `${isCorrect ? '‚úÖ Ê≠£Á¢∫ÔºÅ' : '‚ùå ÈåØË™§ÔºÅ'} ÂõûÊáâÊôÇÈñì: ${responseTime.toFixed(1)}Áßí`;
document.getElementById('questionContainer').appendChild(feedbackDiv);

setTimeout(() => {
nextQuestion(isCorrect);
}, 1500);
}

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöËÄÉË©¶ÈñãÂßãÂÑ™Âåñ - ‰øÆÊ≠£ÁâàÊú¨
function startExam(examType) {
if (!examQuestions[examType]) {
alert('È°åÂ∫´ËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶');
return;
}

const config = examConfigs[examType];
const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

if (questions.length < config.questionCount) {
alert(`È°åÂ∫´È°åÁõÆ‰∏çË∂≥ÔºÅÈúÄË¶Å ${config.questionCount} È°åÔºå‰ΩÜÂè™Êúâ ${questions.length} È°å`);
return;
}

currentExam = examType;
currentQuestions = questions;
currentQuestionIndex = 0;
examStartTime = Date.now();
userScores = { fastAnswers: 0, correctAnswers: 0 };

// üîß ÁßªÈô§ËÄÉË©¶ÈñãÂßãÁçéÂãµÈáëÂπ£
// userCurrency.coins += 5; // ÁßªÈô§ÈÄôË°å
// saveCurrencyData(); // ÁßªÈô§ÈÄôË°å

showExamInterface();
displayQuestion();
startQuestionTimer();
}

// È°ØÁ§∫ËÄÉË©¶‰ªãÈù¢ - Âä†ÂÖ•Ê£ÑÊ¨äÊåâÈàï
function showExamInterface() {
const container = document.getElementById('mainContent');
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
<button class="btn btn-danger" onclick="quitExam()" style="margin-left: 10px;">Ê£ÑÊ¨ä</button>
</div>
<div class="question" id="questionContainer">
<!-- È°åÁõÆÂ∞áÂú®Ê≠§È°ØÁ§∫ -->
</div>
<div class="exam-progress">
<p>È°åÁõÆ <span id="currentQuestionNum">1</span> / ${config.questionCount}</p>
<p>ÂæóÂàÜÔºö<span id="currentScore">0</span> ÂàÜ</p>
</div>
</div>
`;
}

// üÜï Ê£ÑÊ¨äÂäüËÉΩ
function quitExam() {
if (confirm('Á¢∫ÂÆöË¶ÅÊ£ÑÊ¨äÂóéÔºüÊ£ÑÊ¨äÂ∞á‰∏çÊúÉÁç≤Âæó‰ªª‰ΩïÂàÜÊï∏ÂíåÁçéÂãµ„ÄÇ')) {
clearInterval(examTimer);

// Áõ¥Êé•ËøîÂõû‰∏ªÈ†ÅÔºå‰∏ç‰øùÂ≠ò‰ªª‰ΩïÊàêÁ∏æ
location.reload();
}
}

// ÁµêÊùüËÄÉË©¶ - ‰øÆÊ≠£ÁâàÊú¨
async function finishExam() {
clearInterval(examTimer);
const totalTime = (Date.now() - examStartTime) / 1000;
const finalScore = userScores.correctAnswers * 10;
const config = examConfigs[currentExam];

// üîß ‰øÆÊ≠£ÔºöÂè™ÊúâÊªøÂàÜÊâçÁµ¶Èå¢
let coinsEarned = 0;
if (finalScore >= config.questionCount * 10) {
// ÊªøÂàÜÁçéÂãµ
coinsEarned = 50; // ÊªøÂàÜÁçéÂãµ50ÈáëÂπ£
userCurrency.coins += coinsEarned;
await saveCurrencyData();
}

// üèÖ Ê™¢Êü•Âã≥Á´†Ëß£Èéñ
await checkMedalUnlocks(currentExam, finalScore, totalTime, userScores.fastAnswers);

// ‰øùÂ≠òÊàêÁ∏æÂà∞ÊéíË°åÊ¶ú
await saveScoreToLeaderboard(currentExam, finalScore, totalTime);

// È°ØÁ§∫ÁµêÊûú
showExamResult(finalScore, totalTime, coinsEarned);

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÊ∏ÖÈô§Âø´Âèñ‰ª•Áç≤ÂèñÊúÄÊñ∞ÊéíË°åÊ¶ú
const cacheKey = `champion_${currentExam}`;
championCache.delete(cacheKey);
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
}

// È°ØÁ§∫ËÄÉË©¶ÁµêÊûú - ‰øÆÊ≠£ÁâàÊú¨
function showExamResult(score, totalTime, coinsEarned) {
const container = document.getElementById('mainContent');
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-result">
<h2>üéâ ËÄÉË©¶ÂÆåÊàêÔºÅ</h2>
<p><strong>ËÄÉË©¶È°ûÂûãÔºö</strong>${config.name}</p>
<p><strong>ÊúÄÁµÇÂæóÂàÜÔºö</strong>${score} ÂàÜ</p>
<p><strong>Ê≠£Á¢∫È°åÊï∏Ôºö</strong>${userScores.correctAnswers} / ${config.questionCount}</p>
<p><strong>Âø´ÈÄüÁ≠îÈ°åÔºö</strong>${userScores.fastAnswers} È°å</p>
<p><strong>Á∏ΩËÄóÊôÇÔºö</strong>${totalTime.toFixed(1)} Áßí</p>
${coinsEarned > 0 ? 
`<p style="color: var(--gold);"><strong>üéâ ÊªøÂàÜÁçéÂãµÔºö</strong>üí∞ ${coinsEarned}</p>` : 
`<p style="color: var(--text-secondary);">üí∞ Êú™ÈÅîÊªøÂàÜÔºåÁÑ°ÈáëÂπ£ÁçéÂãµ</p>`
}
<div style="margin-top: 20px;">
<button class="btn btn-primary" onclick="location.reload()">ËøîÂõû‰∏ªÈ†Å</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">Êü•ÁúãÊéíË°åÊ¶ú</button>
</div>
</div>
`;
}

// È°ØÁ§∫Á≠îÊ°àÂèçÈ•ã - ‰øÆÊ≠£ÁâàÊú¨
function showAnswerFeedback(selectedIndex, correctIndex, responseTime) {
const options = document.querySelectorAll('.option-btn');
const config = examConfigs[currentExam];

options.forEach((btn, index) => {
btn.disabled = true;
if (index === correctIndex) {
btn.classList.add('correct');
} else if (index === selectedIndex && selectedIndex !== correctIndex) {
btn.classList.add('wrong');
}
});

// È°ØÁ§∫ÂõûÊáâÊôÇÈñìÂíåÂø´ÈÄüÁ≠îÈ°åÊèêÁ§∫
const feedbackDiv = document.createElement('div');
feedbackDiv.style.cssText = `
margin-top: 15px; 
text-align: center; 
font-size: 0.9rem;
color: var(--text-secondary);
`;

let feedbackText = `ÂõûÊáâÊôÇÈñì: ${responseTime.toFixed(1)}Áßí`;
if (responseTime <= config.fastAnswerThreshold) {
feedbackText += ` ‚ö° Âø´ÈÄüÁ≠îÈ°åÔºÅ`;
}

feedbackDiv.innerHTML = feedbackText;
document.getElementById('questionContainer').appendChild(feedbackDiv);
}

// Êï∏Áç®Á≠îÊ°àÊ™¢Êü•
function checkSudokuAnswer() {
const cells = document.querySelectorAll('.sudoku-cell');
const userGrid = Array.from(cells).map(cell => parseInt(cell.value) || 0);
const question = currentQuestions[currentQuestionIndex];

// Ê™¢Êü•ÊòØÂê¶Â°´ÂÆå
const isEmpty = userGrid.some(cell => cell === 0);
if (isEmpty) return;

// Ê™¢Êü•Á≠îÊ°à
const isCorrect = JSON.stringify(userGrid) === JSON.stringify(question.solution);
const responseTime = (Date.now() - questionStartTime) / 1000;

clearInterval(examTimer);

if (isCorrect) {
userScores.correctAnswers++;
userCurrency.coins += 2;
}

// üèÖ Ê™¢Êü•Âø´ÈÄüÁ≠îÈ°å
const config = examConfigs[currentExam];
if (responseTime <= config.fastAnswerThreshold) {
userScores.fastAnswers++;
}

// È°ØÁ§∫Êï∏Áç®ÂèçÈ•ã
cells.forEach(cell => cell.disabled = true);
const feedbackDiv = document.createElement('div');
feedbackDiv.style.cssText = `
margin-top: 15px; 
text-align: center; 
font-size: 0.9rem;
color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};
`;
feedbackDiv.innerHTML = `${isCorrect ? '‚úÖ Ê≠£Á¢∫ÔºÅ' : '‚ùå ÈåØË™§ÔºÅ'} ÂõûÊáâÊôÇÈñì: ${responseTime.toFixed(1)}Áßí`;
document.getElementById('questionContainer').appendChild(feedbackDiv);

setTimeout(() => {
nextQuestion(isCorrect);
}, 1500);
}

// ÈÄ≤ÂÖ•‰∏ã‰∏ÄÈ°åÊàñÁµêÊùüËÄÉË©¶
function nextQuestion(wasCorrect) {
// Êõ¥Êñ∞ÂàÜÊï∏È°ØÁ§∫
const currentScore = userScores.correctAnswers * 10;
document.getElementById('currentScore').textContent = currentScore;

currentQuestionIndex++;

if (currentQuestionIndex >= currentQuestions.length) {
// ËÄÉË©¶ÁµêÊùü
finishExam();
} else {
// ‰∏ã‰∏ÄÈ°å
displayQuestion();
startQuestionTimer();
}
}

// ÁµêÊùüËÄÉË©¶
async function finishExam() {
clearInterval(examTimer);
const totalTime = (Date.now() - examStartTime) / 1000;
const finalScore = userScores.correctAnswers * 10;

// üèÖ ÂÆåÊàêËÄÉË©¶ÁçéÂãµÈáëÂπ£
userCurrency.coins += 10;
await saveCurrencyData();

// üèÖ Ê™¢Êü•Âã≥Á´†Ëß£Èéñ
await checkMedalUnlocks(currentExam, finalScore, totalTime, userScores.fastAnswers);

// ‰øùÂ≠òÊàêÁ∏æÂà∞ÊéíË°åÊ¶ú
await saveScoreToLeaderboard(currentExam, finalScore, totalTime);

// È°ØÁ§∫ÁµêÊûú
showExamResult(finalScore, totalTime);

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÊ∏ÖÈô§Âø´Âèñ‰ª•Áç≤ÂèñÊúÄÊñ∞ÊéíË°åÊ¶ú
const cacheKey = `champion_${currentExam}`;
championCache.delete(cacheKey);
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
}

// ‰øùÂ≠òÊàêÁ∏æÂà∞ÊéíË°åÊ¶ú
async function saveScoreToLeaderboard(examType, score, totalTime) {
try {
const scoreData = {
score: score,
totalTime: totalTime,
timestamp: Date.now(),
fastAnswers: userScores.fastAnswers,
correctAnswers: userScores.correctAnswers
};

await database.ref(`leaderboard/${examType}/${currentUser}`).set(scoreData);
console.log('‚úÖ ÊàêÁ∏æÂ∑≤‰øùÂ≠òÂà∞ÊéíË°åÊ¶ú');
} catch (err) {
console.error('‰øùÂ≠òÊàêÁ∏æÂ§±Êïó:', err);
}
}

// È°ØÁ§∫ËÄÉË©¶ÁµêÊûú
function showExamResult(score, totalTime) {
const container = document.getElementById('mainContent'); // ‰øÆÊ≠£Ôºö‰ΩøÁî®Ê≠£Á¢∫ÁöÑID
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-result">
<h2>üéâ ËÄÉË©¶ÂÆåÊàêÔºÅ</h2>
<p><strong>ËÄÉË©¶È°ûÂûãÔºö</strong>${config.name}</p>
<p><strong>ÊúÄÁµÇÂæóÂàÜÔºö</strong>${score} ÂàÜ</p>
<p><strong>Ê≠£Á¢∫È°åÊï∏Ôºö</strong>${userScores.correctAnswers} / ${config.questionCount}</p>
<p><strong>Âø´ÈÄüÁ≠îÈ°åÔºö</strong>${userScores.fastAnswers} È°å</p>
<p><strong>Á∏ΩËÄóÊôÇÔºö</strong>${totalTime.toFixed(1)} Áßí</p>
<p><strong>Áç≤ÂæóÈáëÂπ£Ôºö</strong>üí∞ ${5 + (userScores.correctAnswers * 2) + 10}</p>
<div style="margin-top: 20px;">
<button class="btn btn-primary" onclick="location.reload()">ËøîÂõû‰∏ªÈ†Å</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">Êü•ÁúãÊéíË°åÊ¶ú</button>
</div>
</div>
`;
}

// È°ØÁ§∫ÊéíË°åÊ¶ú
async function showLeaderboard(examType) {
document.getElementById('modalTitle').textContent = `${examConfigs[examType].name} - ÊéíË°åÊ¶ú`;
document.getElementById('leaderboardModal').style.display = 'flex';
document.getElementById('leaderboardContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div>ËºâÂÖ•ÊéíË°åÊ¶ú‰∏≠...</div>';

try {
const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').once('value');
const data = snapshot.val();

if (!data) {
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>üìä Êö´ÁÑ°ÊéíË°åÊ¶úË®òÈåÑ</p>
<p>ÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÊåëÊà∞ËÄÖÂêßÔºÅ</p>
</div>
`;
return;
}

// ËΩâÊèõ‰∏¶ÊéíÂ∫èË≥áÊñô
const leaderboardData = Object.entries(data).map(([user, userData]) => ({
user,
...userData
})).sort((a, b) => {
// ÂÖàÊåâÂàÜÊï∏ÊéíÂ∫èÔºåÂàÜÊï∏Áõ∏ÂêåÊôÇÊåâÊôÇÈñìÊéíÂ∫èÔºàÊôÇÈñìÁü≠ÁöÑÊéíÂâçÈù¢Ôºâ
if (b.score !== a.score) {
return b.score - a.score;
}
return a.totalTime - b.totalTime;
});

// ÁîüÊàêÊéíË°åÊ¶úHTML
const leaderboardHTML = `
<div class="leaderboard-container">
${leaderboardData.map((entry, index) => {
const isCurrentUser = entry.user === currentUser;
const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;

const medalDisplay = getUserMedalDisplay(entry.user);
return `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">${rankIcon}</div>
<div class="user-name">
${entry.user}
${medalDisplay}
</div>
<div class="score">${entry.score}ÂàÜ</div>
</div>
`;
}).join('')}
</div>
`;

document.getElementById('leaderboardContent').innerHTML = leaderboardHTML;

} catch (err) {
console.error('ËºâÂÖ•ÊéíË°åÊ¶úÂ§±Êïó:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>‚ùå ËºâÂÖ•ÊéíË°åÊ¶úÂ§±Êïó</p>
<p>Ë´ãÁ®çÂæåÂÜçË©¶</p>
</div>
`;
}
}

// È°ØÁ§∫Á∏ΩÂàÜÊéíË°åÊ¶ú
async function showTotalLeaderboard() {
document.getElementById('modalTitle').textContent = 'üèÜ Á∏ΩÂàÜÊéíË°åÊ¶ú';
document.getElementById('leaderboardModal').style.display = 'flex';
document.getElementById('leaderboardContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div>ËºâÂÖ•Á∏ΩÂàÜÊéíË°åÊ¶ú‰∏≠...</div>';

try {
const snapshot = await database.ref('leaderboard').once('value');
const allData = snapshot.val();

if (!allData) {
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>üìä Êö´ÁÑ°Á∏ΩÂàÜÊéíË°åÊ¶úË®òÈåÑ</p>
<p>ÈñãÂßãÊåëÊà∞ÂêßÔºÅ</p>
</div>
`;
return;
}

// Ë®àÁÆóÊØèÂÄãÁî®Êà∂ÁöÑÁ∏ΩÂàÜÂíåÁ∏ΩÊôÇÈñì
const userTotals = {};
Object.entries(allData).forEach(([examType, examData]) => {
Object.entries(examData).forEach(([user, userData]) => {
if (!userTotals[user]) {
userTotals[user] = { totalScore: 0, totalTime: 0, examCount: 0 };
}
userTotals[user].totalScore += userData.score;
userTotals[user].totalTime += userData.totalTime;
userTotals[user].examCount += 1;
});
});

// ËΩâÊèõ‰∏¶ÊéíÂ∫èË≥áÊñô
const totalLeaderboardData = Object.entries(userTotals).map(([user, data]) => ({
user,
...data
})).sort((a, b) => {
// ÂÖàÊåâÁ∏ΩÂàÜÊéíÂ∫èÔºåÁ∏ΩÂàÜÁõ∏ÂêåÊôÇÊåâÁ∏ΩÊôÇÈñìÊéíÂ∫è
if (b.totalScore !== a.totalScore) {
return b.totalScore - a.totalScore;
}
return a.totalTime - b.totalTime;
});

// ÁîüÊàêÁ∏ΩÂàÜÊéíË°åÊ¶úHTML
const leaderboardHTML = `
<div class="leaderboard-container">
${totalLeaderboardData.map((entry, index) => {
const isCurrentUser = entry.user === currentUser;
const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
const medalDisplay = getUserMedalDisplay(entry.user);
return `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">${rankIcon}</div>
<div class="user-name">
${entry.user}
${medalDisplay}
</div>
<div class="score">
<div>${entry.totalScore}ÂàÜ</div>
<div style="font-size: 0.7rem; color: var(--text-secondary);">
${entry.examCount}Â†¥ËÄÉË©¶ | ${entry.totalTime.toFixed(1)}Áßí
</div>
</div>
</div>
`;
}).join('')}
</div>
`;

document.getElementById('leaderboardContent').innerHTML = leaderboardHTML;

} catch (err) {
console.error('ËºâÂÖ•Á∏ΩÂàÜÊéíË°åÊ¶úÂ§±Êïó:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>‚ùå ËºâÂÖ•Á∏ΩÂàÜÊéíË°åÊ¶úÂ§±Êïó</p>
<p>Ë´ãÁ®çÂæåÂÜçË©¶</p>
</div>
`;
}
}

// Áç≤ÂèñÁî®Êà∂Âã≥Á´†È°ØÁ§∫
function getUserMedalDisplay(username) {
// ÂæûFirebaseÁç≤ÂèñÁî®Êà∂Âã≥Á´†Ë≥áÊñô‰∏¶È°ØÁ§∫
// ÈÄôË£°ÂÖàËøîÂõûÁ©∫Â≠ó‰∏≤ÔºåÂèØ‰ª•ÂæåÁ∫åÂÑ™ÂåñÁÇ∫ÂØ¶ÈöõÁöÑÂã≥Á´†È°ØÁ§∫
try {
// Â¶ÇÊûúÊòØÁï∂ÂâçÁî®Êà∂ÔºåÁõ¥Êé•‰ΩøÁî®Â∑≤ËºâÂÖ•ÁöÑÂã≥Á´†Ë≥áÊñô
if (username === currentUser && userMedals.equipped.length > 0) {
return `<div class="leaderboard-medals">
${userMedals.equipped.slice(0, 3).map(medalId => {
const medal = medalsData.medals[medalId];
return medal ? `<div class="leaderboard-medal ${medal.rarity}" style="border-color: ${medal.color};">${medal.icon}</div>` : '';
}).join('')}
</div>`;
}
} catch (err) {
console.error('Áç≤ÂèñÁî®Êà∂Âã≥Á´†È°ØÁ§∫Â§±Êïó:', err);
}
return '';
}

// Èö±ËóèÊéíË°åÊ¶ú
function hideLeaderboard() {
document.getElementById('leaderboardModal').style.display = 'none';
}

// È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
initializeApp();
});

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöË¶ñÁ™óÂ§ßÂ∞èËÆäÂåñÊôÇÁöÑÈüøÊáâÂºèËôïÁêÜ
window.addEventListener('resize', debounce(() => {
// ÂèØ‰ª•Âú®ÈÄôË£°Ê∑ªÂä†ÈüøÊáâÂºèÈÇèËºØ
}, 250));

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÈ†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñËôïÁêÜ
document.addEventListener('visibilitychange', function() {
if (document.hidden) {
// È†ÅÈù¢Èö±ËóèÊôÇÊö´ÂÅúË®àÊôÇÂô®
if (examTimer) {
clearInterval(examTimer);
}
} else {
// È†ÅÈù¢È°ØÁ§∫ÊôÇÊÅ¢Âæ©Ë®àÊôÇÂô®
if (currentExam && currentQuestionIndex < currentQuestions.length) {
startQuestionTimer();
}
}
});

// üöÄ ÊïàËÉΩÂÑ™ÂåñÔºöÈò≤Ê≠¢Ë®òÊÜ∂È´îÊ¥©Êºè
window.addEventListener('beforeunload', function() {
if (examTimer) {
clearInterval(examTimer);
}
championCache.clear();
});
</script>
</body>
</html>

