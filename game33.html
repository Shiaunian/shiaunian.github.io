<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--border-radius: 8px;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "å¾®è»Ÿæ­£é»‘é«”", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
line-height: 1.5;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
will-change: scroll-position;
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
margin-left: 8px;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

/* ğŸ¨ CSS å¾®èª¿ï¼šæŒ‰éˆ•æ¨£å¼å„ªåŒ– */
.btn {
padding: 10px 16px;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
font-size: 0.9rem;
font-weight: 500;
transition: var(--transition);
flex: 1;
position: relative;
overflow: hidden;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
min-height: 44px; /* è§¸æ§å‹å¥½ */
}

.btn::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
transition: left 0.5s;
}

.btn:hover::before {
left: 100%;
}

.btn-primary {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.3);
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(114, 137, 218, 0.4);
}

.btn-secondary {
background: linear-gradient(135deg, var(--warning), #e67e22);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.btn-secondary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.btn-danger {
background: linear-gradient(135deg, var(--danger), #c0392b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

/* ğŸ¨ CSS å¾®èª¿ï¼šheader-actions æŒ‰éˆ•ä½ˆå±€å„ªåŒ– */
.header-actions {
display: flex;
gap: 10px;
margin-top: 12px;
}

.header-actions .btn {
flex: 1;
font-size: 0.85rem;
padding: 8px 12px;
min-height: 40px;
}

.challenge-item {
padding: 16px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s ease;
}

.challenge-item:hover {
background: rgba(255, 255, 255, 0.02);
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
font-weight: 600;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 10px;
}

/* ğŸ¨ CSS å¾®èª¿ï¼šæ¦œé¦–é¡¯ç¤ºå„ªåŒ– */
.champion-display {
margin-bottom: 10px;
}

.champion-card {
display: flex;
align-items: center;
justify-content: space-between;
background: linear-gradient(45deg, #FFD700, #FFA500);
color: #000;
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
font-weight: bold;
box-shadow: 0 3px 6px rgba(255, 215, 0, 0.3);
transition: var(--transition);
}

.champion-card:hover {
transform: translateY(-1px);
box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
}

.champion-empty {
display: flex;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.05);
color: var(--text-secondary);
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
border: 1px dashed rgba(255, 255, 255, 0.15);
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
backdrop-filter: blur(4px);
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 420px;
max-height: 85vh;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { transform: translateY(30px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.modal-header {
padding: 16px;
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 4px 8px;
border-radius: 4px;
transition: var(--transition);
}

.close-btn:hover {
background: rgba(255, 255, 255, 0.1);
transform: scale(1.1);
}

.modal-content {
padding: 16px;
overflow-y: auto;
max-height: calc(85vh - 68px);
min-height: 200px;
}

/* ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè™›æ“¬æ»¾å‹•å„ªåŒ– */
.leaderboard-container {
max-height: calc(60vh - 100px);
overflow-y: auto;
padding-right: 5px;
scroll-behavior: smooth;
}

.leaderboard-item {
display: flex;
align-items: center;
padding: 10px 12px;
border-bottom: 1px solid var(--border-color);
transition: var(--transition);
border-radius: 6px;
margin-bottom: 2px;
}

.leaderboard-item:hover {
background: rgba(114, 137, 218, 0.05);
transform: translateX(2px);
}

.leaderboard-item.current-user {
background: rgba(114, 137, 218, 0.1);
border-left: 3px solid var(--primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.2);
}

.rank {
min-width: 35px;
font-weight: bold;
color: var(--primary);
font-size: 1rem;
}

.user-name {
flex: 1;
margin: 0 12px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.score {
font-weight: bold;
color: var(--primary);
margin-left: auto;
font-size: 1rem;
}

.empty-leaderboard {
text-align: center;
padding: 30px 20px;
color: var(--text-secondary);
}

.exam-container {
padding: 20px;
}

.exam-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding: 16px;
background: rgba(255, 255, 255, 0.03);
border-radius: var(--border-radius);
}

.timer {
font-size: 1.4rem;
color: var(--primary);
font-weight: bold;
padding: 8px 16px;
background: rgba(114, 137, 218, 0.1);
border-radius: var(--border-radius);
}

.question {
background: rgba(255, 255, 255, 0.03);
padding: 24px;
border-radius: var(--border-radius);
margin-bottom: 20px;
border: 1px solid var(--border-color);
}

.options {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 12px;
margin-top: 20px;
}

.option-btn {
width: 100%;
text-align: left;
padding: 14px 16px;
border-radius: var(--border-radius);
transition: var(--transition);
}

.option-btn.correct {
background: linear-gradient(135deg, var(--success), #27ae60);
}

.option-btn.wrong {
background: linear-gradient(135deg, var(--danger), #c0392b);
}

.exam-result {
text-align: center;
padding: 30px 20px;
}

.exam-result h2 {
margin-bottom: 20px;
color: var(--primary);
}

.exam-result p {
margin-bottom: 12px;
font-size: 1.05rem;
}

.exam-result button {
margin: 8px;
}

/* ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ»¾å‹•æ¢å„ªåŒ– */
::-webkit-scrollbar {
width: 6px;
}

::-webkit-scrollbar-track {
background: var(--bg-primary);
border-radius: 3px;
}

::-webkit-scrollbar-thumb {
background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
background: linear-gradient(to bottom, var(--primary-dark), var(--primary));
}

.sudoku-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 6px;
background: var(--border-color);
padding: 8px;
border-radius: var(--border-radius);
margin-bottom: 20px;
}

.sudoku-cell {
width: 100%;
aspect-ratio: 1;
background: var(--bg-primary);
border: 2px solid transparent;
border-radius: 6px;
color: var(--text-primary);
font-size: 1.5rem;
text-align: center;
cursor: pointer;
transition: var(--transition);
}

.sudoku-cell:disabled {
background: var(--bg-secondary);
color: var(--text-secondary);
cursor: not-allowed;
}

.sudoku-cell:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(114, 137, 218, 0.3);
}

.sudoku-cell::-webkit-inner-spin-button,
.sudoku-cell::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}

/* ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè¼‰å…¥å‹•ç•«å„ªåŒ– */
.loading {
text-align: center;
padding: 40px 20px;
color: var(--text-secondary);
}

.loading-spinner {
display: inline-block;
width: 24px;
height: 24px;
border: 3px solid rgba(114, 137, 218, 0.3);
border-top: 3px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-right: 12px;
will-change: transform;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* ğŸ¨ éŸ¿æ‡‰å¼å„ªåŒ– */
@media (max-width: 400px) {
.options {
grid-template-columns: 1fr;
}
.header-actions {
flex-direction: column;
gap: 8px;
}
.header-actions .btn {
width: 100%;
}
}

/* ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šGPU åŠ é€Ÿ */
.btn, .modal, .leaderboard-item, .champion-card {
transform: translateZ(0);
backface-visibility: hidden;
}

/* ğŸ¨ CSS å¾®èª¿ï¼šç„¦é»å¯è¦‹æ€§ */
.btn:focus-visible {
outline: 2px solid var(--primary);
outline-offset: 2px;
}

/* ğŸ¨ CSS å¾®èª¿ï¼šé¸æ“‡ç‹€æ…‹ */
::selection {
background: rgba(114, 137, 218, 0.3);
color: var(--text-primary);
}
</style>
</head>
<body>
<!-- è¼‰å…¥ä¸­ç•«é¢ -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
æ­£åœ¨é©—è­‰ç™»å…¥ç‹€æ…‹...
</div>
</div>

<!-- ä¸»è¦å…§å®¹ -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
<div class="title-text">
  <span>ğŸ¯</span>
  <h1>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</h1>
  <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
</div>
<div class="user-info">
  <span id="currentUserWelcome">æ­¡è¿å›ä¾†ï¼Œè¼‰å…¥ä¸­...</span>
  <span class="connection-status" id="connectionStatus">ç”¨æˆ¶é€£ç·šä¸­</span>
</div>
</div>
<div class="header-actions">
<button class="btn btn-primary" onclick="backToT2()">ğŸ  è¿”å›T2æ—¥</button>
<button class="btn btn-secondary" onclick="showTotalLeaderboard()">ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ</button>
</div>
</header>

<div class="challenge-item">
<h3 class="challenge-title">â­åˆ†æµè€ƒè©¦æŒ‘æˆ°â­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ60ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('basic')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('basic')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­è‹±æ–‡è€ƒè©¦åŸºç¤ç‰ˆâ­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ15ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('food1')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('food1')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­è‹±æ–‡è€ƒè©¦é€²éšç‰ˆâ­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ10ç§’ä½œç­”æ™‚é–“ï¼Œå…±20é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('food')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('food')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­è‹±æ–‡è€ƒè©¦å¼·åŒ–ç‰ˆâ­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ10ç§’ä½œç­”æ™‚é–“ï¼Œå…±30é¡Œ ä¸€é¡Œ10åˆ†(æœ‰é»å›°é›£)</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('foodplus')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('foodplus')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­å‰å°è¤‡æŸ¥æŒ‘æˆ°â­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ60ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('precheck')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('precheck')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">è¦å®šæŒ‘æˆ°</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ60ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('rule')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('rule')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">ğŸ‡°ğŸ‡·éŸ“èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡°ğŸ‡·</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ12ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('korean')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('korean')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">ğŸ‡¯ğŸ‡µæ—¥èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡¯ğŸ‡µ</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ12ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('japanese')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('japanese')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">ğŸ‡»ğŸ‡³è¶Šå—èªè©å½™æŒ‘æˆ°ğŸ‡»ğŸ‡³</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ12ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('vietnamese')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('vietnamese')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">åˆéšæ•¸ç¨æŒ‘æˆ°</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ80ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('sudoku')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('sudoku')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>
</div>

<!-- æ’è¡Œæ¦œæ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">æ’è¡Œæ¦œ</h2>
<button class="close-btn" onclick="hideLeaderboard()">Ã—</button>
</div>
<div class="modal-content" id="leaderboardContent">
</div>
</div>
</div>

<script>
// Firebase é…ç½®
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šFirebase åˆå§‹åŒ–
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œåº«å¿«å–
let examQuestions = {};
let questionsCache = new Map();

async function loadExamQuestions() {
try {
// æª¢æŸ¥å¿«å–
const cacheKey = 'exam_questions_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// å¿«å–æœ‰æ•ˆæœŸ 1 å°æ™‚
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examQuestions = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥é¡Œåº«');
return;
}

const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š${resp.status}`);
examQuestions = await resp.json();

// å„²å­˜åˆ°å¿«å–
localStorage.setItem(cacheKey, JSON.stringify(examQuestions));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… é¡Œåº«å·²è¼‰å…¥ä¸¦å¿«å–', examQuestions);
} catch (err) {
console.error(err);
alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥é¡Œåº«æª”æ¡ˆ');
}
}

// â”€â”€â”€ è€ƒè©¦é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const examConfigs = {
basic:       { name:'â­åˆ†æµè€ƒè©¦æŒ‘æˆ°â­',    timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
food1:       { name:'â­è‹±æ–‡è€ƒè©¦åŸºç¤ç‰ˆâ­',    timePerQuestion:15, questionCount:15, fastAnswerThreshold:2.5,questions:[] },
food:        { name:'â­è‹±æ–‡è€ƒè©¦é€²éšç‰ˆâ­',    timePerQuestion:10, questionCount:20, fastAnswerThreshold:2,  questions:[] },
foodplus:    { name:'â­è‹±æ–‡è€ƒè©¦å¼·åŒ–ç‰ˆâ­',    timePerQuestion:10, questionCount:30, fastAnswerThreshold:2.5,questions:[] },
precheck:    { name:'å‰å°è¤‡æŸ¥æŒ‘æˆ°',        timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
rule:        { name:'è¦å®šæŒ‘æˆ°',            timePerQuestion:60, questionCount:10, fastAnswerThreshold:5,  questions:[] },
korean:      { name:'ğŸ‡°ğŸ‡·éŸ“èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡°ğŸ‡·', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
japanese:    { name:'ğŸ‡¯ğŸ‡µæ—¥èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡¯ğŸ‡µ', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
vietnamese:  { name:'ğŸ‡»ğŸ‡³è¶Šå—èªè©å½™æŒ‘æˆ°ğŸ‡»ğŸ‡³', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
sudoku:      { name:'åˆéšæ•¸ç¨æŒ‘æˆ°',        timePerQuestion:80, questionCount:10, fastAnswerThreshold:30, questions:[] }
};

// å…¨åŸŸè®Šæ•¸
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé˜²æŠ–å‡½æ•¸
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
const later = () => {
clearTimeout(timeout);
func(...args);
};
clearTimeout(timeout);
timeout = setTimeout(later, wait);
};
}

// å·¥å…·å‡½æ•¸ï¼šå¾æ•¸çµ„ä¸­ç§»é™¤ç‰¹å®šå…ƒç´ 
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// å¼·åˆ¶ç™»å‡ºå‡½æ•¸
function forceLogout(message = 'ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index.html';
}

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ™‚æ•ˆ
function checkLoginStatus() {
const flag = localStorage.getItem('t2_login');
const time = localStorage.getItem('t2_login_time');
const user = localStorage.getItem('t2_login_user');
if (flag!=='yes' || !time || !user) {
forceLogout('æœªæª¢æ¸¬åˆ°æœ‰æ•ˆç™»å…¥ç‹€æ…‹');
return false;
}
if (Date.now()-parseInt(time) > 3600000) {
forceLogout('ç™»å…¥æ™‚é–“å·²è¶…é1å°æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
return false;
}
return user;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç”¨æˆ¶è³‡æ–™å¿«å–
async function loadUsersData() {
try {
// æª¢æŸ¥å¿«å–
const cacheKey = 'users_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage
.getItem(cacheTime + '_time');

// å¿«å–æœ‰æ•ˆæœŸ 5 åˆ†é˜
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 300000) {
usersData = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥ç”¨æˆ¶è³‡æ–™');
return;
}

const snapshot = await database.ref('users').once('value');
usersData = snapshot.val() || {};

// å„²å­˜åˆ°å¿«å–
localStorage.setItem(cacheKey, JSON.stringify(usersData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… ç”¨æˆ¶è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–');
} catch (err) {
console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ¦œé¦–è³‡æ–™å¿«å–
const championCache = new Map();

async function getChampion(examType) {
// æª¢æŸ¥å¿«å–
const cacheKey = `champion_${examType}`;
const cached = championCache.get(cacheKey);
if (cached && (Date.now() - cached.timestamp) < 60000) { // 1åˆ†é˜å¿«å–
return cached.data;
}

try {
const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').limitToLast(1).once('value');
const data = snapshot.val();
if (data) {
const users = Object.keys(data);
const champion = data[users[0]];
const result = { user: users[0], ...champion };

// å¿«å–çµæœ
championCache.set(cacheKey, {
data: result,
timestamp: Date.now()
});
return result;
}
return null;
} catch (err) {
console.error('ç²å–æ¦œé¦–å¤±æ•—:', err);
return null;
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ‰¹é‡æ›´æ–°æ¦œé¦–é¡¯ç¤º
const debouncedUpdateChampions = debounce(updateAllChampions, 300);

async function updateAllChampions() {
const examTypes = Object.keys(examConfigs);
const promises = examTypes.map(async (examType) => {
const champion = await getChampion(examType);
const challengeItem = document.querySelector(`[onclick*="'${examType}'"]`).closest('.challenge-item');
let championDisplay = challengeItem.querySelector('.champion-display');

if (!championDisplay) {
championDisplay = document.createElement('div');
championDisplay.className = 'champion-display';
challengeItem.querySelector('.challenge-info').after(championDisplay);
}

if (champion) {
championDisplay.innerHTML = `
<div class="champion-card">
<span>ğŸ† æ¦œé¦–ï¼š${champion.user}</span>
<span>${champion.score}åˆ†</span>
</div>
`;
} else {
championDisplay.innerHTML = `
<div class="champion-empty">
<span>ğŸ† å°šç„¡æ¦œé¦–</span>
</div>
`;
}
});

await Promise.all(promises);
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç™»å…¥é©—è­‰å’Œåˆå§‹åŒ–
async function initializeApp() {
try {
const user = checkLoginStatus();
if (!user) return;

currentUser = user;
document.getElementById('currentUserWelcome').textContent = `æ­¡è¿å›ä¾†ï¼Œ${user}`;

// ä¸¦è¡Œè¼‰å…¥è³‡æ–™
await Promise.all([
loadExamQuestions(),
loadUsersData()
]);

// æ›´æ–°æ¦œé¦–é¡¯ç¤º
await updateAllChampions();

// éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
document.getElementById('loadingScreen').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';

} catch (err) {
console.error('åˆå§‹åŒ–å¤±æ•—:', err);
alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
}
}

// ç™»å‡ºåŠŸèƒ½
function logout() {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
// æ¸…é™¤å¿«å–
localStorage.removeItem('exam_questions_v1');
localStorage.removeItem('exam_questions_v1_time');
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
championCache.clear();
window.location.href = 'index.html';
}

// è¿”å›T2æ—¥
function backToT2() {
window.location.href = 'dashboard.html';
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œç›®éš¨æ©ŸåŒ–
function shuffleArray(array) {
const newArray = [...array];
for (let i = newArray.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[newArray[i], newArray[j]] = [newArray[j], newArray[i]];
}
return newArray;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒè©¦é–‹å§‹å„ªåŒ–
function startExam(examType) {
if (!examQuestions[examType]) {
alert('é¡Œåº«è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
return;
}

const config = examConfigs[examType];
const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

if (questions.length === 0) {
alert('æ­¤è€ƒè©¦é¡å‹æš«ç„¡é¡Œç›®');
return;
}

currentExam = examType;
currentQuestions = questions;
currentQuestionIndex = 0;
userScores = { fastAnswers: 0, correctAnswers: 0 };
examStartTime = Date.now();

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šDOM æ‰¹é‡æ›´æ–°
const container = document.querySelector('.container');
container.innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
<button class="btn btn-danger" onclick="abandonExam()">ğŸš« æ”¾æ£„è€ƒè©¦</button>
</div>
<div id="questionContainer"></div>
</div>
`;

showQuestion();
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œç›®é¡¯ç¤ºå„ªåŒ–
function showQuestion() {
if (currentQuestionIndex >= currentQuestions.length) {
showExamResult();
return;
}

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const container = document.getElementById('questionContainer');

questionStartTime = Date.now();

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment
const fragment = document.createDocumentFragment();

if (currentExam === 'sudoku') {
// æ•¸ç¨é¡Œç›®
const questionDiv = document.createElement('div');
questionDiv.className = 'question';
questionDiv.innerHTML = `
<h3>ç¬¬ ${currentQuestionIndex + 1} é¡Œ / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="sudoku-grid" id="sudokuGrid"></div>
<button class="btn btn-primary" onclick="submitSudokuAnswer()">æäº¤ç­”æ¡ˆ</button>
`;
fragment.appendChild(questionDiv);

container.innerHTML = '';
container.appendChild(fragment);

// ç”Ÿæˆæ•¸ç¨ç¶²æ ¼
const grid = document.getElementById('sudokuGrid');
for (let i = 0; i < 16; i++) {
const cell = document.createElement('input');
cell.type = 'number';
cell.className = 'sudoku-cell';
cell.min = '1';
cell.max = '4';
cell.id = `cell-${i}`;
if (question.given && question.given[i]) {
cell.value = question.given[i];
cell.disabled = true;
}
grid.appendChild(cell);
}
} else {
// é¸æ“‡é¡Œ
const questionDiv = document.createElement('div');
questionDiv.className = 'question';
questionDiv.innerHTML = `
<h3>ç¬¬ ${currentQuestionIndex + 1} é¡Œ / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="options">
${question.options.map((option, index) => 
`<button class="btn btn-primary option-btn" onclick="selectAnswer(${index})">${option}</button>`
).join('')}
</div>
`;
fragment.appendChild(questionDiv);

container.innerHTML = '';
container.appendChild(fragment);
}

startQuestionTimer();
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè¨ˆæ™‚å™¨å„ªåŒ–
function startQuestionTimer() {
const config = examConfigs[currentExam];
let timeLeft = config.timePerQuestion;
const timerElement = document.getElementById('timer');

clearInterval(examTimer);
examTimer = setInterval(() => {
timeLeft--;
timerElement.textContent = timeLeft;

if (timeLeft <= 5) {
timerElement.style.color = '#ef4444';
timerElement.style.animation = 'pulse 0.5s infinite';
}

if (timeLeft <= 0) {
clearInterval(examTimer);
selectAnswer(-1); // æ™‚é–“åˆ°ï¼Œè¦–ç‚ºç­”éŒ¯
}
}, 1000);
}

// é¸æ“‡ç­”æ¡ˆ
function selectAnswer(selectedIndex) {
clearInterval(examTimer);
const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;

const isCorrect = selectedIndex === question.correct;
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) userScores.fastAnswers++;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè¦–è¦ºå›é¥‹å„ªåŒ–
const options = document.querySelectorAll('.option-btn');
options.forEach((btn, index) => {
btn.disabled = true;
if (index === question.correct) {
btn.classList.add('correct');
} else if (index === selectedIndex && !isCorrect) {
btn.classList.add('wrong');
}
});

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 1500);
}

// æ•¸ç¨ç­”æ¡ˆæäº¤
function submitSudokuAnswer() {
clearInterval(examTimer);
const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;

const userAnswer = [];
for (let i = 0; i < 16; i++) {
const cell = document.getElementById(`cell-${i}`);
userAnswer.push(parseInt(cell.value) || 0);
}

const isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.solution);
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) userScores.fastAnswers++;
}

// è¦–è¦ºå›é¥‹
const grid = document.getElementById('sudokuGrid');
grid.style.border = isCorrect ? '3px solid #22c55e' : '3px solid #ef4444';

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 1500);
}

// æ”¾æ£„è€ƒè©¦
function abandonExam() {
if (confirm('ç¢ºå®šè¦æ”¾æ£„è€ƒè©¦å—ï¼Ÿ')) {
clearInterval(examTimer);
location.reload();
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒè©¦çµæœé¡¯ç¤ºå„ªåŒ–
async function showExamResult() {
clearInterval(examTimer);
const config = examConfigs[currentExam];
const totalTime = Math.round((Date.now() - examStartTime) / 1000);
const score = userScores.correctAnswers * 10;

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šä¸¦è¡Œè™•ç†æˆç¸¾ä¿å­˜å’Œé¡¯ç¤º
const savePromise = saveScore(currentExam, score, totalTime, userScores.fastAnswers);

const container = document.querySelector('.container');
container.innerHTML = `
<div class="exam-result">
<h2>ğŸ¯ è€ƒè©¦å®Œæˆï¼</h2>
<p><strong>è€ƒè©¦é …ç›®ï¼š</strong>${config.name}</p>
<p><strong>ç¸½åˆ†ï¼š</strong>${score} åˆ†</p>
<p><strong>ç­”å°é¡Œæ•¸ï¼š</strong>${userScores.correctAnswers} / ${config.questionCount}</p>
<p><strong>å¿«é€Ÿç­”é¡Œï¼š</strong>${userScores.fastAnswers} é¡Œ</p>
<p><strong>ç¸½ç”¨æ™‚ï¼š</strong>${totalTime} ç§’</p>
<div style="margin-top: 20px;">
<button class="btn btn-primary" onclick="location.reload()">è¿”å›æŒ‘æˆ°åˆ—è¡¨</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>
`;

try {
await savePromise;
console.log('âœ… æˆç¸¾å·²ä¿å­˜');
} catch (err) {
console.error('âŒ æˆç¸¾ä¿å­˜å¤±æ•—:', err);
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæˆç¸¾ä¿å­˜å„ªåŒ–
async function saveScore(examType, score, totalTime, fastAnswers) {
try {
const scoreData = {
score: score,
totalTime: totalTime,
fastAnswers: fastAnswers,
timestamp: Date.now(),
date: new Date().toISOString().split('T')[0]
};

// æ‰¹é‡æ›´æ–°
const updates = {};
updates[`leaderboard/${examType}/${currentUser}`] = scoreData;
updates[`users/${currentUser}/scores/${examType}`] = scoreData;

await database.ref().update(updates);

// æ¸…é™¤ç›¸é—œå¿«å–
championCache.delete(`champion_${examType}`);
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');

} catch (err) {
console.error('ä¿å­˜æˆç¸¾å¤±æ•—:', err);
throw err;
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ’è¡Œæ¦œé¡¯ç¤ºå„ªåŒ–
async function showLeaderboard(examType) {
try {
document.getElementById('modalTitle').textContent = `${examConfigs[examType].name} - æ’è¡Œæ¦œ`;
document.getElementById('leaderboardContent').innerHTML = `
<div class="loading">
<div class="loading-spinner"></div>
è¼‰å…¥æ’è¡Œæ¦œä¸­...
</div>
`;
document.getElementById('leaderboardModal').style.display = 'flex';

const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').once('value');
const data = snapshot.val() || {};
const leaderboard = Object.entries(data)
.map(([user, score]) => ({ user, ...score }))
.sort((a, b) => {
if (b.score !== a.score) return b.score - a.score;
return a.totalTime - b.totalTime;
});

displayLeaderboard(leaderboard, examType);
} catch (err) {
console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</p>
<p>è«‹ç¨å¾Œå†è©¦</p>
</div>
`;
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç¸½åˆ†æ’è¡Œæ¦œ
async function showTotalLeaderboard() {
try {
document.getElementById('modalTitle').textContent = 'ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ';
document.getElementById('leaderboardContent').innerHTML = `
<div class="loading">
<div class="loading-spinner"></div>
è¨ˆç®—ç¸½åˆ†ä¸­...
</div>
`;
document.getElementById('leaderboardModal').style.display = 'flex';

// ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰æ’è¡Œæ¦œè³‡æ–™
const examTypes = Object.keys(examConfigs);
const promises = examTypes.map(examType => 
database.ref(`leaderboard/${examType}`).once('value')
);

const snapshots = await Promise.all(promises);
const totalScores = {};

// è¨ˆç®—ç¸½åˆ†
snapshots.forEach((snapshot, index) => {
const examType = examTypes[index];
const data = snapshot.val() || {};

Object.entries(data).forEach(([user, scoreData]) => {
if (!totalScores[user]) {
totalScores[user] = { totalScore: 0, totalTime: 0, examCount: 0 };
}
totalScores[user].totalScore += scoreData.score || 0;
totalScores[user].totalTime += scoreData.totalTime || 0;
totalScores[user].examCount++;
});
});

const leaderboard = Object.entries(totalScores)
.map(([user, data]) => ({ user, ...data }))
.sort((a, b) => {
if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
return a.totalTime - b.totalTime;
});

displayTotalLeaderboard(leaderboard);
} catch (err) {
console.error('è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—</p>
<p>è«‹ç¨å¾Œå†è©¦</p>
</div>
`;
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ’è¡Œæ¦œé¡¯ç¤ºå‡½æ•¸
function displayLeaderboard(leaderboard, examType) {
const content = document.getElementById('leaderboardContent');

if (leaderboard.length === 0) {
content.innerHTML = `
<div class="empty-leaderboard">
<p>ğŸ† å°šç„¡æŒ‘æˆ°è¨˜éŒ„</p>
<p>æˆç‚ºç¬¬ä¸€å€‹æŒ‘æˆ°è€…å§ï¼</p>
</div>
`;
return;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment
const fragment = document.createDocumentFragment();
const container = document.createElement('div');
container.className = 'leaderboard-container';

leaderboard.forEach((item, index) => {
const div = document.createElement('div');
div.className = `leaderboard-item ${item.user === currentUser ? 'current-user' : ''}`;

let rankDisplay = `${index + 1}`;
if (index === 0) rankDisplay = 'ğŸ¥‡';
else if (index === 1) rankDisplay = 'ğŸ¥ˆ';
else if (index === 2) rankDisplay = 'ğŸ¥‰';

// æª¢æŸ¥æ˜¯å¦ç‚ºé¦–ç¶
let firstBindBadge = '';
if (index > 0 && leaderboard[index-1].score === item.score) {
const sameScoreItems = leaderboard.filter(x => x.score === item.score);
const fastest = sameScoreItems.reduce((min, curr) => 
curr.totalTime < min.totalTime ? curr : min
);
if (item.user === fastest.user) {
firstBindBadge = ' <span style="color:#f59e0b;">ğŸ‘‘é¦–ç¶</span>';
}
}

div.innerHTML = `
<div class="rank">${rankDisplay}</div>
<div class="user-name">${item.user}${firstBindBadge}</div>
<div class="score">${item.score}åˆ†</div>
`;

container.appendChild(div);
});

fragment.appendChild(container);
content.innerHTML = '';
content.appendChild(fragment);
}

function displayTotalLeaderboard(leaderboard) {
const content = document.getElementById('leaderboardContent');
  
if (leaderboard.length === 0) {
content.innerHTML = `
<div class="empty-leaderboard">
<p>ğŸ† å°šç„¡æŒ‘æˆ°è¨˜éŒ„</p>
<p>é–‹å§‹ä½ çš„ç¬¬ä¸€æ¬¡æŒ‘æˆ°å§ï¼</p>
</div>
`;
return;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment
const fragment = document.createDocumentFragment();
const container = document.createElement('div');
container.className = 'leaderboard-container';

leaderboard.forEach((item, index) => {
const div = document.createElement('div');
div.className = `leaderboard-item ${item.user === currentUser ? 'current-user' : ''}`;

let rankDisplay = `${index + 1}`;
if (index === 0) rankDisplay = 'ğŸ¥‡';
else if (index === 1) rankDisplay = 'ğŸ¥ˆ';
else if (index === 2) rankDisplay = 'ğŸ¥‰';

// æª¢æŸ¥æ˜¯å¦ç‚ºé¦–ç¶
let firstBindBadge = '';
if (index > 0 && leaderboard[index-1].totalScore === item.totalScore) {
const sameScoreItems = leaderboard.filter(x => x.totalScore === item.totalScore);
const fastest = sameScoreItems.reduce((min, curr) => 
curr.totalTime < min.totalTime ? curr : min
);
if (item.user === fastest.user) {
firstBindBadge = ' <span style="color:#f59e0b;">ğŸ‘‘é¦–ç¶</span>';
}
}

div.innerHTML = `
<div class="rank">${rankDisplay}</div>
<div class="user-name">${item.user}${firstBindBadge}</div>
<div class="score">${item.totalScore}åˆ† (${item.examCount}é …)</div>
`;

container.appendChild(div);
});

fragment.appendChild(container);
content.innerHTML = '';
content.appendChild(fragment);
}

function hideLeaderboard() {
document.getElementById('leaderboardModal').style.display = 'none';
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializeApp);

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚æ›´æ–°è³‡æ–™
document.addEventListener('visibilitychange', () => {
if (!document.hidden && currentUser) {
debouncedUpdateChampions();
}
});

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šéµç›¤å¿«æ·éµ
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') {
hideLeaderboard();
}
});
</script>
</body>
</html>
