<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2日檢疫挑戰系統</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- 添加數獨挑戰腳本 -->
<script src="sudoku6x6.js"></script>
<!-- 添加模組化JS文件 -->
<script src="medalInventory.js"></script>
<script src="shopModule.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--border-radius: 8px;
--gold: #fbbf24;
--silver: #9ca3af;
--bronze: #d97706;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: "微軟正黑體", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  background: var(--bg-primary);
  min-height: 100vh;
  padding: 12px;
  color: var(--text-primary);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  max-width: 480px;
  margin: 0 auto;
  height: calc(100vh - 24px);
  overflow-y: auto;
  background: var(--bg-secondary);
  border-radius: 12px;
  box-shadow: var(--shadow);
  will-change: scroll-position;
}

.header {
  background: var(--bg-secondary);
  padding: 15px;
  border-bottom: 1px solid var(--border-color);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
}

.header-title { display: flex; flex-direction: column; margin-bottom: 10px; }

.title-text {
  font-size: 1.3rem;
  color: var(--text-primary);
  display: flex; align-items: center; gap: 8px; justify-content: space-between;
}

.user-info {
  font-size: 0.9rem; color: var(--text-secondary);
  margin-top: 5px; display: flex; align-items: center; justify-content: space-between;
}

.user-currency { display: flex; gap: 12px; align-items: center; }

.currency-item {
  display: flex; align-items: center; gap: 4px;
  background: rgba(255, 255, 255, 0.05);
  padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;
}

.connection-status {
  background-color: var(--success); color: white;
  padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; animation: pulse 2s infinite;
}

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

/* 🎨 按鈕樣式 */
.btn {
  padding: 10px 16px; border: none; border-radius: var(--border-radius); cursor: pointer;
  font-size: 0.9rem; font-weight: 500; transition: var(--transition); flex: 1; position: relative; overflow: hidden;
  text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-height: 44px;
}
.btn::before {
  content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s;
}
.btn:hover::before { left: 100%; }

.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--text-primary); box-shadow: 0 2px 8px rgba(114, 137, 218, 0.3); }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(114, 137, 218, 0.4); }

.btn-secondary { background: linear-gradient(135deg, var(--warning), #e67e22); color: var(--text-primary); box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); }
.btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }

.btn-danger { background: linear-gradient(135deg, var(--danger), #c0392b); color: var(--text-primary); box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); }
.btn-danger:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }

.btn-shop { background: linear-gradient(135deg, var(--gold), #f59e0b); color: var(--text-primary); box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); }
.btn-shop:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); }

/* header-actions 按鈕佈局 */
.header-actions { display: flex; gap: 8px; margin-top: 12px; }
.header-actions .btn { flex: 1; font-size: 0.8rem; padding: 8px 10px; min-height: 36px; }

/* 🏅 勳章顯示樣式 */
.user-medals {
  display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap;
}
.medal-icon {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; border-radius: 50%; font-size: 0.9rem; border: 2px solid;
  background: rgba(255, 255, 255, 0.1); transition: var(--transition); cursor: pointer; overflow: hidden;
}
.medal-icon:hover { transform: scale(1.1); }
.medal-icon.common { border-color: #84cc16; }
.medal-icon.rare { border-color: #3b82f6; }
.medal-icon.epic { border-color: #8b5cf6; }
.medal-icon.legendary { border-color: #f59e0b; }
.medal-icon.mythic { border-color: #dc2626; }

/* 🔧 勳章圖片樣式（通用基礎） */
.medal-icon img,
.medal-preview img,
.inventory-medal-icon img,
.leaderboard-medal img {
  border-radius: 4px; display: block;
}

/* 🪄 修正：僅限首頁「使用者頭像區」的勳章圖片尺寸，避免撐破圓框 */
.user-medals .medal-icon { position: relative; overflow: hidden; }
.user-medals .medal-icon img { width: 20px; height: 20px; object-fit: contain; display: block; margin: auto; }

/* --- 商店樣式 --- */
.shop-container { padding: 16px; }
.shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.shop-categories { display: flex; gap: 8px; margin-bottom: 16px; }
.category-btn {
  padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color);
  border-radius: var(--border-radius); color: var(--text-secondary); cursor: pointer; transition: var(--transition); font-size: 0.85rem;
}
.category-btn.active { background: var(--primary); color: var(--text-primary); border-color: var(--primary); }
.shop-items { display: grid; gap: 12px; }
.shop-item {
  display: flex; align-items: center; padding: 12px; background: rgba(255, 255, 255, 0.03);
  border: 1px solid var(--border-color); border-radius: var(--border-radius); transition: var(--transition);
}
.shop-item:hover { background: rgba(255, 255, 255, 0.05); transform: translateY(-1px); }
.shop-item.owned { opacity: 0.6; border-color: var(--success); }
.shop-item.equipped { border-color: var(--gold); background: rgba(251, 191, 36, 0.1); }
.medal-preview {
  width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; border: 2px solid; margin-right: 12px;
}
.item-info { flex: 1; }
.item-name { font-weight: 600; margin-bottom: 4px; }
.item-description { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
.item-price { font-size: 0.9rem; color: var(--gold); font-weight: 600; }
.item-actions { display: flex; gap: 8px; }
.btn-small { padding: 6px 12px; font-size: 0.8rem; min-height: 32px; }

/* 🎒 背包樣式 */
.inventory-container { padding: 16px; }
.inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; }
.inventory-item {
  aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(255, 255, 255, 0.03); border: 2px solid var(--border-color); border-radius: var(--border-radius);
  cursor: pointer; transition: var(--transition); padding: 8px;
}
.inventory-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-2px); }
.inventory-item.equipped { border-color: var(--gold); background: rgba(251, 191, 36, 0.1); }
.inventory-medal-icon { font-size: 1.5rem; margin-bottom: 4px; }
.inventory-medal-name { font-size: 0.7rem; text-align: center; line-height: 1.2; }

/* 排行榜勳章顯示 - 升級版本 */
.leaderboard-medals { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; align-items: center; }
.leaderboard-medal {
  width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; border: 2px solid; background: rgba(255, 255, 255, 0.1); flex-shrink: 0; position: relative; overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(0, 0, 0, 0.1) 100%);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}
/* 反光動畫 */
.leaderboard-medal::before {
  content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.4) 50%, transparent 70%);
  transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;
}
.leaderboard-medal:hover::before { opacity: 1; animation: shine 0.6s ease-in-out; }
.leaderboard-medal:hover {
  transform: scale(1.1) translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.4), inset 0 -1px 0 rgba(0, 0, 0, 0.3);
}
@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
  50% { opacity: 1; }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
}

/* 勳章內圖片樣式（排行榜）— 固定 24px */
.leaderboard-medals .leaderboard-medal img {
  width: 24px; height: 24px; object-fit: contain; border-radius: 4px;
  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3)); transition: all 0.3s ease;
}
.leaderboard-medal:hover img { filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4)) brightness(1.1); }

/* 稀有度邊框/特效 */
.leaderboard-medal[data-rarity="common"] { border-color: #84cc16; box-shadow: 0 2px 8px rgba(132, 204, 22, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.2); }
.leaderboard-medal[data-rarity="rare"] { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.2); }
.leaderboard-medal[data-rarity="epic"] { border-color: #8b5cf6; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.2); }
.leaderboard-medal[data-rarity="legendary"] {
  border-color: #f59e0b;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.4), inset 0 -1px 0 rgba(0, 0, 0, 0.2);
  animation: legendaryGlow 2s ease-in-out infinite alternate;
}
.leaderboard-medal[data-rarity="mythic"] {
  border-color: #dc2626;
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.3);
  animation: mythicGlow 2s ease-in-out infinite alternate;
}
@keyframes legendaryGlow {
  0% { box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4), 0 0 10px rgba(245, 158, 11, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4), inset 0 -1px 0 rgba(0, 0, 0, 0.2); }
  100% { box-shadow: 0 2px 8px rgba(245, 158, 11, 0.6), 0 0 20px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.2); }
}
@keyframes mythicGlow {
  0% { box-shadow: 0 2px 8px rgba(220, 38, 38, 0.5), 0 0 15px rgba(220, 38, 38, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.3); }
  100% { box-shadow: 0 2px 8px rgba(220, 38, 38, 0.7), 0 0 25px rgba(220, 38, 38, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.6), inset 0 -1px 0 rgba(0, 0, 0, 0.3); }
}
/* 神話級光線 */
.medal-icon.mythic::before,
.leaderboard-medal[data-rarity="mythic"]::before,
.medal-preview[style*="dc2626"]::before,
.inventory-medal-icon[style*="dc2626"]::before {
  content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.4) 50%, transparent 70%);
  transform: rotate(45deg); animation: mythicRays 3s linear infinite; opacity: 0.5; pointer-events: none;
}
@keyframes mythicRays {
  0% { transform: rotate(0deg) translateX(-100%) translateY(-100%); }
  100% { transform: rotate(360deg) translateX(100%) translateY(100%); }
}

/* 🔧 調整用戶名稱區域以適應更大的勳章 */
.user-name {
  flex: 1; margin: 0 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  display: flex; flex-direction: column; justify-content: center; min-height: 40px;
}

/* 🔧 調整排行榜項目高度 */
.leaderboard-item {
  display: flex; align-items: center; padding: 12px;
  border-bottom: 1px solid var(--border-color); transition: var(--transition); border-radius: 6px; margin-bottom: 2px; min-height: 60px;
}

.rank { min-width: 35px; font-weight: bold; color: var(--primary); font-size: 1rem; }
.score { font-weight: bold; color: var(--primary); margin-left: auto; font-size: 1rem; }

.leaderboard-item:hover { background: rgba(114, 137, 218, 0.05); transform: translateX(2px); }
.leaderboard-item.current-user { background: rgba(114, 137, 218, 0.1); border-left: 3px solid var(--primary); box-shadow: 0 2px 8px rgba(114, 137, 218, 0.2); }
.empty-leaderboard { text-align: center; padding: 30px 20px; color: var(--text-secondary); }

/* --- 考試卡片 --- */
.challenge-item { padding: 16px; border-bottom: 1px solid var(--border-color); transition: background-color 0.3s ease; }
.challenge-item:hover { background: rgba(255, 255, 255, 0.02); }
.challenge-title { font-size: 1.1rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 600; }
.challenge-info { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px; }
.challenge-actions { display: flex; gap: 10px; }
.champion-display { margin-bottom: 10px; }
.champion-card {
  display: flex; align-items: center; justify-content: space-between;
  background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; padding: 8px 14px;
  border-radius: var(--border-radius); font-size: 0.85rem; font-weight: bold; box-shadow: 0 3px 6px rgba(255, 215, 0, 0.3);
  transition: var(--transition);
}
.champion-card:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4); }
.champion-empty {
  display: flex; align-items: center; justify-content: center;
  background: rgba(255, 255, 255, 0.05); color: var(--text-secondary); padding: 8px 14px; border-radius: var(--border-radius);
  font-size: 0.85rem; border: 1px dashed rgba(255, 255, 255, 0.15);
}

/* --- 分頁（標籤）切換：行動友善 --- */
.exam-tabs {
  display: flex; gap: 8px; padding: 10px 16px 0 16px;
  position: sticky; top: 0; background: var(--bg-secondary); z-index: 90;
}
.tab-btn {
  padding: 8px 14px; border-radius: var(--border-radius); border: 1px solid var(--border-color);
  background: rgba(255,255,255,0.05); color: var(--text-secondary); cursor: pointer; transition: var(--transition);
  font-size: 0.9rem; white-space: nowrap;
}
.tab-btn.active {
  background: var(--primary); border-color: var(--primary); color: var(--text-primary); box-shadow: 0 2px 8px rgba(114,137,218,0.25);
}
.tab-panels { padding: 8px 0 16px 0; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* 響應式設計 */
@media (max-width: 400px) {
  .header-actions { flex-direction: column; gap: 8px; }
  .header-actions .btn { width: 100%; }
  .user-currency { flex-direction: column; gap: 4px; }
}

/* GPU 加速 */
.btn, .modal, .leaderboard-item, .champion-card, .medal-icon { transform: translateZ(0); backface-visibility: hidden; }

/* 考試畫面 */
.exam-container { padding: 20px; }
.exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: var(--border-radius); }
.timer { font-size: 1.4rem; color: var(--primary); font-weight: bold; padding: 8px 16px; background: rgba(114, 137, 218, 0.1); border-radius: var(--border-radius); }
.question { background: rgba(255, 255, 255, 0.03); padding: 24px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color); }
.options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 20px; }
.option-btn { width: 100%; text-align: left; padding: 14px 16px; border-radius: var(--border-radius); transition: var(--transition); }
.option-btn.correct { background: linear-gradient(135deg, var(--success), #27ae60); }
.option-btn.wrong { background: linear-gradient(135deg, var(--danger), #c0392b); }
.exam-result { text-align: center; padding: 30px 20px; }
.exam-result h2 { margin-bottom: 20px; color: var(--primary); }
.exam-result p { margin-bottom: 12px; font-size: 1.05rem; }
.exam-result button { margin: 8px; }

/* 捲軸 */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 3px; }
::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--primary), var(--primary-dark)); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, var(--primary-dark), var(--primary)); }
.loading { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
.loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(114, 137, 218, 0.3); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; will-change: transform; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media (max-width: 400px) { .options { grid-template-columns: 1fr; } }
.btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
::selection { background: rgba(114, 137, 218, 0.3); color: var(--text-primary); }

/* Modal 基本 */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal {
  background: var(--bg-secondary); width: 90%; max-width: 420px; max-height: 85vh; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5); animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-header {
  padding: 16px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--text-primary);
  display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0;
}
.close-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: var(--transition); }
.close-btn:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.1); }
.modal-content { padding: 16px; overflow-y: auto; max-height: calc(85vh - 68px); min-height: 200px; }
.leaderboard-container { max-height: calc(60vh - 100px); overflow-y: auto; padding-right: 5px; scroll-behavior: smooth; }
</style>
</head>
<body>
<!-- 載入中畫面 -->
<div id="loadingScreen" class="container">
  <div class="loading">
    <div class="loading-spinner"></div>
    正在驗證登入狀態...
  </div>
</div>

<!-- 主要內容 -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
  <div class="header-title">
    <div class="title-text">
      <span>🎯</span>
      <h1>T2挑戰系統</h1>
      <button class="btn btn-danger" onclick="logout()">登出</button>
    </div>
    <div class="user-info">
      <div>
        <span id="currentUserWelcome">歡迎回來，載入中...</span>
        <div class="user-currency">
          <div class="currency-item"><span>💰</span><span id="userCoins">0</span></div>
          <div class="currency-item"><span>💎</span><span id="userGems">0</span></div>
        </div>
        <div class="user-medals" id="userMedals"></div>
      </div>
      <span class="connection-status" id="connectionStatus">用戶連線中</span>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="backToT2()">🏠 返回T2日</button>
    <button class="btn btn-secondary" onclick="showTotalLeaderboard()">🏆 總分排行榜</button>
    <button class="btn btn-shop" onclick="showShop()">🏪 商店</button>
    <button class="btn btn-primary" onclick="showInventory()">🎒 背包</button>
  </div>
</header>

<!-- 挑戰項目列表（分頁動態生成） -->
<div id="challengesList"></div>
</div>

<!-- 🏪 商店模態視窗 -->
<div class="modal-overlay" id="shopModal">
  <div class="modal">
    <div class="modal-header">
      <h2>🏪 勳章商店</h2>
      <button class="close-btn" onclick="hideShop()">×</button>
    </div>
    <div class="modal-content">
      <div class="shop-container">
        <div class="shop-categories">
          <button class="category-btn active" onclick="filterShop('all')">全部</button>
          <button class="category-btn" onclick="filterShop('common')">普通</button>
          <button class="category-btn" onclick="filterShop('rare')">稀有</button>
          <button class="category-btn" onclick="filterShop('epic')">史詩</button>
          <button class="category-btn" onclick="filterShop('legendary')">傳說</button>
          <button class="category-btn" onclick="filterShop('mythic')">神話</button>
        </div>
        <div class="shop-items" id="shopItems"></div>
      </div>
    </div>
  </div>
</div>

<!-- 🎒 背包模態視窗 -->
<div class="modal-overlay" id="inventoryModal">
  <div class="modal">
    <div class="modal-header">
      <h2>🎒 勳章背包</h2>
      <button class="close-btn" onclick="hideInventory()">×</button>
    </div>
    <div class="modal-content">
      <div class="inventory-container">
        <p style="margin-bottom: 16px; color: var(--text-secondary);">點擊勳章裝備/卸下 (最多裝備5個)</p>
        <div class="inventory-grid" id="inventoryGrid"></div>
      </div>
    </div>
  </div>
</div>

<!-- 排行榜模態視窗 -->
<div class="modal-overlay" id="leaderboardModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">排行榜</h2>
      <button class="close-btn" onclick="hideLeaderboard()">×</button>
    </div>
    <div class="modal-content" id="leaderboardContent"></div>
  </div>
</div>

<script>
// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
  authDomain: "openexammodal.firebaseapp.com",
  databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
  projectId: "openexammodal",
  storageBucket: "openexammodal.firebasestorage.app",
  messagingSenderId: "336901617556",
  appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};

// 🚀 效能優化：Firebase 初始化
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// 🚀 效能優化：題庫快取
let examQuestions = {};
let questionsCache = new Map();

// 🏅 勳章系統變數
let medalsData = {};
let userMedals = { owned: [], equipped: [] };
let userCurrency = { coins: 0, gems: 0 };

// 📝 考試配置變數 (從JSON載入)
let examConfigs = {};

// 🏅 載入勳章資料
async function loadMedalsData() {
  try {
    const cacheKey = 'medals_data_v1';
    const cached = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(cacheKey + '_time');

    if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
      medalsData = JSON.parse(cached);
      console.log('✅ 從快取載入勳章資料');
      return;
    }

    const resp = await fetch('medals.json');
    if (!resp.ok) throw new Error(`載入勳章資料失敗：${resp.status}`);
    medalsData = await resp.json();

    localStorage.setItem(cacheKey, JSON.stringify(medalsData));
    localStorage.setItem(cacheKey + '_time', Date.now().toString());

    console.log('✅ 勳章資料已載入並快取', medalsData);
  } catch (err) {
    console.error('載入勳章資料失敗:', err);
    medalsData = {
      medals: {},
      rarityColors: { common: "#84cc16", rare: "#3b82f6", epic: "#8b5cf6", legendary: "#f59e0b", mythic: "#dc2626" },
      maxEquippedMedals: 5
    };
  }
}

// 📝 載入考試配置
async function loadExamConfigs() {
  try {
    const cacheKey = 'exam_configs_v1';
    const cached = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(cacheKey + '_time');

    if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
      examConfigs = JSON.parse(cached);
      console.log('✅ 從快取載入考試配置');
      return;
    }

    const resp = await fetch('exam-configs.json');
    if (!resp.ok) throw new Error(`載入考試配置失敗：${resp.status}`);
    examConfigs = await resp.json();

    localStorage.setItem(cacheKey, JSON.stringify(examConfigs));
    localStorage.setItem(cacheKey + '_time', Date.now().toString());

    console.log('✅ 考試配置已載入並快取', examConfigs);
  } catch (err) {
    console.error('載入考試配置失敗:', err);
    alert('系統錯誤：無法載入考試配置檔案');
  }
}

// 📝 載入用戶密碼數據（對應名稱）
async function loadPasswordData() {
  try {
    const cacheKey = 'password_data_v1';
    const cached = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(cacheKey + '_time');

    if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
      window.passwordData = JSON.parse(cached);
      console.log('✅ 從快取載入用戶密碼數據');
      return;
    }

    const resp = await fetch('password.json');
    if (!resp.ok) throw new Error(`載入用戶密碼數據失敗：${resp.status}`);
    window.passwordData = await resp.json();

    localStorage.setItem(cacheKey, JSON.stringify(window.passwordData));
    localStorage.setItem(cacheKey + '_time', Date.now().toString());

    console.log('✅ 用戶密碼數據已載入並快取', window.passwordData.length, '位用戶');
  } catch (err) {
    console.error('載入用戶密碼數據失敗:', err);
    window.passwordData = [];
  }
}

/* -----------------------
   ✅ 新：分頁（標籤）渲染
------------------------*/

// 依 examConfigs 動態產生分類
function getExamCategories() {
  const map = new Map();
  Object.entries(examConfigs).forEach(([examType, config]) => {
    const cat = (config.category || '一般').trim();
    if (!map.has(cat)) map.set(cat, []);
    map.get(cat).push([examType, config]);
  });
  return map; // Map<category, Array<[examType, config]>>
}

function renderTabButtons(categoriesMap, activeCat) {
  const tabs = document.createElement('div');
  tabs.className = 'exam-tabs';
  categoriesMap.forEach((_, catName) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (catName === activeCat ? ' active' : '');
    btn.textContent = catName;
    btn.addEventListener('click', () => switchExamCategory(catName));
    tabs.appendChild(btn);
  });
  return tabs;
}

// 📝 動態生成挑戰項目列表（分頁版）
function renderChallengesList() {
  const challengesContainer = document.getElementById('challengesList');
  challengesContainer.innerHTML = '';

  const categoriesMap = getExamCategories();
  // 上次停留的分頁（預設第一個）
  let activeCat = localStorage.getItem('t2_active_category');
  if (!activeCat || !categoriesMap.has(activeCat)) {
    activeCat = categoriesMap.keys().next().value;
  }

  // 分頁按鈕
  const tabsEl = renderTabButtons(categoriesMap, activeCat);
  challengesContainer.appendChild(tabsEl);

  // 分頁面板容器
  const panels = document.createElement('div');
  panels.className = 'tab-panels';
  challengesContainer.appendChild(panels);

  // 建立每個分頁的 panel
  categoriesMap.forEach((list, catName) => {
    const panel = document.createElement('div');
    panel.className = 'tab-panel' + (catName === activeCat ? ' active' : '');
    panel.dataset.cat = catName;

    const fragment = document.createDocumentFragment();
    list.forEach(([examType, config]) => {
      const challengeItem = document.createElement('div');
      challengeItem.className = 'challenge-item';
      challengeItem.innerHTML = `
        <h3 class="challenge-title">${config.name}</h3>
        <p class="challenge-info" style="color:#ef4444;">${config.description}</p>
        <div class="champion-display" data-exam-type="${examType}"></div>
        <div class="challenge-actions">
          <button class="btn btn-primary" onclick="startExam('${examType}')">開始考試</button>
          <button class="btn btn-secondary" onclick="showLeaderboard('${examType}')">查看排行榜</button>
        </div>
      `;
      fragment.appendChild(challengeItem);
    });

    panel.appendChild(fragment);
    panels.appendChild(panel);
  });

  // 渲染後抓各分頁中的榜首資料
  updateAllChampions();
}

function switchExamCategory(catName) {
  localStorage.setItem('t2_active_category', catName);

  const tabs = document.querySelectorAll('.exam-tabs .tab-btn');
  tabs.forEach(btn => btn.classList.toggle('active', btn.textContent === catName));

  const panels = document.querySelectorAll('.tab-panels .tab-panel');
  panels.forEach(p => p.classList.toggle('active', p.dataset.cat === catName));

  // 切換分頁後也刷新一下榜首（避免快取時滯）
  debouncedUpdateChampions();
}

/* -----------------------
   既有流程
------------------------*/

// 🏅 載入用戶勳章和貨幣資料
async function loadUserMedalsAndCurrency() {
  try {
    window.medalInventory = new MedalInventory(database, currentUser, medalsData);
    await window.medalInventory.loadUserData();
    window.medalInventory.updateCurrencyDisplay('userCoins', 'userGems');
    window.medalInventory.updateMedalDisplay('userMedals');

    // 初始化商店模組
    window.shopModule = new ShopModule(database, currentUser, medalsData, window.medalInventory);
  } catch (err) {
    console.error('載入用戶勳章資料失敗:', err);
  }
}

// 🏪 商店
async function showShop() {
  if (!window.shopModule) {
    try {
      window.shopModule = new ShopModule(database, currentUser, medalsData, window.medalInventory);
    } catch (error) {
      console.error('商店模組重新初始化失敗:', error);
      alert('商店模組載入失敗，請重新整理頁面');
      return;
    }
  }
  try { await window.shopModule.showShop(); }
  catch (error) {
    console.error('顯示商店時發生錯誤:', error);
    alert('顯示商店時發生錯誤，請重新整理頁面');
  }
}
function hideShop() { if (window.shopModule) window.shopModule.hideShop(); }
function filterShop(category) { if (window.shopModule) window.shopModule.filterShop(category); }
async function buyMedal(medalId) {
  if (window.shopModule) await window.shopModule.buyMedal(medalId);
  else { console.error('商店模組未初始化'); alert('商店模組未初始化，請重新整理頁面'); }
}

// 🎒 背包
async function showInventory() { document.getElementById('inventoryModal').style.display = 'flex'; await renderInventory(); }
function hideInventory() { document.getElementById('inventoryModal').style.display = 'none'; }
async function renderInventory() { await window.medalInventory.renderInventory('inventoryGrid'); }
async function toggleMedalEquip(medalId) { await window.medalInventory.toggleMedalEquip(medalId, 'inventoryGrid'); }

// 題庫
async function loadExamQuestions() {
  try {
    const cacheKey = 'exam_questions_v1';
    const cached = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(cacheKey + '_time');
    if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
      examQuestions = JSON.parse(cached);
      console.log('✅ 從快取載入題庫');
      return;
    }
    const resp = await fetch('questions.json');
    if (!resp.ok) throw new Error(`載入題庫失敗：${resp.status}`);
    examQuestions = await resp.json();
    localStorage.setItem(cacheKey, JSON.stringify(examQuestions));
    localStorage.setItem(cacheKey + '_time', Date.now().toString());
    console.log('✅ 題庫已載入並快取', examQuestions);
  } catch (err) {
    console.error(err);
    alert('系統錯誤：無法載入題庫檔案');
  }
}

// 全域變數
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// 防抖
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => { clearTimeout(timeout); func(...args); };
    clearTimeout(timeout); timeout = setTimeout(later, wait);
  };
}

Array.prototype.remove = function(element) { const index = this.indexOf(element); if (index > -1) this.splice(index, 1); };

// 登出/登入檢查
function forceLogout(message = '登入驗證失敗，請重新登入') {
  localStorage.removeItem('t2_login');
  localStorage.removeItem('t2_login_time');
  localStorage.removeItem('t2_login_user');
  localStorage.removeItem('t2_login_password');
  alert(message);
  window.location.href = 'index.html';
}
function checkLoginStatus() {
  const flag = localStorage.getItem('t2_login');
  const time = localStorage.getItem('t2_login_time');
  const uniqueId = localStorage.getItem('t2_login_user');
  const displayName = localStorage.getItem('t2_login_display_name');
  if (flag !== 'yes' || !time || !uniqueId) { forceLogout('未檢測到有效登入狀態'); return false; }
  if (Date.now() - parseInt(time) > 3600000) { forceLogout('登入時間已超過1小時，請重新登入'); return false; }
  return { uniqueId, displayName: displayName || uniqueId };
}

// 用戶資料
async function loadUsersData() {
  try {
    const cacheKey = 'users_data_v1';
    const cached = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(cacheKey + '_time');
    if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 60000) {
      usersData = JSON.parse(cached);
      console.log('✅ 從快取載入用戶資料');
      return;
    }
    const snapshot = await database.ref('users').once('value');
    usersData = snapshot.val() || {};
    localStorage.setItem(cacheKey, JSON.stringify(usersData));
    localStorage.setItem(cacheKey + '_time', Date.now().toString());
    console.log('✅ 用戶資料已載入並快取', Object.keys(usersData).length, '位用戶');
  } catch (err) { console.error('載入用戶資料失敗:', err); }
}

// 榜首快取
const championCache = new Map();

async function getChampion(examType) {
  const cacheKey = `champion_${examType}`;
  const cached = championCache.get(cacheKey);
  if (cached && (Date.now() - cached.timestamp) < 60000) return cached.data;

  try {
    const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
    const data = snapshot.val();
    if (data) {
      const leaderboardData = Object.entries(data).map(([user, userData]) => ({ user, ...userData }))
        .sort((a, b) => (b.score !== a.score) ? (b.score - a.score) : (a.totalTime - b.totalTime));
      const result = leaderboardData[0];
      championCache.set(cacheKey, { data: result, timestamp: Date.now() });
      return result;
    }
    return null;
  } catch (err) {
    console.error('獲取榜首失敗:', err);
    return null;
  }
}

const debouncedUpdateChampions = debounce(updateAllChampions, 300);

// ✅ 改：榜首卡片也顯示勳章
async function updateAllChampions() {
  const examTypes = Object.keys(examConfigs);
  const promises = examTypes.map(async (examType) => {
    const champion = await getChampion(examType);
    const championDisplay = document.querySelector(`[data-exam-type="${examType}"]`);
    if (!championDisplay) return;

    if (champion) {
      const displayName = getUserDisplayName(champion.user);
      const medalIcons = getUserMedalIcons(champion.user) || '';
      championDisplay.innerHTML = `
        <div class="champion-card" style="flex-direction:column; align-items:flex-start; gap:6px;">
          <div style="display:flex; width:100%; align-items:center; justify-content:space-between;">
            <span>🏆 榜首：${displayName}</span>
            <span>${champion.score}分</span>
          </div>
          ${medalIcons ? `<div class="leaderboard-medals">${medalIcons}</div>` : `<div class="leaderboard-medals" style="opacity:.6;">（未裝備勳章）</div>`}
        </div>
      `;
    } else {
      championDisplay.innerHTML = `
        <div class="champion-empty"><span>🏆 尚無榜首</span></div>
      `;
    }
  });

  await Promise.all(promises);
}

// 初始化
async function initializeApp() {
  try {
    const userInfo = checkLoginStatus();
    if (!userInfo) return;

    currentUser = userInfo.uniqueId;
    const displayName = userInfo.displayName;
    document.getElementById('currentUserWelcome').textContent = `歡迎回來，${displayName}`;

    await Promise.all([ loadExamQuestions(), loadUsersData(), loadMedalsData(), loadExamConfigs(), loadPasswordData() ]);

    // 勳章系統
    window.medalInventory = new MedalInventory(database, currentUser, medalsData);
    await window.medalInventory.loadUserData();
    window.medalInventory.updateCurrencyDisplay('userCoins', 'userGems');
    window.medalInventory.updateMedalDisplay('userMedals');

    // 商店
    window.shopModule = new ShopModule(database, currentUser, medalsData, window.medalInventory);

    // 分頁＋清單
    renderChallengesList();

    // 榜首
    await updateAllChampions();

    // 顯示主畫面
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
  } catch (err) {
    console.error('初始化失敗:', err);
    alert('系統初始化失敗，請重新整理頁面');
  }
}

function logout() {
  localStorage.removeItem('t2_login');
  localStorage.removeItem('t2_login_time');
  localStorage.removeItem('t2_login_user');
  localStorage.removeItem('t2_login_password');
  localStorage.removeItem('t2_login_display_name');
  localStorage.removeItem('exam_questions_v1');
  localStorage.removeItem('exam_questions_v1_time');
  localStorage.removeItem('users_data_v1');
  localStorage.removeItem('users_data_v1_time');
  localStorage.removeItem('medals_data_v1');
  localStorage.removeItem('medals_data_v1_time');
  localStorage.removeItem('exam_configs_v1');
  localStorage.removeItem('exam_configs_v1_time');
  championCache.clear();
  window.location.href = 'index.html';
}
function backToT2() { window.location.href = 'page33.html'; }

// 題目隨機
function shuffleArray(array) {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
}

// 考試流程
function startExam(examType) {
  const config = examConfigs[examType];
  if (config.type === 'game') {
    if (examType === 'sudoku') { startSudokuChallenge(examType); }
    else { alert('此遊戲類型尚未實現'); }
    return;
  }
  if (!examQuestions[examType]) { alert('題庫載入中，請稍後再試'); return; }

  const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);
  if (questions.length < config.questionCount) {
    alert(`題庫題目不足！需要 ${config.questionCount} 題，但只有 ${questions.length} 題`);
    return;
  }

  currentExam = examType;
  currentQuestions = questions;
  currentQuestionIndex = 0;
  examStartTime = Date.now();
  userScores = { fastAnswers: 0, correctAnswers: 0, totalAnswers: 0, fastCorrectAnswers: 0 };

  showExamInterface();
  displayQuestion();
  startQuestionTimer();
}

function showExamInterface() {
  const container = document.getElementById('mainContent');
  const config = examConfigs[currentExam];
  container.innerHTML = `
    <div class="exam-container">
      <div class="exam-header" style="text-align: center; justify-content: center;">
        <h2>${config.name}</h2>
      </div>
      <div class="question" id="questionContainer"></div>
      <div class="exam-progress" style="margin-bottom: 15px;">
        <p>題目 <span id="currentQuestionNum">1</span> / ${config.questionCount}</p>
        <p>得分：<span id="currentScore">0</span> 分</p>
        <div class="timer" id="timer" style="margin: 10px auto; display: inline-block;">${config.timePerQuestion}秒</div>
      </div>
      <button class="btn btn-danger" onclick="quitExam()" style="width: 100%; margin-top: 10px;">棄 權</button>
    </div>
  `;
}

function quitExam() {
  try {
    clearInterval(examTimer);
    const confirmMessage = `⚠️ 確定要棄權嗎？\n\n• 棄權將不會獲得任何分數和獎勵\n• 此操作無法撤銷`;
    if (confirm(confirmMessage)) {
      const questionContainer = document.getElementById('questionContainer');
      if (questionContainer) {
        questionContainer.innerHTML = `
          <div style="text-align: center; padding: 30px;">
            <h3 style="color: var(--danger);">正在退出考試...</h3>
            <p style="margin-top: 10px; color: var(--text-secondary);">正在返回主頁</p>
          </div>
        `;
      }
      setTimeout(() => { window.location.href = window.location.href; }, 1500);
    } else {
      startQuestionTimer();
    }
  } catch (error) {
    console.error("棄權功能出錯:", error);
    alert("棄權功能出錯，將重新載入頁面");
    window.location.reload();
  }
}

function displayQuestion() {
  const question = currentQuestions[currentQuestionIndex];
  const questionContainer = document.getElementById('questionContainer');
  const config = examConfigs[currentExam];
  document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;

  const options = question.options.map((text, index) => ({ text, originalIndex: index }));
  for (let i = options.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [options[i], options[j]] = [options[j], options[i]];
  }
  window.currentOptionsMap = options.map(option => option.originalIndex);
  const optionsHtml = options.map((option, newIndex) =>
    `<button class="btn option-btn" onclick="selectAnswer(${newIndex})">${option.text}</button>`
  ).join('');

  questionContainer.innerHTML = `<h3>${question.question}</h3><div class="options">${optionsHtml}</div>`;
  questionStartTime = Date.now();
}

function startQuestionTimer() {
  const config = examConfigs[currentExam];
  let timeLeft = config.timePerQuestion;
  const timerElement = document.getElementById('timer');
  timerElement.textContent = `${timeLeft}秒`;

  examTimer = setInterval(() => {
    timeLeft--;
    timerElement.textContent = `${timeLeft}秒`;
    if (timeLeft <= 0) {
      clearInterval(examTimer);
      selectAnswer(-1);
    }
  }, 1000);
}

function selectAnswer(selectedIndex) {
  clearInterval(examTimer);
  const question = currentQuestions[currentQuestionIndex];
  const originalSelectedIndex = window.currentOptionsMap ? window.currentOptionsMap[selectedIndex] : selectedIndex;
  const isCorrect = originalSelectedIndex === question.correct;

  const responseTime = (Date.now() - questionStartTime) / 1000;
  const config = examConfigs[currentExam];

  userScores.totalAnswers++;
  const isFast = responseTime <= config.fastAnswerThreshold;
  if (isFast) userScores.fastAnswers++;
  if (isCorrect) {
    userScores.correctAnswers++;
    if (isFast) userScores.fastCorrectAnswers++;
  }

  const correctDisplayIndex = window.currentOptionsMap.findIndex(index => index === question.correct);
  showAnswerFeedback(selectedIndex, correctDisplayIndex, responseTime);

  setTimeout(() => { nextQuestion(isCorrect); }, 1500);
}

function showAnswerFeedback(selectedIndex, correctDisplayIndex, responseTime) {
  const options = document.querySelectorAll('.option-btn');
  const config = examConfigs[currentExam];

  options.forEach((btn, index) => {
    btn.disabled = true;
    if (index === correctDisplayIndex) btn.classList.add('correct');
    else if (index === selectedIndex && selectedIndex !== correctDisplayIndex) btn.classList.add('wrong');
  });

  const feedbackDiv = document.createElement('div');
  feedbackDiv.style.cssText = `margin-top: 15px; text-align: center; font-size: 0.9rem; color: var(--text-secondary);`;
  let feedbackText = `回應時間: ${responseTime.toFixed(1)}秒`;
  if (responseTime <= config.fastAnswerThreshold) feedbackText += ` ⚡ 快速答題！`;
  feedbackDiv.innerHTML = feedbackText;
  document.getElementById('questionContainer').appendChild(feedbackDiv);
}

function nextQuestion() {
  const baseScore = userScores.correctAnswers * 10;
  const fastBonus = userScores.fastCorrectAnswers * 5;
  const currentScore = baseScore + fastBonus;
  document.getElementById('currentScore').textContent = currentScore;

  if (currentQuestionIndex < currentQuestions.length - 1) {
    currentQuestionIndex++;
    displayQuestion();
    startQuestionTimer();
  } else {
    finishExam();
  }
}

async function finishExam() {
  clearInterval(examTimer);
  const totalTime = (Date.now() - examStartTime) / 1000;
  const config = examConfigs[currentExam];

  const baseScore = userScores.correctAnswers * 10;
  const fastBonus = userScores.fastCorrectAnswers * 5;
  const finalScore = baseScore + fastBonus;

  const isCompleted = (currentQuestionIndex + 1) >= config.questionCount;
  let coinsEarned = 0, gemsEarned = 0, bonusMessages = [];

  if (!isCompleted) {
    console.log('❌ 考試未完成，不保存成績');
    showExamResult(finalScore, totalTime, 0, 0);
    return;
  }

  coinsEarned += userScores.correctAnswers * 5;
  if (userScores.correctAnswers > 0) bonusMessages.push(`📝 答對${userScores.correctAnswers}題獲得${userScores.correctAnswers * 5}金幣`);

  if (userScores.fastCorrectAnswers > 0) {
    const fastCoins = userScores.fastCorrectAnswers * 2;
    coinsEarned += fastCoins;
    bonusMessages.push(`⚡ 快速答對${userScores.fastCorrectAnswers}題獲得額外${fastCoins}金幣`);
  }

  if (userScores.correctAnswers === config.questionCount) {
    const perfectBonus = config.perfectBonus || 50;
    coinsEarned += perfectBonus;
    gemsEarned += 1;
    bonusMessages.push(`🏆 滿分獎勵：+${perfectBonus}金幣 +1寶石`);
  }

  if (coinsEarned > 0) window.medalInventory.userCurrency.coins += coinsEarned;
  if (gemsEarned > 0) window.medalInventory.userCurrency.gems += gemsEarned;

  try {
    await saveScoreToLeaderboard(currentExam, finalScore, totalTime);
    if (coinsEarned > 0 || gemsEarned > 0) await window.medalInventory.saveCurrencyData();
    const cacheKey = `champion_${currentExam}`;
    championCache.delete(cacheKey);
    localStorage.removeItem('users_data_v1');
    localStorage.removeItem('users_data_v1_time');
  } catch (error) {
    console.error('❌ 保存成績失敗:', error);
    alert('保存成績時發生錯誤，請檢查網路連線');
  }

  showExamResult(finalScore, totalTime, coinsEarned, gemsEarned, bonusMessages);
}

function showExamResult(score, totalTime, coinsEarned, gemsEarned, bonusMessages = []) {
  const container = document.getElementById('mainContent');
  const config = examConfigs[currentExam];

  const baseScore = userScores.correctAnswers * 10;
  const fastBonus = userScores.fastCorrectAnswers * 5;

  container.innerHTML = `
    <div class="exam-result">
      <h2>🎉 考試完成！</h2>
      <p><strong>考試類型：</strong>${config.name}</p>
      <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <p><strong>📊 成績統計：</strong></p>
        <p>• 答對題數：${userScores.correctAnswers} / ${config.questionCount}</p>
        <p>• 基礎分數：${baseScore} 分</p>
        <p>• 快速答對：${userScores.fastCorrectAnswers} 題 (+${fastBonus}分)</p>
        <p style="color: var(--primary); font-size: 1.2rem; font-weight: bold;">🏆 最終得分：${score} 分</p>
      </div>
      <p><strong>總耗時：</strong>${totalTime.toFixed(1)} 秒</p>

      ${bonusMessages.length > 0 ? `
      <div style="margin: 15px 0; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
        <p><strong>🎁 獎勵明細：</strong></p>
        ${bonusMessages.map(msg => `<p style="color: var(--success);">• ${msg}</p>`).join('')}
        ${coinsEarned > 0 ? `<p style="color: var(--gold); font-weight: bold;">💰 總獲得金幣：${coinsEarned}</p>` : ''}
        ${gemsEarned > 0 ? `<p style="color: var(--info); font-weight: bold;">💎 總獲得寶石：${gemsEarned}</p>` : ''}
      </div>` : `<p style="color: var(--text-secondary);">💰 本次未獲得獎勵</p>`}

      <div style="margin-top: 20px;">
        <button class="btn btn-primary" onclick="location.reload()">返回主頁</button>
        <button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">查看排行榜</button>
      </div>
    </div>
  `;
}

async function saveScoreToLeaderboard(examType, score, totalTime) {
  try {
    const scoreData = {
      score,
      totalTime,
      timestamp: Date.now(),
      fastAnswers: userScores.fastAnswers,
      correctAnswers: userScores.correctAnswers
    };
    await database.ref(`leaderboard/${examType}/${currentUser}`).set(scoreData);
    console.log('成績已保存到排行榜');
  } catch (err) { console.error('保存成績失敗:', err); }
}

// 排行榜
async function showLeaderboard(examType) {
  document.getElementById('modalTitle').textContent = `${examConfigs[examType].name} - 排行榜`;
  const content = document.getElementById('leaderboardContent');
  content.innerHTML = '<div class="loading"><div class="loading-spinner"></div>載入排行榜中...</div>';
  document.getElementById('leaderboardModal').style.display = 'flex';

  try {
    localStorage.removeItem('users_data_v1');
    localStorage.removeItem('users_data_v1_time');
    await loadUsersData();

    const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
    const data = snapshot.val();

    if (data) {
      const leaderboardData = Object.entries(data).map(([user, userData]) => ({ user, ...userData }))
        .sort((a, b) => (b.score !== a.score) ? (b.score - a.score) : (a.totalTime - b.totalTime));

      const leaderboardHtml = leaderboardData.map((entry, index) => {
        const isCurrentUser = entry.user === currentUser;
        const userMedalIcons = getUserMedalIcons(entry.user);
        const displayName = getUserDisplayName(entry.user);
        const formattedTime = entry.totalTime ? `${entry.totalTime.toFixed(1)}秒` : "N/A";

        return `
          <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
            <div class="rank">#${index + 1}</div>
            <div class="user-name">
              ${displayName}
              <div class="leaderboard-medals">${userMedalIcons}</div>
            </div>
            <div class="score-time">
              <div class="score">${entry.score}分</div>
              <div class="time" style="font-size: 0.8rem; color: var(--text-secondary);">${formattedTime}</div>
            </div>
          </div>
        `;
      }).join('');

      content.innerHTML = `<div class="leaderboard-container">${leaderboardHtml}</div>`;
    } else {
      content.innerHTML = '<div class="empty-leaderboard"><p>🏆 尚無排行榜資料</p></div>';
    }
  } catch (err) {
    console.error('載入排行榜失敗:', err);
    content.innerHTML = '<div class="empty-leaderboard"><p>❌ 載入排行榜失敗</p></div>';
  }
}
function hideLeaderboard() { document.getElementById('leaderboardModal').style.display = 'none'; }

// 顯示名稱
function getUserDisplayName(userId) {
  if (usersData[userId] && usersData[userId].chineseName) return usersData[userId].chineseName;
  if (userId === currentUser && localStorage.getItem('t2_login_display_name')) return localStorage.getItem('t2_login_display_name');
  if (window.passwordData) {
    const username = userId.substring(0, 4);
    const password = userId.substring(4);
    const matchedUser = window.passwordData.find(user => user.username === username && user.password === password);
    if (matchedUser && matchedUser._comment) return matchedUser._comment;
  }
  return userId;
}

// 勳章圖示（沿用你的結構）
function getUserMedalIcons(username) {
  const userData = usersData[username];
  if (!userData || !userData.medals || !userData.medals.equipped || userData.medals.equipped.length === 0) return '';
  return userData.medals.equipped.map(medalId => {
    const medal = medalsData.medals[medalId];
    if (medal) {
      const iconContent = medal.icon && medal.icon.startsWith('http')
        ? `<img src="${medal.icon}" alt="${medal.name}">`
        : medal.icon || '';
      return `<span class="leaderboard-medal" style="border-color: ${medal.color};" data-rarity="${medal.rarity}" title="${medal.name}: ${medal.description}">${iconContent}</span>`;
    }
    return '';
  }).join('');
}

// 數獨
function startSudokuChallenge(examType) {
  const config = examConfigs[examType];
  const container = document.getElementById('mainContent');
  container.innerHTML = `
    <div class="exam-container">
      <div class="exam-header" style="text-align: center; justify-content: center;">
        <h2>${config.name}</h2>
      </div>
      <div id="sudoku-container"></div>
    </div>
  `;
  const sudoku = new Sudoku6x6('sudoku-container', config, (result) => { finishSudokuChallenge(examType, result); });
}

async function finishSudokuChallenge(examType, result) {
  const config = examConfigs[examType];
  if (result.forfeit) { setTimeout(() => { location.reload(); }, 1000); return; }

  const rewardMultiplier = config.rewardMultiplier || 3;
  let coinsEarned = Math.floor(result.score / 10) * rewardMultiplier;
  let gemsEarned = 0;

  if (result.score >= 100) { const perfectBonus = config.perfectBonus || 50; coinsEarned += perfectBonus; gemsEarned += 1; }
  if (result.timeBonus > 0) { coinsEarned += result.timeBonus * rewardMultiplier; }

  window.medalInventory.userCurrency.coins += coinsEarned;
  window.medalInventory.userCurrency.gems += gemsEarned;

  try {
    await saveScoreToLeaderboard(examType, result.score, result.totalTime);
    await window.medalInventory.saveCurrencyData();
    const cacheKey = `champion_${examType}`; championCache.delete(cacheKey);
    localStorage.removeItem('users_data_v1'); localStorage.removeItem('users_data_v1_time');
  } catch (error) {
    console.error('保存成績失敗:', error);
    alert('保存成績時發生錯誤，請檢查網路連線');
  }

  showSudokuResult(examType, result, coinsEarned, gemsEarned);
}

function showSudokuResult(examType, result, coinsEarned, gemsEarned) {
  const container = document.getElementById('mainContent');
  const config = examConfigs[examType];
  const minutes = Math.floor(result.totalTime / 60);
  const seconds = Math.floor(result.totalTime % 60);
  const formattedTime = `${minutes}分${seconds}秒`;
  const bonusMessages = [];
  if (result.score >= 100) bonusMessages.push(`🏆 完美通關：+${config.perfectBonus || 50}金幣 +1寶石`);
  if (result.timeBonus > 0) bonusMessages.push(`⚡ 速度獎勵：+${result.timeBonus * (config.rewardMultiplier || 3)}金幣`);

  container.innerHTML = `
    <div class="exam-result">
      <h2>🎉 數獨挑戰完成！</h2>
      <p><strong>難度：</strong>${result.difficulty}</p>
      <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <p><strong>📊 成績統計：</strong></p>
        <p>• 總分：${result.score} 分</p>
        <p>• 錯誤次數：${result.mistakes} 次</p>
        <p>• 時間獎勵：${result.timeBonus} 分</p>
      </div>
      <p><strong>總耗時：</strong>${formattedTime}</p>

      ${bonusMessages.length > 0 ? `
      <div style="margin: 15px 0; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
        <p><strong>🎁 獎勵明細：</strong></p>
        ${bonusMessages.map(msg => `<p style="color: var(--success);">• ${msg}</p>`).join('')}
        <p style="color: var(--gold); font-weight: bold;">💰 總獲得金幣：${coinsEarned}</p>
        ${gemsEarned > 0 ? `<p style="color: var(--info); font-weight: bold;">💎 總獲得寶石：${gemsEarned}</p>` : ''}
      </div>` : `<p style="color: var(--text-secondary);">💰 本次未獲得獎勵</p>`}

      <div style="margin-top: 20px;">
        <button class="btn btn-primary" onclick="location.reload()">返回主頁</button>
        <button class="btn btn-secondary" onclick="showLeaderboard('${examType}')">查看排行榜</button>
      </div>
    </div>
  `;
}

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
