<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2日檢疫挑戰系統</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--border-radius: 8px;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "微軟正黑體", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
line-height: 1.5;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
will-change: scroll-position;
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
margin-left: 8px;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

/* 🎨 CSS 微調：按鈕樣式優化 */
.btn {
padding: 10px 16px;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
font-size: 0.9rem;
font-weight: 500;
transition: var(--transition);
flex: 1;
position: relative;
overflow: hidden;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
min-height: 44px; /* 觸控友好 */
}

.btn::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
transition: left 0.5s;
}

.btn:hover::before {
left: 100%;
}

.btn-primary {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.3);
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(114, 137, 218, 0.4);
}

.btn-secondary {
background: linear-gradient(135deg, var(--warning), #e67e22);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.btn-secondary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.btn-danger {
background: linear-gradient(135deg, var(--danger), #c0392b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

/* 🎨 CSS 微調：header-actions 按鈕佈局優化 */
.header-actions {
display: flex;
gap: 10px;
margin-top: 12px;
}

.header-actions .btn {
flex: 1;
font-size: 0.85rem;
padding: 8px 12px;
min-height: 40px;
}

.challenge-item {
padding: 16px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s ease;
}

.challenge-item:hover {
background: rgba(255, 255, 255, 0.02);
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
font-weight: 600;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 10px;
}

/* 🎨 CSS 微調：榜首顯示優化 */
.champion-display {
margin-bottom: 10px;
}

.champion-card {
display: flex;
align-items: center;
justify-content: space-between;
background: linear-gradient(45deg, #FFD700, #FFA500);
color: #000;
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
font-weight: bold;
box-shadow: 0 3px 6px rgba(255, 215, 0, 0.3);
transition: var(--transition);
}

.champion-card:hover {
transform: translateY(-1px);
box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
}

.champion-empty {
display: flex;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.05);
color: var(--text-secondary);
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
border: 1px dashed rgba(255, 255, 255, 0.15);
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
backdrop-filter: blur(4px);
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 420px;
max-height: 85vh;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { transform: translateY(30px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.modal-header {
padding: 16px;
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 4px 8px;
border-radius: 4px;
transition: var(--transition);
}

.close-btn:hover {
background: rgba(255, 255, 255, 0.1);
transform: scale(1.1);
}

.modal-content {
padding: 16px;
overflow-y: auto;
max-height: calc(85vh - 68px);
min-height: 200px;
}

/* 🚀 效能優化：虛擬滾動優化 */
.leaderboard-container {
max-height: calc(60vh - 100px);
overflow-y: auto;
padding-right: 5px;
scroll-behavior: smooth;
}

.leaderboard-item {
display: flex;
align-items: center;
padding: 10px 12px;
border-bottom: 1px solid var(--border-color);
transition: var(--transition);
border-radius: 6px;
margin-bottom: 2px;
}

.leaderboard-item:hover {
background: rgba(114, 137, 218, 0.05);
transform: translateX(2px);
}

.leaderboard-item.current-user {
background: rgba(114, 137, 218, 0.1);
border-left: 3px solid var(--primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.2);
}

.rank {
min-width: 35px;
font-weight: bold;
color: var(--primary);
font-size: 1rem;
}

.user-name {
flex: 1;
margin: 0 12px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.score {
font-weight: bold;
color: var(--primary);
margin-left: auto;
font-size: 1rem;
}

.empty-leaderboard {
text-align: center;
padding: 30px 20px;
color: var(--text-secondary);
}

.exam-container {
padding: 20px;
}

.exam-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding: 16px;
background: rgba(255, 255, 255, 0.03);
border-radius: var(--border-radius);
}

.timer {
font-size: 1.4rem;
color: var(--primary);
font-weight: bold;
padding: 8px 16px;
background: rgba(114, 137, 218, 0.1);
border-radius: var(--border-radius);
}

.question {
background: rgba(255, 255, 255, 0.03);
padding: 24px;
border-radius: var(--border-radius);
margin-bottom: 20px;
border: 1px solid var(--border-color);
}

.options {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 12px;
margin-top: 20px;
}

.option-btn {
width: 100%;
text-align: left;
padding: 14px 16px;
border-radius: var(--border-radius);
transition: var(--transition);
}

.option-btn.correct {
background: linear-gradient(135deg, var(--success), #27ae60);
}

.option-btn.wrong {
background: linear-gradient(135deg, var(--danger), #c0392b);
}

.exam-result {
text-align: center;
padding: 30px 20px;
}

.exam-result h2 {
margin-bottom: 20px;
color: var(--primary);
}

.exam-result p {
margin-bottom: 12px;
font-size: 1.05rem;
}

.exam-result button {
margin: 8px;
}

/* 🚀 效能優化：滾動條優化 */
::-webkit-scrollbar {
width: 6px;
}

::-webkit-scrollbar-track {
background: var(--bg-primary);
border-radius: 3px;
}

::-webkit-scrollbar-thumb {
background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
background: linear-gradient(to bottom, var(--primary-dark), var(--primary));
}

.sudoku-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 6px;
background: var(--border-color);
padding: 8px;
border-radius: var(--border-radius);
margin-bottom: 20px;
}

.sudoku-cell {
width: 100%;
aspect-ratio: 1;
background: var(--bg-primary);
border: 2px solid transparent;
border-radius: 6px;
color: var(--text-primary);
font-size: 1.5rem;
text-align: center;
cursor: pointer;
transition: var(--transition);
}

.sudoku-cell:disabled {
background: var(--bg-secondary);
color: var(--text-secondary);
cursor: not-allowed;
}

.sudoku-cell:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(114, 137, 218, 0.3);
}

.sudoku-cell::-webkit-inner-spin-button,
.sudoku-cell::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}

/* 🚀 效能優化：載入動畫優化 */
.loading {
text-align: center;
padding: 40px 20px;
color: var(--text-secondary);
}

.loading-spinner {
display: inline-block;
width: 24px;
height: 24px;
border: 3px solid rgba(114, 137, 218, 0.3);
border-top: 3px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-right: 12px;
will-change: transform;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* 🎨 響應式優化 */
@media (max-width: 400px) {
.options {
grid-template-columns: 1fr;
}
.header-actions {
flex-direction: column;
gap: 8px;
}
.header-actions .btn {
width: 100%;
}
}

/* 🚀 效能優化：GPU 加速 */
.btn, .modal, .leaderboard-item, .champion-card {
transform: translateZ(0);
backface-visibility: hidden;
}

/* 🎨 CSS 微調：焦點可見性 */
.btn:focus-visible {
outline: 2px solid var(--primary);
outline-offset: 2px;
}

/* 🎨 CSS 微調：選擇狀態 */
::selection {
background: rgba(114, 137, 218, 0.3);
color: var(--text-primary);
}
</style>
</head>
<body>
<!-- 載入中畫面 -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
正在驗證登入狀態...
</div>
</div>

<!-- 主要內容 -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
<div class="title-text">
  <span>🎯</span>
  <h1>T2日檢疫挑戰系統</h1>
  <button class="btn btn-danger" onclick="logout()">登出</button>
</div>
<div class="user-info">
  <span id="currentUserWelcome">歡迎回來，載入中...</span>
  <span class="connection-status" id="connectionStatus">用戶連線中</span>
</div>
</div>
<div class="header-actions">
<button class="btn btn-primary" onclick="backToT2()">🏠 返回T2日</button>
<button class="btn btn-secondary" onclick="showTotalLeaderboard()">🏆 總分排行榜</button>
</div>
</header>

<div class="challenge-item">
<h3 class="challenge-title">⭐分流考試挑戰⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題60秒作答時間，共15題</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('basic')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('basic')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐英文考試基礎版⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題15秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('food1')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('food1')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐英文考試進階版⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題10秒作答時間，共20題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('food')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('food')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐英文考試強化版⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題10秒作答時間，共30題 一題10分(有點困難)</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('foodplus')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('foodplus')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐前導複查挑戰⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題60秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('precheck')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('precheck')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">規定挑戰</h3>
<p class="challenge-info" style="color:#ef4444;">每題60秒作答時間，共10題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('rule')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('rule')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">🇰🇷韓語挑戰基礎版🇰🇷</h3>
<p class="challenge-info" style="color:#ef4444;">每題12秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('korean')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('korean')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">🇯🇵日語挑戰基礎版🇯🇵</h3>
<p class="challenge-info" style="color:#ef4444;">每題12秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('japanese')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('japanese')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">🇻🇳越南語詞彙挑戰🇻🇳</h3>
<p class="challenge-info" style="color:#ef4444;">每題12秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('vietnamese')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('vietnamese')">查看排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">初階數獨挑戰</h3>
<p class="challenge-info" style="color:#ef4444;">每題80秒作答時間，共10題 一題10分</p>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('sudoku')">開始考試</button>
<button class="btn btn-secondary" onclick="showLeaderboard('sudoku')">查看排行榜</button>
</div>
</div>
</div>

<!-- 排行榜模態視窗 -->
<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">排行榜</h2>
<button class="close-btn" onclick="hideLeaderboard()">×</button>
</div>
<div class="modal-content" id="leaderboardContent">
</div>
</div>
</div>

<script>
// Firebase 配置
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};

// 🚀 效能優化：Firebase 初始化
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// 🚀 效能優化：題庫快取
let examQuestions = {};
let questionsCache = new Map();

async function loadExamQuestions() {
try {
// 檢查快取
const cacheKey = 'exam_questions_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// 快取有效期 1 小時
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examQuestions = JSON.parse(cached);
console.log('✅ 從快取載入題庫');
return;
}

const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`載入題庫失敗：${resp.status}`);
examQuestions = await resp.json();

// 儲存到快取
localStorage.setItem(cacheKey, JSON.stringify(examQuestions));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('✅ 題庫已載入並快取', examQuestions);
} catch (err) {
console.error(err);
alert('系統錯誤：無法載入題庫檔案');
}
}

// ─── 考試配置 ─────────────────────────────────────────
const examConfigs = {
basic:       { name:'⭐分流考試挑戰⭐',    timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
food1:       { name:'⭐英文考試基礎版⭐',    timePerQuestion:15, questionCount:15, fastAnswerThreshold:2.5,questions:[] },
food:        { name:'⭐英文考試進階版⭐',    timePerQuestion:10, questionCount:20, fastAnswerThreshold:2,  questions:[] },
foodplus:    { name:'⭐英文考試強化版⭐',    timePerQuestion:10, questionCount:30, fastAnswerThreshold:2.5,questions:[] },
precheck:    { name:'前導複查挑戰',        timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
rule:        { name:'規定挑戰',            timePerQuestion:60, questionCount:10, fastAnswerThreshold:5,  questions:[] },
korean:      { name:'🇰🇷韓語挑戰基礎版🇰🇷', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
japanese:    { name:'🇯🇵日語挑戰基礎版🇯🇵', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
vietnamese:  { name:'🇻🇳越南語詞彙挑戰🇻🇳', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
sudoku:      { name:'初階數獨挑戰',        timePerQuestion:80, questionCount:10, fastAnswerThreshold:30, questions:[] }
};

// 全域變數
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// 🚀 效能優化：防抖函數
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
const later = () => {
clearTimeout(timeout);
func(...args);
};
clearTimeout(timeout);
timeout = setTimeout(later, wait);
};
}

// 工具函數：從數組中移除特定元素
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// 強制登出函數
function forceLogout(message = '登入驗證失敗，請重新登入') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index.html';
}

// 檢查登入狀態和時效
function checkLoginStatus() {
const flag = localStorage.getItem('t2_login');
const time = localStorage.getItem('t2_login_time');
const user = localStorage.getItem('t2_login_user');
if (flag!=='yes' || !time || !user) {
forceLogout('未檢測到有效登入狀態');
return false;
}
if (Date.now()-parseInt(time) > 3600000) {
forceLogout('登入時間已超過1小時，請重新登入');
return false;
}
return user;
}

// 🚀 效能優化：用戶資料快取
async function loadUsersData() {
try {
// 檢查快取
const cacheKey = 'users_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage
.getItem(cacheTime + '_time');

// 快取有效期 5 分鐘
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 300000) {
usersData = JSON.parse(cached);
console.log('✅ 從快取載入用戶資料');
return;
}

const snapshot = await database.ref('users').once('value');
usersData = snapshot.val() || {};

// 儲存到快取
localStorage.setItem(cacheKey, JSON.stringify(usersData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('✅ 用戶資料已載入並快取');
} catch (err) {
console.error('載入用戶資料失敗:', err);
}
}

// 🚀 效能優化：榜首資料快取
const championCache = new Map();

async function getChampion(examType) {
// 檢查快取
const cacheKey = `champion_${examType}`;
const cached = championCache.get(cacheKey);
if (cached && (Date.now() - cached.timestamp) < 60000) { // 1分鐘快取
return cached.data;
}

try {
const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').limitToLast(1).once('value');
const data = snapshot.val();
if (data) {
const users = Object.keys(data);
const champion = data[users[0]];
const result = { user: users[0], ...champion };

// 快取結果
championCache.set(cacheKey, {
data: result,
timestamp: Date.now()
});
return result;
}
return null;
} catch (err) {
console.error('獲取榜首失敗:', err);
return null;
}
}

// 🚀 效能優化：批量更新榜首顯示
const debouncedUpdateChampions = debounce(updateAllChampions, 300);

async function updateAllChampions() {
const examTypes = Object.keys(examConfigs);
const promises = examTypes.map(async (examType) => {
const champion = await getChampion(examType);
const challengeItem = document.querySelector(`[onclick*="'${examType}'"]`).closest('.challenge-item');
let championDisplay = challengeItem.querySelector('.champion-display');

if (!championDisplay) {
championDisplay = document.createElement('div');
championDisplay.className = 'champion-display';
challengeItem.querySelector('.challenge-info').after(championDisplay);
}

if (champion) {
championDisplay.innerHTML = `
<div class="champion-card">
<span>🏆 榜首：${champion.user}</span>
<span>${champion.score}分</span>
</div>
`;
} else {
championDisplay.innerHTML = `
<div class="champion-empty">
<span>🏆 尚無榜首</span>
</div>
`;
}
});

await Promise.all(promises);
}

// 🚀 效能優化：登入驗證和初始化
async function initializeApp() {
try {
const user = checkLoginStatus();
if (!user) return;

currentUser = user;
document.getElementById('currentUserWelcome').textContent = `歡迎回來，${user}`;

// 並行載入資料
await Promise.all([
loadExamQuestions(),
loadUsersData()
]);

// 更新榜首顯示
await updateAllChampions();

// 隱藏載入畫面，顯示主要內容
document.getElementById('loadingScreen').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';

} catch (err) {
console.error('初始化失敗:', err);
alert('系統初始化失敗，請重新整理頁面');
}
}

// 登出功能
function logout() {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
// 清除快取
localStorage.removeItem('exam_questions_v1');
localStorage.removeItem('exam_questions_v1_time');
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
championCache.clear();
window.location.href = 'index.html';
}

// 返回T2日
function backToT2() {
window.location.href = 'dashboard.html';
}

// 🚀 效能優化：題目隨機化
function shuffleArray(array) {
const newArray = [...array];
for (let i = newArray.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[newArray[i], newArray[j]] = [newArray[j], newArray[i]];
}
return newArray;
}

// 🚀 效能優化：考試開始優化
function startExam(examType) {
if (!examQuestions[examType]) {
alert('題庫載入中，請稍後再試');
return;
}

const config = examConfigs[examType];
const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

if (questions.length === 0) {
alert('此考試類型暫無題目');
return;
}

currentExam = examType;
currentQuestions = questions;
currentQuestionIndex = 0;
userScores = { fastAnswers: 0, correctAnswers: 0 };
examStartTime = Date.now();

// 🚀 效能優化：DOM 批量更新
const container = document.querySelector('.container');
container.innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
<button class="btn btn-danger" onclick="abandonExam()">🚫 放棄考試</button>
</div>
<div id="questionContainer"></div>
</div>
`;

showQuestion();
}

// 🚀 效能優化：題目顯示優化
function showQuestion() {
if (currentQuestionIndex >= currentQuestions.length) {
showExamResult();
return;
}

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const container = document.getElementById('questionContainer');

questionStartTime = Date.now();

// 🚀 效能優化：使用 DocumentFragment
const fragment = document.createDocumentFragment();

if (currentExam === 'sudoku') {
// 數獨題目
const questionDiv = document.createElement('div');
questionDiv.className = 'question';
questionDiv.innerHTML = `
<h3>第 ${currentQuestionIndex + 1} 題 / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="sudoku-grid" id="sudokuGrid"></div>
<button class="btn btn-primary" onclick="submitSudokuAnswer()">提交答案</button>
`;
fragment.appendChild(questionDiv);

container.innerHTML = '';
container.appendChild(fragment);

// 生成數獨網格
const grid = document.getElementById('sudokuGrid');
for (let i = 0; i < 16; i++) {
const cell = document.createElement('input');
cell.type = 'number';
cell.className = 'sudoku-cell';
cell.min = '1';
cell.max = '4';
cell.id = `cell-${i}`;
if (question.given && question.given[i]) {
cell.value = question.given[i];
cell.disabled = true;
}
grid.appendChild(cell);
}
} else {
// 選擇題
const questionDiv = document.createElement('div');
questionDiv.className = 'question';
questionDiv.innerHTML = `
<h3>第 ${currentQuestionIndex + 1} 題 / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="options">
${question.options.map((option, index) => 
`<button class="btn btn-primary option-btn" onclick="selectAnswer(${index})">${option}</button>`
).join('')}
</div>
`;
fragment.appendChild(questionDiv);

container.innerHTML = '';
container.appendChild(fragment);
}

startQuestionTimer();
}

// 🚀 效能優化：計時器優化
function startQuestionTimer() {
const config = examConfigs[currentExam];
let timeLeft = config.timePerQuestion;
const timerElement = document.getElementById('timer');

clearInterval(examTimer);
examTimer = setInterval(() => {
timeLeft--;
timerElement.textContent = timeLeft;

if (timeLeft <= 5) {
timerElement.style.color = '#ef4444';
timerElement.style.animation = 'pulse 0.5s infinite';
}

if (timeLeft <= 0) {
clearInterval(examTimer);
selectAnswer(-1); // 時間到，視為答錯
}
}, 1000);
}

// 選擇答案
function selectAnswer(selectedIndex) {
clearInterval(examTimer);
const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;

const isCorrect = selectedIndex === question.correct;
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) userScores.fastAnswers++;
}

// 🚀 效能優化：視覺回饋優化
const options = document.querySelectorAll('.option-btn');
options.forEach((btn, index) => {
btn.disabled = true;
if (index === question.correct) {
btn.classList.add('correct');
} else if (index === selectedIndex && !isCorrect) {
btn.classList.add('wrong');
}
});

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 1500);
}

// 數獨答案提交
function submitSudokuAnswer() {
clearInterval(examTimer);
const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;

const userAnswer = [];
for (let i = 0; i < 16; i++) {
const cell = document.getElementById(`cell-${i}`);
userAnswer.push(parseInt(cell.value) || 0);
}

const isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.solution);
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) userScores.fastAnswers++;
}

// 視覺回饋
const grid = document.getElementById('sudokuGrid');
grid.style.border = isCorrect ? '3px solid #22c55e' : '3px solid #ef4444';

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 1500);
}

// 放棄考試
function abandonExam() {
if (confirm('確定要放棄考試嗎？')) {
clearInterval(examTimer);
location.reload();
}
}

// 🚀 效能優化：考試結果顯示優化
async function showExamResult() {
clearInterval(examTimer);
const config = examConfigs[currentExam];
const totalTime = Math.round((Date.now() - examStartTime) / 1000);
const score = userScores.correctAnswers * 10;

// 🚀 效能優化：並行處理成績保存和顯示
const savePromise = saveScore(currentExam, score, totalTime, userScores.fastAnswers);

const container = document.querySelector('.container');
container.innerHTML = `
<div class="exam-result">
<h2>🎯 考試完成！</h2>
<p><strong>考試項目：</strong>${config.name}</p>
<p><strong>總分：</strong>${score} 分</p>
<p><strong>答對題數：</strong>${userScores.correctAnswers} / ${config.questionCount}</p>
<p><strong>快速答題：</strong>${userScores.fastAnswers} 題</p>
<p><strong>總用時：</strong>${totalTime} 秒</p>
<div style="margin-top: 20px;">
<button class="btn btn-primary" onclick="location.reload()">返回挑戰列表</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">查看排行榜</button>
</div>
</div>
`;

try {
await savePromise;
console.log('✅ 成績已保存');
} catch (err) {
console.error('❌ 成績保存失敗:', err);
}
}

// 🚀 效能優化：成績保存優化
async function saveScore(examType, score, totalTime, fastAnswers) {
try {
const scoreData = {
score: score,
totalTime: totalTime,
fastAnswers: fastAnswers,
timestamp: Date.now(),
date: new Date().toISOString().split('T')[0]
};

// 批量更新
const updates = {};
updates[`leaderboard/${examType}/${currentUser}`] = scoreData;
updates[`users/${currentUser}/scores/${examType}`] = scoreData;

await database.ref().update(updates);

// 清除相關快取
championCache.delete(`champion_${examType}`);
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');

} catch (err) {
console.error('保存成績失敗:', err);
throw err;
}
}

// 🚀 效能優化：排行榜顯示優化
async function showLeaderboard(examType) {
try {
document.getElementById('modalTitle').textContent = `${examConfigs[examType].name} - 排行榜`;
document.getElementById('leaderboardContent').innerHTML = `
<div class="loading">
<div class="loading-spinner"></div>
載入排行榜中...
</div>
`;
document.getElementById('leaderboardModal').style.display = 'flex';

const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').once('value');
const data = snapshot.val() || {};
const leaderboard = Object.entries(data)
.map(([user, score]) => ({ user, ...score }))
.sort((a, b) => {
if (b.score !== a.score) return b.score - a.score;
return a.totalTime - b.totalTime;
});

displayLeaderboard(leaderboard, examType);
} catch (err) {
console.error('載入排行榜失敗:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>載入排行榜失敗</p>
<p>請稍後再試</p>
</div>
`;
}
}

// 🚀 效能優化：總分排行榜
async function showTotalLeaderboard() {
try {
document.getElementById('modalTitle').textContent = '🏆 總分排行榜';
document.getElementById('leaderboardContent').innerHTML = `
<div class="loading">
<div class="loading-spinner"></div>
計算總分中...
</div>
`;
document.getElementById('leaderboardModal').style.display = 'flex';

// 並行載入所有排行榜資料
const examTypes = Object.keys(examConfigs);
const promises = examTypes.map(examType => 
database.ref(`leaderboard/${examType}`).once('value')
);

const snapshots = await Promise.all(promises);
const totalScores = {};

// 計算總分
snapshots.forEach((snapshot, index) => {
const examType = examTypes[index];
const data = snapshot.val() || {};

Object.entries(data).forEach(([user, scoreData]) => {
if (!totalScores[user]) {
totalScores[user] = { totalScore: 0, totalTime: 0, examCount: 0 };
}
totalScores[user].totalScore += scoreData.score || 0;
totalScores[user].totalTime += scoreData.totalTime || 0;
totalScores[user].examCount++;
});
});

const leaderboard = Object.entries(totalScores)
.map(([user, data]) => ({ user, ...data }))
.sort((a, b) => {
if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
return a.totalTime - b.totalTime;
});

displayTotalLeaderboard(leaderboard);
} catch (err) {
console.error('載入總分排行榜失敗:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>載入總分排行榜失敗</p>
<p>請稍後再試</p>
</div>
`;
}
}

// 🚀 效能優化：排行榜顯示函數
function displayLeaderboard(leaderboard, examType) {
const content = document.getElementById('leaderboardContent');

if (leaderboard.length === 0) {
content.innerHTML = `
<div class="empty-leaderboard">
<p>🏆 尚無挑戰記錄</p>
<p>成為第一個挑戰者吧！</p>
</div>
`;
return;
}

// 🚀 效能優化：使用 DocumentFragment
const fragment = document.createDocumentFragment();
const container = document.createElement('div');
container.className = 'leaderboard-container';

leaderboard.forEach((item, index) => {
const div = document.createElement('div');
div.className = `leaderboard-item ${item.user === currentUser ? 'current-user' : ''}`;

let rankDisplay = `${index + 1}`;
if (index === 0) rankDisplay = '🥇';
else if (index === 1) rankDisplay = '🥈';
else if (index === 2) rankDisplay = '🥉';

// 檢查是否為首綁
let firstBindBadge = '';
if (index > 0 && leaderboard[index-1].score === item.score) {
const sameScoreItems = leaderboard.filter(x => x.score === item.score);
const fastest = sameScoreItems.reduce((min, curr) => 
curr.totalTime < min.totalTime ? curr : min
);
if (item.user === fastest.user) {
firstBindBadge = ' <span style="color:#f59e0b;">👑首綁</span>';
}
}

div.innerHTML = `
<div class="rank">${rankDisplay}</div>
<div class="user-name">${item.user}${firstBindBadge}</div>
<div class="score">${item.score}分</div>
`;

container.appendChild(div);
});

fragment.appendChild(container);
content.innerHTML = '';
content.appendChild(fragment);
}

function displayTotalLeaderboard(leaderboard) {
const content = document.getElementById('leaderboardContent');
  
if (leaderboard.length === 0) {
content.innerHTML = `
<div class="empty-leaderboard">
<p>🏆 尚無挑戰記錄</p>
<p>開始你的第一次挑戰吧！</p>
</div>
`;
return;
}

// 🚀 效能優化：使用 DocumentFragment
const fragment = document.createDocumentFragment();
const container = document.createElement('div');
container.className = 'leaderboard-container';

leaderboard.forEach((item, index) => {
const div = document.createElement('div');
div.className = `leaderboard-item ${item.user === currentUser ? 'current-user' : ''}`;

let rankDisplay = `${index + 1}`;
if (index === 0) rankDisplay = '🥇';
else if (index === 1) rankDisplay = '🥈';
else if (index === 2) rankDisplay = '🥉';

// 檢查是否為首綁
let firstBindBadge = '';
if (index > 0 && leaderboard[index-1].totalScore === item.totalScore) {
const sameScoreItems = leaderboard.filter(x => x.totalScore === item.totalScore);
const fastest = sameScoreItems.reduce((min, curr) => 
curr.totalTime < min.totalTime ? curr : min
);
if (item.user === fastest.user) {
firstBindBadge = ' <span style="color:#f59e0b;">👑首綁</span>';
}
}

div.innerHTML = `
<div class="rank">${rankDisplay}</div>
<div class="user-name">${item.user}${firstBindBadge}</div>
<div class="score">${item.totalScore}分 (${item.examCount}項)</div>
`;

container.appendChild(div);
});

fragment.appendChild(container);
content.innerHTML = '';
content.appendChild(fragment);
}

function hideLeaderboard() {
document.getElementById('leaderboardModal').style.display = 'none';
}

// 🚀 效能優化：頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', initializeApp);

// 🚀 效能優化：頁面可見性變化時更新資料
document.addEventListener('visibilitychange', () => {
if (!document.hidden && currentUser) {
debouncedUpdateChampions();
}
});

// 🚀 效能優化：鍵盤快捷鍵
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') {
hideLeaderboard();
}
});
</script>
</body>
</html>
