<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2日檢疫挑戰系統</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "微軟正黑體", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
margin-left: 8px;
}

.btn {
padding: 8px 16px;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 0.9rem;
transition: all 0.3s ease;
flex: 1;
}

.btn-primary {
background: var(--primary);
color: var(--text-primary);
}

.btn-primary:hover {
background: var(--primary-dark);
}

.btn-secondary {
background: var(--warning);
color: var(--text-primary);
}

.btn-danger {
background: var(--danger);
color: var(--text-primary);
}

.challenge-item {
padding: 15px;
border-bottom: 1px solid var(--border-color);
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 8px;
}

/* 🏆 新增：榜首顯示樣式 */
.champion-display {
margin-bottom: 8px;
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 400px;
max-height: 80vh;
border-radius: 12px;
overflow: hidden;
position: relative;
}

.modal-header {
padding: 15px;
background: var(--primary);
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 0 8px;
}

.modal-content {
padding: 15px;
overflow-y: auto;
max-height: calc(80vh - 56px);
min-height: 200px;
}

.leaderboard-container {
max-height: calc(60vh - 100px);
overflow-y: auto;
padding-right: 5px;
}

.leaderboard-item {
display: flex;
align-items: center;
padding: 8px 12px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s;
}

.leaderboard-item.current-user {
background: rgba(114, 137, 218, 0.1);
border-left: 3px solid var(--primary);
}

.rank {
min-width: 30px;
font-weight: bold;
color: var(--primary);
}

.user-name {
flex: 1;
margin: 0 10px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.score {
font-weight: bold;
color: var(--primary);
margin-left: auto;
}

.empty-leaderboard {
text-align: center;
padding: 20px;
color: var(--text-secondary);
}

.exam-container {
padding: 20px;
}

.exam-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.timer {
font-size: 1.2rem;
color: var(--primary);
}

.question {
background: var(--bg-secondary);
padding: 20px;
border-radius: 8px;
margin-bottom: 20px;
}

.options {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;
margin-top: 20px;
}

.option-btn {
width: 100%;
text-align: left;
padding: 12px;
}

.option-btn.correct {
background: var(--success);
}

.option-btn.wrong {
background: var(--danger);
}

.exam-result {
text-align: center;
padding: 20px;
}

.exam-result h2 {
margin-bottom: 20px;
}

.exam-result p {
margin-bottom: 10px;
}

.exam-result button {
margin: 10px;
}

::-webkit-scrollbar {
width: 8px;
}

::-webkit-scrollbar-track {
background: var(--bg-primary);
}

::-webkit-scrollbar-thumb {
background: var(--primary);
border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
background: var(--primary-dark);
}

.sudoku-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 4px;
background: var(--border-color);
padding: 4px;
border-radius: 8px;
margin-bottom: 20px;
}

.sudoku-cell {
width: 100%;
aspect-ratio: 1;
background: var(--bg-primary);
border: none;
border-radius: 4px;
color: var(--text-primary);
font-size: 1.5rem;
text-align: center;
cursor: pointer;
}

.sudoku-cell:disabled {
background: var(--bg-secondary);
color: var(--text-secondary);
cursor: not-allowed;
}

.sudoku-cell:focus {
outline: 2px solid var(--primary);
}

.sudoku-cell::-webkit-inner-spin-button,
.sudoku-cell::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}

.loading {
text-align: center;
padding: 40px 20px;
color: var(--text-secondary);
}

.loading-spinner {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid #f3f3f3;
border-top: 3px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-right: 10px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
<!-- 載入中畫面 -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
正在驗證登入狀態...
</div>
</div>

<!-- 主要內容 -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
  <div class="title-text">
      <span>🎯</span>
      <h1>T2日檢疫挑戰系統</h1>
      <button class="btn btn-danger" onclick="logout()">登出</button>
  </div>
  <div class="user-info">
      <span id="currentUserWelcome">歡迎回來，載入中...</span>
      <span class="connection-status" id="connectionStatus">用戶連線中</span>
  </div>
</div>
<div class="header-actions">
  <button class="btn btn-primary" onclick="backToT2()">返回T2日</button>
</div>
</header>

<div class="challenge-item">
<h3 class="challenge-title">⭐分流考試挑戰⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題60秒作答時間，共15題</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('basic')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('basic')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐英文考試基礎版⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題15秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('food1')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('food1')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐英文考試進階版⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題10秒作答時間，共20題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('food')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('food')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐英文考試強化版⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題10秒作答時間，共30題 一題10分(有點困難)</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('foodplus')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('foodplus')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">⭐前導複查挑戰⭐</h3>
<p class="challenge-info" style="color:#ef4444;">每題60秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('precheck')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('precheck')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">規定挑戰</h3>
<p class="challenge-info" style="color:#ef4444;">每題60秒作答時間，共10題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('rule')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('rule')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">🇰🇷韓語挑戰基礎版🇰🇷</h3>
<p class="challenge-info" style="color:#ef4444;">每題12秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('korean')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('korean')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">🇯🇵日語挑戰基礎版🇯🇵</h3>
<p class="challenge-info" style="color:#ef4444;">每題12秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('japanese')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('japanese')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">🇻🇳越南語詞彙挑戰🇻🇳</h3>
<p class="challenge-info" style="color:#ef4444;">每題12秒作答時間，共15題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('vietnamese')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('vietnamese')">排行榜</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">初階數獨挑戰</h3>
<p class="challenge-info" style="color:#ef4444;">每題80秒作答時間，共10題 一題10分</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('sudoku')">考試</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('sudoku')">排行榜</button>
</div>
</div>
</div>

<!-- 排行榜模態視窗 -->
<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
  <h2 id="modalTitle">排行榜</h2>
  <button class="close-btn" onclick="hideLeaderboard()">×</button>
</div>
<div class="modal-content" id="leaderboardContent">
</div>
</div>
</div>

<script>
// Firebase 配置
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};
// 初始化 Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ─── 題庫宣告 & 載入函式 ─────────────────────────
let examQuestions = {};
async function loadExamQuestions() {
try {
const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`載入題庫失敗：${resp.status}`);
examQuestions = await resp.json();
console.log('✅ 題庫已載入', examQuestions);
} catch (err) {
console.error(err);
alert('系統錯誤：無法載入題庫檔案');
}
}

// ─── 考試配置 ─────────────────────────────────────────
const examConfigs = {
basic:       { name:'⭐分流考試挑戰⭐',    timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
food1:       { name:'⭐英文考試基礎版⭐',    timePerQuestion:15, questionCount:15, fastAnswerThreshold:2.5,questions:[] },
food:        { name:'⭐英文考試進階版⭐',    timePerQuestion:10, questionCount:20, fastAnswerThreshold:2,  questions:[] },
foodplus:    { name:'⭐英文考試強化版⭐',    timePerQuestion:10, questionCount:30, fastAnswerThreshold:2.5,questions:[] },
precheck:    { name:'前導複查挑戰',        timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
rule:        { name:'規定挑戰',            timePerQuestion:60, questionCount:10, fastAnswerThreshold:5,  questions:[] },
korean:      { name:'🇰🇷韓語挑戰基礎版🇰🇷', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
japanese:    { name:'🇯🇵日語挑戰基礎版🇯🇵', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
vietnamese:  { name:'🇻🇳越南語詞彙挑戰🇻🇳', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
sudoku:      { name:'初階數獨挑戰',        timePerQuestion:80, questionCount:10, fastAnswerThreshold:30, questions:[] }
};

// 全域變數
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// 工具函數：從數組中移除特定元素
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// 強制登出函數
function forceLogout(message = '登入驗證失敗，請重新登入') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index.html';
}

// 檢查登入狀態和時效
function checkLoginStatus() {
const flag = localStorage.getItem('t2_login');
const time = localStorage.getItem('t2_login_time');
const user = localStorage.getItem('t2_login_user');
if (flag!=='yes' || !time || !user) {
forceLogout('未檢測到有效登入狀態');
return false;
}
if (Date.now()-parseInt(time) > 3600000) {
forceLogout('登入時間已超過1小時，請重新登入');
return false;
}
return user;
}

// 載入用戶資料庫
async function loadUsersData() {
try {
const resp = await fetch('password.json');
if (!resp.ok) throw new Error('無法載入用戶資料庫');
const data = await resp.json();
usersData = Array.isArray(data)? data : [data];
return true;
} catch (err) {
console.error('載入用戶資料庫失敗:', err);
forceLogout('系統錯誤：無法載入用戶資料庫');
return false;
}
}

// 驗證用戶
function validateUser(username) {
const pwd = localStorage.getItem('t2_login_password');
const user = usersData.find(u=>u.username===username && u.password===pwd);
if (!user) {
console.error('用戶不存在', username);
forceLogout('用戶帳號不存在於系統中');
return null;
}
return user;
}

// 顯示歡迎
function showWelcomeMessage(user) {
const elm = document.getElementById('currentUserWelcome');
const name = user.welcome||user._comment||user.username;
elm.textContent = `歡迎回來，${name}`;
}

// 🏆 載入所有榜首資訊 - 修正同分處理
async function loadAllChampions() {
const examTypes = ['basic', 'food1', 'food', 'foodplus', 'precheck', 'rule', 'korean', 'japanese', 'vietnamese', 'sudoku'];
const champions = {};

try {
  console.log('🔄 開始載入排行榜資料...');
  
  for (const examType of examTypes) {
      const snapshot = await database.ref(`scores/${examType}`).once('value');
      const scores = [];
      
      snapshot.forEach(child => {
          scores.push(child.val());
      });
      
      if (scores.length > 0) {
          // 🏆 排序邏輯：分數 → 消耗時間 → 首綁時間
          scores.sort((a, b) => {
              if (b.score !== a.score) {
                  return b.score - a.score; // 分數高的在前
              }
              if (a.totalTime !== b.totalTime) {
                  return (a.totalTime || 999999) - (b.totalTime || 999999); // 同分時，時間短的在前
              }
              return a.timestamp - b.timestamp; // 時間也相同時，時間戳早的在前（首綁）
          });
          
          // 取得榜首
          const champion = scores[0];
          const sameScoreCount = scores.filter(s => s.score === champion.score).length;
          champions[examType] = {
              displayName: champion.displayName,
              score: champion.score,
              timestamp: champion.timestamp,
              totalTime: champion.totalTime,
              hasMultipleSameScore: sameScoreCount > 1
          };
          
          console.log(`🏆 ${examType} 榜首: ${champion.displayName} (${champion.score}分) - 首綁時間: ${new Date(champion.timestamp).toLocaleString()}`);
      }
  }
  
  // 更新頁面顯示
  updateChampionDisplay(champions);
  console.log('✅ 排行榜資料已載入', champions);
  
} catch (error) {
  console.error('❌ 載入榜首資訊失敗:', error);
}
}

// 🏆 更新榜首顯示 - 加入首綁標記
function updateChampionDisplay(champions) {
const challengeItems = document.querySelectorAll('.challenge-item');

challengeItems.forEach(item => {
  const title = item.querySelector('.challenge-title');
  const actions = item.querySelector('.challenge-actions');
  
  // 根據標題判斷考試類型
  let examType = '';
  if (title.textContent.includes('分流考試挑戰')) examType = 'basic';
  else if (title.textContent.includes('⭐英文考試基礎版⭐')) examType = 'food1';
  else if (title.textContent.includes('⭐英文考試進階版⭐')) examType = 'food';
  else if (title.textContent.includes('⭐英文考試強化版⭐')) examType = 'foodplus';
  else if (title.textContent.includes('⭐前導複查挑戰⭐')) examType = 'precheck';
  else if (title.textContent.includes('規定挑戰')) examType = 'rule';
  else if (title.textContent.includes('🇰🇷韓語挑戰基礎版🇰🇷')) examType = 'korean';
  else if (title.textContent.includes('🇯🇵日語挑戰基礎版🇯🇵')) examType = 'japanese';
  else if (title.textContent.includes('🇻🇳越南語詞彙挑戰🇻🇳')) examType = 'vietnamese';
  else if (title.textContent.includes('初階數獨挑戰')) examType = 'sudoku';
  
  // 如果有榜首資訊，添加顯示
  if (examType && champions[examType]) {
      // 檢查是否已經有榜首顯示，避免重複添加
      let championDiv = item.querySelector('.champion-display');
      if (!championDiv) {
          championDiv = document.createElement('div');
          championDiv.className = 'champion-display';
          // 插入到 challenge-actions 之前
          item.insertBefore(championDiv, actions);
      }
      
      // 🏆 加入首綁標記和時間顯示
      const champion = champions[examType];
      const bindDate = new Date(champion.timestamp).toLocaleDateString();
      
      // 🏆 檢查是否真的有同分才顯示首綁標記
      const bindMark = champion.hasMultipleSameScore ? ' 🥇' : '';
      
      // 格式化時間顯示
      const timeDisplay = champion.totalTime ? 
          `${Math.floor(champion.totalTime / 60)}:${(champion.totalTime % 60).toString().padStart(2, '0')}` : 
          '';

      championDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; 
                  background: linear-gradient(45deg, #FFD700, #FFA500); 
                  color: #000; padding: 6px 12px; border-radius: 6px; 
                  font-size: 0.85rem; font-weight: bold; margin-bottom: 8px;
                  box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);">
              <span>🏆 榜首：${champion.displayName}${bindMark}</span>
              <div style="text-align: right;">
                  <div>${champion.score}分</div>
                  <div style="font-size: 0.7rem; opacity: 0.8;">
                      ${champion.hasMultipleSameScore ? '首綁 ' : ''}${bindDate}
                      ${timeDisplay ? ` (${timeDisplay})` : ''}
                  </div>
              </div>
          </div>
      `;
  } else if (examType) {
      // 如果沒有榜首資訊，顯示空榜首
      let championDiv = item.querySelector('.champion-display');
      if (!championDiv) {
          championDiv = document.createElement('div');
          championDiv.className = 'champion-display';
          item.insertBefore(championDiv, actions);
      }
      
      championDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; 
                     background: rgba(255, 255, 255, 0.1); 
                     color: #a0a0a0; padding: 6px 12px; border-radius: 6px; 
                     font-size: 0.85rem; margin-bottom: 8px;
                     border: 1px dashed rgba(255, 255, 255, 0.2);">
              <span>🏆 暫無榜首</span>
          </div>
      `;
  }
});
}

// 主要初始化
async function initializePage() {
try {
await
loadExamQuestions();
const success = await loadUsersData();
if (!success) return;

const username = checkLoginStatus();
if (!username) return;

currentUser = validateUser(username);
if (!currentUser) return;

showWelcomeMessage(currentUser);
await loadAllChampions();

document.getElementById('loadingScreen').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';
console.log('✅ 系統初始化完成');
} catch (error) {
console.error('❌ 初始化失敗:', error);
forceLogout('系統初始化失敗，請重新登入');
}
}

// 登出功能
function logout() {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
window.location.href = 'index.html';
}

// 返回T2日功能
function backToT2() {
window.location.href = 'T2日.html';
}

// ─── 排行榜功能 ─────────────────────────────────────────
async function showLeaderboard(examType) {
try {
const config = examConfigs[examType];
if (!config) {
alert('考試類型不存在');
return;
}

document.getElementById('modalTitle').textContent = `${config.name} - 排行榜`;
document.getElementById('leaderboardContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div>載入排行榜中...</div>';
document.getElementById('leaderboardModal').style.display = 'flex';

const snapshot = await database.ref(`scores/${examType}`).once('value');
const scores = [];

snapshot.forEach(child => {
scores.push(child.val());
});

if (scores.length === 0) {
document.getElementById('leaderboardContent').innerHTML = '<div class="empty-leaderboard">目前還沒有任何成績</div>';
return;
}

// 🏆 排序邏輯：分數 → 消耗時間 → 首綁時間
scores.sort((a, b) => {
if (b.score !== a.score) {
return b.score - a.score; // 分數高的在前
}
if (a.totalTime !== b.totalTime) {
return (a.totalTime || 999999) - (b.totalTime || 999999); // 同分時，時間短的在前
}
return a.timestamp - b.timestamp; // 時間也相同時，時間戳早的在前（首綁）
});

let html = '<div class="leaderboard-container">';
scores.forEach((score, index) => {
const isCurrentUser = score.username === currentUser.username;
const timeDisplay = score.totalTime ? 
`${Math.floor(score.totalTime / 60)}:${(score.totalTime % 60).toString().padStart(2, '0')}` : 
'--:--';

// 🏆 檢查是否為首綁（同分中時間戳最早的）
const sameScoreUsers = scores.filter(s => s.score === score.score);
const isFirstBind = sameScoreUsers.length > 1 && 
sameScoreUsers.sort((a, b) => a.timestamp - b.timestamp)[0].username === score.username;

html += `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">${index + 1}</div>
<div class="user-name">
${score.displayName}${isFirstBind ? ' 🥇' : ''}
<div style="font-size: 0.7rem; color: var(--text-secondary);">
${new Date(score.timestamp).toLocaleDateString()} ${timeDisplay}
</div>
</div>
<div class="score">${score.score}分</div>
</div>
`;
});
html += '</div>';

document.getElementById('leaderboardContent').innerHTML = html;
} catch (error) {
console.error('載入排行榜失敗:', error);
document.getElementById('leaderboardContent').innerHTML = '<div class="empty-leaderboard">載入排行榜時發生錯誤</div>';
}
}

function hideLeaderboard() {
document.getElementById('leaderboardModal').style.display = 'none';
}

// ─── 考試功能 ─────────────────────────────────────────
function startExam(examType) {
const config = examConfigs[examType];
if (!config) {
alert('考試類型不存在');
return;
}

if (!examQuestions[examType] || examQuestions[examType].length === 0) {
alert(`${config.name} 題庫尚未載入或為空`);
return;
}

// 隨機選取題目
const allQuestions = [...examQuestions[examType]];
currentQuestions = [];
for (let i = 0; i < config.questionCount && allQuestions.length > 0; i++) {
const randomIndex = Math.floor(Math.random() * allQuestions.length);
currentQuestions.push(allQuestions[randomIndex]);
allQuestions.splice(randomIndex, 1);
}

currentExam = examType;
currentQuestionIndex = 0;
userScores = { fastAnswers: 0, correctAnswers: 0 };
examStartTime = Date.now();

showExamInterface();
showQuestion();
}

function showExamInterface() {
const config = examConfigs[currentExam];
document.getElementById('mainContent').innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
</div>
<div class="question" id="questionContainer">
</div>
</div>
`;
}

function showQuestion() {
if (currentQuestionIndex >= currentQuestions.length) {
endExam();
return;
}

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
questionStartTime = Date.now();

let questionHTML = '';

if (currentExam === 'sudoku') {
// 數獨題目顯示
questionHTML = `
<h3>第 ${currentQuestionIndex + 1} 題 / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="sudoku-grid" id="sudokuGrid">
${question.grid.map((cell, index) => 
`<input type="number" class="sudoku-cell" min="1" max="4" 
${cell !== 0 ? `value="${cell}" disabled` : ''} 
data-index="${index}">`
).join('')}
</div>
<button class="btn btn-primary" onclick="checkSudokuAnswer()">提交答案</button>
`;
} else {
// 一般選擇題顯示
questionHTML = `
<h3>第 ${currentQuestionIndex + 1} 題 / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="options">
${question.options.map((option, index) => 
`<button class="btn btn-primary option-btn" onclick="selectAnswer(${index})">${option}</button>`
).join('')}
</div>
`;
}

document.getElementById('questionContainer').innerHTML = questionHTML;

// 開始倒數計時
let timeLeft = config.timePerQuestion;
document.getElementById('timer').textContent = timeLeft;

examTimer = setInterval(() => {
timeLeft--;
document.getElementById('timer').textContent = timeLeft;

if (timeLeft <= 0) {
clearInterval(examTimer);
selectAnswer(-1); // 時間到，視為答錯
}
}, 1000);
}

function selectAnswer(selectedIndex) {
clearInterval(examTimer);

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;
const isCorrect = selectedIndex === question.correct;
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) {
userScores.fastAnswers++;
}
}

// 顯示答案反饋
const options = document.querySelectorAll('.option-btn');
options.forEach((btn, index) => {
btn.disabled = true;
if (index === question.correct) {
btn.classList.add('correct');
} else if (index === selectedIndex && !isCorrect) {
btn.classList.add('wrong');
}
});

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 1500);
}

function checkSudokuAnswer() {
clearInterval(examTimer);

const inputs = document.querySelectorAll('.sudoku-cell:not([disabled])');
const userAnswer = [];

inputs.forEach(input => {
userAnswer.push(parseInt(input.value) || 0);
});

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;
const isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.answer);
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) {
userScores.fastAnswers++;
}
}

// 顯示答案反饋
inputs.forEach((input, index) => {
if (parseInt(input.value) === question.answer[index]) {
input.style.background = 'var(--success)';
} else {
input.style.background = 'var(--danger)';
}
input.disabled = true;
});

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 2000);
}

async function endExam() {
const config = examConfigs[currentExam];
const totalTime = Math.floor((Date.now() - examStartTime) / 1000);
const finalScore = userScores.correctAnswers * 10;

// 保存成績到 Firebase
const scoreData = {
username: currentUser.username,
displayName: currentUser.welcome || currentUser._comment || currentUser.username,
score: finalScore,
correctAnswers: userScores.correctAnswers,
fastAnswers: userScores.fastAnswers,
totalQuestions: currentQuestions.length,
totalTime: totalTime,
timestamp: Date.now()
};

try {
await database.ref(`scores/${currentExam}`).push(scoreData);
console.log('✅ 成績已保存');
} catch (error) {
console.error('❌ 保存成績失敗:', error);
}

// 顯示考試結果
showExamResult(finalScore, totalTime);
}

function showExamResult(score, totalTime) {
const config = examConfigs[currentExam];
const minutes = Math.floor(totalTime / 60);
const seconds = totalTime % 60;

document.getElementById('mainContent').innerHTML = `
<div class="exam-result">
<h2>考試完成！</h2>
<p><strong>考試類型：</strong>${config.name}</p>
<p><strong>最終得分：</strong>${score} 分</p>
<p><strong>答對題數：</strong>${userScores.correctAnswers} / ${currentQuestions.length}</p>
<p><strong>快速作答：</strong>${userScores.fastAnswers} 題</p>
<p><strong>總用時：</strong>${minutes}:${seconds.toString().padStart(2, '0')}</p>
<button class="btn btn-primary" onclick="restartExam()">再次挑戰</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">查看排行榜</button>
<button class="btn btn-danger" onclick="backToMain()">返回主頁</button>
</div>
`;
}

function restartExam() {
if (currentExam) {
startExam(currentExam);
} else {
backToMain();
}
}

function backToMain() {
location.reload();
}

// 頁面載入時初始化
window.addEventListener('load', initializePage);

// 點擊模態視窗外部關閉
document.getElementById('leaderboardModal').addEventListener('click', function(e) {
if (e.target === this) {
hideLeaderboard();
}
});
</script>
</body>
</html>
