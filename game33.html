<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--border-radius: 8px;
--gold: #fbbf24;
--silver: #9ca3af;
--bronze: #d97706;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "å¾®è»Ÿæ­£é»‘é«”", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
line-height: 1.5;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
will-change: scroll-position;
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
display: flex;
align-items: center;
justify-content: space-between;
}

.user-currency {
display: flex;
gap: 12px;
align-items: center;
}

.currency-item {
display: flex;
align-items: center;
gap: 4px;
background: rgba(255, 255, 255, 0.05);
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

.btn {
padding: 10px 16px;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
font-size: 0.9rem;
font-weight: 500;
transition: var(--transition);
flex: 1;
position: relative;
overflow: hidden;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
min-height: 44px;
}

.btn-primary {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.3);
}

.btn-danger {
background: linear-gradient(135deg, var(--danger), #c0392b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.btn-secondary {
background: linear-gradient(135deg, var(--warning), #e67e22);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.btn-shop {
background: linear-gradient(135deg, var(--gold), #f59e0b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
}

.header-actions {
display: flex;
gap: 8px;
margin-top: 12px;
}

.header-actions .btn {
flex: 1;
font-size: 0.8rem;
padding: 8px 10px;
min-height: 36px;
}

.user-medals {
display: flex;
gap: 4px;
margin-top: 8px;
flex-wrap: wrap;
}

.medal-icon {
display: inline-flex;
align-items: center;
justify-content: center;
width: 28px;
height: 28px;
border-radius: 50%;
font-size: 0.9rem;
border: 2px solid;
background: rgba(255, 255, 255, 0.1);
transition: var(--transition);
cursor: pointer;
overflow: hidden;
}

.loading {
text-align: center;
padding: 40px 20px;
color: var(--text-secondary);
}

.loading-spinner {
display: inline-block;
width: 24px;
height: 24px;
border: 3px solid rgba(114, 137, 218, 0.3);
border-top: 3px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-right: 12px;
will-change: transform;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.challenge-item {
padding: 16px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s ease;
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
font-weight: 600;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 10px;
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
backdrop-filter: blur(4px);
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 420px;
max-height: 85vh;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
}

.modal-header {
padding: 16px;
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 4px 8px;
border-radius: 4px;
transition: var(--transition);
}

.modal-content {
padding: 16px;
overflow-y: auto;
max-height: calc(85vh - 68px);
min-height: 200px;
}
</style>
</head>
<body>
<!-- è¼‰å…¥ä¸­ç•«é¢ -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
<span id="loadingText">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</span>
</div>
</div>

<!-- ä¸»è¦å…§å®¹ -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
<div class="title-text">
<span>ğŸ¯</span>
<h1>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</h1>
<button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
</div>
<div class="user-info">
<div>
<span id="currentUserWelcome">æ­¡è¿å›ä¾†ï¼Œè¼‰å…¥ä¸­...</span>
<div class="user-currency">
<div class="currency-item">
<span>ğŸ’°</span>
<span id="userCoins">0</span>
</div>
<div class="currency-item">
<span>ğŸ’</span>
<span id="userGems">0</span>
</div>
</div>
<div class="user-medals" id="userMedals"></div>
</div>
<span class="connection-status" id="connectionStatus">ç³»çµ±é€£ç·šä¸­</span>
</div>
</div>
<div class="header-actions">
<button class="btn btn-primary" onclick="backToT2()">ğŸ  è¿”å›T2æ—¥</button>
<button class="btn btn-secondary" onclick="showTotalLeaderboard()">ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ</button>
<button class="btn btn-shop" onclick="showShop()">ğŸª å•†åº—</button>
<button class="btn btn-primary" onclick="showInventory()">ğŸ’ èƒŒåŒ…</button>
</div>
</header>

<div id="challengesList">
<div class="challenge-item">
<div class="challenge-title">ğŸ§  æ™ºåŠ›æ¸¬é©—</div>
<div class="challenge-info">æ¸¬è©¦ä½ çš„é‚è¼¯æ€ç¶­èƒ½åŠ›</div>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startChallenge('iq')">é–‹å§‹æŒ‘æˆ°</button>
<button class="btn btn-secondary" onclick="showLeaderboard('iq')">æ’è¡Œæ¦œ</button>
</div>
</div>
<div class="challenge-item">
<div class="challenge-title">ğŸ“Š æ•¸å­¸é‹ç®—</div>
<div class="challenge-info">æŒ‘æˆ°ä½ çš„è¨ˆç®—èƒ½åŠ›</div>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startChallenge('math')">é–‹å§‹æŒ‘æˆ°</button>
<button class="btn btn-secondary" onclick="showLeaderboard('math')">æ’è¡Œæ¦œ</button>
</div>
</div>
</div>
</div>

<!-- æ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="shopModal">
<div class="modal">
<div class="modal-header">
<h2>ğŸª å‹³ç« å•†åº—</h2>
<button class="close-btn" onclick="hideShop()">Ã—</button>
</div>
<div class="modal-content">
<p>å•†åº—åŠŸèƒ½é–‹ç™¼ä¸­...</p>
</div>
</div>
</div>

<div class="modal-overlay" id="inventoryModal">
<div class="modal">
<div class="modal-header">
<h2>ğŸ’ å‹³ç« èƒŒåŒ…</h2>
<button class="close-btn" onclick="hideInventory()">Ã—</button>
</div>
<div class="modal-content">
<p>èƒŒåŒ…åŠŸèƒ½é–‹ç™¼ä¸­...</p>
</div>
</div>
</div>

<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">æ’è¡Œæ¦œ</h2>
<button class="close-btn" onclick="hideLeaderboard()">Ã—</button>
</div>
<div class="modal-content" id="leaderboardContent">
<p>æ’è¡Œæ¦œåŠŸèƒ½é–‹ç™¼ä¸­...</p>
</div>
</div>
</div>

<script>
// ğŸ¯ é…ç½®ç®¡ç†å™¨ - ç°¡åŒ–ç‰ˆæœ¬
class ConfigManager {
  static configs = {};
  
  static async init() {
      console.log('ğŸ” é–‹å§‹è¼‰å…¥é…ç½®...');
      
      try {
          // å˜—è©¦è¼‰å…¥å¤–éƒ¨é…ç½®æª”æ¡ˆ
          const response = await fetch('system-config.json');
          if (response.ok) {
              const config = await response.json();
              this.configs = config;
              console.log('âœ… å¤–éƒ¨é…ç½®è¼‰å…¥æˆåŠŸ');
          } else {
              throw new Error('å¤–éƒ¨é…ç½®æª”æ¡ˆä¸å­˜åœ¨');
          }
      } catch (err) {
          console.log('âš ï¸ å¤–éƒ¨é…ç½®è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­é…ç½®');
          this.configs = this.getDefaultConfigs();
      }
      
      console.log('âœ… é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ', this.configs);
      return this.configs;
  }
  
  static getText(path, defaultValue = path) {
      try {
          return this.getNestedValue(this.configs.ui, path) || defaultValue;
      } catch {
          return defaultValue;
      }
  }
  
  static getConfig(section, path, defaultValue = null) {
      try {
          return this.getNestedValue(this.configs[section], path) || defaultValue;
      } catch {
          return defaultValue;
      }
  }
  
  static getNestedValue(obj, path) {
      if (!obj || !path) return null;
      return path.split('.').reduce((o, p) => o && o[p], obj);
  }
  
  static formatText(template, params) {
      if (!template) return '';
      return template.replace(/\{(\w+)\}/g, (match, key) => params[key] || match);
  }
  
  static getDefaultConfigs() {
      return {
          system: {
              firebase: {
                  apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
                  authDomain: "openexammodal.firebaseapp.com",
                  databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
                  projectId: "openexammodal",
                  storageBucket: "openexammodal.firebasestorage.app",
                  messagingSenderId: "336901617556",
                  appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
              },
              session: { 
                  loginTimeout: 3600000,
                  storageKeys: {
                      loginFlag: 't2_login',
                      loginTime: 't2_login_time',
                      loginUser: 't2_login_user',
                      loginPassword: 't2_login_password'
                  }
              },
              ui: { maxEquippedMedals: 5 },
              navigation: { homePage: 'index3.html' }
          },
          ui: {
              messages: {
                  loginCheck: "æ­£åœ¨é©—è­‰ç™»å…¥ç‹€æ…‹...",
                  systemError: "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢",
                  welcomeBack: "æ­¡è¿å›ä¾†ï¼Œ{username}ï¼",
                  loginInvalid: "ç™»å…¥ç‹€æ…‹ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥",
                  loginExpired: "ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥",
                  insufficientFunds: "é‡‘å¹£ä¸è¶³ï¼",
                  buyConfirm: "ç¢ºå®šè¦è³¼è²· {medalIcon} {medalName} å—ï¼Ÿ\nåƒ¹æ ¼ï¼š{price} é‡‘å¹£",
                  buySuccess: "æˆåŠŸè³¼è²· {medalIcon} {medalName}ï¼"
              }
          },
          rewards: {
              scoring: { pointsPerCorrect: 10, coinsPerCorrect: 5 }
          }
      };
  }
}

// ğŸ¯ å…¨åŸŸè®Šæ•¸
let currentUser = null;
let database = null;
let userCurrency = { coins: 100, gems: 10 }; // é è¨­å€¼

// ğŸ¯ åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
async function initializeApp() {
  try {
      console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
      
      // æ›´æ–°è¼‰å…¥æ–‡å­—
      updateLoadingText('æ­£åœ¨è¼‰å…¥é…ç½®...');
      
      // è¼‰å…¥é…ç½®
      await ConfigManager.init();
      
      // æ›´æ–°è¼‰å…¥æ–‡å­—
      updateLoadingText(ConfigManager.getText('messages.loginCheck'));
      
      // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const user = checkLoginStatus();
      if (!user) return;

      currentUser = user;
      console.log('âœ… ç”¨æˆ¶é©—è­‰æˆåŠŸ:', currentUser);
      
      // æ›´æ–°æ­¡è¿æ–‡å­—
      const welcomeText = ConfigManager.formatText(
          ConfigManager.getText('messages.welcomeBack'),
          { username: user }
      );
      document.getElementById('currentUserWelcome').textContent = welcomeText;

      // åˆå§‹åŒ– Firebase
      updateLoadingText('æ­£åœ¨é€£æ¥è³‡æ–™åº«...');
      firebase.initializeApp(ConfigManager.getConfig('system', 'firebase'));
      database = firebase.database();
      console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');

      // æ›´æ–°ç”¨æˆ¶è³‡æ–™é¡¯ç¤º
      updateUserDisplay();

      // éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»å…§å®¹
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      console.log('âœ… æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');

  } catch (err) {
      console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', err);
      updateLoadingText('åˆå§‹åŒ–å¤±æ•—: ' + err.message);
      setTimeout(() => {
          alert(ConfigManager.getText('messages.systemError'));
      }, 1000);
  }
}

// ğŸ¯ è¼”åŠ©å‡½æ•¸
function updateLoadingText(text) {
  const loadingTextEl = document.getElementById('loadingText');
  if (loadingTextEl) {
      loadingTextEl.textContent = text;
  }
  console.log('ğŸ“', text);
}

function checkLoginStatus() {
  const keys = ConfigManager.getConfig('system', 'session.storageKeys', {
      loginFlag: 't2_login',
      loginTime: 't2_login_time',
      loginUser: 't2_login_user'
  });
  
  const flag = localStorage.getItem(keys.loginFlag);
  const time = localStorage.getItem(keys.loginTime);
  const user = localStorage.getItem(keys.loginUser);
  
  console.log('ğŸ” æª¢æŸ¥ç™»å…¥ç‹€æ…‹:', { flag, time, user });
  
  if (flag !== 'yes' || !time || !user) {
      forceLogout(ConfigManager.getText('messages.loginInvalid'));
      return false;
  }
  
  const timeout = ConfigManager.getConfig('system', 'session.loginTimeout', 3600000);
  if (Date.now() - parseInt(time) > timeout) {
      forceLogout(ConfigManager.getText('messages.loginExpired'));
      return false;
  }
  
  return user;
}

function forceLogout(message) {
  const keys = ConfigManager.getConfig('system', 'session.storageKeys', {
      loginFlag: 't2_login',
      loginTime: 't2_login_time',
      loginUser: 't2_login_user',
      loginPassword: 't2_login_password'
  });
  
  Object.values(keys).forEach(key => localStorage.removeItem(key));
  
  alert(message);
  const homePage = ConfigManager.getConfig('system', 'navigation.homePage', 'index3.html');
  window.location.href = homePage;
}

function updateUserDisplay() {
  document.getElementById('userCoins').textContent = userCurrency.coins;
  document.getElementById('userGems').textContent = userCurrency.gems;
}

// ğŸ¯ äº‹ä»¶è™•ç†å‡½æ•¸
function logout() {
  if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
      forceLogout('å·²æˆåŠŸç™»å‡º');
  }
}

function backToT2() {
  const homePage = ConfigManager.getConfig('system', 'navigation.homePage', 'index3.html');
  window.location.href = homePage;
}

function startChallenge(type) {
  alert(`é–‹å§‹ ${type} æŒ‘æˆ°ï¼åŠŸèƒ½é–‹ç™¼ä¸­...`);
}

function showLeaderboard(type) {
  document.getElementById('modalTitle').textContent = `${type} æ’è¡Œæ¦œ`;
  document.getElementById('leaderboardModal').style.display = 'flex';
}

function hideLeaderboard() {
  document.getElementById('leaderboardModal').style.display = 'none';
}

function showTotalLeaderboard() {
  document.getElementById('modalTitle').textContent = 'ç¸½åˆ†æ’è¡Œæ¦œ';
  document.getElementById('leaderboardModal').style.display = 'flex';
}

function showShop() {
  document.getElementById('shopModal').style.display = 'flex';
}

function hideShop() {
  document.getElementById('shopModal').style.display = 'none';
}

function showInventory() {
  document.getElementById('inventoryModal').style.display = 'flex';
}

function hideInventory() {
  document.getElementById('inventoryModal').style.display = 'none';
}

// ğŸ¯ é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializeApp);

// ğŸ¯ é»æ“Šæ¨¡æ…‹è¦–çª—èƒŒæ™¯é—œé–‰
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal-overlay')) {
      e.target.style.display = 'none';
  }
});
</script>
</body>
</html>
