<script>
// Firebase é…ç½®
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šFirebase åˆå§‹åŒ–
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œåº«å¿«å–
let examQuestions = {};
let questionsCache = new Map();

// ğŸ… å‹³ç« ç³»çµ±è®Šæ•¸
let medalsData = {};
let userMedals = { owned: [], equipped: [] };
let userCurrency = { coins: 0, gems: 0 };

// ğŸ“ è€ƒè©¦é…ç½®è®Šæ•¸ (å¾JSONè¼‰å…¥)
let examConfigs = {};

// ğŸ… è¼‰å…¥å‹³ç« è³‡æ–™
async function loadMedalsData() {
try {
const cacheKey = 'medals_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
medalsData = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥å‹³ç« è³‡æ–™');
return;
}

const resp = await fetch('medals.json');
if (!resp.ok) throw new Error(`è¼‰å…¥å‹³ç« è³‡æ–™å¤±æ•—ï¼š${resp.status}`);
medalsData = await resp.json();

localStorage.setItem(cacheKey, JSON.stringify(medalsData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… å‹³ç« è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–', medalsData);
} catch (err) {
console.error('è¼‰å…¥å‹³ç« è³‡æ–™å¤±æ•—:', err);
// æä¾›é è¨­å‹³ç« è³‡æ–™
medalsData = {
medals: {},
rarityColors: {
common: "#84cc16",
rare: "#3b82f6", 
epic: "#8b5cf6",
legendary: "#f59e0b"
},
maxEquippedMedals: 5
};
}
}

// ğŸ“ è¼‰å…¥è€ƒè©¦é…ç½®
async function loadExamConfigs() {
try {
const cacheKey = 'exam_configs_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examConfigs = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥è€ƒè©¦é…ç½®');
return;
}

const resp = await fetch('exam-configs.json');
if (!resp.ok) throw new Error(`è¼‰å…¥è€ƒè©¦é…ç½®å¤±æ•—ï¼š${resp.status}`);
examConfigs = await resp.json();

localStorage.setItem(cacheKey, JSON.stringify(examConfigs));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… è€ƒè©¦é…ç½®å·²è¼‰å…¥ä¸¦å¿«å–', examConfigs);
} catch (err) {
console.error('è¼‰å…¥è€ƒè©¦é…ç½®å¤±æ•—:', err);
alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥è€ƒè©¦é…ç½®æª”æ¡ˆ');
}
}

// ğŸ“ å‹•æ…‹ç”ŸæˆæŒ‘æˆ°é …ç›®åˆ—è¡¨
function renderChallengesList() {
const challengesContainer = document.getElementById('challengesList');
const fragment = document.createDocumentFragment();

Object.entries(examConfigs).forEach(([examType, config]) => {
const challengeItem = document.createElement('div');
challengeItem.className = 'challenge-item';

challengeItem.innerHTML = `
<h3 class="challenge-title">${config.name}</h3>
<p class="challenge-info" style="color:#ef4444;">${config.description}</p>
<div class="champion-display" data-exam-type="${examType}">
<!-- æ¦œé¦–è³‡æ–™å°‡åœ¨æ­¤å‹•æ…‹è¼‰å…¥ -->
</div>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('${examType}')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${examType}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
`;

fragment.appendChild(challengeItem);
});

challengesContainer.appendChild(fragment);
}

// ğŸ… è¼‰å…¥ç”¨æˆ¶å‹³ç« å’Œè²¨å¹£è³‡æ–™
async function loadUserMedalsAndCurrency() {
try {
const snapshot = await database.ref(`users/${currentUser}/medals`).once('value');
const medalSnapshot = snapshot.val() || {};
userMedals = {
owned: medalSnapshot.owned || [],
equipped: medalSnapshot.equipped || []
};

const currencySnapshot = await database.ref(`users/${currentUser}/currency`).once('value');
userCurrency = currencySnapshot.val() || { coins: 0, gems: 0 };

updateCurrencyDisplay();
updateMedalDisplay();
} catch (err) {
console.error('è¼‰å…¥ç”¨æˆ¶å‹³ç« è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸ… æ›´æ–°è²¨å¹£é¡¯ç¤º
function updateCurrencyDisplay() {
document.getElementById('userCoins').textContent = userCurrency.coins;
document.getElementById('userGems').textContent = userCurrency.gems;
}

// ğŸ… æ›´æ–°å‹³ç« é¡¯ç¤º
function updateMedalDisplay() {
    const medalContainer = document.getElementById('userMedals');
    medalContainer.innerHTML = '';

    userMedals.equipped.forEach(medalId => {
        const medal = medalsData.medals[medalId];
        if (medal) {
            const medalIcon = document.createElement('div');
            medalIcon.className = `medal-icon ${medal.rarity}`;
            medalIcon.style.borderColor = medal.color;
            
            // ğŸ”§ ä¿®æ”¹é€™è£¡ï¼šåˆ¤æ–·æ˜¯ emoji é‚„æ˜¯ç¶²å€
            if (medal.icon.startsWith('http')) {
                medalIcon.innerHTML = `<img src="${medal.icon}" alt="${medal.name}" style="width: 100%; height: 100%; object-fit: contain;">`;
            } else {
                medalIcon.innerHTML = medal.icon;
            }
            
            medalIcon.title = `${medal.name}: ${medal.description}`;
            medalContainer.appendChild(medalIcon);
        }
    });
}


// ğŸ… ä¿å­˜å‹³ç« è³‡æ–™
async function saveMedalData() {
try {
await database.ref(`users/${currentUser}/medals`).set(userMedals);
updateMedalDisplay();
} catch (err) {
console.error('ä¿å­˜å‹³ç« è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸ… ä¿å­˜è²¨å¹£è³‡æ–™
async function saveCurrencyData() {
try {
await database.ref(`users/${currentUser}/currency`).set(userCurrency);
updateCurrencyDisplay();
} catch (err) {
console.error('ä¿å­˜è²¨å¹£è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸª é¡¯ç¤ºå•†åº—
async function showShop() {
document.getElementById('shopModal').style.display = 'flex';
await renderShopItems();
}

// ğŸª éš±è—å•†åº—
function hideShop() {
document.getElementById('shopModal').style.display = 'none';
}

// ğŸª ç¯©é¸å•†åº—ç‰©å“
function filterShop(category) {
document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
event.target.classList.add('active');
renderShopItems(category);
}

// ğŸª æ¸²æŸ“å•†åº—ç‰©å“
async function renderShopItems(filter = 'all') {
const shopContainer = document.getElementById('shopItems');
shopContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥å•†åº—ä¸­...</div>';

const medals = Object.values(medalsData.medals);
const filteredMedals = filter === 'all' ? medals : medals.filter(medal => medal.rarity === filter);

const fragment = document.createDocumentFragment();

filteredMedals.forEach(medal => {
const isOwned = userMedals.owned.includes(medal.id);
const isEquipped = userMedals.equipped.includes(medal.id);
const canAfford = userCurrency.coins >= medal.price;

const item = document.createElement('div');
item.className = `shop-item ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;

// ğŸ”§ åˆ¤æ–·æ˜¯ emoji é‚„æ˜¯ç¶²å€
const medalIconContent = medal.icon.startsWith('http') ? 
    `<img src="${medal.icon}" alt="${medal.name}" style="width: 100%; height: 100%; object-fit: contain;">` : 
    medal.icon;

item.innerHTML = `
<div class="medal-preview" style="border-color: ${medal.color};">
${medalIconContent}
</div>
<div class="item-info">
<div class="item-name" style="color: ${medal.color};">${medal.name}</div>
<div class="item-description">${medal.description}</div>
<div class="item-price">ğŸ’° ${medal.price}</div>
</div>
<div class="item-actions">
${isOwned ? 
'<span class="btn btn-small btn-secondary">å·²æ“æœ‰</span>' :
`<button class="btn btn-small btn-primary ${!canAfford ? 'disabled' : ''}" 
onclick="buyMedal('${medal.id}')" ${!canAfford ? 'disabled' : ''}>
è³¼è²·
</button>`
}
</div>
`;

fragment.appendChild(item);
});

shopContainer.innerHTML = '';
shopContainer.appendChild(fragment);
}

// ğŸª è³¼è²·å‹³ç« 
async function buyMedal(medalId) {
const medal = medalsData.medals[medalId];
if (!medal || userMedals.owned.includes(medalId)) return;

if (userCurrency.coins < medal.price) {
alert('ğŸ’° é‡‘å¹£ä¸è¶³ï¼');
return;
}

if (confirm(`ç¢ºå®šè¦è³¼è²· ${medal.icon} ${medal.name} å—ï¼Ÿ\nåƒ¹æ ¼ï¼šğŸ’° ${medal.price}`)) {
userCurrency.coins -= medal.price;
userMedals.owned.push(medalId);

await Promise.all([saveMedalData(), saveCurrencyData()]);
await renderShopItems();
alert(`ğŸ‰ æˆåŠŸè³¼è²· ${medal.icon} ${medal.name}ï¼`);
}
}

// ğŸ’ é¡¯ç¤ºèƒŒåŒ…
async function showInventory() {
document.getElementById('inventoryModal').style.display = 'flex';
await renderInventory();
}

// ğŸ’ éš±è—èƒŒåŒ…
function hideInventory() {
document.getElementById('inventoryModal').style.display = 'none';
}

// ğŸ’ æ¸²æŸ“èƒŒåŒ… - ä¿®æ­£ç‰ˆæœ¬
async function renderInventory() {
const inventoryGrid = document.getElementById('inventoryGrid');
inventoryGrid.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥èƒŒåŒ…ä¸­...</div>';

const fragment = document.createDocumentFragment();

userMedals.owned.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (!medal) return;

const isEquipped = userMedals.equipped.includes(medalId);
const item = document.createElement('div');
item.className = `inventory-item ${isEquipped ? 'equipped' : ''}`;
item.onclick = () => toggleMedalEquip(medalId);

// ğŸ”§ ä¿®æ”¹é€™è£¡ï¼šæ–°å¢åˆ¤æ–·é‚è¼¯
const iconHtml = medal.icon.startsWith('http') ? 
    `<img src="${medal.icon}" alt="${medal.name}" style="width: 24px; height: 24px; object-fit: contain;">` : 
    medal.icon;

item.innerHTML = `
<div class="inventory-medal-icon" style="color: ${medal.color};">
${iconHtml}
</div>
<div class="inventory-medal-name">${medal.name}</div>
${isEquipped ? '<div style="font-size: 0.6rem; color: var(--gold);">å·²è£å‚™</div>' : ''}
`;

fragment.appendChild(item);
});

if (userMedals.owned.length === 0) {
const emptyMsg = document.createElement('div');
emptyMsg.className = 'empty-leaderboard';
emptyMsg.innerHTML = '<p>ğŸ’ èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p><p>å»å•†åº—è³¼è²·ä¸€äº›å‹³ç« å§ï¼</p>';
fragment.appendChild(emptyMsg);
}

inventoryGrid.innerHTML = '';
inventoryGrid.appendChild(fragment);
}


// ğŸ’ åˆ‡æ›å‹³ç« è£å‚™ç‹€æ…‹
async function toggleMedalEquip(medalId) {
const isEquipped = userMedals.equipped.includes(medalId);

if (isEquipped) {
// å¸ä¸‹å‹³ç« 
userMedals.equipped = userMedals.equipped.filter(id => id !== medalId);
} else {
// è£å‚™å‹³ç« 
if (userMedals.equipped.length >= medalsData.maxEquippedMedals) {
alert(`æœ€å¤šåªèƒ½è£å‚™ ${medalsData.maxEquippedMedals} å€‹å‹³ç« ï¼`);
return;
}
userMedals.equipped.push(medalId);
}

await saveMedalData();
await renderInventory();
}

async function loadExamQuestions() {
try {
// æª¢æŸ¥å¿«å–
const cacheKey = 'exam_questions_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// å¿«å–æœ‰æ•ˆæœŸ 1 å°æ™‚
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examQuestions = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥é¡Œåº«');
return;
}

const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š${resp.status}`);
examQuestions = await resp.json();

// å„²å­˜åˆ°å¿«å–
localStorage.setItem(cacheKey, JSON.stringify(examQuestions));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… é¡Œåº«å·²è¼‰å…¥ä¸¦å¿«å–', examQuestions);
} catch (err) {
console.error(err);
alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥é¡Œåº«æª”æ¡ˆ');
}
}

// å…¨åŸŸè®Šæ•¸
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé˜²æŠ–å‡½æ•¸
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
const later = () => {
clearTimeout(timeout);
func(...args);
};
clearTimeout(timeout);
timeout = setTimeout(later, wait);
};
}

// å·¥å…·å‡½æ•¸ï¼šå¾æ•¸çµ„ä¸­ç§»é™¤ç‰¹å®šå…ƒç´ 
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// å¼·åˆ¶ç™»å‡ºå‡½æ•¸
function forceLogout(message = 'ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index.html';
}

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ™‚æ•ˆ
function checkLoginStatus() {
const flag = localStorage.getItem('t2_login');
const time = localStorage.getItem('t2_login_time');
const user = localStorage.getItem('t2_login_user');
if (flag!=='yes' || !time || !user) {
forceLogout('æœªæª¢æ¸¬åˆ°æœ‰æ•ˆç™»å…¥ç‹€æ…‹');
return false;
}
if (Date.now()-parseInt(time) > 3600000) {
forceLogout('ç™»å…¥æ™‚é–“å·²è¶…é1å°æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
return false;
}
return user;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç”¨æˆ¶è³‡æ–™å¿«å–
async function loadUsersData() {
try {
// æª¢æŸ¥å¿«å–
const cacheKey = 'users_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// å¿«å–æœ‰æ•ˆæœŸ 5 åˆ†é˜
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 300000) {
usersData = JSON.parse(cached);
console.log('âœ… ç”¨æˆ¶è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–');
return;
}

const snapshot = await database.ref('users').once('value');
usersData = snapshot.val() || {};

// å„²å­˜åˆ°å¿«å–
localStorage.setItem(cacheKey, JSON.stringify(usersData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… ç”¨æˆ¶è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–');
} catch (err) {
console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ¦œé¦–è³‡æ–™å¿«å–
const championCache = new Map();

// ğŸ”§ ä¿®æ­£ï¼šç²å–æ¦œé¦–æ™‚ä¸ä½¿ç”¨ orderByChild ä»¥é¿å…ç´¢å¼•è­¦å‘Š
async function getChampion(examType) {
// æª¢æŸ¥å¿«å–
const cacheKey = `champion_${examType}`;
const cached = championCache.get(cacheKey);
if (cached && (Date.now() - cached.timestamp) < 60000) { // 1åˆ†é˜å¿«å–
return cached.data;
}

try {
// ğŸ”§ ä¿®æ­£ï¼šç›´æ¥ç²å–æ‰€æœ‰è³‡æ–™ï¼Œç„¶å¾Œåœ¨å®¢æˆ¶ç«¯æ’åº
const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
const data = snapshot.val();
if (data) {
// è½‰æ›ä¸¦æ’åºè³‡æ–™æ‰¾å‡ºæ¦œé¦–
const leaderboardData = Object.entries(data).map(([user, userData]) => ({
user,
...userData
})).sort((a, b) => {
if (b.score !== a.score) {
return b.score - a.score;
}
return a.totalTime - b.totalTime;
});

const result = leaderboardData[0]; // æ¦œé¦–

// å¿«å–çµæœ
championCache.set(cacheKey, {
data: result,
timestamp: Date.now()
});
return result;
}
return null;
} catch (err) {
console.error('ç²å–æ¦œé¦–å¤±æ•—:', err);
return null;
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ‰¹é‡æ›´æ–°æ¦œé¦–é¡¯ç¤º
const debouncedUpdateChampions = debounce(updateAllChampions, 300);

async function updateAllChampions() {
const examTypes = Object.keys(examConfigs);
const promises = examTypes.map(async (examType) => {
const champion = await getChampion(examType);
const championDisplay = document.querySelector(`[data-exam-type="${examType}"]`);
if (!championDisplay) return;

if (champion) {
championDisplay.innerHTML = `
<div class="champion-card">
<span>ğŸ† æ¦œé¦–ï¼š${champion.user}</span>
<span>${champion.score}åˆ†</span>
</div>
`;
} else {
championDisplay.innerHTML = `
<div class="champion-empty">
<span>ğŸ† å°šç„¡æ¦œé¦–</span>
</div>
`;
}
});

await Promise.all(promises);
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç™»å…¥é©—è­‰å’Œåˆå§‹åŒ–
async function initializeApp() {
try {
const user = checkLoginStatus();
if (!user) return;

currentUser = user;
document.getElementById('currentUserWelcome').textContent = `æ­¡è¿å›ä¾†ï¼Œ${user}`;

// ä¸¦è¡Œè¼‰å…¥è³‡æ–™
await Promise.all([
loadExamQuestions(),
loadUsersData(),
loadMedalsData(),
loadExamConfigs()
]);

// è¼‰å…¥ç”¨æˆ¶å‹³ç« å’Œè²¨å¹£
await loadUserMedalsAndCurrency();

// ç”ŸæˆæŒ‘æˆ°é …ç›®åˆ—è¡¨
renderChallengesList();

// æ›´æ–°æ¦œé¦–é¡¯ç¤º
await updateAllChampions();

// éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
document.getElementById('loadingScreen').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';

} catch (err) {
console.error('åˆå§‹åŒ–å¤±æ•—:', err);
alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
}
}

// ç™»å‡ºåŠŸèƒ½
function logout() {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
// æ¸…é™¤å¿«å–
localStorage.removeItem('exam_questions_v1');
localStorage.removeItem('exam_questions_v1_time');
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
localStorage.removeItem('medals_data_v1');
localStorage.removeItem('medals_data_v1_time');
localStorage.removeItem('exam_configs_v1');
localStorage.removeItem('exam_configs_v1_time');
championCache.clear();
window.location.href = 'index.html';
}

// è¿”å›T2æ—¥
function backToT2() {
window.location.href = 'dashboard.html';
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œç›®éš¨æ©ŸåŒ–
function shuffleArray(array) {
const newArray = [...array];
for (let i = newArray.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[newArray[i], newArray[j]] = [newArray[j], newArray[i]];
}
return newArray;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒè©¦é–‹å§‹å„ªåŒ– - ä¿®æ­£ç‰ˆæœ¬
function startExam(examType) {
    if (!examQuestions[examType]) {
        alert('é¡Œåº«è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
    }

    const config = examConfigs[examType];
    const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

    if (questions.length < config.questionCount) {
        alert(`é¡Œåº«é¡Œç›®ä¸è¶³ï¼éœ€è¦ ${config.questionCount} é¡Œï¼Œä½†åªæœ‰ ${questions.length} é¡Œ`);
        return;
    }

    currentExam = examType;
    currentQuestions = questions;
    currentQuestionIndex = 0;
    examStartTime = Date.now();
    
    // ğŸ”§ ä¿®æ­£ï¼šå®Œæ•´çš„ userScores åˆå§‹åŒ–
    userScores = { 
        fastAnswers: 0, 
        correctAnswers: 0,
        totalAnswers: 0,
        fastCorrectAnswers: 0  // ğŸ†• æ–°å¢ï¼šå¿«é€Ÿä¸”ç­”å°çš„é¡Œç›®æ•¸
    };

    showExamInterface();
    displayQuestion();
    startQuestionTimer();
}

// é¡¯ç¤ºè€ƒè©¦ä»‹é¢ - åŠ å…¥æ£„æ¬ŠæŒ‰éˆ•
function showExamInterface() {
const container = document.getElementById('mainContent');
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
<button class="btn btn-danger" onclick="quitExam()" style="margin-left: 10px;">æ£„æ¬Š</button>
</div>
<div class="question" id="questionContainer">
<!-- é¡Œç›®å°‡åœ¨æ­¤é¡¯ç¤º -->
</div>
<div class="exam-progress">
<p>é¡Œç›® <span id="currentQuestionNum">1</span> / ${config.questionCount}</p>
<p>å¾—åˆ†ï¼š<span id="currentScore">0</span> åˆ†</p>
</div>
</div>
`;
}

// ğŸ†• æ£„æ¬ŠåŠŸèƒ½
function quitExam() {
if (confirm('ç¢ºå®šè¦æ£„æ¬Šå—ï¼Ÿæ£„æ¬Šå°‡ä¸æœƒç²å¾—ä»»ä½•åˆ†æ•¸å’Œçå‹µã€‚')) {
clearInterval(examTimer);

// ç›´æ¥è¿”å›ä¸»é ï¼Œä¸ä¿å­˜ä»»ä½•æˆç¸¾
location.reload();
}
}

// é¡¯ç¤ºé¡Œç›®
function displayQuestion() {
const question = currentQuestions[currentQuestionIndex];
const questionContainer = document.getElementById('questionContainer');
const config = examConfigs[currentExam];

document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;

if (currentExam === 'sudoku') {
// æ•¸ç¨ç‰¹æ®Šé¡¯ç¤º
questionContainer.innerHTML = `
<h3>${question.question}</h3>
<div class="sudoku-grid">
${question.grid.map((cell, index) => 
`<input type="number" class="sudoku-cell" 
${cell !== 0 ? `value="${cell}" disabled` : ''} 
min="1" max="4" 
data-index="${index}"
${cell === 0 ? 'onchange="checkSudokuAnswer()"' : ''}>`
).join('')}
</div>
<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">
å¡«å…¥1-4çš„æ•¸å­—ï¼Œä½¿æ¯è¡Œæ¯åˆ—éƒ½åŒ…å«1-4
</p>
`;
} else {
// ä¸€èˆ¬é¡Œç›®é¡¯ç¤º
const optionsHtml = question.options.map((option, index) => 
`<button class="btn option-btn" onclick="selectAnswer(${index})">${option}</button>`
).join('');

questionContainer.innerHTML = `
<h3>${question.question}</h3>
<div class="options">
${optionsHtml}
</div>
`;
}

questionStartTime = Date.now();
}

// é–‹å§‹é¡Œç›®è¨ˆæ™‚å™¨
function startQuestionTimer() {
const config = examConfigs[currentExam];
let timeLeft = config.timePerQuestion;
const timerElement = document.getElementById('timer');

examTimer = setInterval(() => {
timeLeft--;
timerElement.textContent = timeLeft;

if (timeLeft <= 0) {
clearInterval(examTimer);
// æ™‚é–“åˆ°ï¼Œè‡ªå‹•è·³åˆ°ä¸‹ä¸€é¡Œ
if (currentExam === 'sudoku') {
nextQuestion(false);
} else {
selectAnswer(-1); // -1 è¡¨ç¤ºæœªä½œç­”
}
}
}, 1000);
}

// é¸æ“‡ç­”æ¡ˆ - ä¿®æ­£ç‰ˆæœ¬
function selectAnswer(selectedIndex) {
    clearInterval(examTimer);
    const question = currentQuestions[currentQuestionIndex];
    const isCorrect = selectedIndex === question.correct;
    const responseTime = (Date.now() - questionStartTime) / 1000;
    const config = examConfigs[currentExam];

    userScores.totalAnswers++; // ğŸ†• è¿½è¹¤ç¸½ç­”é¡Œæ•¸

    // ğŸ… æª¢æŸ¥å¿«é€Ÿç­”é¡Œ
    const isFast = responseTime <= config.fastAnswerThreshold;
    if (isFast) {
        userScores.fastAnswers++;
    }

    // ğŸ”§ ä¿®æ­£ï¼šåªæœ‰ç­”å°æ‰åŠ åˆ†
    if (isCorrect) {
        userScores.correctAnswers++;
        
        // ğŸ¯ åªæœ‰ç­”å°ä¸”å¿«é€Ÿæ‰è¨ˆå…¥å¿«é€Ÿæ­£ç¢ºç­”æ¡ˆ
        if (isFast) {
            userScores.fastCorrectAnswers++;
        }
    }

    // é¡¯ç¤ºç­”æ¡ˆåé¥‹
    showAnswerFeedback(selectedIndex, question.correct, responseTime);

    // å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
    setTimeout(() => {
        nextQuestion(isCorrect);
    }, 1500);
}


// é¡¯ç¤ºç­”æ¡ˆåé¥‹ - ä¿®æ­£ç‰ˆæœ¬
function showAnswerFeedback(selectedIndex, correctIndex, responseTime) {
const options = document.querySelectorAll('.option-btn');
const config = examConfigs[currentExam];

options.forEach((btn, index) => {
btn.disabled = true;
if (index === correctIndex) {
btn.classList.add('correct');
} else if (index === selectedIndex && selectedIndex !== correctIndex) {
btn.classList.add('wrong');
}
});

// é¡¯ç¤ºå›æ‡‰æ™‚é–“å’Œå¿«é€Ÿç­”é¡Œæç¤º
const feedbackDiv = document.createElement('div');
feedbackDiv.style.cssText = `
margin-top: 15px; 
text-align: center; 
font-size: 0.9rem;
color: var(--text-secondary);
`;

let feedbackText = `å›æ‡‰æ™‚é–“: ${responseTime.toFixed(1)}ç§’`;
if (responseTime <= config.fastAnswerThreshold) {
feedbackText += ` âš¡ å¿«é€Ÿç­”é¡Œï¼`;
}

feedbackDiv.innerHTML = feedbackText;
document.getElementById('questionContainer').appendChild(feedbackDiv);
}

// æ•¸ç¨ç­”æ¡ˆæª¢æŸ¥ - ä¿®æ­£ç‰ˆæœ¬
function checkSudokuAnswer() {
    const cells = document.querySelectorAll('.sudoku-cell');
    const userGrid = Array.from(cells).map(cell => parseInt(cell.value) || 0);
    const question = currentQuestions[currentQuestionIndex];

    // æª¢æŸ¥æ˜¯å¦å¡«å®Œ
    const isEmpty = userGrid.some(cell => cell === 0);
    if (isEmpty) return;

    // æª¢æŸ¥ç­”æ¡ˆ
    const isCorrect = JSON.stringify(userGrid) === JSON.stringify(question.solution);
    const responseTime = (Date.now() - questionStartTime) / 1000;
    const config = examConfigs[currentExam];

    clearInterval(examTimer);

    userScores.totalAnswers++; // ğŸ†• è¿½è¹¤ç¸½ç­”é¡Œæ•¸

    // ğŸ… æª¢æŸ¥å¿«é€Ÿç­”é¡Œ
    const isFast = responseTime <= config.fastAnswerThreshold;
    if (isFast) {
        userScores.fastAnswers++;
    }

    // ğŸ”§ ä¿®æ­£ï¼šåªæœ‰ç­”å°æ‰åŠ åˆ†
    if (isCorrect) {
        userScores.correctAnswers++;
        
        // ğŸ¯ åªæœ‰ç­”å°ä¸”å¿«é€Ÿæ‰è¨ˆå…¥å¿«é€Ÿæ­£ç¢ºç­”æ¡ˆ
        if (isFast) {
            userScores.fastCorrectAnswers++;
        }
    }

    // é¡¯ç¤ºæ•¸ç¨åé¥‹
    cells.forEach(cell => cell.disabled = true);
    const feedbackDiv = document.createElement('div');
    feedbackDiv.style.cssText = `
        margin-top: 15px; 
        text-align: center; 
        font-size: 0.9rem;
        color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};
    `;
    feedbackDiv.innerHTML = `${isCorrect ? 'âœ… æ­£ç¢ºï¼' : 'âŒ éŒ¯èª¤ï¼'} å›æ‡‰æ™‚é–“: ${responseTime.toFixed(1)}ç§’`;
    document.getElementById('questionContainer').appendChild(feedbackDiv);

    setTimeout(() => {
        nextQuestion(isCorrect);
    }, 1500);
}

// ä¸‹ä¸€é¡Œ
function nextQuestion(wasCorrect) {
document.getElementById('currentScore').textContent = userScores.correctAnswers * 10;

if (currentQuestionIndex < currentQuestions.length - 1) {
currentQuestionIndex++;
displayQuestion();
startQuestionTimer();
} else {
finishExam();
}
}

// çµæŸè€ƒè©¦ - é˜²æ¿«ç”¨ç‰ˆæœ¬
async function finishExam() {
    clearInterval(examTimer);
    const totalTime = (Date.now() - examStartTime) / 1000;
    const finalScore = userScores.correctAnswers * 10;
    const config = examConfigs[currentExam];
    
    // ğŸ›¡ï¸ é˜²æ¿«ç”¨ï¼šåªæœ‰å®Œæˆæ‰€æœ‰é¡Œç›®æ‰çµ¦çå‹µ
    if (currentQuestionIndex < config.questionCount) {
        // ä¸­é€”æ”¾æ£„ï¼Œä¸çµ¦ä»»ä½•çå‹µ
        showExamResult(finalScore, totalTime, 0, 0);
        return;
    }
    
    // ğŸ¯ æœ€å¾Œçµç®—çå‹µ
    let coinsEarned = 0;
    let gemsEarned = 0;
    let bonusMessages = [];
    
    // ğŸ’° åŸºç¤çå‹µï¼šæ¯ç­”å°ä¸€é¡Œ5é‡‘å¹£
    coinsEarned += userScores.correctAnswers * 5;
    if (userScores.correctAnswers > 0) {
        bonusMessages.push(`ğŸ“ ç­”å°${userScores.correctAnswers}é¡Œç²å¾—${userScores.correctAnswers * 5}é‡‘å¹£`);
    }
    
    // ğŸ† æ»¿åˆ†çå‹µ
    if (finalScore >= config.questionCount * 10) {
        const perfectBonus = config.perfectBonus || 50;
        coinsEarned += perfectBonus;
        gemsEarned += 1;
        bonusMessages.push(`ğŸ† æ»¿åˆ†çå‹µï¼š+${perfectBonus}é‡‘å¹£ +1å¯¶çŸ³`);
    }
    
    // âš¡ å¿«é€Ÿç­”é¡Œçå‹µï¼šåªè¨ˆç®—ç­”å°ä¸”å¿«é€Ÿçš„é¡Œç›®
    const fastCorrectAnswers = userScores.fastCorrectAnswers || 0; // éœ€è¦è¿½è¹¤é€™å€‹æ•¸æ“š
    if (fastCorrectAnswers >= Math.ceil(config.questionCount * 0.7)) {
        const speedBonus = 20;
        coinsEarned += speedBonus;
        bonusMessages.push(`âš¡ å¿«é€Ÿç­”é¡Œçå‹µï¼š+${speedBonus}é‡‘å¹£`);
    }
    
    // ğŸ’° æ›´æ–°è²¨å¹£ï¼ˆåªæœ‰å®Œæˆè€ƒè©¦æ‰æ›´æ–°ï¼‰
    if (coinsEarned > 0) userCurrency.coins += coinsEarned;
    if (gemsEarned > 0) userCurrency.gems += gemsEarned;
    
    if (coinsEarned > 0 || gemsEarned > 0) {
        await saveCurrencyData();
    }
    
    // ä¿å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œ
    await saveScoreToLeaderboard(currentExam, finalScore, totalTime);
    
    // é¡¯ç¤ºçµæœ
    showExamResult(finalScore, totalTime, coinsEarned, gemsEarned, bonusMessages);
    
    // æ¸…é™¤å¿«å–
    const cacheKey = `champion_${currentExam}`;
    championCache.delete(cacheKey);
    localStorage.removeItem('users_data_v1');
    localStorage.removeItem('users_data_v1_time');
}

// é¡¯ç¤ºè€ƒè©¦çµæœ - ä¿®æ­£ç‰ˆæœ¬
function showExamResult(score, totalTime, coinsEarned) {
const container = document.getElementById('mainContent');
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-result">
<h2>ğŸ‰ è€ƒè©¦å®Œæˆï¼</h2>
<p><strong>è€ƒè©¦é¡å‹ï¼š</strong>${config.name}</p>
<p><strong>æœ€çµ‚å¾—åˆ†ï¼š</strong>${score} åˆ†</p>
<p><strong>æ­£ç¢ºé¡Œæ•¸ï¼š</strong>${userScores.correctAnswers} / ${config.questionCount}</p>
<p><strong>å¿«é€Ÿç­”é¡Œï¼š</strong>${userScores.fastAnswers} é¡Œ</p>
<p><strong>ç¸½è€—æ™‚ï¼š</strong>${totalTime.toFixed(1)} ç§’</p>
${coinsEarned > 0 ? 
`<p style="color: var(--gold);"><strong>ğŸ‰ æ»¿åˆ†çå‹µï¼š</strong>ğŸ’° ${coinsEarned}</p>` : 
`<p style="color: var(--text-secondary);">ğŸ’° æœªé”æ»¿åˆ†ï¼Œç„¡é‡‘å¹£çå‹µ</p>`
}
<div style="margin-top: 20px;">
<button class="btn btn-primary" onclick="location.reload()">è¿”å›ä¸»é </button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>
`;
}

// ğŸ”§ ä¿®æ­£ï¼šä¿å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œ - ä¸ä½¿ç”¨ç´¢å¼•æŸ¥è©¢
async function saveScoreToLeaderboard(examType, score, totalTime) {
try {
const scoreData = {
score: score,
totalTime: totalTime,
timestamp: Date.now(),
fastAnswers: userScores.fastAnswers,
correctAnswers: userScores.correctAnswers
};

await database.ref(`leaderboard/${examType}/${currentUser}`).set(scoreData);
console.log('æˆç¸¾å·²ä¿å­˜åˆ°æ’è¡Œæ¦œ');
} catch (err) {
console.error('ä¿å­˜æˆç¸¾å¤±æ•—:', err);
}
}

// ğŸ”§ ä¿®æ­£ï¼šé¡¯ç¤ºæ’è¡Œæ¦œ - ä¸ä½¿ç”¨ç´¢å¼•æŸ¥è©¢
async function showLeaderboard(examType) {
document.getElementById('modalTitle').textContent = `${examConfigs[examType].name} - æ’è¡Œæ¦œ`;
const content = document.getElementById('leaderboardContent');
content.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥æ’è¡Œæ¦œä¸­...</div>';
document.getElementById('leaderboardModal').style.display = 'flex';

try {
// ğŸ”§ ä¿®æ­£ï¼šç›´æ¥ç²å–æ‰€æœ‰è³‡æ–™ï¼Œé¿å…ä½¿ç”¨ orderByChild
const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
const data = snapshot.val();

if (data) {
// è½‰æ›ä¸¦æ’åºè³‡æ–™
const leaderboardData = Object.entries(data).map(([user, userData]) => ({
user,
...userData
})).sort((a, b) => {
if (b.score !== a.score) {
return b.score - a.score;
}
return a.totalTime - b.totalTime;
});

const leaderboardHtml = leaderboardData.map((entry, index) => {
const isCurrentUser = entry.user === currentUser;
const userMedalIcons = getUserMedalIcons(entry.user);

return `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">#${index + 1}</div>
<div class="user-name">
${entry.user}
${userMedalIcons}
</div>
<div class="score">${entry.score}åˆ†</div>
</div>
`;
}).join('');

content.innerHTML = `
<div class="leaderboard-container">
${leaderboardHtml}
</div>
`;
} else {
content.innerHTML = '<div class="empty-leaderboard"><p>ğŸ† å°šç„¡æ’è¡Œæ¦œè³‡æ–™</p></div>';
}
} catch (err) {
console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', err);
content.innerHTML = '<div class="empty-leaderboard"><p>âŒ è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</p></div>';
}
}

// ğŸ† é¡¯ç¤ºç¸½åˆ†æ’è¡Œæ¦œ
async function showTotalLeaderboard() {
document.getElementById('modalTitle').textContent = 'ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ';
const content = document.getElementById('leaderboardContent');
content.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œä¸­...</div>';
document.getElementById('leaderboardModal').style.display = 'flex';

try {
// ğŸ”§ ä¿®æ­£ï¼šè¨ˆç®—ç¸½åˆ†æ™‚ä¸ä½¿ç”¨ç´¢å¼•æŸ¥è©¢
const totalScores = {};
const examTypes = Object.keys(examConfigs);

// ä¸¦è¡Œç²å–æ‰€æœ‰è€ƒè©¦é¡å‹çš„è³‡æ–™
const promises = examTypes.map(async (examType) => {
const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
const data = snapshot.val() || {};

Object.entries(data).forEach(([user, userData]) => {
if (!totalScores[user]) {
totalScores[user] = { totalScore: 0, totalTime: 0, examCount: 0 };
}
totalScores[user].totalScore += userData.score || 0;
totalScores[user].totalTime += userData.totalTime || 0;
totalScores[user].examCount++;
});
});

await Promise.all(promises);

// æ’åºç¸½åˆ†è³‡æ–™
const sortedTotalScores = Object.entries(totalScores)
.map(([user, data]) => ({ user, ...data }))
.sort((a, b) => {
if (b.totalScore !== a.totalScore) {
return b.totalScore - a.totalScore;
}
return a.totalTime - b.totalTime;
});

if (sortedTotalScores.length > 0) {
const leaderboardHtml = sortedTotalScores.map((entry, index) => {
const isCurrentUser = entry.user === currentUser;
const userMedalIcons = getUserMedalIcons(entry.user);

return `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">#${index + 1}</div>
<div class="user-name">
${entry.user}
${userMedalIcons}
</div>
<div class="score">${entry.totalScore}åˆ†</div>
</div>
`;
}).join('');

content.innerHTML = `
<div class="leaderboard-container">
${leaderboardHtml}
</div>
`;
} else {
content.innerHTML = '<div class="empty-leaderboard"><p>ğŸ† å°šç„¡ç¸½åˆ†æ’è¡Œæ¦œè³‡æ–™</p></div>';
}
} catch (err) {
console.error('è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—:', err);
content.innerHTML = '<div class="empty-leaderboard"><p>âŒ è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—</p></div>';
}
}

// ğŸ… ç²å–ç”¨æˆ¶å‹³ç« åœ–ç¤º
function getUserMedalIcons(username) {
    const userData = usersData[username];
    if (!userData || !userData.medals || !userData.medals.equipped) {
        return '';
    }

    return userData.medals.equipped.map(medalId => {
        const medal = medalsData.medals[medalId];
        if (medal) {
            const iconContent = medal.icon.startsWith('http') ? 
                `<img src="${medal.icon}" alt="${medal.name}" style="width: 16px; height: 16px; object-fit: contain;">` : 
                medal.icon;
            return `<span class="leaderboard-medal" style="border-color: ${medal.color};">${iconContent}</span>`;
        }
        return '';
    }).join('');
}


// éš±è—æ’è¡Œæ¦œ
function hideLeaderboard() {
document.getElementById('leaderboardModal').style.display = 'none';
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
