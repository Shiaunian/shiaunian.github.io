<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
margin-left: 8px;
}

.btn {
padding: 8px 16px;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 0.9rem;
transition: all 0.3s ease;
flex: 1;
}

.btn-primary {
background: var(--primary);
color: var(--text-primary);
}

.btn-primary:hover {
background: var(--primary-dark);
}

.btn-secondary {
background: var(--warning);
color: var(--text-primary);
}

.btn-danger {
background: var(--danger);
color: var(--text-primary);
}

.challenge-item {
padding: 15px;
border-bottom: 1px solid var(--border-color);
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 8px;
}

/* ğŸ† æ–°å¢ï¼šæ¦œé¦–é¡¯ç¤ºæ¨£å¼ */
.champion-display {
margin-bottom: 8px;
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 400px;
max-height: 80vh;
border-radius: 12px;
overflow: hidden;
position: relative;
}

.modal-header {
padding: 15px;
background: var(--primary);
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 0 8px;
}

.modal-content {
padding: 15px;
overflow-y: auto;
max-height: calc(80vh - 56px);
min-height: 200px;
}

.leaderboard-container {
max-height: calc(60vh - 100px);
overflow-y: auto;
padding-right: 5px;
}

.leaderboard-item {
display: flex;
align-items: center;
padding: 8px 12px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s;
}

.leaderboard-item.current-user {
background: rgba(114, 137, 218, 0.1);
border-left: 3px solid var(--primary);
}

.rank {
min-width: 30px;
font-weight: bold;
color: var(--primary);
}

.user-name {
flex: 1;
margin: 0 10px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.score {
font-weight: bold;
color: var(--primary);
margin-left: auto;
}

.empty-leaderboard {
text-align: center;
padding: 20px;
color: var(--text-secondary);
}

.exam-container {
padding: 20px;
}

.exam-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.timer {
font-size: 1.2rem;
color: var(--primary);
}

.question {
background: var(--bg-secondary);
padding: 20px;
border-radius: 8px;
margin-bottom: 20px;
}

.options {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;
margin-top: 20px;
}

.option-btn {
width: 100%;
text-align: left;
padding: 12px;
}

.option-btn.correct {
background: var(--success);
}

.option-btn.wrong {
background: var(--danger);
}

.exam-result {
text-align: center;
padding: 20px;
}

.exam-result h2 {
margin-bottom: 20px;
}

.exam-result p {
margin-bottom: 10px;
}

.exam-result button {
margin: 10px;
}

::-webkit-scrollbar {
width: 8px;
}

::-webkit-scrollbar-track {
background: var(--bg-primary);
}

::-webkit-scrollbar-thumb {
background: var(--primary);
border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
background: var(--primary-dark);
}

.sudoku-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 4px;
background: var(--border-color);
padding: 4px;
border-radius: 8px;
margin-bottom: 20px;
}

.sudoku-cell {
width: 100%;
aspect-ratio: 1;
background: var(--bg-primary);
border: none;
border-radius: 4px;
color: var(--text-primary);
font-size: 1.5rem;
text-align: center;
cursor: pointer;
}

.sudoku-cell:disabled {
background: var(--bg-secondary);
color: var(--text-secondary);
cursor: not-allowed;
}

.sudoku-cell:focus {
outline: 2px solid var(--primary);
}

.sudoku-cell::-webkit-inner-spin-button,
.sudoku-cell::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}

.loading {
text-align: center;
padding: 40px 20px;
color: var(--text-secondary);
}

.loading-spinner {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid #f3f3f3;
border-top: 3px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-right: 10px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
<!-- è¼‰å…¥ä¸­ç•«é¢ -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
æ­£åœ¨é©—è­‰ç™»å…¥ç‹€æ…‹...
</div>
</div>

<!-- ä¸»è¦å…§å®¹ -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
  <div class="title-text">
      <span>ğŸ¯</span>
      <h1>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</h1>
      <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
  </div>
  <div class="user-info">
      <span id="currentUserWelcome">æ­¡è¿å›ä¾†ï¼Œè¼‰å…¥ä¸­...</span>
      <span class="connection-status" id="connectionStatus">ç”¨æˆ¶é€£ç·šä¸­</span>
  </div>
</div>
<div class="header-actions">
  <button class="btn btn-primary" onclick="backToT2()">è¿”å›T2æ—¥</button>
</div>
</header>

<div class="challenge-item">
<h3 class="challenge-title">â­åˆ†æµè€ƒè©¦æŒ‘æˆ°â­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ60ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('basic')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('basic')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­è‹±æ–‡è€ƒè©¦åŸºç¤ç‰ˆâ­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ15ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('food1')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('food1')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­è‹±æ–‡è€ƒè©¦é€²éšç‰ˆâ­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ10ç§’ä½œç­”æ™‚é–“ï¼Œå…±20é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('food')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('food')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­è‹±æ–‡è€ƒè©¦å¼·åŒ–ç‰ˆâ­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ10ç§’ä½œç­”æ™‚é–“ï¼Œå…±30é¡Œ ä¸€é¡Œ10åˆ†(æœ‰é»å›°é›£)</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('foodplus')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('foodplus')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">â­å‰å°è¤‡æŸ¥æŒ‘æˆ°â­</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ60ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('precheck')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('precheck')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">è¦å®šæŒ‘æˆ°</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ60ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('rule')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('rule')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">ğŸ‡°ğŸ‡·éŸ“èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡°ğŸ‡·</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ12ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('korean')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('korean')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">ğŸ‡¯ğŸ‡µæ—¥èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡¯ğŸ‡µ</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ12ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('japanese')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('japanese')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">ğŸ‡»ğŸ‡³è¶Šå—èªè©å½™æŒ‘æˆ°ğŸ‡»ğŸ‡³</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ12ç§’ä½œç­”æ™‚é–“ï¼Œå…±15é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('vietnamese')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('vietnamese')">æ’è¡Œæ¦œ</button>
</div>
</div>

<div class="challenge-item">
<h3 class="challenge-title">åˆéšæ•¸ç¨æŒ‘æˆ°</h3>
<p class="challenge-info" style="color:#ef4444;">æ¯é¡Œ80ç§’ä½œç­”æ™‚é–“ï¼Œå…±10é¡Œ ä¸€é¡Œ10åˆ†</p>
<div class="challenge-actions">
  <button class="btn btn-primary" onclick="startExam('sudoku')">è€ƒè©¦</button>
  <button class="btn btn-secondary" onclick="showLeaderboard('sudoku')">æ’è¡Œæ¦œ</button>
</div>
</div>
</div>

<!-- æ’è¡Œæ¦œæ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
  <h2 id="modalTitle">æ’è¡Œæ¦œ</h2>
  <button class="close-btn" onclick="hideLeaderboard()">Ã—</button>
</div>
<div class="modal-content" id="leaderboardContent">
</div>
</div>
</div>

<script>
// Firebase é…ç½®
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};
// åˆå§‹åŒ– Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// â”€â”€â”€ é¡Œåº«å®£å‘Š & è¼‰å…¥å‡½å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let examQuestions = {};
async function loadExamQuestions() {
try {
const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š${resp.status}`);
examQuestions = await resp.json();
console.log('âœ… é¡Œåº«å·²è¼‰å…¥', examQuestions);
} catch (err) {
console.error(err);
alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥é¡Œåº«æª”æ¡ˆ');
}
}

// â”€â”€â”€ è€ƒè©¦é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const examConfigs = {
basic:       { name:'â­åˆ†æµè€ƒè©¦æŒ‘æˆ°â­',    timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
food1:       { name:'â­è‹±æ–‡è€ƒè©¦åŸºç¤ç‰ˆâ­',    timePerQuestion:15, questionCount:15, fastAnswerThreshold:2.5,questions:[] },
food:        { name:'â­è‹±æ–‡è€ƒè©¦é€²éšç‰ˆâ­',    timePerQuestion:10, questionCount:20, fastAnswerThreshold:2,  questions:[] },
foodplus:    { name:'â­è‹±æ–‡è€ƒè©¦å¼·åŒ–ç‰ˆâ­',    timePerQuestion:10, questionCount:30, fastAnswerThreshold:2.5,questions:[] },
precheck:    { name:'å‰å°è¤‡æŸ¥æŒ‘æˆ°',        timePerQuestion:60, questionCount:15, fastAnswerThreshold:5,  questions:[] },
rule:        { name:'è¦å®šæŒ‘æˆ°',            timePerQuestion:60, questionCount:10, fastAnswerThreshold:5,  questions:[] },
korean:      { name:'ğŸ‡°ğŸ‡·éŸ“èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡°ğŸ‡·', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
japanese:    { name:'ğŸ‡¯ğŸ‡µæ—¥èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡¯ğŸ‡µ', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
vietnamese:  { name:'ğŸ‡»ğŸ‡³è¶Šå—èªè©å½™æŒ‘æˆ°ğŸ‡»ğŸ‡³', timePerQuestion:12, questionCount:15, fastAnswerThreshold:3,  questions:[] },
sudoku:      { name:'åˆéšæ•¸ç¨æŒ‘æˆ°',        timePerQuestion:80, questionCount:10, fastAnswerThreshold:30, questions:[] }
};

// å…¨åŸŸè®Šæ•¸
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// å·¥å…·å‡½æ•¸ï¼šå¾æ•¸çµ„ä¸­ç§»é™¤ç‰¹å®šå…ƒç´ 
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// å¼·åˆ¶ç™»å‡ºå‡½æ•¸
function forceLogout(message = 'ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index.html';
}

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ™‚æ•ˆ
function checkLoginStatus() {
const flag = localStorage.getItem('t2_login');
const time = localStorage.getItem('t2_login_time');
const user = localStorage.getItem('t2_login_user');
if (flag!=='yes' || !time || !user) {
forceLogout('æœªæª¢æ¸¬åˆ°æœ‰æ•ˆç™»å…¥ç‹€æ…‹');
return false;
}
if (Date.now()-parseInt(time) > 3600000) {
forceLogout('ç™»å…¥æ™‚é–“å·²è¶…é1å°æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
return false;
}
return user;
}

// è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«
async function loadUsersData() {
try {
const resp = await fetch('password.json');
if (!resp.ok) throw new Error('ç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«');
const data = await resp.json();
usersData = Array.isArray(data)? data : [data];
return true;
} catch (err) {
console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«å¤±æ•—:', err);
forceLogout('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™åº«');
return false;
}
}

// é©—è­‰ç”¨æˆ¶
function validateUser(username) {
const pwd = localStorage.getItem('t2_login_password');
const user = usersData.find(u=>u.username===username && u.password===pwd);
if (!user) {
console.error('ç”¨æˆ¶ä¸å­˜åœ¨', username);
forceLogout('ç”¨æˆ¶å¸³è™Ÿä¸å­˜åœ¨æ–¼ç³»çµ±ä¸­');
return null;
}
return user;
}

// é¡¯ç¤ºæ­¡è¿
function showWelcomeMessage(user) {
const elm = document.getElementById('currentUserWelcome');
const name = user.welcome||user._comment||user.username;
elm.textContent = `æ­¡è¿å›ä¾†ï¼Œ${name}`;
}

// ğŸ† è¼‰å…¥æ‰€æœ‰æ¦œé¦–è³‡è¨Š - ä¿®æ­£åŒåˆ†è™•ç†
async function loadAllChampions() {
const examTypes = ['basic', 'food1', 'food', 'foodplus', 'precheck', 'rule', 'korean', 'japanese', 'vietnamese', 'sudoku'];
const champions = {};

try {
  console.log('ğŸ”„ é–‹å§‹è¼‰å…¥æ’è¡Œæ¦œè³‡æ–™...');
  
  for (const examType of examTypes) {
      const snapshot = await database.ref(`scores/${examType}`).once('value');
      const scores = [];
      
      snapshot.forEach(child => {
          scores.push(child.val());
      });
      
      if (scores.length > 0) {
          // ğŸ† æ’åºé‚è¼¯ï¼šåˆ†æ•¸ â†’ æ¶ˆè€—æ™‚é–“ â†’ é¦–ç¶æ™‚é–“
          scores.sort((a, b) => {
              if (b.score !== a.score) {
                  return b.score - a.score; // åˆ†æ•¸é«˜çš„åœ¨å‰
              }
              if (a.totalTime !== b.totalTime) {
                  return (a.totalTime || 999999) - (b.totalTime || 999999); // åŒåˆ†æ™‚ï¼Œæ™‚é–“çŸ­çš„åœ¨å‰
              }
              return a.timestamp - b.timestamp; // æ™‚é–“ä¹Ÿç›¸åŒæ™‚ï¼Œæ™‚é–“æˆ³æ—©çš„åœ¨å‰ï¼ˆé¦–ç¶ï¼‰
          });
          
          // å–å¾—æ¦œé¦–
          const champion = scores[0];
          const sameScoreCount = scores.filter(s => s.score === champion.score).length;
          champions[examType] = {
              displayName: champion.displayName,
              score: champion.score,
              timestamp: champion.timestamp,
              totalTime: champion.totalTime,
              hasMultipleSameScore: sameScoreCount > 1
          };
          
          console.log(`ğŸ† ${examType} æ¦œé¦–: ${champion.displayName} (${champion.score}åˆ†) - é¦–ç¶æ™‚é–“: ${new Date(champion.timestamp).toLocaleString()}`);
      }
  }
  
  // æ›´æ–°é é¢é¡¯ç¤º
  updateChampionDisplay(champions);
  console.log('âœ… æ’è¡Œæ¦œè³‡æ–™å·²è¼‰å…¥', champions);
  
} catch (error) {
  console.error('âŒ è¼‰å…¥æ¦œé¦–è³‡è¨Šå¤±æ•—:', error);
}
}

// ğŸ† æ›´æ–°æ¦œé¦–é¡¯ç¤º - åŠ å…¥é¦–ç¶æ¨™è¨˜
function updateChampionDisplay(champions) {
const challengeItems = document.querySelectorAll('.challenge-item');

challengeItems.forEach(item => {
  const title = item.querySelector('.challenge-title');
  const actions = item.querySelector('.challenge-actions');
  
  // æ ¹æ“šæ¨™é¡Œåˆ¤æ–·è€ƒè©¦é¡å‹
  let examType = '';
  if (title.textContent.includes('åˆ†æµè€ƒè©¦æŒ‘æˆ°')) examType = 'basic';
  else if (title.textContent.includes('â­è‹±æ–‡è€ƒè©¦åŸºç¤ç‰ˆâ­')) examType = 'food1';
  else if (title.textContent.includes('â­è‹±æ–‡è€ƒè©¦é€²éšç‰ˆâ­')) examType = 'food';
  else if (title.textContent.includes('â­è‹±æ–‡è€ƒè©¦å¼·åŒ–ç‰ˆâ­')) examType = 'foodplus';
  else if (title.textContent.includes('â­å‰å°è¤‡æŸ¥æŒ‘æˆ°â­')) examType = 'precheck';
  else if (title.textContent.includes('è¦å®šæŒ‘æˆ°')) examType = 'rule';
  else if (title.textContent.includes('ğŸ‡°ğŸ‡·éŸ“èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡°ğŸ‡·')) examType = 'korean';
  else if (title.textContent.includes('ğŸ‡¯ğŸ‡µæ—¥èªæŒ‘æˆ°åŸºç¤ç‰ˆğŸ‡¯ğŸ‡µ')) examType = 'japanese';
  else if (title.textContent.includes('ğŸ‡»ğŸ‡³è¶Šå—èªè©å½™æŒ‘æˆ°ğŸ‡»ğŸ‡³')) examType = 'vietnamese';
  else if (title.textContent.includes('åˆéšæ•¸ç¨æŒ‘æˆ°')) examType = 'sudoku';
  
  // å¦‚æœæœ‰æ¦œé¦–è³‡è¨Šï¼Œæ·»åŠ é¡¯ç¤º
  if (examType && champions[examType]) {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ¦œé¦–é¡¯ç¤ºï¼Œé¿å…é‡è¤‡æ·»åŠ 
      let championDiv = item.querySelector('.champion-display');
      if (!championDiv) {
          championDiv = document.createElement('div');
          championDiv.className = 'champion-display';
          // æ’å…¥åˆ° challenge-actions ä¹‹å‰
          item.insertBefore(championDiv, actions);
      }
      
      // ğŸ† åŠ å…¥é¦–ç¶æ¨™è¨˜å’Œæ™‚é–“é¡¯ç¤º
      const champion = champions[examType];
      const bindDate = new Date(champion.timestamp).toLocaleDateString();
      
      // ğŸ† æª¢æŸ¥æ˜¯å¦çœŸçš„æœ‰åŒåˆ†æ‰é¡¯ç¤ºé¦–ç¶æ¨™è¨˜
      const bindMark = champion.hasMultipleSameScore ? ' ğŸ¥‡' : '';
      
      // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
      const timeDisplay = champion.totalTime ? 
          `${Math.floor(champion.totalTime / 60)}:${(champion.totalTime % 60).toString().padStart(2, '0')}` : 
          '';

      championDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; 
                  background: linear-gradient(45deg, #FFD700, #FFA500); 
                  color: #000; padding: 6px 12px; border-radius: 6px; 
                  font-size: 0.85rem; font-weight: bold; margin-bottom: 8px;
                  box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);">
              <span>ğŸ† æ¦œé¦–ï¼š${champion.displayName}${bindMark}</span>
              <div style="text-align: right;">
                  <div>${champion.score}åˆ†</div>
                  <div style="font-size: 0.7rem; opacity: 0.8;">
                      ${champion.hasMultipleSameScore ? 'é¦–ç¶ ' : ''}${bindDate}
                      ${timeDisplay ? ` (${timeDisplay})` : ''}
                  </div>
              </div>
          </div>
      `;
  } else if (examType) {
      // å¦‚æœæ²’æœ‰æ¦œé¦–è³‡è¨Šï¼Œé¡¯ç¤ºç©ºæ¦œé¦–
      let championDiv = item.querySelector('.champion-display');
      if (!championDiv) {
          championDiv = document.createElement('div');
          championDiv.className = 'champion-display';
          item.insertBefore(championDiv, actions);
      }
      
      championDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; 
                     background: rgba(255, 255, 255, 0.1); 
                     color: #a0a0a0; padding: 6px 12px; border-radius: 6px; 
                     font-size: 0.85rem; margin-bottom: 8px;
                     border: 1px dashed rgba(255, 255, 255, 0.2);">
              <span>ğŸ† æš«ç„¡æ¦œé¦–</span>
          </div>
      `;
  }
});
}

// ä¸»è¦åˆå§‹åŒ–
async function initializePage() {
try {
await
loadExamQuestions();
const success = await loadUsersData();
if (!success) return;

const username = checkLoginStatus();
if (!username) return;

currentUser = validateUser(username);
if (!currentUser) return;

showWelcomeMessage(currentUser);
await loadAllChampions();

document.getElementById('loadingScreen').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';
console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
} catch (error) {
console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
forceLogout('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
}
}

// ç™»å‡ºåŠŸèƒ½
function logout() {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
window.location.href = 'index.html';
}

// è¿”å›T2æ—¥åŠŸèƒ½
function backToT2() {
window.location.href = 'T2æ—¥.html';
}

// â”€â”€â”€ æ’è¡Œæ¦œåŠŸèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showLeaderboard(examType) {
try {
const config = examConfigs[examType];
if (!config) {
alert('è€ƒè©¦é¡å‹ä¸å­˜åœ¨');
return;
}

document.getElementById('modalTitle').textContent = `${config.name} - æ’è¡Œæ¦œ`;
document.getElementById('leaderboardContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥æ’è¡Œæ¦œä¸­...</div>';
document.getElementById('leaderboardModal').style.display = 'flex';

const snapshot = await database.ref(`scores/${examType}`).once('value');
const scores = [];

snapshot.forEach(child => {
scores.push(child.val());
});

if (scores.length === 0) {
document.getElementById('leaderboardContent').innerHTML = '<div class="empty-leaderboard">ç›®å‰é‚„æ²’æœ‰ä»»ä½•æˆç¸¾</div>';
return;
}

// ğŸ† æ’åºé‚è¼¯ï¼šåˆ†æ•¸ â†’ æ¶ˆè€—æ™‚é–“ â†’ é¦–ç¶æ™‚é–“
scores.sort((a, b) => {
if (b.score !== a.score) {
return b.score - a.score; // åˆ†æ•¸é«˜çš„åœ¨å‰
}
if (a.totalTime !== b.totalTime) {
return (a.totalTime || 999999) - (b.totalTime || 999999); // åŒåˆ†æ™‚ï¼Œæ™‚é–“çŸ­çš„åœ¨å‰
}
return a.timestamp - b.timestamp; // æ™‚é–“ä¹Ÿç›¸åŒæ™‚ï¼Œæ™‚é–“æˆ³æ—©çš„åœ¨å‰ï¼ˆé¦–ç¶ï¼‰
});

let html = '<div class="leaderboard-container">';
scores.forEach((score, index) => {
const isCurrentUser = score.username === currentUser.username;
const timeDisplay = score.totalTime ? 
`${Math.floor(score.totalTime / 60)}:${(score.totalTime % 60).toString().padStart(2, '0')}` : 
'--:--';

// ğŸ† æª¢æŸ¥æ˜¯å¦ç‚ºé¦–ç¶ï¼ˆåŒåˆ†ä¸­æ™‚é–“æˆ³æœ€æ—©çš„ï¼‰
const sameScoreUsers = scores.filter(s => s.score === score.score);
const isFirstBind = sameScoreUsers.length > 1 && 
sameScoreUsers.sort((a, b) => a.timestamp - b.timestamp)[0].username === score.username;

html += `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">${index + 1}</div>
<div class="user-name">
${score.displayName}${isFirstBind ? ' ğŸ¥‡' : ''}
<div style="font-size: 0.7rem; color: var(--text-secondary);">
${new Date(score.timestamp).toLocaleDateString()} ${timeDisplay}
</div>
</div>
<div class="score">${score.score}åˆ†</div>
</div>
`;
});
html += '</div>';

document.getElementById('leaderboardContent').innerHTML = html;
} catch (error) {
console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
document.getElementById('leaderboardContent').innerHTML = '<div class="empty-leaderboard">è¼‰å…¥æ’è¡Œæ¦œæ™‚ç™¼ç”ŸéŒ¯èª¤</div>';
}
}

function hideLeaderboard() {
document.getElementById('leaderboardModal').style.display = 'none';
}

// â”€â”€â”€ è€ƒè©¦åŠŸèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startExam(examType) {
const config = examConfigs[examType];
if (!config) {
alert('è€ƒè©¦é¡å‹ä¸å­˜åœ¨');
return;
}

if (!examQuestions[examType] || examQuestions[examType].length === 0) {
alert(`${config.name} é¡Œåº«å°šæœªè¼‰å…¥æˆ–ç‚ºç©º`);
return;
}

// éš¨æ©Ÿé¸å–é¡Œç›®
const allQuestions = [...examQuestions[examType]];
currentQuestions = [];
for (let i = 0; i < config.questionCount && allQuestions.length > 0; i++) {
const randomIndex = Math.floor(Math.random() * allQuestions.length);
currentQuestions.push(allQuestions[randomIndex]);
allQuestions.splice(randomIndex, 1);
}

currentExam = examType;
currentQuestionIndex = 0;
userScores = { fastAnswers: 0, correctAnswers: 0 };
examStartTime = Date.now();

showExamInterface();
showQuestion();
}

function showExamInterface() {
const config = examConfigs[currentExam];
document.getElementById('mainContent').innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
</div>
<div class="question" id="questionContainer">
</div>
</div>
`;
}

function showQuestion() {
if (currentQuestionIndex >= currentQuestions.length) {
endExam();
return;
}

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
questionStartTime = Date.now();

let questionHTML = '';

if (currentExam === 'sudoku') {
// æ•¸ç¨é¡Œç›®é¡¯ç¤º
questionHTML = `
<h3>ç¬¬ ${currentQuestionIndex + 1} é¡Œ / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="sudoku-grid" id="sudokuGrid">
${question.grid.map((cell, index) => 
`<input type="number" class="sudoku-cell" min="1" max="4" 
${cell !== 0 ? `value="${cell}" disabled` : ''} 
data-index="${index}">`
).join('')}
</div>
<button class="btn btn-primary" onclick="checkSudokuAnswer()">æäº¤ç­”æ¡ˆ</button>
`;
} else {
// ä¸€èˆ¬é¸æ“‡é¡Œé¡¯ç¤º
questionHTML = `
<h3>ç¬¬ ${currentQuestionIndex + 1} é¡Œ / ${currentQuestions.length}</h3>
<p>${question.question}</p>
<div class="options">
${question.options.map((option, index) => 
`<button class="btn btn-primary option-btn" onclick="selectAnswer(${index})">${option}</button>`
).join('')}
</div>
`;
}

document.getElementById('questionContainer').innerHTML = questionHTML;

// é–‹å§‹å€’æ•¸è¨ˆæ™‚
let timeLeft = config.timePerQuestion;
document.getElementById('timer').textContent = timeLeft;

examTimer = setInterval(() => {
timeLeft--;
document.getElementById('timer').textContent = timeLeft;

if (timeLeft <= 0) {
clearInterval(examTimer);
selectAnswer(-1); // æ™‚é–“åˆ°ï¼Œè¦–ç‚ºç­”éŒ¯
}
}, 1000);
}

function selectAnswer(selectedIndex) {
clearInterval(examTimer);

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;
const isCorrect = selectedIndex === question.correct;
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) {
userScores.fastAnswers++;
}
}

// é¡¯ç¤ºç­”æ¡ˆåé¥‹
const options = document.querySelectorAll('.option-btn');
options.forEach((btn, index) => {
btn.disabled = true;
if (index === question.correct) {
btn.classList.add('correct');
} else if (index === selectedIndex && !isCorrect) {
btn.classList.add('wrong');
}
});

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 1500);
}

function checkSudokuAnswer() {
clearInterval(examTimer);

const inputs = document.querySelectorAll('.sudoku-cell:not([disabled])');
const userAnswer = [];

inputs.forEach(input => {
userAnswer.push(parseInt(input.value) || 0);
});

const question = currentQuestions[currentQuestionIndex];
const config = examConfigs[currentExam];
const answerTime = (Date.now() - questionStartTime) / 1000;
const isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.answer);
const isFastAnswer = answerTime <= config.fastAnswerThreshold;

if (isCorrect) {
userScores.correctAnswers++;
if (isFastAnswer) {
userScores.fastAnswers++;
}
}

// é¡¯ç¤ºç­”æ¡ˆåé¥‹
inputs.forEach((input, index) => {
if (parseInt(input.value) === question.answer[index]) {
input.style.background = 'var(--success)';
} else {
input.style.background = 'var(--danger)';
}
input.disabled = true;
});

setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 2000);
}

async function endExam() {
const config = examConfigs[currentExam];
const totalTime = Math.floor((Date.now() - examStartTime) / 1000);
const finalScore = userScores.correctAnswers * 10;

// ä¿å­˜æˆç¸¾åˆ° Firebase
const scoreData = {
username: currentUser.username,
displayName: currentUser.welcome || currentUser._comment || currentUser.username,
score: finalScore,
correctAnswers: userScores.correctAnswers,
fastAnswers: userScores.fastAnswers,
totalQuestions: currentQuestions.length,
totalTime: totalTime,
timestamp: Date.now()
};

try {
await database.ref(`scores/${currentExam}`).push(scoreData);
console.log('âœ… æˆç¸¾å·²ä¿å­˜');
} catch (error) {
console.error('âŒ ä¿å­˜æˆç¸¾å¤±æ•—:', error);
}

// é¡¯ç¤ºè€ƒè©¦çµæœ
showExamResult(finalScore, totalTime);
}

function showExamResult(score, totalTime) {
const config = examConfigs[currentExam];
const minutes = Math.floor(totalTime / 60);
const seconds = totalTime % 60;

document.getElementById('mainContent').innerHTML = `
<div class="exam-result">
<h2>è€ƒè©¦å®Œæˆï¼</h2>
<p><strong>è€ƒè©¦é¡å‹ï¼š</strong>${config.name}</p>
<p><strong>æœ€çµ‚å¾—åˆ†ï¼š</strong>${score} åˆ†</p>
<p><strong>ç­”å°é¡Œæ•¸ï¼š</strong>${userScores.correctAnswers} / ${currentQuestions.length}</p>
<p><strong>å¿«é€Ÿä½œç­”ï¼š</strong>${userScores.fastAnswers} é¡Œ</p>
<p><strong>ç¸½ç”¨æ™‚ï¼š</strong>${minutes}:${seconds.toString().padStart(2, '0')}</p>
<button class="btn btn-primary" onclick="restartExam()">å†æ¬¡æŒ‘æˆ°</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
<button class="btn btn-danger" onclick="backToMain()">è¿”å›ä¸»é </button>
</div>
`;
}

function restartExam() {
if (currentExam) {
startExam(currentExam);
} else {
backToMain();
}
}

function backToMain() {
location.reload();
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
window.addEventListener('load', initializePage);

// é»æ“Šæ¨¡æ…‹è¦–çª—å¤–éƒ¨é—œé–‰
document.getElementById('leaderboardModal').addEventListener('click', function(e) {
if (e.target === this) {
hideLeaderboard();
}
});
</script>
</body>
</html>
