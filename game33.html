<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--border-radius: 8px;
--gold: #fbbf24;
--silver: #9ca3af;
--bronze: #d97706;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "å¾®è»Ÿæ­£é»‘é«”", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
line-height: 1.5;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
will-change: scroll-position;
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
display: flex;
align-items: center;
justify-content: space-between;
}

.user-currency {
display: flex;
gap: 12px;
align-items: center;
}

.currency-item {
display: flex;
align-items: center;
gap: 4px;
background: rgba(255, 255, 255, 0.05);
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

/* ğŸ¨ æŒ‰éˆ•æ¨£å¼ */
.btn {
padding: 10px 16px;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
font-size: 0.9rem;
font-weight: 500;
transition: var(--transition);
flex: 1;
position: relative;
overflow: hidden;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
min-height: 44px;
}

.btn::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
transition: left 0.5s;
}

.btn:hover::before {
left: 100%;
}

.btn-primary {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.3);
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(114, 137, 218, 0.4);
}

.btn-secondary {
background: linear-gradient(135deg, var(--warning), #e67e22);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.btn-secondary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.btn-danger {
background: linear-gradient(135deg, var(--danger), #c0392b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

.btn-shop {
background: linear-gradient(135deg, var(--gold), #f59e0b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
}

.btn-shop:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
}

/* header-actions æŒ‰éˆ•ä½ˆå±€ */
.header-actions {
display: flex;
gap: 8px;
margin-top: 12px;
}

.header-actions .btn {
flex: 1;
font-size: 0.8rem;
padding: 8px 10px;
min-height: 36px;
}

/* ğŸ… å‹³ç« é¡¯ç¤ºæ¨£å¼ */
.user-medals {
display: flex;
gap: 4px;
margin-top: 8px;
flex-wrap: wrap;
}

.medal-icon {
display: inline-flex;
align-items: center;
justify-content: center;
width: 28px;
height: 28px;
border-radius: 50%;
font-size: 0.9rem;
border: 2px solid;
background: rgba(255, 255, 255, 0.1);
transition: var(--transition);
cursor: pointer;
}

.medal-icon:hover {
transform: scale(1.1);
}

.medal-icon.common { border-color: #84cc16; }
.medal-icon.rare { border-color: #3b82f6; }
.medal-icon.epic { border-color: #8b5cf6; }
.medal-icon.legendary { border-color: #f59e0b; }

/* ğŸª å•†åº—æ¨£å¼ */
.shop-container {
padding: 16px;
}

.shop-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.shop-categories {
display: flex;
gap: 8px;
margin-bottom: 16px;
}

.category-btn {
padding: 8px 16px;
background: rgba(255, 255, 255, 0.05);
border: 1px solid var(--border-color);
border-radius: var(--border-radius);
color: var(--text-secondary);
cursor: pointer;
transition: var(--transition);
font-size: 0.85rem;
}

.category-btn.active {
background: var(--primary);
color: var(--text-primary);
border-color: var(--primary);
}

.shop-items {
display: grid;
gap: 12px;
}

.shop-item {
display: flex;
align-items: center;
padding: 12px;
background: rgba(255, 255, 255, 0.03);
border: 1px solid var(--border-color);
border-radius: var(--border-radius);
transition: var(--transition);
}

.shop-item:hover {
background: rgba(255, 255, 255, 0.05);
transform: translateY(-1px);
}

.shop-item.owned {
opacity: 0.6;
border-color: var(--success);
}

.shop-item.equipped {
border-color: var(--gold);
background: rgba(251, 191, 36, 0.1);
}

.medal-preview {
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
border: 2px solid;
margin-right: 12px;
}

.item-info {
flex: 1;
}

.item-name {
font-weight: 600;
margin-bottom: 4px;
}

.item-description {
font-size: 0.8rem;
color: var(--text-secondary);
margin-bottom: 4px;
}

.item-price {
font-size: 0.9rem;
color: var(--gold);
font-weight: 600;
}

.item-actions {
display: flex;
gap: 8px;
}

.btn-small {
padding: 6px 12px;
font-size: 0.8rem;
min-height: 32px;
}

/* ğŸ’ èƒŒåŒ…æ¨£å¼ */
.inventory-container {
padding: 16px;
}

.inventory-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
gap: 12px;
}

.inventory-item {
aspect-ratio: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.03);
border: 2px solid var(--border-color);
border-radius: var(--border-radius);
cursor: pointer;
transition: var(--transition);
padding: 8px;
}

.inventory-item:hover {
background: rgba(255, 255, 255, 0.08);
transform: translateY(-2px);
}

.inventory-item.equipped {
border-color: var(--gold);
background: rgba(251, 191, 36, 0.1);
}

.inventory-medal-icon {
font-size: 1.5rem;
margin-bottom: 4px;
}

.inventory-medal-name {
font-size: 0.7rem;
text-align: center;
line-height: 1.2;
}

/* æ’è¡Œæ¦œå‹³ç« é¡¯ç¤º */
.leaderboard-medals {
display: flex;
gap: 2px;
margin-left: 8px;
}

.leaderboard-medal {
width: 16px;
height: 16px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.6rem;
border: 1px solid;
}

/* å…¶ä»–ç¾æœ‰æ¨£å¼ä¿æŒä¸è®Š... */
.challenge-item {
padding: 16px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s ease;
}

.challenge-item:hover {
background: rgba(255, 255, 255, 0.02);
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
font-weight: 600;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 10px;
}

.champion-display {
margin-bottom: 10px;
}

.champion-card {
display: flex;
align-items: center;
justify-content: space-between;
background: linear-gradient(45deg, #FFD700, #FFA500);
color: #000;
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
font-weight: bold;
box-shadow: 0 3px 6px rgba(255, 215, 0, 0.3);
transition: var(--transition);
}

.champion-card:hover {
transform: translateY(-1px);
box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
}

.champion-empty {
display: flex;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.05);
color: var(--text-secondary);
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
border: 1px dashed rgba(255, 255, 255, 0.15);
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
backdrop-filter: blur(4px);
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 420px;
max-height: 85vh;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { transform: translateY(30px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.modal-header {
padding: 16px;
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 4px 8px;
border-radius: 4px;
transition: var(--transition);
}

.close-btn:hover {
background: rgba(255, 255, 255, 0.1);
transform: scale(1.1);
}

.modal-content {
padding: 16px;
overflow-y: auto;
max-height: calc(85vh - 68px);
min-height: 200px;
}

.leaderboard-container {
max-height: calc(60vh - 100px);
overflow-y: auto;
padding-right: 5px;
scroll-behavior: smooth;
}

.leaderboard-item {
display: flex;
align-items: center;
padding: 10px 12px;
border-bottom: 1px solid var(--border-color);
transition: var(--transition);
border-radius: 6px;
margin-bottom: 2px;
}

.leaderboard-item:hover {
background: rgba(114, 137, 218, 0.05);
transform: translateX(2px);
}

.leaderboard-item.current-user {
background: rgba(114, 137, 218, 0.1);
border-left: 3px solid var(--primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.2);
}

.rank {
min-width: 35px;
font-weight: bold;
color: var(--primary);
font-size: 1rem;
}

.user-name {
flex: 1;
margin: 0 12px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
display: flex;
align-items: center;
}

.score {
font-weight: bold;
color: var(--primary);
margin-left: auto;
font-size: 1rem;
}

.empty-leaderboard {
text-align: center;
padding: 30px 20px;
color: var(--text-secondary);
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 400px) {
.header-actions {
flex-direction: column;
gap: 8px;
}
.header-actions .btn {
width: 100%;
}
.user-currency {
flex-direction: column;
gap: 4px;
}
}

/* GPU åŠ é€Ÿ */
.btn, .modal, .leaderboard-item, .champion-card, .medal-icon {
transform: translateZ(0);
backface-visibility: hidden;
}

/* å…¶ä»–ç¾æœ‰æ¨£å¼... */
.exam-container { padding: 20px; }
.exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: var(--border-radius); }
.timer { font-size: 1.4rem; color: var(--primary); font-weight: bold; padding: 8px 16px; background: rgba(114, 137, 218, 0.1); border-radius: var(--border-radius); }
.question { background: rgba(255, 255, 255, 0.03); padding: 24px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color); }
.options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 20px; }
.option-btn { width: 100%; text-align: left; padding: 14px 16px; border-radius: var(--border-radius); transition: var(--transition); }
.option-btn.correct { background: linear-gradient(135deg, var(--success), #27ae60); }
.option-btn.wrong { background: linear-gradient(135deg, var(--danger), #c0392b); }
.exam-result { text-align: center; padding: 30px 20px; }
.exam-result h2 { margin-bottom: 20px; color: var(--primary); }
.exam-result p { margin-bottom: 12px; font-size: 1.05rem; }
.exam-result button { margin: 8px; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 3px; }
::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--primary), var(--primary-dark)); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, var(--primary-dark), var(--primary)); }
.sudoku-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; background: var(--border-color); padding: 8px; border-radius: var(--border-radius); margin-bottom: 20px; }
.sudoku-cell { width: 100%; aspect-ratio: 1; background: var(--bg-primary); border: 2px solid transparent; border-radius: 6px; color: var(--text-primary); font-size: 1.5rem; text-align: center; cursor: pointer; transition: var(--transition); }
.sudoku-cell:disabled { background: var(--bg-secondary); color: var(--text-secondary); cursor: not-allowed; }
.sudoku-cell:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(114, 137, 218, 0.3); }
.sudoku-cell::-webkit-inner-spin-button, .sudoku-cell::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.loading { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
.loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(114, 137, 218, 0.3); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; will-change: transform; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media (max-width: 400px) { .options { grid-template-columns: 1fr; } }
.btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
::selection { background: rgba(114, 137, 218, 0.3); color: var(--text-primary); }
</style>
</head>
<body>
<!-- è¼‰å…¥ä¸­ç•«é¢ -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
æ­£åœ¨é©—è­‰ç™»å…¥ç‹€æ…‹...
</div>
</div>

<!-- ä¸»è¦å…§å®¹ -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
<div class="title-text">
<span>ğŸ¯</span>
<h1>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</h1>
<button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
</div>
<div class="user-info">
<div>
<span id="currentUserWelcome">æ­¡è¿å›ä¾†ï¼Œè¼‰å…¥ä¸­...</span>
<div class="user-currency">
<div class="currency-item">
  <span>ğŸ’°</span>
  <span id="userCoins">0</span>
</div>
<div class="currency-item">
  <span>ğŸ’</span>
  <span id="userGems">0</span>
</div>
</div>
<div class="user-medals" id="userMedals"></div>
</div>
<span class="connection-status" id="connectionStatus">ç”¨æˆ¶é€£ç·šä¸­</span>
</div>
</div>
<div class="header-actions">
<button class="btn btn-primary" onclick="backToT2()">ğŸ  è¿”å›T2æ—¥</button>
<button class="btn btn-secondary" onclick="showTotalLeaderboard()">ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ</button>
<button class="btn btn-shop" onclick="showShop()">ğŸª å•†åº—</button>
<button class="btn btn-primary" onclick="showInventory()">ğŸ’ èƒŒåŒ…</button>
</div>
</header>

<!-- æŒ‘æˆ°é …ç›®åˆ—è¡¨ - å°‡å‹•æ…‹ç”Ÿæˆ -->
<div id="challengesList">
<!-- æŒ‘æˆ°é …ç›®å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>

<!-- ğŸª å•†åº—æ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="shopModal">
<div class="modal">
<div class="modal-header">
<h2>ğŸª å‹³ç« å•†åº—</h2>
<button class="close-btn" onclick="hideShop()">Ã—</button>
</div>
<div class="modal-content">
<div class="shop-container">
<div class="shop-categories">
<button class="category-btn active" onclick="filterShop('all')">å…¨éƒ¨</button>
<button class="category-btn" onclick="filterShop('common')">æ™®é€š</button>
<button class="category-btn" onclick="filterShop('rare')">ç¨€æœ‰</button>
<button class="category-btn" onclick="filterShop('epic')">å²è©©</button>
<button class="category-btn" onclick="filterShop('legendary')">å‚³èªª</button>
</div>
<div class="shop-items" id="shopItems">
<!-- å•†åº—ç‰©å“å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>
</div>
</div>
</div>

<!-- ğŸ’ èƒŒåŒ…æ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="inventoryModal">
<div class="modal">
<div class="modal-header">
<h2>ğŸ’ å‹³ç« èƒŒåŒ…</h2>
<button class="close-btn" onclick="hideInventory()">Ã—</button>
</div>
<div class="modal-content">
<div class="inventory-container">
<p style="margin-bottom: 16px; color: var(--text-secondary);">é»æ“Šå‹³ç« è£å‚™/å¸ä¸‹ (æœ€å¤šè£å‚™5å€‹)</p>
<div class="inventory-grid" id="inventoryGrid">
<!-- èƒŒåŒ…ç‰©å“å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>
</div>
</div>
</div>

<!-- æ’è¡Œæ¦œæ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">æ’è¡Œæ¦œ</h2>
<button class="close-btn" onclick="hideLeaderboard()">Ã—</button>
</div>
<div class="modal-content" id="leaderboardContent">
</div>
</div>
</div>

<script>
// Firebase é…ç½®
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šFirebase åˆå§‹åŒ–
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œåº«å¿«å–
let examQuestions = {};
let questionsCache = new Map();

// ğŸ… å‹³ç« ç³»çµ±è®Šæ•¸
let medalsData = {};
let userMedals = { owned: [], equipped: [] };
let userCurrency = { coins: 0, gems: 0 };

// ğŸ“ è€ƒè©¦é…ç½®è®Šæ•¸ (å¾JSONè¼‰å…¥)
let examConfigs = {};

// ğŸ… è¼‰å…¥å‹³ç« è³‡æ–™
async function loadMedalsData() {
try {
const cacheKey = 'medals_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
medalsData = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥å‹³ç« è³‡æ–™');
return;
}

const resp = await fetch('medals.json');
if (!resp.ok) throw new Error(`è¼‰å…¥å‹³ç« è³‡æ–™å¤±æ•—ï¼š${resp.status}`);
medalsData = await resp.json();

localStorage.setItem(cacheKey, JSON.stringify(medalsData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… å‹³ç« è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–', medalsData);
} catch (err) {
console.error('è¼‰å…¥å‹³ç« è³‡æ–™å¤±æ•—:', err);
// æä¾›é è¨­å‹³ç« è³‡æ–™
medalsData = {
medals: {},
rarityColors: {
common: "#84cc16",
rare: "#3b82f6", 
epic: "#8b5cf6",
legendary: "#f59e0b"
},
maxEquippedMedals: 5
};
}
}

// ğŸ“ è¼‰å…¥è€ƒè©¦é…ç½®
async function loadExamConfigs() {
try {
const cacheKey = 'exam_configs_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examConfigs = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥è€ƒè©¦é…ç½®');
return;
}

const resp = await fetch('exam-configs.json');
if (!resp.ok) throw new Error(`è¼‰å…¥è€ƒè©¦é…ç½®å¤±æ•—ï¼š${resp.status}`);
examConfigs = await resp.json();

localStorage.setItem(cacheKey, JSON.stringify(examConfigs));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… è€ƒè©¦é…ç½®å·²è¼‰å…¥ä¸¦å¿«å–', examConfigs);
} catch (err) {
console.error('è¼‰å…¥è€ƒè©¦é…ç½®å¤±æ•—:', err);
alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥è€ƒè©¦é…ç½®æª”æ¡ˆ');
}
}

// ğŸ“ å‹•æ…‹ç”ŸæˆæŒ‘æˆ°é …ç›®åˆ—è¡¨
function renderChallengesList() {
const challengesContainer = document.getElementById('challengesList');
const fragment = document.createDocumentFragment();

Object.entries(examConfigs).forEach(([examType, config]) => {
const challengeItem = document.createElement('div');
challengeItem.className = 'challenge-item';

challengeItem.innerHTML = `
<h3 class="challenge-title">${config.name}</h3>
<p class="challenge-info" style="color:#ef4444;">${config.description}</p>
<div class="champion-display" data-exam-type="${examType}">
<!-- æ¦œé¦–è³‡æ–™å°‡åœ¨æ­¤å‹•æ…‹è¼‰å…¥ -->
</div>
<div class="challenge-actions">
<button class="btn btn-primary" onclick="startExam('${examType}')">é–‹å§‹è€ƒè©¦</button>
<button class="btn btn-secondary" onclick="showLeaderboard('${examType}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
`;

fragment.appendChild(challengeItem);
});

challengesContainer.appendChild(fragment);
}

// ğŸ… è¼‰å…¥ç”¨æˆ¶å‹³ç« å’Œè²¨å¹£è³‡æ–™
async function loadUserMedalsAndCurrency() {
try {
const snapshot = await database.ref(`users/${currentUser}/medals`).once('value');
const medalSnapshot = snapshot.val() || {};
userMedals = {
owned: medalSnapshot.owned || [],
equipped: medalSnapshot.equipped || []
};

const currencySnapshot = await database.ref(`users/${currentUser}/currency`).once('value');
userCurrency = currencySnapshot.val() || { coins: 0, gems: 0 };

updateCurrencyDisplay();
updateMedalDisplay();
} catch (err) {
console.error('è¼‰å…¥ç”¨æˆ¶å‹³ç« è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸ… æ›´æ–°è²¨å¹£é¡¯ç¤º
function updateCurrencyDisplay() {
document.getElementById('userCoins').textContent = userCurrency.coins;
document.getElementById('userGems').textContent = userCurrency.gems;
}

// ğŸ… æ›´æ–°å‹³ç« é¡¯ç¤º
function updateMedalDisplay() {
const medalContainer = document.getElementById('userMedals');
medalContainer.innerHTML = '';

userMedals.equipped.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (medal) {
const medalIcon = document.createElement('div');
medalIcon.className = `medal-icon ${medal.rarity}`;
medalIcon.style.borderColor = medal.color;
medalIcon.innerHTML = medal.icon;
medalIcon.title = `${medal.name}: ${medal.description}`;
medalContainer.appendChild(medalIcon);
}
});
}

// ğŸ… æª¢æŸ¥å‹³ç« è§£é–æ¢ä»¶
async function checkMedalUnlocks(examType, score, totalTime, fastAnswers) {
const newUnlocks = [];

for (const [medalId, medal] of Object.entries(medalsData.medals)) {
if (userMedals.owned.includes(medalId)) continue;

let unlocked = false;
const condition = medal.unlockCondition;

switch (condition.type) {
case 'fast_answers':
if (fastAnswers >= condition.value) unlocked = true;
break;
case 'perfect_score':
if (score >= examConfigs[examType].questionCount * 10) unlocked = true;
break;
case 'high_score':
if (condition.examType === examType && score >= condition.value) unlocked = true;
break;
case 'first_exam':
unlocked = true;
break;
// å…¶ä»–æ¢ä»¶å¯ä»¥åœ¨é€™è£¡æ·»åŠ 
}

if (unlocked) {
newUnlocks.push(medalId);
userMedals.owned.push(medalId);
}
}

if (newUnlocks.length > 0) {
await saveMedalData();
showMedalUnlockNotification(newUnlocks);
}
}

// ğŸ… é¡¯ç¤ºå‹³ç« è§£é–é€šçŸ¥
function showMedalUnlockNotification(medalIds) {
medalIds.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (medal) {
// ç°¡å–®çš„é€šçŸ¥ï¼Œå¯ä»¥å¾ŒçºŒå„ªåŒ–ç‚ºæ›´å¥½çš„UI
setTimeout(() => {
alert(`ğŸ‰ æ­å–œè§£é–å‹³ç« ï¼š${medal.icon} ${medal.name}\n${medal.description}`);
}, 500);
}
});
}

// ğŸ… ä¿å­˜å‹³ç« è³‡æ–™
async function saveMedalData() {
try {
await database.ref(`users/${currentUser}/medals`).set(userMedals);
updateMedalDisplay();
} catch (err) {
console.error('ä¿å­˜å‹³ç« è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸ… ä¿å­˜è²¨å¹£è³‡æ–™
async function saveCurrencyData() {
try {
await database.ref(`users/${currentUser}/currency`).set(userCurrency);
updateCurrencyDisplay();
} catch (err) {
console.error('ä¿å­˜è²¨å¹£è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸª é¡¯ç¤ºå•†åº—
async function showShop() {
document.getElementById('shopModal').style.display = 'flex';
await renderShopItems();
}

// ğŸª éš±è—å•†åº—
function hideShop() {
document.getElementById('shopModal').style.display = 'none';
}

// ğŸª ç¯©é¸å•†åº—ç‰©å“
function filterShop(category) {
document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
event.target.classList.add('active');
renderShopItems(category);
}

// ğŸª æ¸²æŸ“å•†åº—ç‰©å“
async function renderShopItems(filter = 'all') {
const shopContainer = document.getElementById('shopItems');
shopContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥å•†åº—ä¸­...</div>';

const medals = Object.values(medalsData.medals);
const filteredMedals = filter === 'all' ? medals : medals.filter(medal => medal.rarity === filter);

const fragment = document.createDocumentFragment();

filteredMedals.forEach(medal => {
const isOwned = userMedals.owned.includes(medal.id);
const isEquipped = userMedals.equipped.includes(medal.id);
const canAfford = userCurrency.coins >= medal.price;

const item = document.createElement('div');
item.className = `shop-item ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;

item.innerHTML = `
<div class="medal-preview" style="border-color: ${medal.color};">
${medal.icon}
</div>
<div class="item-info">
<div class="item-name" style="color: ${medal.color};">${medal.name}</div>
<div class="item-description">${medal.description}</div>
<div class="item-price">ğŸ’° ${medal.price}</div>
</div>
<div class="item-actions">
${isOwned ? 
'<span class="btn btn-small btn-secondary">å·²æ“æœ‰</span>' :
`<button class="btn btn-small btn-primary ${!canAfford ? 'disabled' : ''}" 
onclick="buyMedal('${medal.id}')" ${!canAfford ? 'disabled' : ''}>
è³¼è²·
</button>`
}
</div>
`;

fragment.appendChild(item);
});

shopContainer.innerHTML = '';
shopContainer.appendChild(fragment);
}

// ğŸª è³¼è²·å‹³ç« 
async function buyMedal(medalId) {
const medal = medalsData.medals[medalId];
if (!medal || userMedals.owned.includes(medalId)) return;

if (userCurrency.coins < medal.price) {
alert('ğŸ’° é‡‘å¹£ä¸è¶³ï¼');
return;
}

if (confirm(`ç¢ºå®šè¦è³¼è²· ${medal.icon} ${medal.name} å—ï¼Ÿ\nåƒ¹æ ¼ï¼šğŸ’° ${medal.price}`)) {
userCurrency.coins -= medal.price;
userMedals.owned.push(medalId);

await Promise.all([saveMedalData(), saveCurrencyData()]);
await renderShopItems();
alert(`ğŸ‰ æˆåŠŸè³¼è²· ${medal.icon} ${medal.name}ï¼`);
}
}

// ğŸ’ é¡¯ç¤ºèƒŒåŒ…
async function showInventory() {
document.getElementById('inventoryModal').style.display = 'flex';
await renderInventory();
}

// ğŸ’ éš±è—èƒŒåŒ…
function hideInventory() {
document.getElementById('inventoryModal').style.display = 'none';
}

// ğŸ’ æ¸²æŸ“èƒŒåŒ…
async function renderInventory() {
const inventoryGrid = document.getElementById('inventoryGrid');
inventoryGrid.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥èƒŒåŒ…ä¸­...</div>';

const fragment = document.createDocumentFragment();

userMedals.owned.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (!medal) return;

const isEquipped = userMedals.equipped.includes(medalId);
const item = document.createElement('div');
item.className = `inventory-item ${isEquipped ? 'equipped' : ''}`;
item.onclick = () => toggleMedalEquip(medalId);

item.innerHTML = `
<div class="inventory-medal-icon" style="color: ${medal.color};">
${medal.icon}
</div>
<div class="inventory-medal-name">${medal.name}</div>
${isEquipped ? '<div style="font-size: 0.6rem; color: var(--gold);">å·²è£å‚™</div>' : ''}
`;

fragment.appendChild(item);
});

if (userMedals.owned.length === 0) {
const emptyMsg = document.createElement('div');
emptyMsg.className = 'empty-leaderboard';
emptyMsg.innerHTML = '<p>ğŸ’ èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p><p>å»å•†åº—è³¼è²·ä¸€äº›å‹³ç« å§ï¼</p>';
fragment.appendChild(emptyMsg);
}

inventoryGrid.innerHTML = '';
inventoryGrid.appendChild(fragment);
}

// ğŸ’ åˆ‡æ›å‹³ç« è£å‚™ç‹€æ…‹
async function toggleMedalEquip(medalId) {
const isEquipped = userMedals.equipped.includes(medalId);

if (isEquipped) {
// å¸ä¸‹å‹³ç« 
userMedals.equipped = userMedals.equipped.filter(id => id !== medalId);
} else {
// è£å‚™å‹³ç« 
if (userMedals.equipped.length >= medalsData.maxEquippedMedals) {
alert(`æœ€å¤šåªèƒ½è£å‚™ ${medalsData.maxEquippedMedals} å€‹å‹³ç« ï¼`);
return;
}
userMedals.equipped.push(medalId);
}

await saveMedalData();
await renderInventory();
}

async function loadExamQuestions() {
try {
// æª¢æŸ¥å¿«å–
const cacheKey = 'exam_questions_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// å¿«å–æœ‰æ•ˆæœŸ 1 å°æ™‚
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examQuestions = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥é¡Œåº«');
return;
}

const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š${resp.status}`);
examQuestions = await resp.json();

// å„²å­˜åˆ°å¿«å–
localStorage.setItem(cacheKey, JSON.stringify(examQuestions));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… é¡Œåº«å·²è¼‰å…¥ä¸¦å¿«å–', examQuestions);
} catch (err) {
console.error(err);
alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥é¡Œåº«æª”æ¡ˆ');
}
}

// å…¨åŸŸè®Šæ•¸
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé˜²æŠ–å‡½æ•¸
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
const later = () => {
clearTimeout(timeout);
func(...args);
};
clearTimeout(timeout);
timeout = setTimeout(later, wait);
};
}

// å·¥å…·å‡½æ•¸ï¼šå¾æ•¸çµ„ä¸­ç§»é™¤ç‰¹å®šå…ƒç´ 
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// å¼·åˆ¶ç™»å‡ºå‡½æ•¸
function forceLogout(message = 'ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index.html';
}

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ™‚æ•ˆ
function checkLoginStatus() {
const flag = localStorage.getItem('t2_login');
const time = localStorage.getItem('t2_login_time');
const user = localStorage.getItem('t2_login_user');
if (flag!=='yes' || !time || !user) {
forceLogout('æœªæª¢æ¸¬åˆ°æœ‰æ•ˆç™»å…¥ç‹€æ…‹');
return false;
}
if (Date.now()-parseInt(time) > 3600000) {
forceLogout('ç™»å…¥æ™‚é–“å·²è¶…é1å°æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
return false;
}
return user;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç”¨æˆ¶è³‡æ–™å¿«å–
async function loadUsersData() {
try {
// æª¢æŸ¥å¿«å–
const cacheKey = 'users_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// å¿«å–æœ‰æ•ˆæœŸ 5 åˆ†é˜
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 300000) {
usersData = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥ç”¨æˆ¶è³‡æ–™');
return;
}

const snapshot = await database.ref('users').once('value');
usersData = snapshot.val() || {};

// å„²å­˜åˆ°å¿«å–
localStorage.setItem(cacheKey, JSON.stringify(usersData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… ç”¨æˆ¶è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–');
} catch (err) {
console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ¦œé¦–è³‡æ–™å¿«å–
const championCache = new Map();

async function getChampion(examType) {
// æª¢æŸ¥å¿«å–
const cacheKey = `champion_${examType}`;
const cached = championCache.get(cacheKey);
if (cached && (Date.now() - cached.timestamp) < 60000) { // 1åˆ†é˜å¿«å–
return cached.data;
}

try {
const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').limitToLast(1).once('value');
const data = snapshot.val();
if (data) {
const users = Object.keys(data);
const champion = data[users[0]];
const result = { user: users[0], ...champion };

// å¿«å–çµæœ
championCache.set(cacheKey, {
data: result,
timestamp: Date.now()
});
return result;
}
return null;
} catch (err) {
console.error('ç²å–æ¦œé¦–å¤±æ•—:', err);
return null;
}
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ‰¹é‡æ›´æ–°æ¦œé¦–é¡¯ç¤º
const debouncedUpdateChampions = debounce(updateAllChampions, 300);

async function updateAllChampions() {
const examTypes = Object.keys(examConfigs);
const promises = examTypes.map(async (examType) => {
const champion = await getChampion(examType);
const championDisplay = document.querySelector(`[data-exam-type="${examType}"]`);
if (!championDisplay) return;

if (champion) {
championDisplay.innerHTML = `
<div class="champion-card">
<span>ğŸ† æ¦œé¦–ï¼š${champion.user}</span>
<span>${champion.score}åˆ†</span>
</div>
`;
} else {
championDisplay.innerHTML = `
<div class="champion-empty">
<span>ğŸ† å°šç„¡æ¦œé¦–</span>
</div>
`;
}
});

await Promise.all(promises);
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç™»å…¥é©—è­‰å’Œåˆå§‹åŒ–
async function initializeApp() {
try {
const user = checkLoginStatus();
if (!user) return;

currentUser = user;
document.getElementById('currentUserWelcome').textContent = `æ­¡è¿å›ä¾†ï¼Œ${user}`;

// ä¸¦è¡Œè¼‰å…¥è³‡æ–™
await Promise.all([
loadExamQuestions(),
loadUsersData(),
loadMedalsData(),
loadExamConfigs()
]);

// è¼‰å…¥ç”¨æˆ¶å‹³ç« å’Œè²¨å¹£
await loadUserMedalsAndCurrency();

// ç”ŸæˆæŒ‘æˆ°é …ç›®åˆ—è¡¨
renderChallengesList();

// æ›´æ–°æ¦œé¦–é¡¯ç¤º
await updateAllChampions();

// éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
document.getElementById('loadingScreen').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';

} catch (err) {
console.error('åˆå§‹åŒ–å¤±æ•—:', err);
alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
}
}

// ç™»å‡ºåŠŸèƒ½
function logout() {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
// æ¸…é™¤å¿«å–
localStorage.removeItem('exam_questions_v1');
localStorage.removeItem('exam_questions_v1_time');
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
localStorage.removeItem('medals_data_v1');
localStorage.removeItem('medals_data_v1_time');
localStorage.removeItem('exam_configs_v1');
localStorage.removeItem('exam_configs_v1_time');
championCache.clear();
window.location.href = 'index.html';
}

// è¿”å›T2æ—¥
function backToT2() {
window.location.href = 'dashboard.html';
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œç›®éš¨æ©ŸåŒ–
function shuffleArray(array) {
const newArray = [...array];
for (let i = newArray.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[newArray[i], newArray[j]] = [newArray[j], newArray[i]];
}
return newArray;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒè©¦é–‹å§‹å„ªåŒ–
function startExam(examType) {
if (!examQuestions[examType]) {
alert('é¡Œåº«è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
return;
}

const config = examConfigs[examType];
const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

if (questions.length < config.questionCount) {
alert(`é¡Œåº«é¡Œç›®ä¸è¶³ï¼éœ€è¦ ${config.questionCount} é¡Œï¼Œä½†åªæœ‰ ${questions.length} é¡Œ`);
return;
}

currentExam = examType;
currentQuestions = questions;
currentQuestionIndex = 0;
examStartTime = Date.now();
userScores = { fastAnswers: 0, correctAnswers: 0 };

// ğŸ… çå‹µé‡‘å¹£ (è€ƒè©¦é–‹å§‹çå‹µ)
userCurrency.coins += 5;
saveCurrencyData();

showExamInterface();
displayQuestion();
startQuestionTimer();
}

// é¡¯ç¤ºè€ƒè©¦ä»‹é¢ - ä¿®æ­£é¸æ“‡å™¨å•é¡Œ
function showExamInterface() {
const container = document.getElementById('mainContent'); // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ID
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
</div>
<div class="question" id="questionContainer">
<!-- é¡Œç›®å°‡åœ¨æ­¤é¡¯ç¤º -->
</div>
<div class="exam-progress">
<p>é¡Œç›® <span id="currentQuestionNum">1</span> / ${config.questionCount}</p>
<p>å¾—åˆ†ï¼š<span id="currentScore">0</span> åˆ†</p>
</div>
</div>
`;
}

// é¡¯ç¤ºé¡Œç›®
function displayQuestion() {
const question = currentQuestions[currentQuestionIndex];
const questionContainer = document.getElementById('questionContainer');
const config = examConfigs[currentExam];

document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;

if (currentExam === 'sudoku') {
// æ•¸ç¨ç‰¹æ®Šé¡¯ç¤º
questionContainer.innerHTML = `
<h3>${question.question}</h3>
<div class="sudoku-grid">
${question.grid.map((cell, index) => 
`<input type="number" class="sudoku-cell" 
${cell !== 0 ? `value="${cell}" disabled` : ''} 
min="1" max="4" 
data-index="${index}"
${cell === 0 ? 'onchange="checkSudokuAnswer()"' : ''}>`
).join('')}
</div>
<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">
å¡«å…¥1-4çš„æ•¸å­—ï¼Œä½¿æ¯è¡Œæ¯åˆ—éƒ½åŒ…å«1-4
</p>
`;
} else {
// ä¸€èˆ¬é¡Œç›®é¡¯ç¤º
const optionsHtml = question.options.map((option, index) => 
`<button class="btn option-btn" onclick="selectAnswer(${index})">${option}</button>`
).join('');

questionContainer.innerHTML = `
<h3>${question.question}</h3>
<div class="options">
${optionsHtml}
</div>
`;
}

questionStartTime = Date.now();
}

// é–‹å§‹é¡Œç›®è¨ˆæ™‚å™¨
function startQuestionTimer() {
const config = examConfigs[currentExam];
let timeLeft = config.timePerQuestion;
const timerElement = document.getElementById('timer');

examTimer = setInterval(() => {
timeLeft--;
timerElement.textContent = timeLeft;

if (timeLeft <= 0) {
clearInterval(examTimer);
// æ™‚é–“åˆ°ï¼Œè‡ªå‹•è·³åˆ°ä¸‹ä¸€é¡Œ
if (currentExam === 'sudoku') {
nextQuestion(false);
} else {
selectAnswer(-1); // -1 è¡¨ç¤ºæœªä½œç­”
}
}
}, 1000);
}

// é¸æ“‡ç­”æ¡ˆ - ä¿®æ­£ç‰ˆæœ¬
function selectAnswer(selectedIndex) {
clearInterval(examTimer);
const question = currentQuestions[currentQuestionIndex];
const isCorrect = selectedIndex === question.correct;
const responseTime = (Date.now() - questionStartTime) / 1000;
const config = examConfigs[currentExam];

// ğŸ… æª¢æŸ¥å¿«é€Ÿç­”é¡Œ
if (responseTime <= config.fastAnswerThreshold) {
userScores.fastAnswers++;
}

// ğŸ”§ ä¿®æ­£ï¼šåªæœ‰ç­”å°æ‰åŠ åˆ†ï¼Œä¸çµ¦éŒ¢
if (isCorrect) {
userScores.correctAnswers++;
// ç§»é™¤ï¼šuserCurrency.coins += 2; // ç­”å°ä¸çµ¦éŒ¢
}

// é¡¯ç¤ºç­”æ¡ˆåé¥‹
showAnswerFeedback(selectedIndex, question.correct, responseTime);

// å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
setTimeout(() => {
nextQuestion(isCorrect);
}, 1500);
}

// æ•¸ç¨ç­”æ¡ˆæª¢æŸ¥ - ä¿®æ­£ç‰ˆæœ¬
function checkSudokuAnswer() {
const cells = document.querySelectorAll('.sudoku-cell');
const userGrid = Array.from(cells).map(cell => parseInt(cell.value) || 0);
const question = currentQuestions[currentQuestionIndex];

// æª¢æŸ¥æ˜¯å¦å¡«å®Œ
const isEmpty = userGrid.some(cell => cell === 0);
if (isEmpty) return;

// æª¢æŸ¥ç­”æ¡ˆ
const isCorrect = JSON.stringify(userGrid) === JSON.stringify(question.solution);
const responseTime = (Date.now() - questionStartTime) / 1000;

clearInterval(examTimer);

// ğŸ”§ ä¿®æ­£ï¼šåªæœ‰ç­”å°æ‰åŠ åˆ†ï¼Œä¸çµ¦éŒ¢
if (isCorrect) {
userScores.correctAnswers++;
// ç§»é™¤ï¼šuserCurrency.coins += 2; // ç­”å°ä¸çµ¦éŒ¢
}

// ğŸ… æª¢æŸ¥å¿«é€Ÿç­”é¡Œ
const config = examConfigs[currentExam];
if (responseTime <= config.fastAnswerThreshold) {
userScores.fastAnswers++;
}

// é¡¯ç¤ºæ•¸ç¨åé¥‹
cells.forEach(cell => cell.disabled = true);
const feedbackDiv = document.createElement('div');
feedbackDiv.style.cssText = `
margin-top: 15px; 
text-align: center; 
font-size: 0.9rem;
color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};
`;
feedbackDiv.innerHTML = `${isCorrect ? 'âœ… æ­£ç¢ºï¼' : 'âŒ éŒ¯èª¤ï¼'} å›æ‡‰æ™‚é–“: ${responseTime.toFixed(1)}ç§’`;
document.getElementById('questionContainer').appendChild(feedbackDiv);

setTimeout(() => {
nextQuestion(isCorrect);
}, 1500);
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒè©¦é–‹å§‹å„ªåŒ– - ä¿®æ­£ç‰ˆæœ¬
function startExam(examType) {
if (!examQuestions[examType]) {
alert('é¡Œåº«è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
return;
}

const config = examConfigs[examType];
const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

if (questions.length < config.questionCount) {
alert(`é¡Œåº«é¡Œç›®ä¸è¶³ï¼éœ€è¦ ${config.questionCount} é¡Œï¼Œä½†åªæœ‰ ${questions.length} é¡Œ`);
return;
}

currentExam = examType;
currentQuestions = questions;
currentQuestionIndex = 0;
examStartTime = Date.now();
userScores = { fastAnswers: 0, correctAnswers: 0 };

// ğŸ”§ ç§»é™¤è€ƒè©¦é–‹å§‹çå‹µé‡‘å¹£
// userCurrency.coins += 5; // ç§»é™¤é€™è¡Œ
// saveCurrencyData(); // ç§»é™¤é€™è¡Œ

showExamInterface();
displayQuestion();
startQuestionTimer();
}

// é¡¯ç¤ºè€ƒè©¦ä»‹é¢ - åŠ å…¥æ£„æ¬ŠæŒ‰éˆ•
function showExamInterface() {
const container = document.getElementById('mainContent');
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-container">
<div class="exam-header">
<h2>${config.name}</h2>
<div class="timer" id="timer">${config.timePerQuestion}</div>
<button class="btn btn-danger" onclick="quitExam()" style="margin-left: 10px;">æ£„æ¬Š</button>
</div>
<div class="question" id="questionContainer">
<!-- é¡Œç›®å°‡åœ¨æ­¤é¡¯ç¤º -->
</div>
<div class="exam-progress">
<p>é¡Œç›® <span id="currentQuestionNum">1</span> / ${config.questionCount}</p>
<p>å¾—åˆ†ï¼š<span id="currentScore">0</span> åˆ†</p>
</div>
</div>
`;
}

// ğŸ†• æ£„æ¬ŠåŠŸèƒ½
function quitExam() {
if (confirm('ç¢ºå®šè¦æ£„æ¬Šå—ï¼Ÿæ£„æ¬Šå°‡ä¸æœƒç²å¾—ä»»ä½•åˆ†æ•¸å’Œçå‹µã€‚')) {
clearInterval(examTimer);

// ç›´æ¥è¿”å›ä¸»é ï¼Œä¸ä¿å­˜ä»»ä½•æˆç¸¾
location.reload();
}
}

// çµæŸè€ƒè©¦ - ä¿®æ­£ç‰ˆæœ¬
async function finishExam() {
clearInterval(examTimer);
const totalTime = (Date.now() - examStartTime) / 1000;
const finalScore = userScores.correctAnswers * 10;
const config = examConfigs[currentExam];

// ğŸ”§ ä¿®æ­£ï¼šåªæœ‰æ»¿åˆ†æ‰çµ¦éŒ¢
let coinsEarned = 0;
if (finalScore >= config.questionCount * 10) {
// æ»¿åˆ†çå‹µ
coinsEarned = 50; // æ»¿åˆ†çå‹µ50é‡‘å¹£
userCurrency.coins += coinsEarned;
await saveCurrencyData();
}

// ğŸ… æª¢æŸ¥å‹³ç« è§£é–
await checkMedalUnlocks(currentExam, finalScore, totalTime, userScores.fastAnswers);

// ä¿å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œ
await saveScoreToLeaderboard(currentExam, finalScore, totalTime);

// é¡¯ç¤ºçµæœ
showExamResult(finalScore, totalTime, coinsEarned);

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ¸…é™¤å¿«å–ä»¥ç²å–æœ€æ–°æ’è¡Œæ¦œ
const cacheKey = `champion_${currentExam}`;
championCache.delete(cacheKey);
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
}

// é¡¯ç¤ºè€ƒè©¦çµæœ - ä¿®æ­£ç‰ˆæœ¬
function showExamResult(score, totalTime, coinsEarned) {
const container = document.getElementById('mainContent');
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-result">
<h2>ğŸ‰ è€ƒè©¦å®Œæˆï¼</h2>
<p><strong>è€ƒè©¦é¡å‹ï¼š</strong>${config.name}</p>
<p><strong>æœ€çµ‚å¾—åˆ†ï¼š</strong>${score} åˆ†</p>
<p><strong>æ­£ç¢ºé¡Œæ•¸ï¼š</strong>${userScores.correctAnswers} / ${config.questionCount}</p>
<p><strong>å¿«é€Ÿç­”é¡Œï¼š</strong>${userScores.fastAnswers} é¡Œ</p>
<p><strong>ç¸½è€—æ™‚ï¼š</strong>${totalTime.toFixed(1)} ç§’</p>
${coinsEarned > 0 ? 
`<p style="color: var(--gold);"><strong>ğŸ‰ æ»¿åˆ†çå‹µï¼š</strong>ğŸ’° ${coinsEarned}</p>` : 
`<p style="color: var(--text-secondary);">ğŸ’° æœªé”æ»¿åˆ†ï¼Œç„¡é‡‘å¹£çå‹µ</p>`
}
<div style="margin-top: 20px;">
<button class="btn btn-primary" onclick="location.reload()">è¿”å›ä¸»é </button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>
`;
}

// é¡¯ç¤ºç­”æ¡ˆåé¥‹ - ä¿®æ­£ç‰ˆæœ¬
function showAnswerFeedback(selectedIndex, correctIndex, responseTime) {
const options = document.querySelectorAll('.option-btn');
const config = examConfigs[currentExam];

options.forEach((btn, index) => {
btn.disabled = true;
if (index === correctIndex) {
btn.classList.add('correct');
} else if (index === selectedIndex && selectedIndex !== correctIndex) {
btn.classList.add('wrong');
}
});

// é¡¯ç¤ºå›æ‡‰æ™‚é–“å’Œå¿«é€Ÿç­”é¡Œæç¤º
const feedbackDiv = document.createElement('div');
feedbackDiv.style.cssText = `
margin-top: 15px; 
text-align: center; 
font-size: 0.9rem;
color: var(--text-secondary);
`;

let feedbackText = `å›æ‡‰æ™‚é–“: ${responseTime.toFixed(1)}ç§’`;
if (responseTime <= config.fastAnswerThreshold) {
feedbackText += ` âš¡ å¿«é€Ÿç­”é¡Œï¼`;
}

feedbackDiv.innerHTML = feedbackText;
document.getElementById('questionContainer').appendChild(feedbackDiv);
}

// æ•¸ç¨ç­”æ¡ˆæª¢æŸ¥
function checkSudokuAnswer() {
const cells = document.querySelectorAll('.sudoku-cell');
const userGrid = Array.from(cells).map(cell => parseInt(cell.value) || 0);
const question = currentQuestions[currentQuestionIndex];

// æª¢æŸ¥æ˜¯å¦å¡«å®Œ
const isEmpty = userGrid.some(cell => cell === 0);
if (isEmpty) return;

// æª¢æŸ¥ç­”æ¡ˆ
const isCorrect = JSON.stringify(userGrid) === JSON.stringify(question.solution);
const responseTime = (Date.now() - questionStartTime) / 1000;

clearInterval(examTimer);

if (isCorrect) {
userScores.correctAnswers++;
userCurrency.coins += 2;
}

// ğŸ… æª¢æŸ¥å¿«é€Ÿç­”é¡Œ
const config = examConfigs[currentExam];
if (responseTime <= config.fastAnswerThreshold) {
userScores.fastAnswers++;
}

// é¡¯ç¤ºæ•¸ç¨åé¥‹
cells.forEach(cell => cell.disabled = true);
const feedbackDiv = document.createElement('div');
feedbackDiv.style.cssText = `
margin-top: 15px; 
text-align: center; 
font-size: 0.9rem;
color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};
`;
feedbackDiv.innerHTML = `${isCorrect ? 'âœ… æ­£ç¢ºï¼' : 'âŒ éŒ¯èª¤ï¼'} å›æ‡‰æ™‚é–“: ${responseTime.toFixed(1)}ç§’`;
document.getElementById('questionContainer').appendChild(feedbackDiv);

setTimeout(() => {
nextQuestion(isCorrect);
}, 1500);
}

// é€²å…¥ä¸‹ä¸€é¡Œæˆ–çµæŸè€ƒè©¦
function nextQuestion(wasCorrect) {
// æ›´æ–°åˆ†æ•¸é¡¯ç¤º
const currentScore = userScores.correctAnswers * 10;
document.getElementById('currentScore').textContent = currentScore;

currentQuestionIndex++;

if (currentQuestionIndex >= currentQuestions.length) {
// è€ƒè©¦çµæŸ
finishExam();
} else {
// ä¸‹ä¸€é¡Œ
displayQuestion();
startQuestionTimer();
}
}

// çµæŸè€ƒè©¦
async function finishExam() {
clearInterval(examTimer);
const totalTime = (Date.now() - examStartTime) / 1000;
const finalScore = userScores.correctAnswers * 10;

// ğŸ… å®Œæˆè€ƒè©¦çå‹µé‡‘å¹£
userCurrency.coins += 10;
await saveCurrencyData();

// ğŸ… æª¢æŸ¥å‹³ç« è§£é–
await checkMedalUnlocks(currentExam, finalScore, totalTime, userScores.fastAnswers);

// ä¿å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œ
await saveScoreToLeaderboard(currentExam, finalScore, totalTime);

// é¡¯ç¤ºçµæœ
showExamResult(finalScore, totalTime);

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ¸…é™¤å¿«å–ä»¥ç²å–æœ€æ–°æ’è¡Œæ¦œ
const cacheKey = `champion_${currentExam}`;
championCache.delete(cacheKey);
localStorage.removeItem('users_data_v1');
localStorage.removeItem('users_data_v1_time');
}

// ä¿å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œ
async function saveScoreToLeaderboard(examType, score, totalTime) {
try {
const scoreData = {
score: score,
totalTime: totalTime,
timestamp: Date.now(),
fastAnswers: userScores.fastAnswers,
correctAnswers: userScores.correctAnswers
};

await database.ref(`leaderboard/${examType}/${currentUser}`).set(scoreData);
console.log('âœ… æˆç¸¾å·²ä¿å­˜åˆ°æ’è¡Œæ¦œ');
} catch (err) {
console.error('ä¿å­˜æˆç¸¾å¤±æ•—:', err);
}
}

// é¡¯ç¤ºè€ƒè©¦çµæœ
function showExamResult(score, totalTime) {
const container = document.getElementById('mainContent'); // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ID
const config = examConfigs[currentExam];

container.innerHTML = `
<div class="exam-result">
<h2>ğŸ‰ è€ƒè©¦å®Œæˆï¼</h2>
<p><strong>è€ƒè©¦é¡å‹ï¼š</strong>${config.name}</p>
<p><strong>æœ€çµ‚å¾—åˆ†ï¼š</strong>${score} åˆ†</p>
<p><strong>æ­£ç¢ºé¡Œæ•¸ï¼š</strong>${userScores.correctAnswers} / ${config.questionCount}</p>
<p><strong>å¿«é€Ÿç­”é¡Œï¼š</strong>${userScores.fastAnswers} é¡Œ</p>
<p><strong>ç¸½è€—æ™‚ï¼š</strong>${totalTime.toFixed(1)} ç§’</p>
<p><strong>ç²å¾—é‡‘å¹£ï¼š</strong>ğŸ’° ${5 + (userScores.correctAnswers * 2) + 10}</p>
<div style="margin-top: 20px;">
<button class="btn btn-primary" onclick="location.reload()">è¿”å›ä¸»é </button>
<button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
</div>
</div>
`;
}

// é¡¯ç¤ºæ’è¡Œæ¦œ
async function showLeaderboard(examType) {
document.getElementById('modalTitle').textContent = `${examConfigs[examType].name} - æ’è¡Œæ¦œ`;
document.getElementById('leaderboardModal').style.display = 'flex';
document.getElementById('leaderboardContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥æ’è¡Œæ¦œä¸­...</div>';

try {
const snapshot = await database.ref(`leaderboard/${examType}`).orderByChild('score').once('value');
const data = snapshot.val();

if (!data) {
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>ğŸ“Š æš«ç„¡æ’è¡Œæ¦œè¨˜éŒ„</p>
<p>æˆç‚ºç¬¬ä¸€å€‹æŒ‘æˆ°è€…å§ï¼</p>
</div>
`;
return;
}

// è½‰æ›ä¸¦æ’åºè³‡æ–™
const leaderboardData = Object.entries(data).map(([user, userData]) => ({
user,
...userData
})).sort((a, b) => {
// å…ˆæŒ‰åˆ†æ•¸æ’åºï¼Œåˆ†æ•¸ç›¸åŒæ™‚æŒ‰æ™‚é–“æ’åºï¼ˆæ™‚é–“çŸ­çš„æ’å‰é¢ï¼‰
if (b.score !== a.score) {
return b.score - a.score;
}
return a.totalTime - b.totalTime;
});

// ç”Ÿæˆæ’è¡Œæ¦œHTML
const leaderboardHTML = `
<div class="leaderboard-container">
${leaderboardData.map((entry, index) => {
const isCurrentUser = entry.user === currentUser;
const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;

const medalDisplay = getUserMedalDisplay(entry.user);
return `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">${rankIcon}</div>
<div class="user-name">
${entry.user}
${medalDisplay}
</div>
<div class="score">${entry.score}åˆ†</div>
</div>
`;
}).join('')}
</div>
`;

document.getElementById('leaderboardContent').innerHTML = leaderboardHTML;

} catch (err) {
console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>âŒ è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</p>
<p>è«‹ç¨å¾Œå†è©¦</p>
</div>
`;
}
}

// é¡¯ç¤ºç¸½åˆ†æ’è¡Œæ¦œ
async function showTotalLeaderboard() {
document.getElementById('modalTitle').textContent = 'ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ';
document.getElementById('leaderboardModal').style.display = 'flex';
document.getElementById('leaderboardContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œä¸­...</div>';

try {
const snapshot = await database.ref('leaderboard').once('value');
const allData = snapshot.val();

if (!allData) {
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>ğŸ“Š æš«ç„¡ç¸½åˆ†æ’è¡Œæ¦œè¨˜éŒ„</p>
<p>é–‹å§‹æŒ‘æˆ°å§ï¼</p>
</div>
`;
return;
}

// è¨ˆç®—æ¯å€‹ç”¨æˆ¶çš„ç¸½åˆ†å’Œç¸½æ™‚é–“
const userTotals = {};
Object.entries(allData).forEach(([examType, examData]) => {
Object.entries(examData).forEach(([user, userData]) => {
if (!userTotals[user]) {
userTotals[user] = { totalScore: 0, totalTime: 0, examCount: 0 };
}
userTotals[user].totalScore += userData.score;
userTotals[user].totalTime += userData.totalTime;
userTotals[user].examCount += 1;
});
});

// è½‰æ›ä¸¦æ’åºè³‡æ–™
const totalLeaderboardData = Object.entries(userTotals).map(([user, data]) => ({
user,
...data
})).sort((a, b) => {
// å…ˆæŒ‰ç¸½åˆ†æ’åºï¼Œç¸½åˆ†ç›¸åŒæ™‚æŒ‰ç¸½æ™‚é–“æ’åº
if (b.totalScore !== a.totalScore) {
return b.totalScore - a.totalScore;
}
return a.totalTime - b.totalTime;
});

// ç”Ÿæˆç¸½åˆ†æ’è¡Œæ¦œHTML
const leaderboardHTML = `
<div class="leaderboard-container">
${totalLeaderboardData.map((entry, index) => {
const isCurrentUser = entry.user === currentUser;
const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
const medalDisplay = getUserMedalDisplay(entry.user);
return `
<div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
<div class="rank">${rankIcon}</div>
<div class="user-name">
${entry.user}
${medalDisplay}
</div>
<div class="score">
<div>${entry.totalScore}åˆ†</div>
<div style="font-size: 0.7rem; color: var(--text-secondary);">
${entry.examCount}å ´è€ƒè©¦ | ${entry.totalTime.toFixed(1)}ç§’
</div>
</div>
</div>
`;
}).join('')}
</div>
`;

document.getElementById('leaderboardContent').innerHTML = leaderboardHTML;

} catch (err) {
console.error('è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—:', err);
document.getElementById('leaderboardContent').innerHTML = `
<div class="empty-leaderboard">
<p>âŒ è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—</p>
<p>è«‹ç¨å¾Œå†è©¦</p>
</div>
`;
}
}

// ç²å–ç”¨æˆ¶å‹³ç« é¡¯ç¤º
function getUserMedalDisplay(username) {
// å¾Firebaseç²å–ç”¨æˆ¶å‹³ç« è³‡æ–™ä¸¦é¡¯ç¤º
// é€™è£¡å…ˆè¿”å›ç©ºå­—ä¸²ï¼Œå¯ä»¥å¾ŒçºŒå„ªåŒ–ç‚ºå¯¦éš›çš„å‹³ç« é¡¯ç¤º
try {
// å¦‚æœæ˜¯ç•¶å‰ç”¨æˆ¶ï¼Œç›´æ¥ä½¿ç”¨å·²è¼‰å…¥çš„å‹³ç« è³‡æ–™
if (username === currentUser && userMedals.equipped.length > 0) {
return `<div class="leaderboard-medals">
${userMedals.equipped.slice(0, 3).map(medalId => {
const medal = medalsData.medals[medalId];
return medal ? `<div class="leaderboard-medal ${medal.rarity}" style="border-color: ${medal.color};">${medal.icon}</div>` : '';
}).join('')}
</div>`;
}
} catch (err) {
console.error('ç²å–ç”¨æˆ¶å‹³ç« é¡¯ç¤ºå¤±æ•—:', err);
}
return '';
}

// éš±è—æ’è¡Œæ¦œ
function hideLeaderboard() {
document.getElementById('leaderboardModal').style.display = 'none';
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
initializeApp();
});

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè¦–çª—å¤§å°è®ŠåŒ–æ™‚çš„éŸ¿æ‡‰å¼è™•ç†
window.addEventListener('resize', debounce(() => {
// å¯ä»¥åœ¨é€™è£¡æ·»åŠ éŸ¿æ‡‰å¼é‚è¼¯
}, 250));

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé é¢å¯è¦‹æ€§è®ŠåŒ–è™•ç†
document.addEventListener('visibilitychange', function() {
if (document.hidden) {
// é é¢éš±è—æ™‚æš«åœè¨ˆæ™‚å™¨
if (examTimer) {
clearInterval(examTimer);
}
} else {
// é é¢é¡¯ç¤ºæ™‚æ¢å¾©è¨ˆæ™‚å™¨
if (currentExam && currentQuestionIndex < currentQuestions.length) {
startQuestionTimer();
}
}
});

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
window.addEventListener('beforeunload', function() {
if (examTimer) {
clearInterval(examTimer);
}
championCache.clear();
});
</script>
</body>
</html>

