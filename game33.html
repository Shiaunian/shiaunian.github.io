<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T2æ—¥æª¢ç–«æŒ‘æˆ°ç³»çµ±</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
--bg-primary: #1a1b1e;
--bg-secondary: #2d2d30;
--primary: #7289da;
--primary-dark: #5c6fb1;
--text-primary: #ffffff;
--text-secondary: #a0a0a0;
--danger: #ef4444;
--warning: #f59e0b;
--success: #22c55e;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
--border-color: rgba(255, 255, 255, 0.1);
--info: #3b82f6;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
--border-radius: 8px;
--gold: #fbbf24;
--silver: #9ca3af;
--bronze: #d97706;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: "å¾®è»Ÿæ­£é»‘é«”", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background: var(--bg-primary);
min-height: 100vh;
padding: 12px;
color: var(--text-primary);
line-height: 1.5;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.container {
max-width: 480px;
margin: 0 auto;
height: calc(100vh - 24px);
overflow-y: auto;
background: var(--bg-secondary);
border-radius: 12px;
box-shadow: var(--shadow);
will-change: scroll-position;
}

.header {
background: var(--bg-secondary);
padding: 15px;
border-bottom: 1px solid var(--border-color);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
}

.header-title {
display: flex;
flex-direction: column;
margin-bottom: 10px;
}

.title-text {
font-size: 1.3rem;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
justify-content: space-between;
}

.user-info {
font-size: 0.9rem;
color: var(--text-secondary);
margin-top: 5px;
display: flex;
align-items: center;
justify-content: space-between;
}

.user-currency {
display: flex;
gap: 12px;
align-items: center;
}

.currency-item {
display: flex;
align-items: center;
gap: 4px;
background: rgba(255, 255, 255, 0.05);
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
}

.connection-status {
background-color: var(--success);
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

/* ğŸ¨ æŒ‰éˆ•æ¨£å¼ */
.btn {
padding: 10px 16px;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
font-size: 0.9rem;
font-weight: 500;
transition: var(--transition);
flex: 1;
position: relative;
overflow: hidden;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
min-height: 44px;
}

.btn::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
transition: left 0.5s;
}

.btn:hover::before {
left: 100%;
}

.btn-primary {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.3);
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(114, 137, 218, 0.4);
}

.btn-secondary {
background: linear-gradient(135deg, var(--warning), #e67e22);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.btn-secondary:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.btn-danger {
background: linear-gradient(135deg, var(--danger), #c0392b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

.btn-shop {
background: linear-gradient(135deg, var(--gold), #f59e0b);
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
}

.btn-shop:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
}

/* header-actions æŒ‰éˆ•ä½ˆå±€ */
.header-actions {
display: flex;
gap: 8px;
margin-top: 12px;
}

.header-actions .btn {
flex: 1;
font-size: 0.8rem;
padding: 8px 10px;
min-height: 36px;
}

/* ğŸ… å‹³ç« é¡¯ç¤ºæ¨£å¼ */
.user-medals {
display: flex;
gap: 4px;
margin-top: 8px;
flex-wrap: wrap;
}

.medal-icon {
display: inline-flex;
align-items: center;
justify-content: center;
width: 28px;
height: 28px;
border-radius: 50%;
font-size: 0.9rem;
border: 2px solid;
background: rgba(255, 255, 255, 0.1);
transition: var(--transition);
cursor: pointer;
overflow: hidden; /* ğŸ”§ æ–°å¢ï¼šé˜²æ­¢åœ–ç‰‡æº¢å‡º */
}

.medal-icon:hover {
transform: scale(1.1);
}

.medal-icon.common { border-color: #84cc16; }
.medal-icon.rare { border-color: #3b82f6; }
.medal-icon.epic { border-color: #8b5cf6; }
.medal-icon.legendary { border-color: #f59e0b; }

/* ğŸ”§ æ–°å¢ï¼šå‹³ç« åœ–ç‰‡æ¨£å¼ */
.medal-icon img,
.medal-preview img,
.inventory-medal-icon img,
.leaderboard-medal img {
border-radius: 4px;
display: block;
}

/* ğŸª å•†åº—æ¨£å¼ */
.shop-container {
padding: 16px;
}

.shop-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.shop-categories {
display: flex;
gap: 8px;
margin-bottom: 16px;
}

.category-btn {
padding: 8px 16px;
background: rgba(255, 255, 255, 0.05);
border: 1px solid var(--border-color);
border-radius: var(--border-radius);
color: var(--text-secondary);
cursor: pointer;
transition: var(--transition);
font-size: 0.85rem;
}

.category-btn.active {
background: var(--primary);
color: var(--text-primary);
border-color: var(--primary);
}

.shop-items {
display: grid;
gap: 12px;
}

.shop-item {
display: flex;
align-items: center;
padding: 12px;
background: rgba(255, 255, 255, 0.03);
border: 1px solid var(--border-color);
border-radius: var(--border-radius);
transition: var(--transition);
}

.shop-item:hover {
background: rgba(255, 255, 255, 0.05);
transform: translateY(-1px);
}

.shop-item.owned {
opacity: 0.6;
border-color: var(--success);
}

.shop-item.equipped {
border-color: var(--gold);
background: rgba(251, 191, 36, 0.1);
}

.medal-preview {
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
border: 2px solid;
margin-right: 12px;
}

.item-info {
flex: 1;
}

.item-name {
font-weight: 600;
margin-bottom: 4px;
}

.item-description {
font-size: 0.8rem;
color: var(--text-secondary);
margin-bottom: 4px;
}

.item-price {
font-size: 0.9rem;
color: var(--gold);
font-weight: 600;
}

.item-actions {
display: flex;
gap: 8px;
}

.btn-small {
padding: 6px 12px;
font-size: 0.8rem;
min-height: 32px;
}

/* ğŸ’ èƒŒåŒ…æ¨£å¼ */
.inventory-container {
padding: 16px;
}

.inventory-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
gap: 12px;
}

.inventory-item {
aspect-ratio: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.03);
border: 2px solid var(--border-color);
border-radius: var(--border-radius);
cursor: pointer;
transition: var(--transition);
padding: 8px;
}

.inventory-item:hover {
background: rgba(255, 255, 255, 0.08);
transform: translateY(-2px);
}

.inventory-item.equipped {
border-color: var(--gold);
background: rgba(251, 191, 36, 0.1);
}

.inventory-medal-icon {
font-size: 1.5rem;
margin-bottom: 4px;
}

.inventory-medal-name {
font-size: 0.7rem;
text-align: center;
line-height: 1.2;
}

/* æ’è¡Œæ¦œå‹³ç« é¡¯ç¤º - å‡ç´šç‰ˆæœ¬ */
.leaderboard-medals {
    display: flex;
    gap: 4px;
    margin-top: 4px;
    flex-wrap: wrap;
    align-items: center;
}

.leaderboard-medal {
    width: 32px;  /* ğŸ”§ å¾16pxå¢åŠ åˆ°32pxï¼Œæ”¾å¤§å…©å€ */
    height: 32px; /* ğŸ”§ å¾16pxå¢åŠ åˆ°32pxï¼Œæ”¾å¤§å…©å€ */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem; /* ğŸ”§ å¾0.6remå¢åŠ åˆ°1.2rem */
    border: 2px solid; /* ğŸ”§ å¾1pxå¢åŠ åˆ°2pxï¼Œé‚Šæ¡†æ›´æ˜é¡¯ */
    background: rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    
    /* ğŸŒŸ æ–°å¢ï¼šåå…‰æ•ˆæœåŸºç¤ */
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.2) 0%, 
        rgba(255, 255, 255, 0.05) 50%, 
        rgba(0, 0, 0, 0.1) 100%);
    box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

/* ğŸŒŸ æ–°å¢ï¼šåå…‰å‹•ç•«æ•ˆæœ */
.leaderboard-medal::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
        transparent 30%, 
        rgba(255, 255, 255, 0.4) 50%, 
        transparent 70%);
    transform: rotate(45deg);
    transition: all 0.6s ease;
    opacity: 0;
}

/* ğŸŒŸ æ–°å¢ï¼šæ‡¸åœæ™‚çš„åå…‰æ•ˆæœ */
.leaderboard-medal:hover::before {
    opacity: 1;
    animation: shine 0.6s ease-in-out;
}

.leaderboard-medal:hover {
    transform: scale(1.1) translateY(-1px);
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.4),
        inset 0 -1px 0 rgba(0, 0, 0, 0.3);
}

/* ğŸŒŸ åå…‰å‹•ç•«é—œéµå¹€ */
@keyframes shine {
    0% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
    100% {
        transform: translateX(100%) translateY(100%) rotate(45deg);
        opacity: 0;
    }
}

/* ğŸ”§ ä¿®æ­£ï¼šå‹³ç« å…§åœ–ç‰‡æ¨£å¼ */
.leaderboard-medal img {
    width: 24px;  /* ğŸ”§ å¾12pxå¢åŠ åˆ°24px */
    height: 24px; /* ğŸ”§ å¾12pxå¢åŠ åˆ°24px */
    object-fit: contain;
    border-radius: 4px;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
    transition: all 0.3s ease;
}

.leaderboard-medal:hover img {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4)) brightness(1.1);
}

/* ğŸŒŸ æ–°å¢ï¼šä¸åŒç¨€æœ‰åº¦çš„ç‰¹æ®Šæ•ˆæœ */
.leaderboard-medal[data-rarity="common"] {
    border-color: #84cc16;
    box-shadow: 
        0 2px 8px rgba(132, 204, 22, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

.leaderboard-medal[data-rarity="rare"] {
    border-color: #3b82f6;
    box-shadow: 
        0 2px 8px rgba(59, 130, 246, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

.leaderboard-medal[data-rarity="epic"] {
    border-color: #8b5cf6;
    box-shadow: 
        0 2px 8px rgba(139, 92, 246, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
}

.leaderboard-medal[data-rarity="legendary"] {
    border-color: #f59e0b;
    box-shadow: 
        0 2px 8px rgba(245, 158, 11, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.4),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    animation: legendaryGlow 2s ease-in-out infinite alternate;
}
.leaderboard-medal[data-rarity="mythic"] {
    border-color: #dc2626;
    box-shadow: 
        0 2px 8px rgba(220, 38, 38, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.5),
        inset 0 -1px 0 rgba(0, 0, 0, 0.3);
    animation: mythicGlow 2s ease-in-out infinite alternate;
}

/* ğŸŒŸ å‚³èªªç´šå‹³ç« çš„ç‰¹æ®Šç™¼å…‰æ•ˆæœ */
@keyframes legendaryGlow {
    0% {
        box-shadow: 
            0 2px 8px rgba(245, 158, 11, 0.4),
            0 0 10px rgba(245, 158, 11, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.4),
            inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    }
    100% {
        box-shadow: 
            0 2px 8px rgba(245, 158, 11, 0.6),
            0 0 20px rgba(245, 158, 11, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.5),
            inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    }

}
/* ç¥è©±ç´šå‹³ç« çš„ç‰¹æ®Šç™¼å…‰æ•ˆæœ */
@keyframes mythicGlow {
    0% {
        box-shadow: 
            0 2px 8px rgba(220, 38, 38, 0.5),
            0 0 15px rgba(220, 38, 38, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.5),
            inset 0 -1px 0 rgba(0, 0, 0, 0.3);
    }
    100% {
        box-shadow: 
            0 2px 8px rgba(220, 38, 38, 0.7),
            0 0 25px rgba(220, 38, 38, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.6),
            inset 0 -1px 0 rgba(0, 0, 0, 0.3);
    }
}

/* ğŸ”§ èª¿æ•´ç”¨æˆ¶åç¨±å€åŸŸä»¥é©æ‡‰æ›´å¤§çš„å‹³ç«  */
.user-name {
    flex: 1;
    margin: 0 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 40px; /* ğŸ”§ æ–°å¢ï¼šç¢ºä¿æœ‰è¶³å¤ é«˜åº¦å®¹ç´å¤§å‹³ç«  */
}

/* ğŸ”§ èª¿æ•´æ’è¡Œæ¦œé …ç›®é«˜åº¦ */
.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 12px; /* ğŸ”§ å¾10pxå¢åŠ åˆ°12px */
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
    border-radius: 6px;
    margin-bottom: 2px;
    min-height: 60px; /* ğŸ”§ æ–°å¢ï¼šç¢ºä¿æœ‰è¶³å¤ é«˜åº¦ */
}

.leaderboard-medal img {
    width: 12px;
    height: 12px;
    object-fit: contain;
    border-radius: 2px;
}

.user-name {
    flex: 1;
    margin: 0 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* å…¶ä»–ç¾æœ‰æ¨£å¼ä¿æŒä¸è®Š... */
.challenge-item {
padding: 16px;
border-bottom: 1px solid var(--border-color);
transition: background-color 0.3s ease;
}

.challenge-item:hover {
background: rgba(255, 255, 255, 0.02);
}

.challenge-title {
font-size: 1.1rem;
color: var(--text-primary);
margin-bottom: 8px;
font-weight: 600;
}

.challenge-info {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 12px;
}

.challenge-actions {
display: flex;
gap: 10px;
}

.champion-display {
margin-bottom: 10px;
}

.champion-card {
display: flex;
align-items: center;
justify-content: space-between;
background: linear-gradient(45deg, #FFD700, #FFA500);
color: #000;
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
font-weight: bold;
box-shadow: 0 3px 6px rgba(255, 215, 0, 0.3);
transition: var(--transition);
}

.champion-card:hover {
transform: translateY(-1px);
box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
}

.champion-empty {
display: flex;
align-items: center;
justify-content: center;
background: rgba(255, 255, 255, 0.05);
color: var(--text-secondary);
padding: 8px 14px;
border-radius: var(--border-radius);
font-size: 0.85rem;
border: 1px dashed rgba(255, 255, 255, 0.15);
}

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
backdrop-filter: blur(4px);
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.modal {
background: var(--bg-secondary);
width: 90%;
max-width: 420px;
max-height: 85vh;
border-radius: 12px;
overflow: hidden;
position: relative;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { transform: translateY(30px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.modal-header {
padding: 16px;
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: var(--text-primary);
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
}

.close-btn {
background: none;
border: none;
color: var(--text-primary);
font-size: 1.5rem;
cursor: pointer;
padding: 4px 8px;
border-radius: 4px;
transition: var(--transition);
}

.close-btn:hover {
background: rgba(255, 255, 255, 0.1);
transform: scale(1.1);
}

.modal-content {
padding: 16px;
overflow-y: auto;
max-height: calc(85vh - 68px);
min-height: 200px;
}

.leaderboard-container {
max-height: calc(60vh - 100px);
overflow-y: auto;
padding-right: 5px;
scroll-behavior: smooth;
}

.leaderboard-item {
display: flex;
align-items: center;
padding: 10px 12px;
border-bottom: 1px solid var(--border-color);
transition: var(--transition);
border-radius: 6px;
margin-bottom: 2px;
}

.leaderboard-item:hover {
background: rgba(114, 137, 218, 0.05);
transform: translateX(2px);
}

.leaderboard-item.current-user {
background: rgba(114, 137, 218, 0.1);
border-left: 3px solid var(--primary);
box-shadow: 0 2px 8px rgba(114, 137, 218, 0.2);
}

.rank {
min-width: 35px;
font-weight: bold;
color: var(--primary);
font-size: 1rem;
}

.user-name {
flex: 1;
margin: 0 12px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
display: flex;
align-items: center;
}

.score {
font-weight: bold;
color: var(--primary);
margin-left: auto;
font-size: 1rem;
}

.empty-leaderboard {
text-align: center;
padding: 30px 20px;
color: var(--text-secondary);
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 400px) {
.header-actions {
flex-direction: column;
gap: 8px;
}
.header-actions .btn {
width: 100%;
}
.user-currency {
flex-direction: column;
gap: 4px;
}
}

/* GPU åŠ é€Ÿ */
.btn, .modal, .leaderboard-item, .champion-card, .medal-icon {
transform: translateZ(0);
backface-visibility: hidden;
}

/* å…¶ä»–ç¾æœ‰æ¨£å¼... */
.exam-container { padding: 20px; }
.exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: var(--border-radius); }
.timer { font-size: 1.4rem; color: var(--primary); font-weight: bold; padding: 8px 16px; background: rgba(114, 137, 218, 0.1); border-radius: var(--border-radius); }
.question { background: rgba(255, 255, 255, 0.03); padding: 24px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color); }
.options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 20px; }
.option-btn { width: 100%; text-align: left; padding: 14px 16px; border-radius: var(--border-radius); transition: var(--transition); }
.option-btn.correct { background: linear-gradient(135deg, var(--success), #27ae60); }
.option-btn.wrong { background: linear-gradient(135deg, var(--danger), #c0392b); }
.exam-result { text-align: center; padding: 30px 20px; }
.exam-result h2 { margin-bottom: 20px; color: var(--primary); }
.exam-result p { margin-bottom: 12px; font-size: 1.05rem; }
.exam-result button { margin: 8px; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 3px; }
::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--primary), var(--primary-dark)); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, var(--primary-dark), var(--primary)); }
.loading { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
.loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(114, 137, 218, 0.3); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; will-change: transform; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media (max-width: 400px) { .options { grid-template-columns: 1fr; } }
.btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
::selection { background: rgba(114, 137, 218, 0.3); color: var(--text-primary); }


</style>
</head>
<body>
<!-- è¼‰å…¥ä¸­ç•«é¢ -->
<div id="loadingScreen" class="container">
<div class="loading">
<div class="loading-spinner"></div>
æ­£åœ¨é©—è­‰ç™»å…¥ç‹€æ…‹...
</div>
</div>

<!-- ä¸»è¦å…§å®¹ -->
<div id="mainContent" class="container" style="display: none;">
<header class="header">
<div class="header-title">
<div class="title-text">
<span>ğŸ¯</span>
<h1>T2æŒ‘æˆ°ç³»çµ±</h1>
<button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
</div>
<div class="user-info">
<div>
<span id="currentUserWelcome">æ­¡è¿å›ä¾†ï¼Œè¼‰å…¥ä¸­...</span>
<div class="user-currency">
<div class="currency-item">
  <span>ğŸ’°</span>
  <span id="userCoins">0</span>
</div>
<div class="currency-item">
  <span>ğŸ’</span>
  <span id="userGems">0</span>
</div>
</div>
<div class="user-medals" id="userMedals"></div>
</div>
<span class="connection-status" id="connectionStatus">ç”¨æˆ¶é€£ç·šä¸­</span>
</div>
</div>
<div class="header-actions">
<button class="btn btn-primary" onclick="backToT2()">ğŸ  è¿”å›T2æ—¥</button>
<button class="btn btn-secondary" onclick="showTotalLeaderboard()">ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ</button>
<button class="btn btn-shop" onclick="showShop()">ğŸª å•†åº—</button>
<button class="btn btn-primary" onclick="showInventory()">ğŸ’ èƒŒåŒ…</button>
</div>
</header>

<!-- æŒ‘æˆ°é …ç›®åˆ—è¡¨ - å°‡å‹•æ…‹ç”Ÿæˆ -->
<div id="challengesList">
<!-- æŒ‘æˆ°é …ç›®å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>

<!-- ğŸª å•†åº—æ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="shopModal">
<div class="modal">
<div class="modal-header">
<h2>ğŸª å‹³ç« å•†åº—</h2>
<button class="close-btn" onclick="hideShop()">Ã—</button>
</div>
<div class="modal-content">
<div class="shop-container">
<div class="shop-categories">
<button class="category-btn active" onclick="filterShop('all')">å…¨éƒ¨</button>
<button class="category-btn" onclick="filterShop('common')">æ™®é€š</button>
<button class="category-btn" onclick="filterShop('rare')">ç¨€æœ‰</button>
<button class="category-btn" onclick="filterShop('epic')">å²è©©</button>
<button class="category-btn" onclick="filterShop('legendary')">å‚³èªª</button>
<button class="category-btn" onclick="filterShop('mythic')">ç¥è©±</button>
</div>
<div class="shop-items" id="shopItems">
<!-- å•†åº—ç‰©å“å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>
</div>
</div>
</div>

<!-- ğŸ’ èƒŒåŒ…æ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="inventoryModal">
<div class="modal">
<div class="modal-header">
<h2>ğŸ’ å‹³ç« èƒŒåŒ…</h2>
<button class="close-btn" onclick="hideInventory()">Ã—</button>
</div>
<div class="modal-content">
<div class="inventory-container">
<p style="margin-bottom: 16px; color: var(--text-secondary);">é»æ“Šå‹³ç« è£å‚™/å¸ä¸‹ (æœ€å¤šè£å‚™5å€‹)</p>
<div class="inventory-grid" id="inventoryGrid">
<!-- èƒŒåŒ…ç‰©å“å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>
</div>
</div>
</div>

<!-- æ’è¡Œæ¦œæ¨¡æ…‹è¦–çª— -->
<div class="modal-overlay" id="leaderboardModal">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">æ’è¡Œæ¦œ</h2>
<button class="close-btn" onclick="hideLeaderboard()">Ã—</button>
</div>
<div class="modal-content" id="leaderboardContent">
</div>
</div>
</div>

<script>
// Firebase é…ç½®
const firebaseConfig = {
apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
authDomain: "openexammodal.firebaseapp.com",
databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
projectId: "openexammodal",
storageBucket: "openexammodal.firebasestorage.app",
messagingSenderId: "336901617556",
appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
};

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šFirebase åˆå§‹åŒ–
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œåº«å¿«å–
let examQuestions = {};
let questionsCache = new Map();

// ğŸ… å‹³ç« ç³»çµ±è®Šæ•¸
let medalsData = {};
let userMedals = { owned: [], equipped: [] };
let userCurrency = { coins: 0, gems: 0 };

// ğŸ“ è€ƒè©¦é…ç½®è®Šæ•¸ (å¾JSONè¼‰å…¥)
let examConfigs = {};

// ğŸ… è¼‰å…¥å‹³ç« è³‡æ–™
async function loadMedalsData() {
try {
const cacheKey = 'medals_data_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
medalsData = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥å‹³ç« è³‡æ–™');
return;
}

const resp = await fetch('medals.json');
if (!resp.ok) throw new Error(`è¼‰å…¥å‹³ç« è³‡æ–™å¤±æ•—ï¼š${resp.status}`);
medalsData = await resp.json();

localStorage.setItem(cacheKey, JSON.stringify(medalsData));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… å‹³ç« è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–', medalsData);
} catch (err) {
console.error('è¼‰å…¥å‹³ç« è³‡æ–™å¤±æ•—:', err);
// æä¾›é è¨­å‹³ç« è³‡æ–™
medalsData = {
medals: {},
rarityColors: {
common: "#84cc16",
rare: "#3b82f6", 
epic: "#8b5cf6",
legendary: "#f59e0b",
mythic: "#dc2626"
},
maxEquippedMedals: 5
};
}
}

// ğŸ“ è¼‰å…¥è€ƒè©¦é…ç½®
async function loadExamConfigs() {
    try {
        const cacheKey = 'exam_configs_v1';
        const cached = localStorage.getItem(cacheKey);
        const cacheTime = localStorage.getItem(cacheKey + '_time');

        if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
            examConfigs = JSON.parse(cached);
            console.log('âœ… å¾å¿«å–è¼‰å…¥è€ƒè©¦é…ç½®');
            return;
        }

        const resp = await fetch('exam-configs.json');
        if (!resp.ok) throw new Error(`è¼‰å…¥è€ƒè©¦é…ç½®å¤±æ•—ï¼š${resp.status}`);
        examConfigs = await resp.json();

        localStorage.setItem(cacheKey, JSON.stringify(examConfigs));
        localStorage.setItem(cacheKey + '_time', Date.now().toString());

        console.log('âœ… è€ƒè©¦é…ç½®å·²è¼‰å…¥ä¸¦å¿«å–', examConfigs);
    } catch (err) {
        console.error('è¼‰å…¥è€ƒè©¦é…ç½®å¤±æ•—:', err);
        alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥è€ƒè©¦é…ç½®æª”æ¡ˆ');
    }
}

// ğŸ“ è¼‰å…¥ç”¨æˆ¶å¯†ç¢¼æ•¸æ“š
async function loadPasswordData() {
    try {
        const cacheKey = 'password_data_v1';
        const cached = localStorage.getItem(cacheKey);
        const cacheTime = localStorage.getItem(cacheKey + '_time');

        if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
            window.passwordData = JSON.parse(cached);
            console.log('âœ… å¾å¿«å–è¼‰å…¥ç”¨æˆ¶å¯†ç¢¼æ•¸æ“š');
            return;
        }

        const resp = await fetch('password.json');
        if (!resp.ok) throw new Error(`è¼‰å…¥ç”¨æˆ¶å¯†ç¢¼æ•¸æ“šå¤±æ•—ï¼š${resp.status}`);
        window.passwordData = await resp.json();

        localStorage.setItem(cacheKey, JSON.stringify(window.passwordData));
        localStorage.setItem(cacheKey + '_time', Date.now().toString());

        console.log('âœ… ç”¨æˆ¶å¯†ç¢¼æ•¸æ“šå·²è¼‰å…¥ä¸¦å¿«å–', window.passwordData.length, 'ä½ç”¨æˆ¶');
    } catch (err) {
        console.error('è¼‰å…¥ç”¨æˆ¶å¯†ç¢¼æ•¸æ“šå¤±æ•—:', err);
        window.passwordData = [];
    }
}

// ğŸ“ å‹•æ…‹ç”ŸæˆæŒ‘æˆ°é …ç›®åˆ—è¡¨
function renderChallengesList() {
    const challengesContainer = document.getElementById('challengesList');
    const fragment = document.createDocumentFragment();

    Object.entries(examConfigs).forEach(([examType, config]) => {
        const challengeItem = document.createElement('div');
        challengeItem.className = 'challenge-item';

        challengeItem.innerHTML = `
        <h3 class="challenge-title">${config.name}</h3>
        <p class="challenge-info" style="color:#ef4444;">${config.description}</p>
        <div class="champion-display" data-exam-type="${examType}">
        <!-- æ¦œé¦–è³‡æ–™å°‡åœ¨æ­¤å‹•æ…‹è¼‰å…¥ -->
        </div>
        <div class="challenge-actions">
        <button class="btn btn-primary" onclick="startExam('${examType}')">é–‹å§‹è€ƒè©¦</button>
        <button class="btn btn-secondary" onclick="showLeaderboard('${examType}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </div>
        `;

        fragment.appendChild(challengeItem);
    });

    challengesContainer.appendChild(fragment);
}

// ğŸ… è¼‰å…¥ç”¨æˆ¶å‹³ç« å’Œè²¨å¹£è³‡æ–™
async function loadUserMedalsAndCurrency() {
    try {
        const snapshot = await database.ref(`users/${currentUser}/medals`).once('value');
        const medalSnapshot = snapshot.val() || {};
        userMedals = {
            owned: medalSnapshot.owned || [],
            equipped: medalSnapshot.equipped || []
        };

        const currencySnapshot = await database.ref(`users/${currentUser}/currency`).once('value');
        userCurrency = currencySnapshot.val() || { coins: 0, gems: 0 };

        updateCurrencyDisplay();
        updateMedalDisplay();
    } catch (err) {
        console.error('è¼‰å…¥ç”¨æˆ¶å‹³ç« è³‡æ–™å¤±æ•—:', err);
    }
}

// ğŸ… æ›´æ–°è²¨å¹£é¡¯ç¤º
function updateCurrencyDisplay() {
document.getElementById('userCoins').textContent = userCurrency.coins;
document.getElementById('userGems').textContent = userCurrency.gems;
}

// ğŸ… æ›´æ–°å‹³ç« é¡¯ç¤º
function updateMedalDisplay() {
    const medalContainer = document.getElementById('userMedals');
    medalContainer.innerHTML = '';

    userMedals.equipped.forEach(medalId => {
        const medal = medalsData.medals[medalId];
        if (medal) {
            const medalIcon = document.createElement('div');
            medalIcon.className = `medal-icon ${medal.rarity}`;
            medalIcon.style.borderColor = medal.color;
            
            // ğŸ”§ ä¿®æ”¹é€™è£¡ï¼šåˆ¤æ–·æ˜¯ emoji é‚„æ˜¯ç¶²å€
            if (medal.icon.startsWith('http')) {
                medalIcon.innerHTML = `<img src="${medal.icon}" alt="${medal.name}" style="width: 100%; height: 100%; object-fit: contain;">`;
            } else {
                medalIcon.innerHTML = medal.icon;
            }
            
            medalIcon.title = `${medal.name}: ${medal.description}`;
            medalContainer.appendChild(medalIcon);
        }
    });
}


// ğŸ… ä¿å­˜å‹³ç« è³‡æ–™
async function saveMedalData() {
try {
await database.ref(`users/${currentUser}/medals`).set(userMedals);
updateMedalDisplay();
} catch (err) {
console.error('ä¿å­˜å‹³ç« è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸ… ä¿å­˜è²¨å¹£è³‡æ–™
async function saveCurrencyData() {
try {
await database.ref(`users/${currentUser}/currency`).set(userCurrency);
updateCurrencyDisplay();
} catch (err) {
console.error('ä¿å­˜è²¨å¹£è³‡æ–™å¤±æ•—:', err);
}
}

// ğŸª é¡¯ç¤ºå•†åº—
async function showShop() {
document.getElementById('shopModal').style.display = 'flex';
await renderShopItems();
}

// ğŸª éš±è—å•†åº—
function hideShop() {
document.getElementById('shopModal').style.display = 'none';
}

// ğŸª ç¯©é¸å•†åº—ç‰©å“
function filterShop(category) {
document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
event.target.classList.add('active');
renderShopItems(category);
}

// ğŸª æ¸²æŸ“å•†åº—ç‰©å“ - ä¿®æ”¹ç‰ˆæœ¬
async function renderShopItems(filter = 'all') {
    const shopContainer = document.getElementById('shopItems');
    shopContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥å•†åº—ä¸­...</div>';

    const medals = Object.values(medalsData.medals);
    const filteredMedals = filter === 'all' ? medals : medals.filter(medal => medal.rarity === filter);

    const fragment = document.createDocumentFragment();

    filteredMedals.forEach(medal => {
        const isOwned = userMedals.owned.includes(medal.id);
        const isEquipped = userMedals.equipped.includes(medal.id);
        
        // ç²å–åƒ¹æ ¼
        let coinPrice = 0;
        let gemPrice = 0;
        
        if (typeof medal.price === 'object') {
            coinPrice = medal.price.coins || 0;
            gemPrice = medal.price.gems || 0;
        } else {
            coinPrice = medal.price;
        }
        
        // æª¢æŸ¥æ˜¯å¦èƒ½è² æ“”
        const canAffordCoins = userCurrency.coins >= coinPrice;
        const canAffordGems = userCurrency.gems >= gemPrice;
        const canAfford = canAffordCoins && canAffordGems;

        const item = document.createElement('div');
        item.className = `shop-item ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;

        // åˆ¤æ–·æ˜¯ emoji é‚„æ˜¯ç¶²å€
        const medalIconContent = medal.icon.startsWith('http') ? 
            `<img src="${medal.icon}" alt="${medal.name}" style="width: 100%; height: 100%; object-fit: contain;">` : 
            medal.icon;

        // æ§‹å»ºåƒ¹æ ¼é¡¯ç¤º
        let priceDisplay = '';
        if (coinPrice > 0) priceDisplay += `ğŸ’° ${coinPrice} `;
        if (gemPrice > 0) priceDisplay += `ğŸ’ ${gemPrice}`;

        item.innerHTML = `
        <div class="medal-preview" style="border-color: ${medal.color};">
        ${medalIconContent}
        </div>
        <div class="item-info">
        <div class="item-name" style="color: ${medal.color};">${medal.name}</div>
        <div class="item-description">${medal.description}</div>
        <div class="item-price">${priceDisplay}</div>
        </div>
        <div class="item-actions">
        ${isOwned ? 
        '<span class="btn btn-small btn-secondary">å·²æ“æœ‰</span>' :
        `<button class="btn btn-small btn-primary ${!canAfford ? 'disabled' : ''}" 
        onclick="buyMedal('${medal.id}')" ${!canAfford ? 'disabled' : ''}>
        è³¼è²·
        </button>`
        }
        </div>
        `;

        fragment.appendChild(item);
    });

    shopContainer.innerHTML = '';
    shopContainer.appendChild(fragment);
}

// ğŸª è³¼è²·å‹³ç«  - ä¿®æ”¹ç‰ˆæœ¬
async function buyMedal(medalId) {
    const medal = medalsData.medals[medalId];
    if (!medal || userMedals.owned.includes(medalId)) return;
    
    // æª¢æŸ¥åƒ¹æ ¼çµæ§‹
    let coinPrice = 0;
    let gemPrice = 0;
    
    if (typeof medal.price === 'object') {
        // æ–°çµæ§‹ï¼šåŒ…å«é‡‘å¹£å’Œå¯¶çŸ³
        coinPrice = medal.price.coins || 0;
        gemPrice = medal.price.gems || 0;
    } else {
        // èˆŠçµæ§‹ï¼šåªæœ‰é‡‘å¹£
        coinPrice = medal.price;
    }
    
    // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰è¶³å¤ çš„è²¨å¹£
    if (userCurrency.coins < coinPrice) {
        alert('ğŸ’° é‡‘å¹£ä¸è¶³ï¼');
        return;
    }
    
    if (userCurrency.gems < gemPrice) {
        alert('ğŸ’ å¯¶çŸ³ä¸è¶³ï¼');
        return;
    }
    
    // é¡¯ç¤ºç¢ºèªå°è©±æ¡†ï¼ŒåŒ…å«æ‰€æœ‰è²¨å¹£æˆæœ¬
    // å¦‚æœiconæ˜¯ç¶²å€ï¼Œå‰‡ä½¿ç”¨ğŸ–¼ï¸åœ–ç¤ºä»£æ›¿
    const iconDisplay = medal.icon.startsWith('http') ? 'ğŸ–¼ï¸' : medal.icon;
    let confirmMessage = `ç¢ºå®šè¦è³¼è²· ${iconDisplay} ${medal.name} å—ï¼Ÿ\n`;
    if (coinPrice > 0) confirmMessage += `é‡‘å¹£ï¼šğŸ’° ${coinPrice}\n`;
    if (gemPrice > 0) confirmMessage += `å¯¶çŸ³ï¼šğŸ’ ${gemPrice}`;
    
    if (confirm(confirmMessage)) {
        // æ‰£é™¤è²¨å¹£
        userCurrency.coins -= coinPrice;
        userCurrency.gems -= gemPrice;
        
        // æ·»åŠ å‹³ç« åˆ°æ“æœ‰åˆ—è¡¨
        userMedals.owned.push(medalId);
        
        // ä¿å­˜æ•¸æ“š
        await Promise.all([saveMedalData(), saveCurrencyData()]);
        await renderShopItems();
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ - åŒæ¨£è™•ç†åœ–ç¤ºé¡¯ç¤ºå•é¡Œ
        alert(`ğŸ‰ æˆåŠŸè³¼è²· ${iconDisplay} ${medal.name}ï¼`);
    }
}

// ğŸ’ é¡¯ç¤ºèƒŒåŒ…
async function showInventory() {
document.getElementById('inventoryModal').style.display = 'flex';
await renderInventory();
}

// ğŸ’ éš±è—èƒŒåŒ…
function hideInventory() {
document.getElementById('inventoryModal').style.display = 'none';
}

// ğŸ’ æ¸²æŸ“èƒŒåŒ… - ä¿®æ­£ç‰ˆæœ¬
async function renderInventory() {
const inventoryGrid = document.getElementById('inventoryGrid');
inventoryGrid.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥èƒŒåŒ…ä¸­...</div>';

const fragment = document.createDocumentFragment();

userMedals.owned.forEach(medalId => {
const medal = medalsData.medals[medalId];
if (!medal) return;

const isEquipped = userMedals.equipped.includes(medalId);
const item = document.createElement('div');
item.className = `inventory-item ${isEquipped ? 'equipped' : ''}`;
item.onclick = () => toggleMedalEquip(medalId);

// ğŸ”§ ä¿®æ”¹é€™è£¡ï¼šæ–°å¢åˆ¤æ–·é‚è¼¯
const iconHtml = medal.icon.startsWith('http') ? 
    `<img src="${medal.icon}" alt="${medal.name}" style="width: 24px; height: 24px; object-fit: contain;">` : 
    medal.icon;

item.innerHTML = `
<div class="inventory-medal-icon" style="color: ${medal.color};">
${iconHtml}
</div>
<div class="inventory-medal-name">${medal.name}</div>
${isEquipped ? '<div style="font-size: 0.6rem; color: var(--gold);">å·²è£å‚™</div>' : ''}
`;

fragment.appendChild(item);
});

if (userMedals.owned.length === 0) {
const emptyMsg = document.createElement('div');
emptyMsg.className = 'empty-leaderboard';
emptyMsg.innerHTML = '<p>ğŸ’ èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p><p>å»å•†åº—è³¼è²·ä¸€äº›å‹³ç« å§ï¼</p>';
fragment.appendChild(emptyMsg);
}

inventoryGrid.innerHTML = '';
inventoryGrid.appendChild(fragment);
}


// ğŸ’ åˆ‡æ›å‹³ç« è£å‚™ç‹€æ…‹
async function toggleMedalEquip(medalId) {
const isEquipped = userMedals.equipped.includes(medalId);

if (isEquipped) {
// å¸ä¸‹å‹³ç« 
userMedals.equipped = userMedals.equipped.filter(id => id !== medalId);
} else {
// è£å‚™å‹³ç« 
if (userMedals.equipped.length >= medalsData.maxEquippedMedals) {
alert(`æœ€å¤šåªèƒ½è£å‚™ ${medalsData.maxEquippedMedals} å€‹å‹³ç« ï¼`);
return;
}
userMedals.equipped.push(medalId);
}

await saveMedalData();
await renderInventory();
}

async function loadExamQuestions() {
try {
// æª¢æŸ¥å¿«å–
const cacheKey = 'exam_questions_v1';
const cached = localStorage.getItem(cacheKey);
const cacheTime = localStorage.getItem(cacheKey + '_time');

// å¿«å–æœ‰æ•ˆæœŸ 1 å°æ™‚
if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
examQuestions = JSON.parse(cached);
console.log('âœ… å¾å¿«å–è¼‰å…¥é¡Œåº«');
return;
}

const resp = await fetch('questions.json');
if (!resp.ok) throw new Error(`è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š${resp.status}`);
examQuestions = await resp.json();

// å„²å­˜åˆ°å¿«å–
localStorage.setItem(cacheKey, JSON.stringify(examQuestions));
localStorage.setItem(cacheKey + '_time', Date.now().toString());

console.log('âœ… é¡Œåº«å·²è¼‰å…¥ä¸¦å¿«å–', examQuestions);
} catch (err) {
console.error(err);
alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥é¡Œåº«æª”æ¡ˆ');
}
}

// å…¨åŸŸè®Šæ•¸
let currentUser = null;
let usersData = [];
let currentExam = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let examTimer = null;
let questionStartTime = null;
let examStartTime = null;
let userScores = { fastAnswers:0, correctAnswers:0 };

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé˜²æŠ–å‡½æ•¸
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
const later = () => {
clearTimeout(timeout);
func(...args);
};
clearTimeout(timeout);
timeout = setTimeout(later, wait);
};
}

// å·¥å…·å‡½æ•¸ï¼šå¾æ•¸çµ„ä¸­ç§»é™¤ç‰¹å®šå…ƒç´ 
Array.prototype.remove = function(element) {
const index = this.indexOf(element);
if (index > -1) this.splice(index, 1);
};

// å¼·åˆ¶ç™»å‡ºå‡½æ•¸
function forceLogout(message = 'ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥') {
localStorage.removeItem('t2_login');
localStorage.removeItem('t2_login_time');
localStorage.removeItem('t2_login_user');
localStorage.removeItem('t2_login_password');
alert(message);
window.location.href = 'index3.html';
}

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ™‚æ•ˆ - ä¿®æ­£ç‰ˆæœ¬
function checkLoginStatus() {
    const flag = localStorage.getItem('t2_login');
    const time = localStorage.getItem('t2_login_time');
    const uniqueId = localStorage.getItem('t2_login_user'); // ğŸ”§ é€™æ‡‰è©²æ˜¯å”¯ä¸€ID (00175126)
    const displayName = localStorage.getItem('t2_login_display_name'); // ğŸ†• é¡¯ç¤ºåç¨± (å¿µå¿µ)
    
    if (flag !== 'yes' || !time || !uniqueId) {
        forceLogout('æœªæª¢æ¸¬åˆ°æœ‰æ•ˆç™»å…¥ç‹€æ…‹');
        return false;
    }
    
    if (Date.now() - parseInt(time) > 3600000) {
        forceLogout('ç™»å…¥æ™‚é–“å·²è¶…é1å°æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
        return false;
    }
    
    // ğŸ”§ è¿”å›æ­£ç¢ºçš„å°è±¡çµæ§‹
    return {
        uniqueId: uniqueId,        // 00175126 (ç”¨æ–¼Firebase)
        displayName: displayName || uniqueId // å¿µå¿µ (ç”¨æ–¼é¡¯ç¤º)
    };
}


// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç”¨æˆ¶è³‡æ–™å¿«å– - ä¿®æ­£ç‰ˆæœ¬
async function loadUsersData() {
    try {
        // æª¢æŸ¥å¿«å–
        const cacheKey = 'users_data_v1';
        const cached = localStorage.getItem(cacheKey);
        const cacheTime = localStorage.getItem(cacheKey + '_time');

        // ğŸ”§ ä¿®æ­£ï¼šç¸®çŸ­å¿«å–æ™‚é–“ä»¥ç¢ºä¿å‹³ç« è³‡æ–™å³æ™‚æ›´æ–°
        if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 60000) { // æ”¹ç‚º1åˆ†é˜
            usersData = JSON.parse(cached);
            console.log('âœ… å¾å¿«å–è¼‰å…¥ç”¨æˆ¶è³‡æ–™');
            return;
        }

        const snapshot = await database.ref('users').once('value');
        usersData = snapshot.val() || {};

        // å„²å­˜åˆ°å¿«å–
        localStorage.setItem(cacheKey, JSON.stringify(usersData));
        localStorage.setItem(cacheKey + '_time', Date.now().toString());

        console.log('âœ… ç”¨æˆ¶è³‡æ–™å·²è¼‰å…¥ä¸¦å¿«å–', Object.keys(usersData).length, 'ä½ç”¨æˆ¶');
        
        // ğŸ”§ èª¿è©¦ï¼šæª¢æŸ¥æ˜¯å¦æœ‰å‹³ç« è³‡æ–™
        Object.entries(usersData).forEach(([username, userData]) => {
            if (userData.medals && userData.medals.equipped && userData.medals.equipped.length > 0) {
                console.log(`ğŸ‘¤ ${username} è£å‚™å‹³ç« :`, userData.medals.equipped);
            }
        });
        
    } catch (err) {
        console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', err);
    }
}


// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ¦œé¦–è³‡æ–™å¿«å–
const championCache = new Map();

// ğŸ”§ ä¿®æ­£ï¼šç²å–æ¦œé¦–æ™‚ä¸ä½¿ç”¨ orderByChild ä»¥é¿å…ç´¢å¼•è­¦å‘Š
async function getChampion(examType) {
    // æª¢æŸ¥å¿«å–
    const cacheKey = `champion_${examType}`;
    const cached = championCache.get(cacheKey);
    if (cached && (Date.now() - cached.timestamp) < 60000) { // 1åˆ†é˜å¿«å–
        return cached.data;
    }

    try {
        // ğŸ”§ ä¿®æ­£ï¼šç›´æ¥ç²å–æ‰€æœ‰è³‡æ–™ï¼Œç„¶å¾Œåœ¨å®¢æˆ¶ç«¯æ’åº
        const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
        const data = snapshot.val();
        if (data) {
            // è½‰æ›ä¸¦æ’åºè³‡æ–™æ‰¾å‡ºæ¦œé¦–
            const leaderboardData = Object.entries(data).map(([user, userData]) => ({
                user,
                ...userData
            })).sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return a.totalTime - b.totalTime;
            });

            const result = leaderboardData[0]; // æ¦œé¦–

            // å¿«å–çµæœ
            championCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });
            return result;
        }
        return null;
    } catch (err) {
        console.error('ç²å–æ¦œé¦–å¤±æ•—:', err);
        return null;
    }
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šæ‰¹é‡æ›´æ–°æ¦œé¦–é¡¯ç¤º
const debouncedUpdateChampions = debounce(updateAllChampions, 300);

async function updateAllChampions() {
    const examTypes = Object.keys(examConfigs);
    const promises = examTypes.map(async (examType) => {
        const champion = await getChampion(examType);
        const championDisplay = document.querySelector(`[data-exam-type="${examType}"]`);
        if (!championDisplay) return;

        if (champion) {
            // ğŸ”§ ä¿®æ­£ï¼šé¡¯ç¤ºæ¦œé¦–çš„é¡¯ç¤ºåç¨±
            const displayName = getUserDisplayName(champion.user);
            championDisplay.innerHTML = `
            <div class="champion-card">
            <span>ğŸ† æ¦œé¦–ï¼š${displayName}</span>
            <span>${champion.score}åˆ†</span>
            </div>
            `;
        } else {
            championDisplay.innerHTML = `
            <div class="champion-empty">
            <span>ğŸ† å°šç„¡æ¦œé¦–</span>
            </div>
            `;
        }
    });

    await Promise.all(promises);
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šç™»å…¥é©—è­‰å’Œåˆå§‹åŒ– - ä¿®æ­£ç‰ˆæœ¬
// ğŸ”§ ä¿®æ­£ï¼šinitializeApp å‡½æ•¸
async function initializeApp() {
    try {
        const userInfo = checkLoginStatus();
        if (!userInfo) return;

        currentUser = userInfo.uniqueId;
        const displayName = userInfo.displayName;
        
        document.getElementById('currentUserWelcome').textContent = `æ­¡è¿å›ä¾†ï¼Œ${displayName}`;

        // ä¸¦è¡Œè¼‰å…¥è³‡æ–™
        await Promise.all([
            loadExamQuestions(),
            loadUsersData(),
            loadMedalsData(),
            loadExamConfigs(),
            loadPasswordData() // æ–°å¢ï¼šè¼‰å…¥ç”¨æˆ¶å¯†ç¢¼æ•¸æ“š
        ]);

        // è¼‰å…¥ç”¨æˆ¶å‹³ç« å’Œè²¨å¹£
        await loadUserMedalsAndCurrency();

        // ç”ŸæˆæŒ‘æˆ°é …ç›®åˆ—è¡¨
        renderChallengesList();

        // æ›´æ–°æ¦œé¦–é¡¯ç¤º
        await updateAllChampions();

        // éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

    } catch (err) {
        console.error('åˆå§‹åŒ–å¤±æ•—:', err);
        alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    }
}


// ç™»å‡ºåŠŸèƒ½
function logout() {
    localStorage.removeItem('t2_login');
    localStorage.removeItem('t2_login_time');
    localStorage.removeItem('t2_login_user');
    localStorage.removeItem('t2_login_password');
    localStorage.removeItem('t2_login_display_name'); // ğŸ†• æ¸…é™¤é¡¯ç¤ºåç¨±
    // æ¸…é™¤å¿«å–
    localStorage.removeItem('exam_questions_v1');
    localStorage.removeItem('exam_questions_v1_time');
    localStorage.removeItem('users_data_v1');
    localStorage.removeItem('users_data_v1_time');
    localStorage.removeItem('medals_data_v1');
    localStorage.removeItem('medals_data_v1_time');
    localStorage.removeItem('exam_configs_v1');
    localStorage.removeItem('exam_configs_v1_time');
    championCache.clear();
    window.location.href = 'index3.html';
}

// è¿”å›T2æ—¥
function backToT2() {
    window.location.href = 'page33.html'; 
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šé¡Œç›®éš¨æ©ŸåŒ–
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

// ğŸš€ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒè©¦é–‹å§‹å„ªåŒ– - ä¿®æ­£ç‰ˆæœ¬
function startExam(examType) {
    if (!examQuestions[examType]) {
        alert('é¡Œåº«è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
    }

    const config = examConfigs[examType];
    const questions = shuffleArray(examQuestions[examType]).slice(0, config.questionCount);

    if (questions.length < config.questionCount) {
        alert(`é¡Œåº«é¡Œç›®ä¸è¶³ï¼éœ€è¦ ${config.questionCount} é¡Œï¼Œä½†åªæœ‰ ${questions.length} é¡Œ`);
        return;
    }

    currentExam = examType;
    currentQuestions = questions;
    currentQuestionIndex = 0;
    examStartTime = Date.now();
    
    // ğŸ”§ ä¿®æ­£ï¼šå®Œæ•´çš„ userScores åˆå§‹åŒ–
    userScores = { 
        fastAnswers: 0, 
        correctAnswers: 0,
        totalAnswers: 0,
        fastCorrectAnswers: 0  // ğŸ†• æ–°å¢ï¼šå¿«é€Ÿä¸”ç­”å°çš„é¡Œç›®æ•¸
    };

    showExamInterface();
    displayQuestion();
    startQuestionTimer();
}

// é¡¯ç¤ºè€ƒè©¦ä»‹é¢ - æ£„æ¬ŠæŒ‰éˆ•ç§»è‡³åº•éƒ¨
function showExamInterface() {
    const container = document.getElementById('mainContent');
    const config = examConfigs[currentExam];

    container.innerHTML = `
    <div class="exam-container">
    <div class="exam-header" style="text-align: center; justify-content: center;">
    <h2>${config.name}</h2>
    </div>
    <div class="question" id="questionContainer">
    <!-- é¡Œç›®å°‡åœ¨æ­¤é¡¯ç¤º -->
    </div>
    <div class="exam-progress" style="margin-bottom: 15px;">
    <p>é¡Œç›® <span id="currentQuestionNum">1</span> / ${config.questionCount}</p>
    <p>å¾—åˆ†ï¼š<span id="currentScore">0</span> åˆ†</p>
    <div class="timer" id="timer" style="margin: 10px auto; display: inline-block;">${config.timePerQuestion}ç§’</div>
    </div>
    <button class="btn btn-danger" onclick="quitExam()" style="width: 100%; margin-top: 10px;">æ£„ æ¬Š</button>
    </div>
    `;
}

// ä¿®æ­£çš„æ£„æ¬ŠåŠŸèƒ½ - ä¿®å¾©ç„¡åæ‡‰å•é¡Œ
function quitExam() {
    try {
        // åœæ­¢è¨ˆæ™‚å™¨
        clearInterval(examTimer);
        
        // ç›´æ¥é¡¯ç¤ºç¢ºèªå°è©±æ¡†ï¼Œç°¡åŒ–é‚è¼¯
        const confirmMessage = `âš ï¸ ç¢ºå®šè¦æ£„æ¬Šå—ï¼Ÿ\n\nâ€¢ æ£„æ¬Šå°‡ä¸æœƒç²å¾—ä»»ä½•åˆ†æ•¸å’Œçå‹µ\nâ€¢ æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·`;
        
        if (confirm(confirmMessage)) {
            // é¡¯ç¤ºçŸ­æš«çš„é€€å‡ºæç¤º
            const questionContainer = document.getElementById('questionContainer');
            if (questionContainer) {
                questionContainer.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <h3 style="color: var(--danger);">æ­£åœ¨é€€å‡ºè€ƒè©¦...</h3>
                    <p style="margin-top: 10px; color: var(--text-secondary);">æ­£åœ¨è¿”å›ä¸»é </p>
                </div>
                `;
            }
            
            // å»¶é²ä¸€ç§’å¾Œè¿”å›ä¸»é 
            setTimeout(() => {
                window.location.href = window.location.href; // å¼·åˆ¶é‡æ–°è¼‰å…¥ç•¶å‰é é¢
            }, 1500);
        } else {
            // å¦‚æœç”¨æˆ¶å–æ¶ˆï¼Œé‡æ–°å•Ÿå‹•è¨ˆæ™‚å™¨
            startQuestionTimer();
        }
    } catch (error) {
        console.error("æ£„æ¬ŠåŠŸèƒ½å‡ºéŒ¯:", error);
        alert("æ£„æ¬ŠåŠŸèƒ½å‡ºéŒ¯ï¼Œå°‡é‡æ–°è¼‰å…¥é é¢");
        window.location.reload();
    }
}


// é¡¯ç¤ºé¡Œç›® - ä¿®æ­£ç‰ˆæœ¬
function displayQuestion() {
    const question = currentQuestions[currentQuestionIndex];
    const questionContainer = document.getElementById('questionContainer');
    const config = examConfigs[currentExam];

    document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;

    // å‰µå»ºé¸é …é™£åˆ—çš„å‰¯æœ¬ï¼ŒåŒ…å«é¸é …æ–‡å­—å’ŒåŸå§‹ç´¢å¼•
    const options = question.options.map((text, index) => ({
        text,
        originalIndex: index
    }));
    
    // æ‰“äº‚é¸é …é †åº
    for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
    }
    
    // å„²å­˜æ‰“äº‚å¾Œçš„é¸é …æ˜ å°„é—œä¿‚åˆ°å…¨å±€è®Šé‡ï¼Œä»¥ä¾¿åœ¨é¸æ“‡ç­”æ¡ˆæ™‚ä½¿ç”¨
    window.currentOptionsMap = options.map(option => option.originalIndex);
    
    // ç”Ÿæˆé¸é …HTMLï¼Œä½¿ç”¨æ–°çš„ç´¢å¼•ä½ç½®
    const optionsHtml = options.map((option, newIndex) => 
        `<button class="btn option-btn" onclick="selectAnswer(${newIndex})">${option.text}</button>`
    ).join('');

    questionContainer.innerHTML = `
    <h3>${question.question}</h3>
    <div class="options">
    ${optionsHtml}
    </div>
    `;

    questionStartTime = Date.now();
}

// é–‹å§‹é¡Œç›®è¨ˆæ™‚å™¨ - ä¿®æ­£é¡¯ç¤ºæ ¼å¼
function startQuestionTimer() {
    const config = examConfigs[currentExam];
    let timeLeft = config.timePerQuestion;
    const timerElement = document.getElementById('timer');
    
    // åˆå§‹é¡¯ç¤ºæ ¼å¼
    timerElement.textContent = `${timeLeft}ç§’`;

    examTimer = setInterval(() => {
        timeLeft--;
        // æ›´æ–°é¡¯ç¤ºæ ¼å¼
        timerElement.textContent = `${timeLeft}ç§’`;

        if (timeLeft <= 0) {
            clearInterval(examTimer);
            // æ™‚é–“åˆ°ï¼Œè‡ªå‹•è·³åˆ°ä¸‹ä¸€é¡Œ
            selectAnswer(-1); // -1 è¡¨ç¤ºæœªä½œç­”
        }
    }, 1000);
}



// é¸æ“‡ç­”æ¡ˆ - ä¿®æ­£ç‰ˆæœ¬
function selectAnswer(selectedIndex) {
    clearInterval(examTimer);
    const question = currentQuestions[currentQuestionIndex];
    
    // ä½¿ç”¨æ˜ å°„é—œä¿‚ç²å–åŸå§‹ç´¢å¼•
    const originalSelectedIndex = window.currentOptionsMap ? window.currentOptionsMap[selectedIndex] : selectedIndex;
    const isCorrect = originalSelectedIndex === question.correct;
    
    const responseTime = (Date.now() - questionStartTime) / 1000;
    const config = examConfigs[currentExam];

    userScores.totalAnswers++;

    // æª¢æŸ¥å¿«é€Ÿç­”é¡Œ
    const isFast = responseTime <= config.fastAnswerThreshold;
    if (isFast) {
        userScores.fastAnswers++;
    }

    // åªæœ‰ç­”å°æ‰åŠ åˆ†
    if (isCorrect) {
        userScores.correctAnswers++;
        
        // åªæœ‰ç­”å°ä¸”å¿«é€Ÿæ‰è¨ˆå…¥å¿«é€Ÿæ­£ç¢ºç­”æ¡ˆ
        if (isFast) {
            userScores.fastCorrectAnswers++;
        }
    }

    // é¡¯ç¤ºç­”æ¡ˆåé¥‹ - éœ€è¦å‚³éæ˜ å°„å¾Œçš„æ­£ç¢ºç­”æ¡ˆç´¢å¼•
    const correctDisplayIndex = window.currentOptionsMap.findIndex(index => index === question.correct);
    showAnswerFeedback(selectedIndex, correctDisplayIndex, responseTime);

    // å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
    setTimeout(() => {
        nextQuestion(isCorrect);
    }, 1500);
}



// é¡¯ç¤ºç­”æ¡ˆåé¥‹ - ä¿®æ­£ç‰ˆæœ¬ï¼Œä½¿ç”¨é¡¯ç¤ºç´¢å¼•
function showAnswerFeedback(selectedIndex, correctDisplayIndex, responseTime) {
    const options = document.querySelectorAll('.option-btn');
    const config = examConfigs[currentExam];

    options.forEach((btn, index) => {
        btn.disabled = true;
        if (index === correctDisplayIndex) {
            btn.classList.add('correct');
        } else if (index === selectedIndex && selectedIndex !== correctDisplayIndex) {
            btn.classList.add('wrong');
        }
    });

    // é¡¯ç¤ºå›æ‡‰æ™‚é–“å’Œå¿«é€Ÿç­”é¡Œæç¤º
    const feedbackDiv = document.createElement('div');
    feedbackDiv.style.cssText = `
    margin-top: 15px; 
    text-align: center; 
    font-size: 0.9rem;
    color: var(--text-secondary);
    `;

    let feedbackText = `å›æ‡‰æ™‚é–“: ${responseTime.toFixed(1)}ç§’`;
    if (responseTime <= config.fastAnswerThreshold) {
        feedbackText += ` âš¡ å¿«é€Ÿç­”é¡Œï¼`;
    }

    feedbackDiv.innerHTML = feedbackText;
    document.getElementById('questionContainer').appendChild(feedbackDiv);
}

// ä¸‹ä¸€é¡Œ - ä¿®æ­£ç‰ˆæœ¬
function nextQuestion(wasCorrect) {
    // ğŸ”§ ä¿®æ­£ï¼šè¨ˆç®—åŒ…å«å¿«é€Ÿç­”å°åŠ åˆ†çš„ç¸½åˆ†
    const baseScore = userScores.correctAnswers * 10;
    const fastBonus = userScores.fastCorrectAnswers * 5; // å¿«é€Ÿç­”å°é¡å¤–åŠ åˆ†
    const currentScore = baseScore + fastBonus;
    
    document.getElementById('currentScore').textContent = currentScore;

    if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
        startQuestionTimer();
    } else {
        finishExam();
    }
}


// çµæŸè€ƒè©¦ - ä¿®æ­£ç‰ˆæœ¬
async function finishExam() {
    clearInterval(examTimer);
    const totalTime = (Date.now() - examStartTime) / 1000;
    const config = examConfigs[currentExam];
    
    // ğŸ”§ ä¿®æ­£ï¼šæ­£ç¢ºè¨ˆç®—æœ€çµ‚åˆ†æ•¸ï¼ˆåŸºç¤åˆ† + å¿«é€Ÿç­”å°åŠ åˆ†ï¼‰
    const baseScore = userScores.correctAnswers * 10;
    const fastBonus = userScores.fastCorrectAnswers * 5;
    const finalScore = baseScore + fastBonus;
    
    console.log(`ğŸ“Š åˆ†æ•¸çµ±è¨ˆ:
    - ç­”å°é¡Œæ•¸: ${userScores.correctAnswers}/${config.questionCount}
    - åŸºç¤åˆ†æ•¸: ${baseScore}åˆ†
    - å¿«é€Ÿç­”å°: ${userScores.fastCorrectAnswers}é¡Œ
    - å¿«é€ŸåŠ åˆ†: ${fastBonus}åˆ†
    - æœ€çµ‚åˆ†æ•¸: ${finalScore}åˆ†`);
    
    // ğŸ›¡ï¸ é˜²æ¿«ç”¨ï¼šæª¢æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰é¡Œç›®
    const isCompleted = (currentQuestionIndex + 1) >= config.questionCount;
    
    if (!isCompleted) {
        console.log('âŒ è€ƒè©¦æœªå®Œæˆï¼Œä¸ä¿å­˜æˆç¸¾');
        showExamResult(finalScore, totalTime, 0, 0);
        return;
    }
    
    // ğŸ¯ è¨ˆç®—çå‹µ
    let coinsEarned = 0;
    let gemsEarned = 0;
    let bonusMessages = [];
    
    // ğŸ’° åŸºç¤çå‹µï¼šæ¯ç­”å°ä¸€é¡Œ5é‡‘å¹£
    coinsEarned += userScores.correctAnswers * 5;
    if (userScores.correctAnswers > 0) {
        bonusMessages.push(`ğŸ“ ç­”å°${userScores.correctAnswers}é¡Œç²å¾—${userScores.correctAnswers * 5}é‡‘å¹£`);
    }
    
    // âš¡ å¿«é€Ÿç­”å°çå‹µï¼šæ¯å¿«é€Ÿç­”å°ä¸€é¡Œé¡å¤–2é‡‘å¹£
    if (userScores.fastCorrectAnswers > 0) {
        const fastCoins = userScores.fastCorrectAnswers * 2;
        coinsEarned += fastCoins;
        bonusMessages.push(`âš¡ å¿«é€Ÿç­”å°${userScores.fastCorrectAnswers}é¡Œç²å¾—é¡å¤–${fastCoins}é‡‘å¹£`);
    }
    
    // ğŸ† æ»¿åˆ†çå‹µ
    if (userScores.correctAnswers === config.questionCount) {
        const perfectBonus = config.perfectBonus || 50;
        coinsEarned += perfectBonus;
        gemsEarned += 1;
        bonusMessages.push(`ğŸ† æ»¿åˆ†çå‹µï¼š+${perfectBonus}é‡‘å¹£ +1å¯¶çŸ³`);
    }
    
    // ğŸ’° æ›´æ–°è²¨å¹£
    if (coinsEarned > 0) userCurrency.coins += coinsEarned;
    if (gemsEarned > 0) userCurrency.gems += gemsEarned;
    
    // ğŸ”§ ä¿®æ­£ï¼šç¢ºä¿æˆç¸¾ä¿å­˜åˆ°æ’è¡Œæ¦œ
    try {
        console.log('ğŸ’¾ é–‹å§‹ä¿å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œ...');
        await saveScoreToLeaderboard(currentExam, finalScore, totalTime);
        console.log('âœ… æˆç¸¾ä¿å­˜æˆåŠŸ');
        
        // ä¿å­˜è²¨å¹£è³‡æ–™
        if (coinsEarned > 0 || gemsEarned > 0) {
            await saveCurrencyData();
            console.log('ğŸ’° è²¨å¹£æ›´æ–°æˆåŠŸ');
        }
        
        // æ¸…é™¤ç›¸é—œå¿«å–ä»¥ç¢ºä¿æ’è¡Œæ¦œæ›´æ–°
        const cacheKey = `champion_${currentExam}`;
        championCache.delete(cacheKey);
        localStorage.removeItem('users_data_v1');
        localStorage.removeItem('users_data_v1_time');
        console.log('ğŸ—‘ï¸ å¿«å–å·²æ¸…é™¤');
        
    } catch (error) {
        console.error('âŒ ä¿å­˜æˆç¸¾å¤±æ•—:', error);
        alert('ä¿å­˜æˆç¸¾æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
    }
    
    // é¡¯ç¤ºçµæœ
    showExamResult(finalScore, totalTime, coinsEarned, gemsEarned, bonusMessages);
}

// é¡¯ç¤ºè€ƒè©¦çµæœ - ä¿®æ­£ç‰ˆæœ¬
function showExamResult(score, totalTime, coinsEarned, gemsEarned, bonusMessages = []) {
    const container = document.getElementById('mainContent');
    const config = examConfigs[currentExam];
    
    // ğŸ”§ ä¿®æ­£ï¼šè¨ˆç®—åˆ†æ•¸æ˜ç´°
    const baseScore = userScores.correctAnswers * 10;
    const fastBonus = userScores.fastCorrectAnswers * 5;

    container.innerHTML = `
    <div class="exam-result">
        <h2>ğŸ‰ è€ƒè©¦å®Œæˆï¼</h2>
        <p><strong>è€ƒè©¦é¡å‹ï¼š</strong>${config.name}</p>
        <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <p><strong>ğŸ“Š æˆç¸¾çµ±è¨ˆï¼š</strong></p>
            <p>â€¢ ç­”å°é¡Œæ•¸ï¼š${userScores.correctAnswers} / ${config.questionCount}</p>
            <p>â€¢ åŸºç¤åˆ†æ•¸ï¼š${baseScore} åˆ†</p>
            <p>â€¢ å¿«é€Ÿç­”å°ï¼š${userScores.fastCorrectAnswers} é¡Œ (+${fastBonus}åˆ†)</p>
            <p style="color: var(--primary); font-size: 1.2rem; font-weight: bold;">
                ğŸ† æœ€çµ‚å¾—åˆ†ï¼š${score} åˆ†
            </p>
        </div>
        <p><strong>ç¸½è€—æ™‚ï¼š</strong>${totalTime.toFixed(1)} ç§’</p>
        
        ${bonusMessages.length > 0 ? `
        <div style="margin: 15px 0; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
            <p><strong>ğŸ çå‹µæ˜ç´°ï¼š</strong></p>
            ${bonusMessages.map(msg => `<p style="color: var(--success);">â€¢ ${msg}</p>`).join('')}
            ${coinsEarned > 0 ? `<p style="color: var(--gold); font-weight: bold;">ğŸ’° ç¸½ç²å¾—é‡‘å¹£ï¼š${coinsEarned}</p>` : ''}
            ${gemsEarned > 0 ? `<p style="color: var(--info); font-weight: bold;">ğŸ’ ç¸½ç²å¾—å¯¶çŸ³ï¼š${gemsEarned}</p>` : ''}
        </div>
        ` : `<p style="color: var(--text-secondary);">ğŸ’° æœ¬æ¬¡æœªç²å¾—çå‹µ</p>`}
        
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="location.reload()">è¿”å›ä¸»é </button>
            <button class="btn btn-secondary" onclick="showLeaderboard('${currentExam}')">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </div>
    </div>
    `;
}


// ğŸ”§ ä¿®æ­£ï¼šä¿å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œ - ä¸ä½¿ç”¨ç´¢å¼•æŸ¥è©¢
async function saveScoreToLeaderboard(examType, score, totalTime) {
    try {
        const scoreData = {
            score: score,
            totalTime: totalTime,
            timestamp: Date.now(),
            fastAnswers: userScores.fastAnswers,
            correctAnswers: userScores.correctAnswers
        };

        // ğŸ”§ ä½¿ç”¨ uniqueId ä½œç‚º Firebase key
        await database.ref(`leaderboard/${examType}/${currentUser}`).set(scoreData);
        console.log('æˆç¸¾å·²ä¿å­˜åˆ°æ’è¡Œæ¦œ');
    } catch (err) {
        console.error('ä¿å­˜æˆç¸¾å¤±æ•—:', err);
    }
}

// ğŸ”§ ä¿®æ­£ï¼šé¡¯ç¤ºæ’è¡Œæ¦œ - å¼·åˆ¶é‡æ–°è¼‰å…¥ç”¨æˆ¶è³‡æ–™
async function showLeaderboard(examType) {
    document.getElementById('modalTitle').textContent = `${examConfigs[examType].name} - æ’è¡Œæ¦œ`;
    const content = document.getElementById('leaderboardContent');
    content.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥æ’è¡Œæ¦œä¸­...</div>';
    document.getElementById('leaderboardModal').style.display = 'flex';

    try {
        // ğŸ”§ å¼·åˆ¶é‡æ–°è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä»¥ç²å–æœ€æ–°å‹³ç« ç‹€æ…‹
        localStorage.removeItem('users_data_v1');
        localStorage.removeItem('users_data_v1_time');
        await loadUsersData();

        // ç²å–æ’è¡Œæ¦œè³‡æ–™
        const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
        const data = snapshot.val();

        if (data) {
            // è½‰æ›ä¸¦æ’åºè³‡æ–™
            const leaderboardData = Object.entries(data).map(([user, userData]) => ({
                user,
                ...userData
            })).sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return a.totalTime - b.totalTime;
            });

        const leaderboardHtml = leaderboardData.map((entry, index) => {
            const isCurrentUser = entry.user === currentUser;
            const userMedalIcons = getUserMedalIcons(entry.user);
            const displayName = getUserDisplayName(entry.user); // ğŸ†• æ–°å¢ï¼šç²å–é¡¯ç¤ºåç¨±
            
            // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
            const formattedTime = entry.totalTime ? `${entry.totalTime.toFixed(1)}ç§’` : "N/A";

            return `
            <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                <div class="rank">#${index + 1}</div>
                <div class="user-name">
                    ${displayName}
                    <div class="leaderboard-medals">
                        ${userMedalIcons}
                    </div>
                </div>
                <div class="score-time">
                    <div class="score">${entry.score}åˆ†</div>
                    <div class="time" style="font-size: 0.8rem; color: var(--text-secondary);">${formattedTime}</div>
                </div>
            </div>
            `;
        }).join('');

            content.innerHTML = `
                <div class="leaderboard-container">
                    ${leaderboardHtml}
                </div>
            `;
        } else {
            content.innerHTML = '<div class="empty-leaderboard"><p>ğŸ† å°šç„¡æ’è¡Œæ¦œè³‡æ–™</p></div>';
        }
    } catch (err) {
        console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', err);
        content.innerHTML = '<div class="empty-leaderboard"><p>âŒ è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</p></div>';
    }
}


// ğŸ… ç²å–ç”¨æˆ¶é¡¯ç¤ºåç¨± - å®Œæ•´ä¿®æ­£ç‰ˆæœ¬
function getUserDisplayName(userId) {
    // 1. æª¢æŸ¥ usersData ä¸­æ˜¯å¦æœ‰æ­¤ç”¨æˆ¶çš„ä¸­æ–‡åç¨±
    if (usersData[userId] && usersData[userId].chineseName) {
        return usersData[userId].chineseName;
    }
    
    // 2. å¦‚æœåœ¨ usersData ä¸­æ‰¾ä¸åˆ°ï¼Œå‰‡å˜—è©¦å¾ localStorage ä¸­ç²å–ç•¶å‰ç”¨æˆ¶çš„é¡¯ç¤ºåç¨±
    if (userId === currentUser && localStorage.getItem('t2_login_display_name')) {
        return localStorage.getItem('t2_login_display_name');
    }
    
    // 3. å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œå‰‡å˜—è©¦å¾ password.json ä¸­æŸ¥æ‰¾ (éœ€è¦åœ¨åˆå§‹åŒ–æ™‚è¼‰å…¥)
    if (window.passwordData) {
        // å¾ userId ä¸­æå–ç”¨æˆ¶åå’Œå¯†ç¢¼éƒ¨åˆ† (ä¾‹å¦‚ 00170128 -> 0017 å’Œ 0128)
        const username = userId.substring(0, 4);
        const password = userId.substring(4);
        
        // æŸ¥æ‰¾åŒ¹é…çš„ç”¨æˆ¶
        const matchedUser = window.passwordData.find(user => 
            user.username === username && user.password === password);
        
        if (matchedUser && matchedUser._comment) {
            return matchedUser._comment;
        }
    }
    
    // 4. å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œå‰‡è¿”å›åŸå§‹ userId
    return userId;
}

// ğŸ† é¡¯ç¤ºç¸½åˆ†æ’è¡Œæ¦œ - ä¿®æ­£ç‰ˆæœ¬
async function showTotalLeaderboard() {
    document.getElementById('modalTitle').textContent = 'ğŸ† ç¸½åˆ†æ’è¡Œæ¦œ';
    const content = document.getElementById('leaderboardContent');
    content.innerHTML = '<div class="loading"><div class="loading-spinner"></div>è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œä¸­...</div>';
    document.getElementById('leaderboardModal').style.display = 'flex';

    try {
        // ğŸ”§ å¼·åˆ¶é‡æ–°è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä»¥ç²å–æœ€æ–°å‹³ç« ç‹€æ…‹
        localStorage.removeItem('users_data_v1');
        localStorage.removeItem('users_data_v1_time');
        await loadUsersData();

        // è¨ˆç®—ç¸½åˆ†
        const totalScores = {};
        const examTypes = Object.keys(examConfigs);

        // ä¸¦è¡Œç²å–æ‰€æœ‰è€ƒè©¦é¡å‹çš„è³‡æ–™
        const promises = examTypes.map(async (examType) => {
            const snapshot = await database.ref(`leaderboard/${examType}`).once('value');
            const data = snapshot.val() || {};

            Object.entries(data).forEach(([user, userData]) => {
                if (!totalScores[user]) {
                    totalScores[user] = { totalScore: 0, totalTime: 0, examCount: 0 };
                }
                totalScores[user].totalScore += userData.score || 0;
                totalScores[user].totalTime += userData.totalTime || 0;
                totalScores[user].examCount++;
            });
        });

        await Promise.all(promises);

        // æ’åºç¸½åˆ†è³‡æ–™
        const sortedTotalScores = Object.entries(totalScores)
            .map(([user, data]) => ({ user, ...data }))
            .sort((a, b) => {
                if (b.totalScore !== a.totalScore) {
                    return b.totalScore - a.totalScore;
                }
                return a.totalTime - b.totalTime;
            });

        if (sortedTotalScores.length > 0) {
            const leaderboardHtml = sortedTotalScores.map((entry, index) => {
                const isCurrentUser = entry.user === currentUser;
                const userMedalIcons = getUserMedalIcons(entry.user);
                const displayName = getUserDisplayName(entry.user); // ğŸ†• æ–°å¢ï¼šç²å–é¡¯ç¤ºåç¨±
                
                // æ ¼å¼åŒ–ç¸½æ™‚é–“é¡¯ç¤º
                const formattedTime = entry.totalTime ? `${entry.totalTime.toFixed(1)}ç§’` : "N/A";

                return `
                <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                    <div class="rank">#${index + 1}</div>
                    <div class="user-name">
                        ${displayName}
                        <div class="leaderboard-medals">
                            ${userMedalIcons}
                        </div>
                    </div>
                    <div class="score-time">
                        <div class="score">${entry.totalScore}åˆ†</div>
                        <div class="time" style="font-size: 0.8rem; color: var(--text-secondary);">${formattedTime}</div>
                    </div>
                </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="leaderboard-container">
                    ${leaderboardHtml}
                </div>
            `;
        } else {
            content.innerHTML = '<div class="empty-leaderboard"><p>ğŸ† å°šç„¡ç¸½åˆ†æ’è¡Œæ¦œè³‡æ–™</p></div>';
        }
    } catch (err) {
        console.error('è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—:', err);
        content.innerHTML = '<div class="empty-leaderboard"><p>âŒ è¼‰å…¥ç¸½åˆ†æ’è¡Œæ¦œå¤±æ•—</p></div>';
    }
}

// ğŸ… ç²å–ç”¨æˆ¶å‹³ç« åœ–ç¤º - å‡ç´šç‰ˆæœ¬
function getUserMedalIcons(username) {
    // ğŸ”§ ä¿®æ­£ï¼šå¾ usersData æ­£ç¢ºç²å–ç”¨æˆ¶å‹³ç« è³‡æ–™
    const userData = usersData[username];
    if (!userData || !userData.medals || !userData.medals.equipped || userData.medals.equipped.length === 0) {
        return '';
    }

    return userData.medals.equipped.map(medalId => {
        const medal = medalsData.medals[medalId];
        if (medal) {
            const iconContent = medal.icon.startsWith('http') ? 
                `<img src="${medal.icon}" alt="${medal.name}" style="width: 24px; height: 24px; object-fit: contain; border-radius: 4px;">` : 
                medal.icon;
            return `<span class="leaderboard-medal" 
                        style="border-color: ${medal.color};" 
                        data-rarity="${medal.rarity}"
                        title="${medal.name}: ${medal.description}">
                        ${iconContent}
                    </span>`;
        }
        return '';
    }).join('');
}

// éš±è—æ’è¡Œæ¦œ
function hideLeaderboard() {
    document.getElementById('leaderboardModal').style.display = 'none';
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>
