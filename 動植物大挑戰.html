<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å‹•æ¤ç‰©å¤§æŒ‘æˆ°</title>
  <style>
    :root {
      --brand: #4b4e8a;
      --bg: #f4f5fa;
      --card: #ffffff;
      --muted: #a3a6b3;
      --input: #e9ecf4;
      --radius: 16px;
      --title-size: 23px;
      --btn-height: 46px;
    }

    body{
      margin:0;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#555;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Noto Sans TC","PingFang TC","Helvetica Neue",Arial,"Microsoft JhengHei",sans-serif;
    }

    .phone {
      width: min(420px, 94vw);
      background: var(--card);
      border-radius: 0;
      box-shadow: 0 6px 22px rgba(0,0,0,.25);
      padding: 18px 10px 46px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }

    .title-row {
      display:flex;
      justify-content:center;
      gap:10px;
      color:var(--brand);
      font-weight:800;
      font-size:var(--title-size);
      text-align:center;
      align-items:center;
      margin: 0 12px 4px;
    }

    .title-row img{width:22px;height:22px;}

    .user-bar{
      margin: 0 8px 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#e4f5ec;
      color:#0f7a3b;
      font-weight:700;
      font-size: 14px;
      text-align:center;
    }

    .section{
      margin: 0 6px;
      padding: 10px 10px 8px;
      border-radius: 14px;
      background:#eef0ff;
      border:1px solid #d8dcff;
    }
    .section-title{
      margin:0 0 6px;
      font-size:18px;
      font-weight:800;
      color:#2f3161;
      text-align:center;
      letter-spacing:.15em;
    }
    .section-desc{
      margin:0 0 8px;
      font-size:14px;
      color:#333;
      text-align:center;
      line-height:1.5;
    }

    .mode-toggle{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:4px;
    }
    .pill-btn{
      border:none;
      border-radius:999px;
      padding:8px 4px;
      font-size:15px;
      font-weight:800;
      letter-spacing:.15em;
      background:#d0d3f2;
      color:#2f3161;
      cursor:pointer;
    }
    .pill-btn.active{
      background:#ba004c;
      color:#fff;
    }

    .work-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    .work-btn{
      border:none;
      border-radius:14px;
      padding:8px 4px;
      font-size:14px;
      font-weight:800;
      background:#2f3161;
      color:#fff;
      letter-spacing:.15em;
      cursor:pointer;
      min-height:38px;
    }
    .work-btn.active{
      background:#c7a64a;
      color:#fff;
    }

    .lang-wrap{
      margin-top:8px;
    }
    .lang-row{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .lang-label{
      font-weight:800;
      color:#2f3161;
      min-width:62px;
      font-size:14px;
      display:flex;
      align-items:center;
    }
    .level-btn{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:14px;
      background:#d0d3f2;
      color:#2f3161;
      cursor:pointer;
    }
    .level-btn.active{
      background:#c7a64a;
      color:#fff;
    }

    .current-choice{
      margin-top:6px;
      font-size:14px;
      text-align:center;
      color:#444;
    }

    /* ç‹€æ…‹å€ */
    .status-card{
      margin: 2px 6px 0;
      padding: 8px 10px 10px;
      border-radius: 14px;
      background:#f7f7ff;
      border:1px solid #dfe2ff;
    }
    .status-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
      color:#2f3161;
      margin-bottom:4px;
    }
    .status-row span{font-weight:700;}

    .status-actions{
      margin-top:4px;
      display:flex;
      gap:8px;
    }

    .btn-main,
    .btn-secondary{
      border:none;
      border-radius:14px;
      padding:8px 10px;
      font-size:15px;
      font-weight:800;
      letter-spacing:.15em;
      cursor:pointer;
      flex:1;
      text-align:center;
      white-space:nowrap;
    }
    .btn-main{
      background:#2f3161;
      color:#fff;
    }
    .btn-main:disabled{
      opacity:.4;
      cursor:default;
    }
    .btn-secondary{
      background:#6c6e9e;
      color:#fff;
    }

    .hint-text{
      font-size:12px;
      color:#777;
      margin-top:4px;
      text-align:center;
    }

    /* åº•éƒ¨è¿”å› */
    .footer-actions{
      margin: 8px 6px 0;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .btn-back{
      flex:1;
      border:none;
      border-radius:14px;
      padding:8px 6px;
      font-size:15px;
      font-weight:800;
      letter-spacing:.15em;
      background:#6c6e9e;
      color:#fff;
      cursor:pointer;
      text-align:center;
    }
    .btn-back.secondary{
      background:#a12a5e;
    }

    /* ===== é€šç”¨å½ˆå‡ºè¦–çª— ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .modal-overlay.show{
      display:flex;
    }
    .modal-card{
      width:min(380px, 94vw);
      max-height:82vh;
      background:#ffffff;
      border-radius:20px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:4px;
      gap:8px;
    }
    .modal-header-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .modal-title{
      font-size:15px;
      font-weight:800;
      color:#2f3161;
    }
    .modal-sub{
      font-size:12px;
      color:#777;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      color:#666;
    }
    .modal-body{
      font-size:14px;
      color:#222;
      margin-top:4px;
      overflow:auto;
      padding-right:2px;
    }
    .modal-footer{
      margin-top:8px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    /* é¡Œç›®å…§å®¹å¡ç‰‡ */
    .question-card{
      border-radius:14px;
      background:#f5f6ff;
      padding:8px 8px 10px;
      border:1px solid #e0e3ff;
    }
    .question-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:#555;
      margin-bottom:4px;
    }
    .question-badge{
      padding:2px 8px;
      border-radius:999px;
      background:#2f3161;
      color:#fff;
      font-size:11px;
      font-weight:700;
    }
    .question-text{
      line-height:1.6;
      margin-bottom:8px;
      font-size:14px;
      color:#222;
    }
    .question-media-box{
      margin-bottom:8px;
      border-radius:10px;
      overflow:hidden;
      background:#ddd;
      max-height:200px;
    }
    .question-media-box img{
      width:100%;
      height:auto;
      display:block;
      object-fit:cover;
    }

    .modal-options{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }
    .option-btn{
      border:none;
      border-radius:12px;
      padding:8px 10px;
      font-size:14px;
      text-align:left;
      background:#e2e4ff;
      color:#222;
      cursor:pointer;
      transition:background .15s, transform .05s;
    }
    .option-btn:active{
      transform:scale(0.98);
    }
    .option-btn.correct{
      background:#d6f5dc;
      border:1px solid #46a663;
    }
    .option-btn.wrong{
      background:#ffd6d6;
      border:1px solid #d94a4a;
    }

    /* æ’è¡Œæ¦œè¡¨æ ¼ï¼ˆåœ¨å½ˆçª—è£¡ç”¨ï¼‰ */
    .rank-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:4px;
    }
    .rank-table th,
    .rank-table td{
      padding:3px 4px;
      border-bottom:1px dashed #f1e0a8;
      text-align:left;
      white-space:nowrap;
    }
    .rank-table th{
      font-weight:800;
      color:#5b4b18;
    }
    .rank-empty{
      font-size:13px;
      color:#666;
      text-align:center;
      margin-top:4px;
    }
    .me-row{
      background:#fff4c1;
    }

    /* é–‹å§‹ä½œç­”æŒ‰éˆ•ç‹€æ…‹ */
    .btn-main.locked {
      background: #2b2b2b !important;
      color: #888 !important;
      cursor: not-allowed !important;
    }

    .btn-main.ready {
      background: #c62828 !important;
      color: #fff !important;
    }

        /* æ¯å€‹æŒ‘æˆ°é …ç›®ç•¶å‰å‰ 3 åé¡¯ç¤ºå€å¡Š */
    .top3-box{
      margin-top:6px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid #f9d98b;
      background:linear-gradient(135deg,#fff7e0,#ffe8b3);
      font-size:12px;
      color:#5a4305;
      animation: top3Pop .35s ease-out;
    }
    .top3-title{
      font-weight:800;
      margin-bottom:3px;
    }
    .top3-list{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .top3-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
    }
    .top3-item span.score{
      font-weight:700;
    }
    .top3-empty{
      font-size:12px;
      color:#777;
      text-align:center;
    }
    @keyframes top3Pop{
      0%{ transform:translateY(6px); opacity:0; }
      100%{ transform:translateY(0); opacity:1; }
    }
    
    /* èªéŸ³æ’­æ”¾æŒ‰éˆ•ï¼šåœ“å½¢ iconï¼Œè²¼åœ¨æ–‡å­—æ—é‚Š */
    .audio-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      padding:0;
      margin:0 0 0 6px;   /* åªç•™å·¦é‚Šè·ï¼Œé¿å…æ‰åˆ°ä¸‹ä¸€è¡Œçš„è¦–è¦ºæ„Ÿ */
      border:none;
      border-radius:50%;
      background:#ff7043;
      color:#fff;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      vertical-align:middle;
      flex:0 0 auto;
    }
    .audio-btn.small{
      width:18px;
      height:18px;
      font-size:11px;
      margin-left:6px;
    }




  </style>
</head>
<body>
  <main class="phone">
    <div class="title-row">
      <img src="https://res.cloudinary.com/dcexvv7co/image/upload/v1758859484/%E6%A8%99%E9%A1%8C%E5%9C%96%E7%A4%BA-%E8%B1%AC%E9%BC%BB%E7%B4%99_ppobop.png" alt="icon">
      <h1 style="margin:0;font-size:inherit;">å‹•æ¤ç‰©å¤§æŒ‘æˆ°</h1>
    </div>

    <div id="userBar" class="user-bar">ç›®å‰ç™»å…¥ï¼šï¼</div>

    <!-- é¡å‹é¸æ“‡ -->
    <section class="section">
      <h2 class="section-title">é¸æ“‡æŒ‘æˆ°é¡å‹</h2>
      <p class="section-desc">
        å…ˆé¸ <b>å·¥ä½œæŒ‘æˆ°</b> æˆ– <b>èªè¨€æŒ‘æˆ°</b>ï¼Œå†é¸å­é …ç›®å¾Œå³å¯é–‹å§‹æ¸¬é©—ã€‚<br>
        æ¯æ¬¡éš¨æ©Ÿå¾é¡Œåº«æŠ½å‡ºæœ€å¤š 20 é¡Œï¼Œé¡Œç›®ä¸€é¡Œä¸€é¡Œå½ˆå‡ºä½œç­”ï¼Œæ»¿åˆ† 100 åˆ†ã€‚
      </p>

      <div class="mode-toggle">
        <button id="modeWork" class="pill-btn">å·¥ä½œæŒ‘æˆ°</button>
        <button id="modeLang" class="pill-btn">èªè¨€æŒ‘æˆ°</button>
      </div>

      <!-- å·¥ä½œæŒ‘æˆ° -->
      <div id="workPanel" style="display:none;">
        <div class="work-grid">
          <button class="work-btn" data-category="work-pre">å‰å°æŒ‘æˆ°</button>
          <button class="work-btn" data-category="work-review">è¤‡æŸ¥æŒ‘æˆ°</button>
          <button class="work-btn" data-category="work-flow">åˆ†æµæŒ‘æˆ°</button>
          <button class="work-btn" data-category="work-rule">è¦å®šæŒ‘æˆ°</button>
        </div>
      </div>

      <!-- èªè¨€æŒ‘æˆ° -->
      <div id="langPanel" style="display:none;">
        <div class="lang-wrap">
          <div class="lang-row">
            <div class="lang-label">è‹±æ–‡</div>
              <button class="level-btn" data-category="lang-en-quarantine">æª¢ç–«</button>
              <button class="level-btn" data-category="lang-en-beginner">åˆç´š</button>
              <button class="level-btn" data-category="lang-en-middle">ä¸­ç´š</button>
              <button class="level-btn" data-category="lang-en-advanced">é«˜ç´š</button>
           </div>

          <div class="lang-row">
            <div class="lang-label">éŸ“æ–‡</div>
              <button class="level-btn" data-category="lang-kr-quarantine">æª¢ç–«</button>
              <button class="level-btn" data-category="lang-kr-beginner">åˆç´š</button>
              <button class="level-btn" data-category="lang-kr-middle">ä¸­ç´š</button>
              <button class="level-btn" data-category="lang-kr-advanced">é«˜ç´š</button>
          </div>

          <div class="lang-row">
            <div class="lang-label">è¶Šå—</div>
              <button class="level-btn" data-category="lang-vn-quarantine">æª¢ç–«</button>
              <button class="level-btn" data-category="lang-vn-beginner">åˆç´š</button>
              <button class="level-btn" data-category="lang-vn-middle">ä¸­ç´š</button>
              <button class="level-btn" data-category="lang-vn-advanced">é«˜ç´š</button>
          </div>

          <div class="lang-row">
            <div class="lang-label">æ—¥èª</div>
              <button class="level-btn" data-category="lang-jp-quarantine">æª¢ç–«</button>
              <button class="level-btn" data-category="lang-jp-beginner">åˆç´š</button>
              <button class="level-btn" data-category="lang-jp-middle">ä¸­ç´š</button>
              <button class="level-btn" data-category="lang-jp-advanced">é«˜ç´š</button>
          </div>
        </div>
      </div>

      <div id="currentChoice" class="current-choice">å°šæœªé¸æ“‡æŒ‘æˆ°é …ç›®ã€‚</div>
    </section>

    <!-- ç‹€æ…‹ + æ“ä½œ -->
      <section class="status-card">
        <div class="status-row">
          <span id="statusText">å°šæœªé–‹å§‹æ¸¬é©—</span>
          <span id="timerText">æ™‚é–“ï¼š0åˆ†0ç§’</span>
        </div>
        <div class="status-actions">
          <button id="startBtn" class="btn-main">é–‹å§‹ä½œç­”</button>
          <button id="viewRankBtn" class="btn-secondary">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </div>
        <!-- é€™è£¡æ˜¯å„é …ç›®å‰ä¸‰å -->
        <div id="top3Box" class="top3-box"></div>

        <div class="hint-text">
          ä½œç­”ä¸­ã€Œé–‹å§‹ä½œç­”ã€æŒ‰éˆ•æœƒé–ä½ï¼Œç„¡æ³•é‡æ–°é»æ“Šã€‚å®Œæˆå¾Œå¯é¸æ“‡æ˜¯å¦å„²å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œã€‚
        </div>
      </section>

    <!-- åº•éƒ¨ -->
    <div class="footer-actions">
      <button id="backMainBtn" class="btn-back">è¿”å›ä¸»é </button>
      <button id="logoutBtn" class="btn-back secondary">ç™»å‡º</button>
    </div>
  </main>
    <!-- å…±ç”¨èªéŸ³æ’­æ”¾å™¨ -->
  <audio id="qaAudio"></audio>


  <!-- ===== é¡Œç›®å½ˆå‡ºè¦–çª— ===== -->
  <div id="questionModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title" id="questionModalTitle">é¡Œç›®</div>
          <div class="modal-sub" id="questionModalTimer">ä½œç­”æ™‚é–“ï¼š0åˆ†0ç§’</div>
        </div>
        <button id="questionModalClose" class="modal-close" title="æ”¾æ£„æœ¬æ¬¡ä½œç­”">Ã—</button>
      </div>
      <div class="modal-body" id="questionModalBody">
        <!-- é¡Œç›®èˆ‡é¸é …æœƒå‹•æ…‹å¡é€²ä¾† -->
      </div>
    </div>
  </div>

  <!-- ===== æˆç¸¾å½ˆå‡ºè¦–çª—ï¼ˆè©¢å•æ˜¯å¦å„²å­˜ï¼‰ ===== -->
  <div id="resultModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title">æœ¬æ¬¡æŒ‘æˆ°æˆç¸¾</div>
        </div>
        <button id="resultModalClose" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="resultText" style="line-height:1.7;"></div>
      </div>
      <div class="modal-footer">
        <button id="viewWrongBtn" class="btn-main" style="flex:1;background:#c62828;color:#fff;">
          æŸ¥çœ‹éŒ¯èª¤
        </button>
        <button id="noSaveResultBtn" class="btn-secondary" style="flex:1;">ä¸å„²å­˜</button>
        <button id="saveResultBtn" class="btn-main" style="flex:1;">å„²å­˜åˆ°æ’è¡Œæ¦œ</button>
      </div>
    </div>
  </div>

  <!-- ===== æ’è¡Œæ¦œå½ˆå‡ºè¦–çª— ===== -->
  <div id="rankModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title" id="rankModalTitle">æ’è¡Œæ¦œ</div>
        </div>
        <button id="rankModalClose" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body" id="rankModalBody">
        <!-- æ’è¡Œæ¦œè¡¨æ ¼æœƒå‹•æ…‹å¡é€²ä¾† -->
      </div>
    </div>
  </div>

    <!-- ===== æœ¬æ¬¡éŒ¯èª¤é¡Œç›®æª¢è¦–è¦–çª— ===== -->
  <div id="wrongModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title">æœ¬æ¬¡éŒ¯èª¤é¡Œç›®</div>
          <div class="modal-sub">åƒ…é¡¯ç¤ºé€™ä¸€æ¬¡æŒ‘æˆ°ç­”éŒ¯çš„é¡Œç›®ï¼Œæ–¹ä¾¿è¤‡ç¿’ã€‚</div>
        </div>
        <button id="wrongModalClose" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body" id="wrongModalBody">
        <!-- éŒ¯èª¤é¡Œç›®æœƒå‹•æ…‹å¡é€²ä¾† -->
      </div>
    </div>
  </div>


  
  <!-- å…±ç”¨æ’­æ”¾å‡½å¼ï¼ˆçµ¦é¡Œç›®æŒ‰éˆ•ç”¨ï¼‰ -->
  <script>
    window.playAudio = function(src){
      var audio = document.getElementById('qaAudio');
      if(!audio) return;
      // è‹¥æ›äº†æ–°ä¾†æºå°±é‡æ–°æŒ‡å®š
      if(audio.src.indexOf(src) === -1){
        audio.src = src;
      }
      audio.currentTime = 0;
      audio.play().catch(function(e){
        console && console.warn && console.warn('audio play error', e);
      });
    };
  </script>

  <!-- é¡Œåº«å¤–éƒ¨æª”æ¡ˆ -->
  <script src="challenge-questions.js"></script>
  <!-- Firebase (compat ç‰ˆï¼Œé©åˆç´” html ä¸ç”¨ import) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  firebase.initializeApp({
    apiKey: "AIzaSyBVC5zJl6LCKFrsdN7_JkVsZHmqALuixwE",
    authDomain: "openexammodal.firebaseapp.com",
    databaseURL: "https://openexammodal-default-rtdb.firebaseio.com",
    projectId: "openexammodal",
    storageBucket: "openexammodal.firebasestorage.app",
    messagingSenderId: "336901617556",
    appId: "1:336901617556:web:53f60cddf513b2ea6a4181"
  });
  var db = firebase.database();
</script>

  <script>
    (function(){
      // ===== è®€å– main / index å­˜çš„ç™»å…¥è³‡è¨Š =====
      var name = localStorage.getItem('t2_user_name') || '';
      var bind = localStorage.getItem('t2_user_bind') || '';
      var acc  = localStorage.getItem('t2_user_acc')  || '';
      var pwd  = localStorage.getItem('t2_user_pwd')  || '';
      var userKey = acc + '|' + pwd;   // â˜… æ–°å¢ï¼šçµ¦æ’è¡Œæ¦œç”¨

      if(!name || !bind || !acc || !pwd || bind.indexOf(acc + pwd) !== 0){
        window.location.replace('T2æ—¥å‹•æ¤ç‰©æª¢ç–«ç™»å…¥ç³»çµ±.html');
        return;
      }

      document.getElementById('userBar').textContent = 'ç›®å‰ç™»å…¥ï¼š' + name;

    // ===== é¡åˆ¥å®šç¾© =====
    var CATEGORY_META = {
      'work-pre':        { group:'å·¥ä½œæŒ‘æˆ°', label:'å‰å°æŒ‘æˆ°' },
      'work-review':     { group:'å·¥ä½œæŒ‘æˆ°', label:'è¤‡æŸ¥æŒ‘æˆ°' },
      'work-flow':       { group:'å·¥ä½œæŒ‘æˆ°', label:'åˆ†æµæŒ‘æˆ°' },
      'work-rule':       { group:'å·¥ä½œæŒ‘æˆ°', label:'è¦å®šæŒ‘æˆ°' },

      // ===== èªè¨€æŒ‘æˆ°ï¼ˆåŠ å…¥æª¢ç–«ï¼‰=====
      'lang-en-quarantine': { group:'èªè¨€æŒ‘æˆ°', label:'è‹±æ–‡ æª¢ç–«' },
      'lang-en-beginner':   { group:'èªè¨€æŒ‘æˆ°', label:'è‹±æ–‡ åˆç´š' },
      'lang-en-middle':     { group:'èªè¨€æŒ‘æˆ°', label:'è‹±æ–‡ ä¸­ç´š' },
      'lang-en-advanced':   { group:'èªè¨€æŒ‘æˆ°', label:'è‹±æ–‡ é«˜ç´š' },

      'lang-kr-quarantine': { group:'èªè¨€æŒ‘æˆ°', label:'éŸ“æ–‡ æª¢ç–«' },
      'lang-kr-beginner':   { group:'èªè¨€æŒ‘æˆ°', label:'éŸ“æ–‡ åˆç´š' },
      'lang-kr-middle':     { group:'èªè¨€æŒ‘æˆ°', label:'éŸ“æ–‡ ä¸­ç´š' },
      'lang-kr-advanced':   { group:'èªè¨€æŒ‘æˆ°', label:'éŸ“æ–‡ é«˜ç´š' },

      'lang-vn-quarantine': { group:'èªè¨€æŒ‘æˆ°', label:'è¶Šå— æª¢ç–«' },
      'lang-vn-beginner':   { group:'èªè¨€æŒ‘æˆ°', label:'è¶Šå— åˆç´š' },
      'lang-vn-middle':     { group:'èªè¨€æŒ‘æˆ°', label:'è¶Šå— ä¸­ç´š' },
      'lang-vn-advanced':   { group:'èªè¨€æŒ‘æˆ°', label:'è¶Šå— é«˜ç´š' },

      'lang-jp-quarantine': { group:'èªè¨€æŒ‘æˆ°', label:'æ—¥èª æª¢ç–«' },
      'lang-jp-beginner':   { group:'èªè¨€æŒ‘æˆ°', label:'æ—¥èª åˆç´š' },
      'lang-jp-middle':     { group:'èªè¨€æŒ‘æˆ°', label:'æ—¥èª ä¸­ç´š' },
      'lang-jp-advanced':   { group:'èªè¨€æŒ‘æˆ°', label:'æ—¥èª é«˜ç´š' }
    };


      // é¡Œåº«
      var QUESTION_BANK = window.QUESTION_BANK || {};
      var RANK_KEY = 't2_challenge_rank_v1';

      // ===== DOM =====
      var modeWorkBtn = document.getElementById('modeWork');
      var modeLangBtn = document.getElementById('modeLang');
      var workPanel   = document.getElementById('workPanel');
      var langPanel   = document.getElementById('langPanel');
      var currentChoiceEl = document.getElementById('currentChoice');
      var statusText  = document.getElementById('statusText');
      var timerText   = document.getElementById('timerText');
      var startBtn    = document.getElementById('startBtn');
      var viewRankBtn = document.getElementById('viewRankBtn');
      var backMainBtn = document.getElementById('backMainBtn');
      var logoutBtn   = document.getElementById('logoutBtn');

      var questionModal      = document.getElementById('questionModal');
      var questionModalTitle = document.getElementById('questionModalTitle');
      var questionModalBody  = document.getElementById('questionModalBody');
      var questionModalClose = document.getElementById('questionModalClose');
      var questionModalTimer = document.getElementById('questionModalTimer');

      var resultModal        = document.getElementById('resultModal');
      var resultModalClose   = document.getElementById('resultModalClose');
      var resultTextEl       = document.getElementById('resultText');
      var saveResultBtn      = document.getElementById('saveResultBtn');
      var noSaveResultBtn    = document.getElementById('noSaveResultBtn');
      var viewWrongBtn       = document.getElementById('viewWrongBtn');

      var rankModal          = document.getElementById('rankModal');
      var rankModalTitle     = document.getElementById('rankModalTitle');
      var rankModalBody      = document.getElementById('rankModalBody');
      var rankModalClose     = document.getElementById('rankModalClose');

      // é¡¯ç¤ºå„é …ç›®å‰ä¸‰å
      var top3Box            = document.getElementById('top3Box');

      // æœ¬æ¬¡éŒ¯èª¤é¡Œç›®æª¢è¦–
      var wrongModal         = document.getElementById('wrongModal');
      var wrongModalBody     = document.getElementById('wrongModalBody');
      var wrongModalClose    = document.getElementById('wrongModalClose');


      // ===== ç‹€æ…‹ =====
      var currentCategory = null;
      var examQuestions = [];
      var currentIndex = 0;
      var correctCount = 0;
      var examStartTime = null;
      var timerId = null;
      var examInProgress = false;
      var lastResult = null;
      var lastExamDetail = null; // å­˜é€™æ¬¡æ¯ä¸€é¡Œçš„ä½œç­”ç´€éŒ„


      // ===== å·¥å…· =====
      function setMode(mode){
        if(mode === 'work'){
          modeWorkBtn.classList.add('active');
          modeLangBtn.classList.remove('active');
          workPanel.style.display = 'block';
          langPanel.style.display = 'none';
        }else if(mode === 'lang'){
          modeLangBtn.classList.add('active');
          modeWorkBtn.classList.remove('active');
          workPanel.style.display = 'none';
          langPanel.style.display = 'block';
        }
      }

      function updateCurrentChoice(){
        if(!currentCategory || !CATEGORY_META[currentCategory]){
          currentChoiceEl.textContent = 'å°šæœªé¸æ“‡æŒ‘æˆ°é …ç›®ã€‚';
          if(typeof updateTop3Box === 'function'){
            updateTop3Box(null);
          }
          return;
        }
        var meta = CATEGORY_META[currentCategory];
        currentChoiceEl.textContent = 'ç›®å‰æŒ‘æˆ°ï¼š' + meta.group + ' - ' + meta.label;

        if(typeof updateTop3Box === 'function'){
          updateTop3Box(currentCategory);
        }
      }


      function updateStartButtonState(){
        if(!currentCategory){
          startBtn.classList.add('locked');
          startBtn.classList.remove('ready');
          return;
        }
        var bank = QUESTION_BANK[currentCategory] || [];
        if(bank.length >= 20){
          startBtn.classList.remove('locked');
          startBtn.classList.add('ready');
        } else {
          startBtn.classList.add('locked');
          startBtn.classList.remove('ready');
        }
      }

      function shuffle(arr){
        for(var i=arr.length-1;i>0;i--){
          var j = Math.floor(Math.random() * (i+1));
          var tmp = arr[i];
          arr[i] = arr[j];
          arr[j] = tmp;
        }
        return arr;
      }

      function formatDuration(ms){
        var sec = Math.floor(ms / 1000);
        if(sec < 0){ sec = 0; }
        var m = Math.floor(sec / 60);
        var s = sec % 60;
        return m + 'åˆ†' + s + 'ç§’';
      }

      function loadRankData(){
        try{
          var raw = localStorage.getItem(RANK_KEY);
          if(!raw){ return { categories:{} }; }
          var obj = JSON.parse(raw);
          if(!obj || typeof obj !== 'object'){ return { categories:{} }; }
          if(!obj.categories || typeof obj.categories !== 'object'){
            obj.categories = {};
          }
          return obj;
        }catch(e){
          return { categories:{} };
        }
      }

      function saveRankData(data){
        try{
          localStorage.setItem(RANK_KEY, JSON.stringify(data));
        }catch(e){}
      }

      function stopTimer(){
        if(timerId){
          clearInterval(timerId);
          timerId = null;
        }
      }

      function resetExamState(){
        stopTimer();
        examStartTime = null;
        examQuestions = [];
        currentIndex = 0;
        correctCount = 0;
        examInProgress = false;
        lastResult = null;
        statusText.textContent = 'å°šæœªé–‹å§‹æ¸¬é©—';
        timerText.textContent = 'æ™‚é–“ï¼š0åˆ†0ç§’';
        if(questionModalTimer){
          questionModalTimer.textContent = 'ä½œç­”æ™‚é–“ï¼š0åˆ†0ç§’';
        }
        startBtn.disabled = false;
        startBtn.textContent = 'é–‹å§‹ä½œç­”';
      }

      function openModal(el){
        if(el){ el.classList.add('show'); }
      }
      function closeModal(el){
        if(el){ el.classList.remove('show'); }
      }

      function refreshCategoryButtons() {
        var allBtns = document.querySelectorAll('[data-category]');
        allBtns.forEach(function(btn){
          var cat = btn.getAttribute('data-category');
          var bank = QUESTION_BANK[cat] || [];
          if(bank.length < 20){
            btn.style.display = 'none';
          } else {
            btn.style.display = 'inline-block';
          }
        });
      }

      // ===== å»ºç«‹è€ƒå· =====
      function buildExamFromBank(categoryId){
        var bank = QUESTION_BANK[categoryId] || [];
        if(!bank.length){ return null; }
        var pool = shuffle(bank.slice());
        var count = pool.length >= 20 ? 20 : pool.length;
        var result = [];
        for(var i=0;i<count;i++){
          var raw = pool[i];
          var opts = (raw.options || []).map(function(opt, idx){
            // èˆŠæ ¼å¼ï¼šoptions æ˜¯å­—ä¸²é™£åˆ—ï¼ˆç›¸å®¹ï¼‰
            if(typeof opt === 'string'){
              return {
                text: opt,
                audio: '',
                correct: (idx === raw.answer)
              };
            }

            // æ–°æ ¼å¼ï¼šoptions æ˜¯ { text, audio }
            opt = opt || {};
            return {
              text: String(opt.text || ''),
              audio: String(opt.audio || ''),
              correct: (idx === raw.answer)
            };
          });

          shuffle(opts);
          result.push({
            text: raw.text,
            image: raw.image || '',
            options: opts,
            userIndex: null,   // ä½¿ç”¨è€…é¸äº†å“ªä¸€å€‹ index
            isCorrect: null    // é€™é¡Œæœ‰æ²’æœ‰ç­”å°
          });
        }
        return result;
      }


      // ===== é¡Œç›®å½ˆçª— =====
      function showCurrentQuestion(){
        if(!examQuestions.length || currentIndex >= examQuestions.length){
          finishExam();
          return;
        }
        var q = examQuestions[currentIndex];
        var total = examQuestions.length;
        var letters = ['A','B','C','D','E','F'];

        questionModalTitle.textContent = 'ç¬¬ ' + (currentIndex+1) + ' é¡Œ / å…± ' + total + ' é¡Œ';

        var html = '';
        html += '<div class="question-card">';
        html +=   '<div class="question-meta">';
        html +=     '<span class="question-badge">é¡Œç›® ' + (currentIndex+1) + '</span>';
        html +=     '<span>å…± ' + total + ' é¡Œ</span>';
        html +=   '</div>';
        if(q.image){
          html += '<div class="question-media-box"><img src="'+ q.image +'" alt="question image"></div>';
        }
        html +=   '<div class="question-text">' + q.text + '</div>';
        html +=   '<div class="modal-options">';
        for(var i=0;i<q.options.length;i++){
          var opt = q.options[i];
          var letter = letters[i] || '';
          html += '<button class="option-btn" data-index="'+i+'">'
               + (letter ? (letter + '. ') : '')
               + opt.text
               + '</button>';
        }
        html +=   '</div>';
        html += '</div>';

        questionModalBody.innerHTML = html;

        var btns = questionModalBody.querySelectorAll('.option-btn');
        for(var j=0;j<btns.length;j++){
          (function(idx){
            btns[idx].addEventListener('click', function(){
              if(!examInProgress){ return; }

              var qNow = examQuestions[currentIndex];
              var buttons = btns;

              // ç´€éŒ„é€™é¡Œä½¿ç”¨è€…é¸äº†å“ªå€‹ & æœ‰æ²’æœ‰ç­”å°
              qNow.userIndex = idx;
              qNow.isCorrect = !!qNow.options[idx].correct;

              // å…ˆå…¨éƒ¨ disable
              for(var b=0;b<buttons.length;b++){
                buttons[b].disabled = true;
              }

              // æ¨™å‡ºæ­£ç¢ºç­”æ¡ˆ
              for(var k=0;k<qNow.options.length;k++){
                if(qNow.options[k].correct){
                  buttons[k].classList.add('correct');
                }
              }

              // æ¨™è¨˜ä½¿ç”¨è€…é¸çš„
              if(!qNow.options[idx].correct){
                this.classList.add('wrong');
              }else{
                correctCount++;
              }

              // 0.6 ç§’å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
              setTimeout(function(){
                currentIndex++;
                if(currentIndex < examQuestions.length){
                  showCurrentQuestion();
                }else{
                  closeModal(questionModal);
                  finishExam();
                }
              }, 600);
            });
          })(j);
        }


        openModal(questionModal);
      }

      // ===== å®Œæˆè€ƒè©¦ =====
      function finishExam(){
        if(!examInProgress || !examStartTime){
          resetExamState();
          return;
        }
        stopTimer();
        examInProgress = false;

        var usedMs = Date.now() - examStartTime;
        var total = examQuestions.length || 1;
        var score = Math.round((correctCount / total) * 100);
        if(score < 0){ score = 0; }
        if(score > 100){ score = 100; }

        // âœ… å­˜æœ¬æ¬¡æˆç¸¾ï¼ˆçµ¦ã€Œå„²å­˜åˆ°æ’è¡Œæ¦œã€æŒ‰éˆ•ç”¨ï¼‰
        lastResult = {
          categoryId: currentCategory,
          score: score,
          timeMs: usedMs
        };


        var title = 'æœ¬æ¬¡æŒ‘æˆ°';
        if(currentCategory && CATEGORY_META[currentCategory]){
          title = CATEGORY_META[currentCategory].label;
        }

        statusText.textContent = 'å·²å®Œæˆï¼š' + title + 'ï½œç­”å° ' + correctCount + ' / ' + total + ' é¡Œ';
        timerText.textContent = 'æ™‚é–“ï¼š' + formatDuration(usedMs);
        if(questionModalTimer){
          questionModalTimer.textContent = 'ä½œç­”æ™‚é–“ï¼š' + formatDuration(usedMs);
        }

        // å­˜é€™ä¸€æ¬¡å®Œæ•´çš„é¡Œç›® + ä½œç­”è¨˜éŒ„ï¼Œçµ¦ã€ŒæŸ¥çœ‹éŒ¯èª¤ã€ç”¨
        lastExamDetail = {
          categoryId: currentCategory,
          questions: examQuestions.slice()
        };


        startBtn.disabled = false;
        startBtn.textContent = 'é‡æ–°ä½œç­”';

        var msg = '';
        msg += '<div><b>' + title + '</b></div>';
        msg += '<div>æœ¬æ¬¡æˆç¸¾ï¼š<b>' + score + ' åˆ†</b></div>';
        msg += '<div>ç­”å°é¡Œæ•¸ï¼š' + correctCount + ' / ' + total + '</div>';
        msg += '<div>å®Œæˆæ™‚é–“ï¼š' + formatDuration(usedMs) + '</div>';
        msg += '<div style="margin-top:6px;font-size:13px;color:#555;">';
        msg += 'æ˜¯å¦è¦å°‡æœ¬æ¬¡æˆç¸¾å„²å­˜åˆ°æ’è¡Œæ¦œï¼Ÿè‹¥å·²å­˜åœ¨åŒåä½¿ç”¨è€…ï¼Œæœƒä»¥æœ¬æ¬¡æˆç¸¾è¦†è“‹ã€‚';
        msg += '</div>';

        resultTextEl.innerHTML = msg;
        openModal(resultModal);
      }

            // ===== æœ¬æ¬¡éŒ¯èª¤é¡Œç›®æª¢è¦– =====
      if(wrongModalClose){
        wrongModalClose.addEventListener('click', function(){
          closeModal(wrongModal);
        });
      }

      if(viewWrongBtn){
        viewWrongBtn.addEventListener('click', function(){
          if(!lastExamDetail || !lastExamDetail.questions || !lastExamDetail.questions.length){
            alert('ç›®å‰æ²’æœ‰å¯æª¢è¦–çš„éŒ¯èª¤é¡Œç›®ï¼Œè«‹å…ˆå®Œæˆä¸€æ¬¡æŒ‘æˆ°ã€‚');
            return;
          }

          var qs = lastExamDetail.questions;
          var wrongList = qs.filter(function(q){ return q.isCorrect === false; });

          var html = '';
          if(!wrongList.length){
            html += '<div class="top3-empty">æœ¬æ¬¡å…¨éƒ¨ç­”å°ï¼Œæ²’æœ‰éŒ¯èª¤é¡Œç›®ï¼</div>';
          }else{
            html += '<div style="font-size:13px;color:#555;margin-bottom:6px;">ä»¥ä¸‹æ˜¯æœ¬æ¬¡ä½œç­”éŒ¯èª¤çš„é¡Œç›®ï¼Œæ–¹ä¾¿ä½ ä¹‹å¾Œè¤‡ç¿’ï¼š</div>';
            var letters = ['A','B','C','D','E','F'];
            for(var i=0;i<wrongList.length;i++){
              var q = wrongList[i];
              var qIdx = qs.indexOf(q);
              var userIdx = (typeof q.userIndex === 'number') ? q.userIndex : -1;
              var correctIdx = -1;
              for(var k=0;k<q.options.length;k++){
                if(q.options[k].correct){
                  correctIdx = k;
                  break;
                }
              }

              html += '<div class="question-card" style="margin-bottom:8px;">';
              html +=   '<div class="question-meta">';
              html +=     '<span class="question-badge">ç¬¬ ' + (qIdx+1) + ' é¡Œ</span>';
              html +=     '<span>ä½ çš„ç­”æ¡ˆ vs æ­£ç¢ºç­”æ¡ˆ</span>';
              html +=   '</div>';

              if(q.image){
                html += '<div class="question-media-box"><img src="'+ q.image +'" alt=""></div>';
              }

              html +=   '<div class="question-text">' + q.text + '</div>';
              html +=   '<div style="font-size:13px;line-height:1.6;margin-top:4px;">';

              if(userIdx >= 0 && q.options[userIdx]){
                html += '<div>ä½ çš„ç­”æ¡ˆï¼š<span style="color:#c62828;font-weight:700;">'
                     + (letters[userIdx] || '') + ' ' + q.options[userIdx].text + '</span></div>';
              }else{
                html += '<div>ä½ çš„ç­”æ¡ˆï¼š<span style="color:#c62828;">ï¼ˆæœªä½œç­”ï¼‰</span></div>';
              }

              if(correctIdx >= 0 && q.options[correctIdx]){
                html += '<div>æ­£ç¢ºç­”æ¡ˆï¼š<span style="color:#2e7d32;font-weight:700;">'
                     + (letters[correctIdx] || '') + ' ' + q.options[correctIdx].text + '</span></div>';
              }

              html +=   '</div>';
              html += '</div>';
            }
          }

          wrongModalBody.innerHTML = html;

          // é—œæ‰æˆç¸¾è¦–çª—ï¼Œé–‹éŒ¯é¡Œè¦–çª—
          closeModal(resultModal);
          openModal(wrongModal);
        });
      }


      // ===== å¾ Firebase è®€å–æ’è¡Œæ¦œï¼ˆä¾ categoryIdï¼‰=====
      function fetchRankListFromFirebase(categoryId, cb){
        if(!categoryId){ cb([]); return; }
        db.ref('challengeRank/' + categoryId).once('value')
          .then(function(snap){
            var val = snap.val() || {};
            var list = Object.keys(val).map(function(k){
              return val[k];
            });

            // æ’åºï¼šåˆ†æ•¸é«˜å„ªå…ˆï¼›åŒåˆ†æ™‚é–“çŸ­å„ªå…ˆ
            list.sort(function(a,b){
              a = a || {}; b = b || {};
              var as = Number(a.score||0), bs = Number(b.score||0);
              if(as !== bs) return bs - as;
              return Number(a.timeMs||0) - Number(b.timeMs||0);
            });

            cb(list);
          })
          .catch(function(err){
            console && console.warn && console.warn('fetch rank error', err);
            cb([]);
          });
      }

      // ===== æ’è¡Œæ¦œ =====
      function renderRank(categoryId){
        rankModalBody.innerHTML = '';
        if(!categoryId || !CATEGORY_META[categoryId]){
          rankModalTitle.textContent = 'æ’è¡Œæ¦œ';
          rankModalBody.innerHTML = '<div class="rank-empty">è«‹å…ˆé¸æ“‡æŒ‘æˆ°é …ç›®ï¼Œå†æŸ¥çœ‹æ’è¡Œæ¦œã€‚</div>';
          return;
        }

        var meta = CATEGORY_META[categoryId];
        rankModalTitle.textContent = 'æ’è¡Œæ¦œï¼š' + meta.label;

        // âœ… æ”¹è®€ Firebase
        rankModalBody.innerHTML = '<div class="rank-empty">è®€å–ä¸­...</div>';

        fetchRankListFromFirebase(categoryId, function(list){
          if(!list.length){
            rankModalBody.innerHTML = '<div class="rank-empty">ç›®å‰å°šç„¡æˆç¸¾ç´€éŒ„ã€‚</div>';
            return;
          }

          var html = '';
          html += '<table class="rank-table"><thead><tr>';
          html += '<th>åæ¬¡</th><th>å§“å</th><th>åˆ†æ•¸</th><th>å®Œæˆæ™‚é–“</th>';
          html += '</tr></thead><tbody>';

          for(var i=0;i<list.length;i++){
            var row = list[i] || {};
            var cls = (row.userKey === userKey) ? ' class="me-row"' : '';
            html += '<tr'+cls+'>';
            html += '<td>' + (i+1) + '</td>';
            html += '<td>' + (row.name || '-') + '</td>';
            html += '<td>' + (row.score || 0) + 'åˆ†</td>';
            html += '<td>' + formatDuration(row.timeMs || 0) + '</td>';
            html += '</tr>';
          }

          html += '</tbody></table>';
          rankModalBody.innerHTML = html;
        });
      }


       // ===== é¡¯ç¤ºç›®å‰æŒ‘æˆ°é …ç›® Top 3 =====
        function updateTop3Box(categoryId){
          if(!top3Box){ return; }
          top3Box.innerHTML = '';

          if(!categoryId || !CATEGORY_META[categoryId]){
            top3Box.innerHTML = '<div class="top3-empty">è«‹å…ˆé¸æ“‡æŒ‘æˆ°é …ç›®ï¼Œå°‡é¡¯ç¤ºè©²é …ç›®å‰ 3 åæˆç¸¾ã€‚</div>';
            return;
          }

          // âœ… æ”¹è®€ Firebase
          top3Box.innerHTML = '<div class="top3-empty">è®€å–å‰ 3 åä¸­...</div>';

          fetchRankListFromFirebase(categoryId, function(list){
            if(!list.length){
              top3Box.innerHTML = '<div class="top3-empty">ç›®å‰å°šç„¡æ’è¡Œæ¦œç´€éŒ„ï¼Œå®ŒæˆæŒ‘æˆ°ä¸¦å„²å­˜æˆç¸¾å¾Œæœƒé¡¯ç¤ºå‰ 3 åã€‚</div>';
              return;
            }

            var max = Math.min(3, list.length);
            var medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

            var html = '<div class="top3-title">æœ¬é …ç›®å‰ä¸‰å</div>';
            html += '<div class="top3-list">';
            for(var i=0;i<max;i++){
              var row = list[i] || {};
              html += '<div class="top3-item">';
              html +=   '<span>' + medals[i] + ' ' + (row.name || '-') + '</span>';
              html +=   '<span class="score">' + (row.score || 0) + 'åˆ† / ' + formatDuration(row.timeMs || 0) + '</span>';
              html += '</div>';
            }
            html += '</div>';

            top3Box.innerHTML = html;
          });
        }



      // ===== äº‹ä»¶ï¼šåˆ‡æ› mode =====
      modeWorkBtn.addEventListener('click', function(){
        setMode('work');
      });
      modeLangBtn.addEventListener('click', function(){
        setMode('lang');
      });
      setMode('work');
      
      // åˆå§‹åŒ–ï¼šä¾ç…§é¡Œåº«æ•¸é‡éš±è—æœªæ»¿ 20 é¡Œçš„é …ç›®ï¼Œä¸¦æ›´æ–°é–‹å§‹ä½œç­”æŒ‰éˆ• & Top3
      refreshCategoryButtons();
      updateStartButtonState();
      updateCurrentChoice();


      // å·¥ä½œæŒ‘æˆ°
      var workBtns = workPanel.querySelectorAll('.work-btn');
      for (var i = 0; i < workBtns.length; i++) {
        workBtns[i].addEventListener('click', function () {
          // æ¸…é™¤å·¥ä½œæŒ‘æˆ°æŒ‰éˆ• active æ¨£å¼
          for (var k = 0; k < workBtns.length; k++) {
            workBtns[k].classList.remove('active');
          }
          this.classList.add('active');

          // è¨­å®šç›®å‰æŒ‘æˆ°é¡åˆ¥
          currentCategory = this.getAttribute('data-category');

          // æ¸…é™¤èªè¨€æŒ‘æˆ°çš„æŒ‰éˆ•æ¨£å¼
          var lvlBtns = langPanel.querySelectorAll('.level-btn');
          for (var k2 = 0; k2 < lvlBtns.length; k2++) {
            lvlBtns[k2].classList.remove('active');
          }

          // é‡ç½®è€ƒè©¦ç‹€æ…‹
          resetExamState();

          // æ›´æ–°ç›®å‰æŒ‘æˆ°æ–‡å­—
          updateCurrentChoice();

          // æ›´æ–°é–‹å§‹ä½œç­”æŒ‰éˆ•ç‹€æ…‹ï¼ˆæš—è‰² / ç´…åº•ï¼‰
          if (typeof updateStartButtonState === 'function') {
            updateStartButtonState();
          }
        });
      }


      // èªè¨€æŒ‘æˆ°
      var levelBtns = langPanel.querySelectorAll('.level-btn');
      for (var j = 0; j < levelBtns.length; j++) {
        levelBtns[j].addEventListener('click', function () {
          // æ¸…é™¤èªè¨€ç­‰ç´š active æ¨£å¼
          for (var k = 0; k < levelBtns.length; k++) {
            levelBtns[k].classList.remove('active');
          }
          this.classList.add('active');

          // è¨­å®šç›®å‰æŒ‘æˆ°é¡åˆ¥
          currentCategory = this.getAttribute('data-category');

          // æ¸…é™¤å·¥ä½œæŒ‘æˆ° active æ¨£å¼
          for (var k2 = 0; k2 < workBtns.length; k2++) {
            workBtns[k2].classList.remove('active');
          }

          // é‡ç½®è€ƒè©¦ç‹€æ…‹
          resetExamState();

          // æ›´æ–°ç›®å‰æŒ‘æˆ°æ–‡å­—
          updateCurrentChoice();

          // æ›´æ–°é–‹å§‹ä½œç­”æŒ‰éˆ•ç‹€æ…‹ï¼ˆæš—è‰² / ç´…åº•ï¼‰
          if (typeof updateStartButtonState === 'function') {
            updateStartButtonState();
          }
        });
      }


      // ===== é–‹å§‹ä½œç­” =====
      startBtn.addEventListener('click', function(){
        if(examInProgress){
          return;
        }
        if(!currentCategory || !CATEGORY_META[currentCategory]){
          alert('è«‹å…ˆé¸æ“‡æŒ‘æˆ°é¡å‹èˆ‡å­é …ç›®ã€‚');
          return;
        }
        var bank = QUESTION_BANK[currentCategory] || [];
        if(!bank.length){
          alert('é€™å€‹æŒ‘æˆ°ç›®å‰å°šæœªè¨­å®šé¡Œç›®ï¼Œè«‹ä¹‹å¾Œå†è©¦è©¦ï¼Œæˆ–ç”±ç®¡ç†å“¡æ–°å¢é¡Œåº«ã€‚');
          return;
        }

        var exam = buildExamFromBank(currentCategory);
        if(!exam || !exam.length){
          alert('æœ¬æŒ‘æˆ°æ²’æœ‰å¯ç”¨é¡Œç›®ã€‚');
          return;
        }

        examQuestions = exam;
        currentIndex = 0;
        correctCount = 0;
        examStartTime = Date.now();
        examInProgress = true;
        lastResult = null;

        statusText.textContent = 'ä½œç­”ä¸­ï¼ˆå…± ' + examQuestions.length + ' é¡Œï¼‰';
        timerText.textContent = 'æ™‚é–“ï¼š0åˆ†0ç§’';
        if(questionModalTimer){
          questionModalTimer.textContent = 'ä½œç­”æ™‚é–“ï¼š0åˆ†0ç§’';
        }

        stopTimer();
        timerId = setInterval(function(){
          if(!examStartTime){
            timerText.textContent = 'æ™‚é–“ï¼š0åˆ†0ç§’';
            if(questionModalTimer){
              questionModalTimer.textContent = 'ä½œç­”æ™‚é–“ï¼š0åˆ†0ç§’';
            }
            return;
          }
          var diff = Date.now() - examStartTime;
          var txt = formatDuration(diff);
          timerText.textContent = 'æ™‚é–“ï¼š' + txt;
          if(questionModalTimer){
            questionModalTimer.textContent = 'ä½œç­”æ™‚é–“ï¼š' + txt;
          }
        }, 500);

        startBtn.disabled = true;
        startBtn.textContent = 'ä½œç­”ä¸­...';

        showCurrentQuestion();
      });

      // é¡Œç›®å½ˆçª—å³ä¸Šè§’ Xï¼šæ”¾æ£„ä½œç­”
      questionModalClose.addEventListener('click', function(){
        if(examInProgress){
          var sure = confirm('ç¢ºå®šè¦ä¸­æ­¢æœ¬æ¬¡ä½œç­”å—ï¼Ÿå·²ä½œç­”çš„é¡Œç›®å°‡ä¸æœƒè¨ˆåˆ†ã€‚');
          if(!sure){ return; }
        }
        closeModal(questionModal);
        resetExamState();
      });

      // æˆç¸¾å½ˆçª—
      resultModalClose.addEventListener('click', function(){
        closeModal(resultModal);
      });

saveResultBtn.addEventListener('click', function(){
  if(!lastResult || !lastResult.categoryId){
    alert('ç›®å‰æ²’æœ‰å¯å„²å­˜çš„æˆç¸¾ã€‚');
    return;
  }

      // âœ… ä½¿ç”¨å¤–å±¤å·²å®£å‘Šçš„ userKeyï¼ˆé¿å…æ’è¡Œæ¦œç©ºç™½ï¼‰
      var path = 'challengeRank/' + lastResult.categoryId + '/' + userKey;

      db.ref(path).set({
        name: name,
        acc: acc,
        userKey: userKey,
        score: lastResult.score,
        timeMs: lastResult.timeMs,
        updatedAt: Date.now()
      }).then(function () {
        alert('å·²å„²å­˜åˆ°æ’è¡Œæ¦œï¼ˆé›²ç«¯ï¼‰');

        if (typeof updateTop3Box === 'function') {
          updateTop3Box(lastResult.categoryId);
        }

        closeModal(resultModal);
      }).catch(function (err) {
        alert('å„²å­˜å¤±æ•—ï¼š' + err);
      });
    });


      // æŸ¥çœ‹æ’è¡Œæ¦œ
      viewRankBtn.addEventListener('click', function(){
        if(!currentCategory || !CATEGORY_META[currentCategory]){
          alert('è«‹å…ˆé¸æ“‡æŒ‘æˆ°é …ç›®ã€‚');
          return;
        }
        renderRank(currentCategory);
        openModal(rankModal);
      });

      rankModalClose.addEventListener('click', function(){
        closeModal(rankModal);
      });

      // è¿”å›ä¸»é  / ç™»å‡º
      backMainBtn.addEventListener('click', function(){
        window.location.href = 'main.html';
      });

      logoutBtn.addEventListener('click', function(){
        try{
          localStorage.removeItem('t2_user_bind');
          localStorage.removeItem('t2_user_name');
          localStorage.removeItem('t2_user_acc');
        }catch(e){}
        window.location.replace('index.html');
      });

      // åˆå§‹åŒ–
      resetExamState();
      updateCurrentChoice();
      refreshCategoryButtons();
      setMode('work');
    })();
  </script>
</body>
</html>
